<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation — Reschedule</title>
  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,Helvetica,sans-serif}
    main{max-width:760px;width:92vw;margin:0 auto 40px;padding:0 16px}
    h1{color:#ffddae;margin:16px 0}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,select{
      display:block;width:100%;height:44px;padding:10px 12px;
      background:#1a1a1a;color:#ffddae;border:1px solid #444;border-radius:8px;outline:none;
    }
    input:focus,select:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    button{
      width:100%;padding:14px 16px;margin-top:18px;background:var(--copper);color:#000;
      font-weight:700;font-size:18px;border:0;border-radius:10px;cursor:pointer;
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .card{margin:18px 0;padding:16px;border-radius:12px;background:#0e0e0e;border:1px solid rgba(168,116,79,.3)}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:10px 0}
    .kpi{background:#0d0d0d;border:1px solid rgba(168,116,79,.25);border-radius:12px;padding:12px}
    .kpi .label{font-size:.8rem;opacity:.8;margin-bottom:6px}
    .kpi .value{font-size:1.35rem;font-weight:800;color:#f0d1ad}
    .kpi .value.price{color:#ffddae}
    .breakdown{margin:10px 0;font-size:.9rem}
    .breakdown .row{display:flex;justify-content:space-between;padding:6px 0}
    .breakdown .row.total{font-weight:800;color:#ffddae;font-size:1rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:8px 0}
    .veh-toggle{display:flex;gap:8px;margin:10px 0}
    .veh-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);
      color:var(--copper);padding:12px;border-radius:10px;cursor:pointer;font-weight:700}
    .veh-btn.active{background:var(--copper);color:#000;border-color:var(--copper)}
    .mg-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);
      color:var(--copper);padding:10px;border-radius:8px;cursor:pointer;font-weight:700;text-align:center}
    .mg-btn.active{background:var(--copper);color:#000;border-color:var(--copper)}
    .hint{font-size:.85rem;margin-top:6px}
    .hint.warn{color:var(--warn)}
    .hint.err{color:var(--err)}
    .hint.ok{color:var(--ok)}
    #map{height:320px;margin-top:12px;border-radius:12px;overflow:hidden}
  </style>
</head>
<body>
  <main>
    <h1>Reschedule Reservation</h1>
    <div class="card">
      <label for="cn">Reservation Code (CN)</label>
      <input id="cn" type="text" placeholder="BZ-XXXX-1234" />
      <button id="btnLoad">Load Reservation</button>
      <div id="loadHint" class="hint"></div>
    </div>

    <div id="currentCard" class="card" style="display:none">
      <h3>Current Booking</h3>
      <div id="bookingSummary"></div>
      <div id="reschedWarn" class="hint warn" style="margin-top:8px"></div>
    </div>

    <div id="changeCard" class="card" style="display:none">
      <h3>Change Booking</h3>

      <label for="newDate">New Date</label>
      <input id="newDate" type="date" />
      <label for="newTime">New Time</label>
      <input id="newTime" type="time" step="900" />

      <label for="pickup">Pickup Address</label>
      <input id="pickup" placeholder="Enter pickup address" />
      <label for="dropoff">Drop-off Address</label>
      <input id="dropoff" placeholder="Enter drop-off address" />

      <div id="vehToggle" class="veh-toggle">
        <button class="veh-btn active" data-type="suv">SUV</button>
        <button class="veh-btn" data-type="van">Van</button>
      </div>
      <div id="mgWrap" style="display:none;margin-top:10px">
        <h4>Meet & Greet (SLC only)</h4>
        <div style="display:flex;gap:8px">
          <div class="mg-btn active" data-choice="none">None</div>
          <div class="mg-btn" data-choice="tsa_exit">TSA Exit +$50</div>
          <div class="mg-btn" data-choice="baggage_claim">Baggage Claim +$50</div>
        </div>
      </div>

      <button id="btnRoute">Calculate Route</button>

      <div class="kpis">
        <div class="kpi"><div class="label">Vehicle</div><div id="kpiVehicle" class="value">SUV</div></div>
        <div class="kpi"><div class="label">Miles</div><div id="kpiMiles" class="value">—</div></div>
        <div class="kpi"><div class="label">Original</div><div id="kpiOriginal" class="value">$0.00</div></div>
        <div class="kpi"><div class="label">New Total</div><div id="kpiNew" class="value price">$0.00</div></div>
        <div class="kpi"><div class="label">Difference</div><div id="kpiDiff" class="value">$0.00</div></div>
        <div class="kpi"><div class="label">After Hours</div><div id="kpiAH" class="value">No</div></div>
      </div>

      <div id="breakdown" class="breakdown"></div>
      <button id="btnSave" disabled>Save Changes</button>
      <div id="saveHint" class="hint warn" style="margin-top:6px"></div>
    </div>

    <div id="resultCard" class="card" style="display:none">
      <h3>Result</h3>
      <div id="result"></div>
    </div>

    <div id="map"></div>
  </main>

  <script src="https://js.stripe.com/v3"></script>
  <script>
    // === Config ===
    const STRIPE_PK = "pk_live_51Rr9g0LxdVPME4zrYzx4WKgoT3NUZBSkWbwMnSmGPQCyE4MzzIufo6gM8EvLeTHOjQ5Vcn2V1GY0D9RrcJrOjRCd002MQFljOF";
    const BASE_ADDRESS = "13742 N Jordanelle Pkwy, Kamas, UT";
    let map, directionsService, directionsRenderer, geocoder;
    let pickupPlace, dropoffPlace, selectedVehicle = "suv", mgChoice = "none";
    let originalTotal = 0;

    // Pricing
    function calculateBase(mi){
      if (mi <= 10) return 120;
      if (mi <= 35) return 190;
      if (mi <= 39) return 210;
      if (mi <= 48) return 230;
      if (mi <= 55) return 250;
      return mi * 5.4;
    }
    function applyVehicleMultiplier(total){
      return (selectedVehicle === "van") ? Math.round(total * 1.3) : total;
    }
    function getMGFee(){ return mgChoice !== "none" ? 50 : 0; }

    // Basic airport/SLC helpers (for Meet & Greet toggle)
    function isAirport(place){
      const t=place?.types||[];
      return t.includes("airport") || /airport/i.test(place?.name||place?.formatted_address||"");
    }
    function isUtah(place){
      const a=(place?.formatted_address||"").toLowerCase();
      return /\but\b/.test(a) || /, ut(ah)?\b/.test(a);
    }
    const FBO_RX=/\b(fbo|million air|signature( aviation| flight| support)?|atlantic aviation|ok3 air|ross aviation|tac air|jet center|hangar)\b/i;
    function isPrivateUtahAirport(p){ if(!p) return false; if(!isAirport(p)||!isUtah(p)) return false; const t=`${p.name||""} ${p.formatted_address||""}`; return FBO_RX.test(t); }
    function isSLCInternational(p){
      if(!p) return false;
      const name=(p.name||"").toLowerCase(), addr=(p.formatted_address||"").toLowerCase();
      const hits=/salt lake city international/.test(name)||/\bslc\b/.test(name)||/salt lake city international/.test(addr)||/\bslc\b/.test(addr);
      return hits && isAirport(p) && !isPrivateUtahAirport(p);
    }
    function updateMeetGreetVisibility(){
      const show = selectedVehicle==='suv' && isSLCInternational(pickupPlace||null);
      const wrap = document.getElementById('mgWrap');
      if (!wrap) return;
      wrap.style.display = show ? 'block' : 'none';
      if (!show) {
        mgChoice = 'none';
        document.querySelectorAll('#mgWrap .mg-btn').forEach(b=>b.classList.toggle('active', b.dataset.choice==='none'));
      }
    }

    function isAfterHours(dateStr, timeStr){
      if(!dateStr || !timeStr) return false;
      const d = new Date(dateStr+"T"+timeStr+":00");
      const sh = 6, eh = 23;
      return d.getHours() < sh || d.getHours() >= eh;
    }

    // Load booking
    document.getElementById("btnLoad").addEventListener("click", async ()=>{
      const cn = document.getElementById("cn").value.trim();
      if(!cn) return alert("Enter CN");
      document.getElementById("loadHint").textContent = "Loading booking…";
      try{
        const resp = await fetch(`/api/book/get?cn=${encodeURIComponent(cn)}`);
        const data = await resp.json();
        if(!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
        const b = data.booking || data;

        originalTotal = Number(b.quoted_total ?? b.quotedTotal ?? 0);
        document.getElementById("currentCard").style.display="block";
        document.getElementById("changeCard").style.display="block";
        document.getElementById("bookingSummary").textContent =
          `${b.date_iso||b.date} ${b.time_hhmm||b.time} — ${b.pickup} → ${b.dropoff} — $${originalTotal.toFixed(2)}`;
        document.getElementById("kpiOriginal").textContent = `$${originalTotal.toFixed(2)}`;
        document.getElementById("loadHint").textContent = "Booking loaded ✔️";
      }catch(e){
        document.getElementById("loadHint").textContent = "❌ " + (e?.message||e);
        alert("Reservation not found");
      }
    });

    // Vehicle toggle
    document.querySelectorAll(".veh-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".veh-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        selectedVehicle = btn.dataset.type;
        document.getElementById("kpiVehicle").textContent = selectedVehicle.toUpperCase();
        updateMeetGreetVisibility();
      });
    });
    // Meet & Greet
    document.querySelectorAll(".mg-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".mg-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        mgChoice = btn.dataset.choice;
      });
    });

    // Route calc
    document.getElementById("btnRoute").addEventListener("click", async ()=>{
      if(!pickupPlace?.place_id || !dropoffPlace?.place_id) return alert("Select both addresses from suggestions");

      const trip = await directionsService.route({
        origin:{placeId:pickupPlace.place_id},
        destination:{placeId:dropoffPlace.place_id},
        travelMode:google.maps.TravelMode.DRIVING
      });
      directionsRenderer.setDirections(trip);
      const leg = trip.routes[0].legs[0];
      const miles = leg.distance.value/1609.34;
      document.getElementById("kpiMiles").textContent = miles.toFixed(1);

      const base = calculateBase(miles);
      const ahFee = isAfterHours(document.getElementById("newDate").value, document.getElementById("newTime").value)
        ? (base) * 0.20 : 0;
      const mgFee = getMGFee();
      let newTotal = applyVehicleMultiplier(base + ahFee + mgFee);

      // ——— Regla de reprogramación: NUNCA devolvemos si baja ———
      let diff = newTotal - originalTotal;
      if (diff <= 0) {
        diff = 0; // no refund
      }

      // KPIs + breakdown
      document.getElementById("kpiNew").textContent  = `$${newTotal.toFixed(2)}`;
      document.getElementById("kpiDiff").textContent = `$${diff.toFixed(2)}`;
      document.getElementById("kpiAH").textContent   = ahFee>0 ? "Yes (+20%)" : "No";

      const rows = [];
      rows.push(`<div class="row"><span>Base (${miles.toFixed(1)} mi)</span><span>$${base.toFixed(2)}</span></div>`);
      if (ahFee>0) rows.push(`<div class="row"><span>After‑Hours (20%)</span><span>$${ahFee.toFixed(2)}</span></div>`);
      if (mgFee>0) rows.push(`<div class="row"><span>Meet & Greet (SLC)</span><span>$${mgFee.toFixed(2)}</span></div>`);
      rows.push(`<div class="divider"></div><div class="row total"><span>Total</span><span>$${newTotal.toFixed(2)}</span></div>`);
      document.getElementById("breakdown").innerHTML = rows.join("");

      document.getElementById("btnSave").disabled = false;
      document.getElementById("saveHint").textContent = diff>0
        ? "Extra payment required to confirm changes."
        : "No extra payment required. (No refunds on reschedules.)";

      // Guardar para submit
      window.__calc = { newTotal, diff, miles, ahFee, mgFee, vehicle:selectedVehicle, mgChoice };
    });

    // Save
    document.getElementById("btnSave").addEventListener("click", async ()=>{
      const cn = document.getElementById("cn").value.trim();
      const newDate = document.getElementById("newDate").value;
      const newTime = document.getElementById("newTime").value;
      if (!cn || !newDate || !newTime) return alert("Fill CN, new date & time.");

      try{
        const resp = await fetch("/api/book/reschedule",{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({cn,newDate,newTime})
        });
        const data = await resp.json();
        if(!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

        document.getElementById("resultCard").style.display="block";
        const diff = Number((window.__calc?.diff||0).toFixed(2));
        document.getElementById("result").textContent =
          diff>0 ? `✅ Rescheduled. Extra due: $${diff.toFixed(2)}.` : "✅ Rescheduled. No extra payment.";

        if (diff>0){
          const stripe = Stripe(STRIPE_PK);
          const checkout = await fetch("/api/create-checkout-session-diff",{
            method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({cn,amount:Math.round(diff*100)})
          });
          const sdata = await checkout.json();
          if(sdata?.id){ await stripe.redirectToCheckout({sessionId:sdata.id}); }
        }
      }catch(e){
        alert("Error: "+(e?.message||e));
      }
    });

    // Maps init
    function initMapReschedule(){
      map = new google.maps.Map(document.getElementById("map"), {center:{lat:40.7,lng:-111.9},zoom:10});
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);
      geocoder = new google.maps.Geocoder();
      const opts={componentRestrictions:{country:["us"]},fields:["place_id","name","types","formatted_address","geometry","address_components"]};
      const acPickup=new google.maps.places.Autocomplete(document.getElementById("pickup"),opts);
      const acDrop=new google.maps.places.Autocomplete(document.getElementById("dropoff"),opts);
      acPickup.addListener("place_changed",()=>{pickupPlace=acPickup.getPlace(); updateMeetGreetVisibility();});
      acDrop.addListener("place_changed",()=>{dropoffPlace=acDrop.getPlace();});
    }
    window.initMapReschedule = initMapReschedule;
  </script>

  <!-- Google Maps con tu clave proporcionada -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMapReschedule"></script>
</body>
</html>
