<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>
  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,Helvetica,sans-serif}
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo{width:160px;height:160px;border-radius:50%;border:2px solid var(--copper);object-fit:cover;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    main{max-width:820px;width:92vw;margin:0 auto 40px;padding:0 16px}
    h1{margin:0 0 8px;color:#ffddae;font-size:1.35rem}
    .card{border:1px solid rgba(168,116,79,.45);border-radius:14px;background:linear-gradient(180deg,#121212,#0b0b0b);
      box-shadow:0 12px 28px rgba(0,0,0,.45);padding:16px;margin:12px 0}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,select,textarea{
      display:block;width:100%;height:44px;padding:10px 12px;background:#1a1a1a;color:#ffddae;
      border:1px solid #444;border-radius:10px;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    .input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:520px){.input-row{grid-template-columns:1fr}}
    .helper{font-size:.85rem;opacity:.95;margin-top:6px;color:#ffddae;}
    .hint{font-size:.9rem;margin-top:6px}
    .hint.ok{color:var(--ok)} .hint.err{color:var(--err)} .hint.warn{color:var(--warn)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:10px}
    .kpi .label{font-size:.75rem;opacity:.85;margin-bottom:6px}
    .kpi .value{font-size:1.25rem;font-weight:800;color:#f0d1ad}
    .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
    .row.total{font-weight:800;color:#ffddae;font-size:1.05rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:8px 0}
    button{width:100%;padding:14px 16px;margin-top:14px;background:var(--copper);color:#000;font-weight:800;
      font-size:18px;border:0;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .veh-toggle{display:flex;gap:8px}
    .veh-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);color:var(--copper);
      padding:10px;border-radius:10px;cursor:pointer;font-weight:700;text-align:center}
    .veh-btn.active{background:var(--copper);color:#000;border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.25)}
    .mg-options{display:flex;gap:8px;margin-top:6px}
    .mg-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);color:var(--copper);
      padding:10px;border-radius:8px;cursor:pointer;font-weight:700;text-align:center}
    .mg-btn.active{background:var(--copper);color:#000;border-color:var(--copper)}
    .tax-note{font-size:13px;color:#c9a97c;font-style:italic;text-align:right;opacity:.85}
    .muted{opacity:.8}
    .invalid{border-color:var(--err) !important; box-shadow:0 0 0 3px rgba(255,107,107,.25) !important;}
    #map{height:360px;border-radius:12px;overflow:hidden;margin-top:10px}
    /* NUEVO: bloqueo visual/funcional para div-toggles cuando hay límite */
    .disabled{ pointer-events:none; opacity:.6; }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="/images/bonanza-logo.PNG" alt="Bonanza Transportation Logo"/>
  </header>

  <main>
    <h1>Reschedule</h1>

    <!-- LOAD -->
    <div class="card" id="loadCard">
      <label for="cn">Reservation Code (CN)</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="cn" placeholder="BZ-20250821-ABCD" style="flex:1 1 auto" autocomplete="off"/>
        <button id="btnLoad" style="width:auto;padding:10px 14px;">Load</button>
      </div>
      <div id="loadHint" class="hint muted"></div>
    </div>

    <!-- CURRENT -->
    <div class="card" id="currentCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Current Booking</h3>
      <div id="bookingSummary" class="muted" style="line-height:1.5"></div>
      <div class="divider"></div>
      <div class="kpis">
        <div class="kpi"><div class="label">Vehicle</div><div class="value" id="kpiVehicle">SUV</div></div>
        <div class="kpi"><div class="label">Distance</div><div class="value"><span id="kpiMiles">—</span> mi</div></div>
        <div class="kpi"><div class="label">Original Total</div><div class="value">$<span id="kpiOriginal">—</span></div></div>
      </div>
      <div id="reschedWarn" class="hint warn" style="display:none"></div>
    </div>

    <!-- CHANGES -->
    <div class="card" id="changeCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Change Date, Time & Route</h3>

      <div class="input-row">
        <div>
          <label for="newDate">New Date</label>
          <input type="date" id="newDate"/>
          <div id="newDateHelp" class="helper"></div>
        </div>
        <div>
          <label for="newTime">New Time</label>
          <input type="time" id="newTime" step="900"/>
          <div id="newTimeHelp" class="helper"></div>
        </div>
      </div>

      <label style="margin-top:10px">Pickup</label>
      <input id="pickup" placeholder="e.g. SLC Airport" autocomplete="off"/>
      <label style="margin-top:10px">Drop-off</label>
      <input id="dropoff" placeholder="e.g. Montage Deer Valley" autocomplete="off"/>
      <!-- 
      
      JSX fields (solo cuando el pickup sea JSX en Utah) -->
<div id="jsxContainer" style="display:none; margin-top:10px;">
  <label for="jsxFlightNumber">JSX Flight Number:</label>
  <input id="jsxFlightNumber" placeholder="e.g. XE1234" />
  <label for="jsxOrigin" style="margin-top:12px;">JSX Origin City:</label>
  <input id="jsxOrigin" placeholder="e.g. Burbank (BUR)" />
</div>

<!-- Vuelo comercial (SLC / PVU / JSX comercial) -->
<div id="flightContainer" style="display:none;">
  <label for="flightNumber">Flight Number</label>
  <input id="flightNumber" placeholder="e.g. DL1234" />
  <div id="flightHint" class="hint warn" style="display:none"></div>

  <label for="flightOrigin" style="margin-top:12px;">Flight Origin City</label>
  <input id="flightOrigin" placeholder="e.g. Miami (MIA)" />
  <div id="originHelp" class="hint" style="display:none"></div>
</div>

<!-- Resultado del backend (FlightCheck) -->
<div id="backendResult" class="hint" style="display:block; margin-top:6px;"></div>

<!-- Jet privado / FBO (aeropuertos privados en Utah) -->
<div id="privateFlightContainer" style="display:none;">
  <label for="tailNumber">Jet Tail Number (N-Number)</label>
  <input id="tailNumber" placeholder="e.g., N123AB" />
  <div id="tailHelp" class="hint" style="display:none"></div>

  <label for="pvtOrigin" style="margin-top:12px;">Flight Origin City</label>
  <input id="pvtOrigin" placeholder="e.g., Van Nuys (VNY)" />
  <div id="pvtOriginHelp" class="hint" style="display:none"></div>
</div>
      <!-- Helpers base que usa updateFlightVisibility (deben existir ANTES) -->
<script>
(function () {
  // ¿es aeropuerto?
  window.isAirport = function (place) {
    const t = place?.types || [];
    return t.includes('airport') || /airport/i.test(place?.name || place?.formatted_address || '');
  };
  // ¿está en Utah?
  window.isUtah = function (place) {
    const a = (place?.formatted_address || '').toLowerCase();
    return /\but\b/.test(a) || /, ut(ah)?\b/i.test(a);
  };
  // FBO privado en Utah
  const FBO_RX = /\b(fbo|million air|signature( aviation| flight| support)?|atlantic aviation|ok3 air|ross aviation|tac air|jet center|hangar)\b/i;
  window.isPrivateUtahAirport = function (place) {
    if (!place) return false;
    if (!window.isAirport(place) || !window.isUtah(place)) return false;
    const text = `${place.name || ''} ${place.formatted_address || ''}`;
    return FBO_RX.test(text);
  };
  // SLC comercial (no FBO)
  window.isSLCInternational = function (place) {
    if (!place) return false;
    const name = (place.name || '').toLowerCase();
    const addr = (place.formatted_address || '').toLowerCase();
    const hits = /salt lake city international/.test(name) || /\bslc\b/.test(name) ||
                 /salt lake city international/.test(addr) || /\bslc\b/.test(addr);
    return hits && window.isAirport(place) && !window.isPrivateUtahAirport(place);
  };
})();
</script>
<script>
// === Helpers extra (JSX + vuelo) ===
const AIRLINES = new Set(["AA","DL","UA","WN","AS","B6","F9","NK","HA","AC","AM","AF","BA","KL","LH","VS","IB","TK","QR","EK","CM","AV","QF","CX","AZ","SK","LA","AR","TS","WS","DY","NH","JL","KE","XE"]);
const FLIGHT_REGEX = /^([A-Z0-9]{2})\s?-?\s?(\d{1,4})([A-Z])?$/;
let __flightSeq = 0;

function normalizeFlight(v){
  return (v||'').toUpperCase().trim().replace(/\s+/g,' ').replace('–','-');
}
function validateFlightValue(v){
  const m = normalizeFlight(v).match(FLIGHT_REGEX);
  if (!m) return {ok:false,msg:'Invalid format. Use AA1234 or WN 987.'};
  const code = m[1], num = m[2];
  if(!AIRLINES.has(code)) return {ok:false,msg:'Unknown airline code.'};
  if(/^0+$/.test(num)) return {ok:false,msg:'Invalid flight number.'};
  return {ok:true,msg:''};
}
function parseOriginIata(text){
  const t = (text || "").trim().toUpperCase();
  const m = t.match(/\(([A-Z]{3})\)$/);
  if (m) return m[1];
  if (/^[A-Z]{3}$/.test(t)) return t;
  return null;
}
function isJSXUtah(place){
  if (!place) return false;
  const text = (place.name || place.formatted_address || "").toUpperCase();
  return text.includes("JSX");
}
function isProvoAirport(place){
  if(!place) return false;
  const name=(place.name||'').toLowerCase();
  const addr=(place.formatted_address||'').toLowerCase();
  const nameHit=/\bprovo\b/.test(name)||/\bpvu\b/.test(name)||/municipal|regional/.test(name);
  const addrHit=(/\bprovo\b/.test(addr)&&/\but\b/.test(addr))||/\b84601\b/.test(addr)||/mike\s*jense\s*pkwy/.test(addr);
  return (nameHit||addrHit) && isAirport(place) && isUtah(place) && !isPrivateUtahAirport(place);
}
function isCommercialPickup(place){
  return !!place && isUtah(place) && (isSLCInternational(place) || isProvoAirport(place) || isJSXUtah(place));
}

// ——— UI show/hide según pickup ———
function updateFlightVisibility(){
  const commWrap = document.getElementById('flightContainer');
  const pvtWrap  = document.getElementById('privateFlightContainer');
  const jsxWrap  = document.getElementById('jsxContainer');

 const place = pickupPlace || null;
  const isAirportUT = !!place && isAirport(place) && isUtah(place);
  const isComm      = isCommercialPickup(place);

  // JSX: mostrar su bloque y ocultar el de vuelo comercial
  if (jsxWrap) jsxWrap.style.display = (isJSXUtah(place) ? 'block' : 'none');

  if (commWrap){
    const showComm = isComm && !isJSXUtah(place);
    commWrap.style.display = showComm ? 'block' : 'none';
    if(!showComm){
      const n = document.getElementById('flightNumber');
      const o = document.getElementById('flightOrigin');
      if(n){n.value=''; n.setCustomValidity('');}
      if(o){o.value=''; o.setCustomValidity('');}
      document.getElementById('flightHint')?.style?.setProperty('display','none');
      document.getElementById('originHelp')?.style?.setProperty('display','none');
    } else {
      initFlightOriginAutocomplete();
    }
  }
  if (pvtWrap){
    const showPvt = isAirportUT && !isComm;
    pvtWrap.style.display = showPvt ? 'block' : 'none';
    if(!showPvt){
      const t = document.getElementById('tailNumber');
      const p = document.getElementById('pvtOrigin');
      if(t){t.value=''; t.setCustomValidity('');}
      if(p){p.value=''; p.setCustomValidity('');}
      document.getElementById('tailHelp')?.style?.setProperty('display','none');
      document.getElementById('pvtOriginHelp')?.style?.setProperty('display','none');
    }
  }
}

// ——— Autocomplete para Flight Origin (ciudades) ———
function initFlightOriginAutocomplete() {
  const input = document.getElementById("flightOrigin");
  if (!input || !window.google?.maps?.places?.Autocomplete) return;
  const ac = new google.maps.places.Autocomplete(input, {
    types: ["(cities)"],
    fields: ["name","place_id","geometry"],
  });
  ac.addListener("place_changed", () => {
    window._flightOrigin = ac.getPlace();
  });
}

// ——— Fecha en ISO por los IDs de reschedule ———
const getResDateISO = () => {
  const v = (document.getElementById('newDate')?.value || '').trim();
  if (!v) return '';
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return v;
  const localMs = d.getTime() - d.getTimezoneOffset()*60000;
  return new Date(localMs).toISOString().slice(0,10);
};

// ——— Validación en vivo del Flight Number ———
function wireFlightValidation(){
  const input = document.getElementById('flightNumber');
  const hint  = document.getElementById('flightHint');
  if(!input || !hint) return;
  function update(){
    const r = validateFlightValue(input.value || "");
    hint.textContent = r.ok ? "Format looks good" : r.msg;
    hint.className   = "hint " + (r.ok ? "ok" : "err");
    hint.style.display = 'block';
    input.setCustomValidity(r.ok ? "" : r.msg);
  }
  input.addEventListener('input', update);
  update();
}

// ——— Llamada a Cloud Run (FlightCheck) ———
async function maybeCheckBackend(){
  const fl  = (document.getElementById("flightNumber")?.value || "").trim();
  const org = (document.getElementById("flightOrigin")?.value || "").trim();
  const dt  = getResDateISO();   // 👈 usa newDate

  if (!fl || !org || !dt) return;

  const normFl = fl.replace(/\s+/g,'').toUpperCase();
  const originIata = parseOriginIata(org) || "";

  const mySeq = ++__flightSeq;
  const hint = document.getElementById("flightHint");
  const originHelp = document.getElementById("originHelp");
  const backendRes = document.getElementById("backendResult");

  try{
    const qs = new URLSearchParams({ fn: normFl, originIata, date: dt });
    const resp = await fetch(`${FLIGHTCHECK_URL}?${qs.toString()}`);
    const data = await resp.json().catch(()=>({}));

    if (mySeq !== __flightSeq) return;

    if (!resp.ok || !data?.ok){
      hint && (hint.textContent="✗ Flight not found", hint.className="hint err", hint.style.display="block");
      originHelp && (originHelp.textContent=data?.msg||"✗ Invalid origin", originHelp.className="hint err", originHelp.style.display="block");
      backendRes && (backendRes.textContent = data?.msg || `Service error (${resp.status})`);
      return;
    }

    hint && (hint.textContent="✅ Flight confirmed", hint.className="hint ok", hint.style.display="block");
    originHelp && (originHelp.textContent="✅ Origin city confirmed", originHelp.className="hint ok", originHelp.style.display="block");

    // si viene arrivalLocal => propone hora local
    const t = String(data.arrivalLocal||"").match(/T(\d{2}:\d{2})/);
    if (t) document.getElementById('newTime')?.value = t[1];

    backendRes && (backendRes.textContent = data.arrivalLocal ? `ETA: ${data.arrivalLocal}` : "No ETA provided");
  }catch(e){
    hint && (hint.textContent="⚠️ Network error", hint.className="hint err", hint.style.display="block");
    backendRes && (backendRes.textContent = "⚠️ Error consultando backend: " + e.message);
  }
}

// ——— Disparadores backend ———
function wireFlightBackendTriggers(){
  const fn = document.getElementById('flightNumber');
  const org= document.getElementById('flightOrigin');
  const d  = document.getElementById('newDate');   // 👈 newDate
  const run = () => setTimeout(maybeCheckBackend, 200);
  fn?.addEventListener('input', run);
  org?.addEventListener('input', run);
  d?.addEventListener('change', run);
}
</script>


      <!-- ÚNICO BOTÓN DE CÁLCULO -->
      <button id="btnRoute" style="margin-top:12px">Calculate Route</button>
      <div id="map"></div>

      <!-- Vehicle -->
      <label style="margin-top:14px">Vehicle</label>
      <div class="veh-toggle" id="vehToggle">
        <div class="veh-btn active" data-type="suv">SUV (1–5)</div>
        <div class="veh-btn" data-type="van">Van (up to 12)</div>
      </div>

      <!-- Meet & Greet (SLC only) -->
      <div id="mgWrap" style="display:none; margin-top:10px;">
        <label>Meet & Greet — SLC Only</label>
        <div class="mg-options">
          <div class="mg-btn" data-choice="tsa_exit">TSA Exit (+$50)</div>
          <div class="mg-btn" data-choice="baggage_claim">Baggage Claim (+$50)</div>
          <div class="mg-btn active" data-choice="none">No Meet & Greet</div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:6px 0 8px;color:#ffddae">New Quote</h3>
      <div class="kpis">
        <div class="kpi"><div class="label">New Total</div><div class="value">$<span id="kpiNew">—</span></div></div>
        <div class="kpi"><div class="label">Difference</div><div class="value">$<span id="kpiDiff">—</span></div></div>
        <div class="kpi"><div class="label">After-Hours</div><div class="value" id="kpiAH">No</div></div>
      </div>

      <div id="breakdown" style="margin-top:6px"></div>
      <div class="tax-note">Taxes & gratuity included</div>

      <!-- YA NO EXISTE RECALCULATE -->
      <button id="btnSave" disabled>Save Changes</button>
      <div id="saveHint" class="hint muted">First, click “Calculate Route” to generate your full quote.</div>
    </div>

    <div class="card" id="resultCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Result</h3>
      <div id="result" class="hint"></div>
    </div>
  </main>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3"></script>
  <script>
// === 1) Detección de modo actual según pickup (reutiliza tus helpers) ===
function currentPickupMode(){
  const p = window.pickupPlace || null;
  if (!p || !isUtah(p) || !isAirport(p)) return 'NONE';
  if (isJSXUtah(p))           return 'JSX';
  if (isCommercialPickup(p))  return 'COMM'; // SLC / PVU
  return 'PVT'; // FBO Utah
}

// === 2) Validadores simples por campo (apoya los tuyos) ===
function nonEmpty(v){ return (v||'').trim().length > 0; }

function markInvalid(el, helpEl, msg){
  if (!el) return false;
  el.classList.add('invalid');
  if (helpEl){
    helpEl.textContent = msg;
    helpEl.className = 'hint err';
    helpEl.style.display = 'block';
  }
  if (typeof el.setCustomValidity === 'function') el.setCustomValidity(msg);
  return false;
}
function markValid(el, helpEl, okMsg){
  if (!el) return true;
  el.classList.remove('invalid');
  if (helpEl){
    helpEl.textContent = okMsg || '';
    helpEl.className = 'hint ok';
    helpEl.style.display = okMsg ? 'block' : 'none';
  }
  if (typeof el.setCustomValidity === 'function') el.setCustomValidity('');
  return true;
}
// ——— Validadores que faltaban (mismos del index) ———
const N_NUMBER_REGEX = /^N[1-9]\d{0,4}([A-HJ-NP-Z]{1,2})?$/i;
function validateNNumber(v){
  const val=(v||"").toUpperCase().trim();
  if(!val) return {ok:false,msg:"Please enter the aircraft tail number (e.g., N123AB)."};
  if(!N_NUMBER_REGEX.test(val)) return {ok:false,msg:"Format: N + 1–5 digits + optional 1–2 letters (no I/O)."};
  return {ok:true,msg:"Tail number captured."};
}
function validateCityLike(v, label="origin city"){
  const val=(v||"").trim();
  if(!val) return {ok:false,msg:`Please enter the ${label} (e.g., Van Nuys or Van Nuys (VNY)).`};
  const ok = /^[A-Za-z .,'-]{2,}( \([A-Z]{3}\))?$/.test(val);
  return ok ? {ok:true,msg:`${label[0].toUpperCase()+label.slice(1)} captured.`} : {ok:false,msg:`Use letters and optional airport code, e.g., Van Nuys (VNY).`};
}
// === 3) Validación dinámica condicional (la llamaremos antes de calcular/pagar)
function validateAirportConditionalFields(){
  const mode = currentPickupMode();

  // Comercial
  const fn   = document.getElementById('flightNumber');
  const fnh  = document.getElementById('flightHint');
  const org  = document.getElementById('flightOrigin');
  const orgh = document.getElementById('originHelp');

  // JSX
  const jfn  = document.getElementById('jsxFlightNumber');
  const jorg = document.getElementById('jsxOrigin');

  // Privado
  const tail = document.getElementById('tailNumber');
  const tHelp= document.getElementById('tailHelp');
  const porg = document.getElementById('pvtOrigin');
  const porh = document.getElementById('pvtOriginHelp');

  // Limpieza rápida de mensajes (evita “fantasmas”)
  [fnh, orgh, tHelp, porh].forEach(h=>{ if(h){ h.style.display=''; h.textContent=''; } });

  // Por defecto, no exigimos nada si no es aeropuerto de Utah
  if (mode === 'NONE') return true;

  // ——— COMMERCIAL (SLC/PVU) ———
  if (mode === 'COMM'){
    let ok = true;

    // flightNumber requerido + formato (ya tienes validateFlightValue; lo usamos)
    if (!fn || !nonEmpty(fn.value)) ok = markInvalid(fn, fnh, 'Flight Number is required.');
    else {
      const r = validateFlightValue(fn.value);
      ok = r.ok ? markValid(fn, fnh, 'Format looks good') : markInvalid(fn, fnh, r.msg || 'Invalid flight');
    }

    // flightOrigin requerido (ciudad con opcional IATA)
    if (!org || !nonEmpty(org.value)) ok = markInvalid(org, orgh, 'Origin city is required.');
    else {
      const ro = validateCityLike(org.value, 'origin city');
      ok = ro.ok ? markValid(org, orgh, 'Origin captured.') : markInvalid(org, orgh, ro.msg);
    }
    return ok;
  }

  // ——— JSX ——— (no llamamos backend, solo formato básico)
  if (mode === 'JSX'){
    let ok = true;
    if (!jfn || !nonEmpty(jfn.value)) ok = markInvalid(jfn, null, 'JSX Flight Number is required.');
    else {
      const norm = normalizeFlight(jfn.value);
      // Acepta “XE1234” o “JSX1234”; tu set AIRLINES ya incluye "XE"
      const pat = /^((XE|JSX))\s?-?\s?\d{1,4}$/i;
      ok = pat.test(norm) ? markValid(jfn, null, '') : markInvalid(jfn, null, 'Use XE1234 or JSX1234.');
    }

    if (!jorg || !nonEmpty(jorg.value)) ok = markInvalid(jorg, null, 'JSX Origin city is required.');
    else ok = markValid(jorg, null, '');

    // Mensaje informativo en backendResult
    const backendRes = document.getElementById('backendResult');
    if (backendRes) backendRes.textContent = 'JSX flight captured (manual verification).';
    return ok;
  }

  // ——— PRIVADO (FBO Utah) ———
  if (mode === 'PVT'){
    let ok = true;

    if (!tail || !nonEmpty(tail.value)) ok = markInvalid(tail, tHelp, 'Tail number is required.');
    else {
      const r = validateNNumber(tail.value);
      ok = r.ok ? markValid(tail, tHelp, r.msg) : markInvalid(tail, tHelp, r.msg);
    }

    if (!porg || !nonEmpty(porg.value)) ok = markInvalid(porg, porh, 'Origin city is required.');
    else {
      const ro = validateCityLike(porg.value, 'origin city');
      ok = ro.ok ? markValid(porg, porh, ro.msg) : markInvalid(porg, porh, ro.msg);
    }
    return ok;
  }

  return true;
}

// === 4) Hook: revalidar cuando cambie la visibilidad (llámalo al final de updateFlightVisibility)
(function patchUpdateFlightVisibility(){
  const _orig = window.updateFlightVisibility;
  if (typeof _orig !== 'function') return;
  window.updateFlightVisibility = function(){
    _orig.apply(this, arguments);
    // Pequeño defer para que el DOM termine de mostrar/ocultar
    setTimeout(()=>{ try{ validateAirportConditionalFields(); }catch(_){} }, 0);
  };
})();

// === 5) Integración con “Calculate” y “Pay” (bloquear si falta algo condicional)
(function hardenCalculateAndPay(){
  // Calculate
  const calc = document.getElementById('calculate');
  if (calc){
    const handler = calc.onclick || null;
    calc.addEventListener('click', (e)=>{
      if (!validateAirportConditionalFields()){
        e.preventDefault();
        alert('Please complete required flight fields.');
        return;
      }
    }, true);
    // Mantén tu lógica original (no removemos handlers previos)
    if (handler) calc.addEventListener('click', handler);
  }

  // Pay
  const pay = document.getElementById('pay');
  if (pay){
    pay.addEventListener('click', (e)=>{
      if (!validateAirportConditionalFields()){
        e.preventDefault();
        alert('Please complete required flight fields.');
        return;
      }
    }, true);
  }
})();
document.addEventListener('DOMContentLoaded', ()=>{
  try { validateAirportConditionalFields(); } catch(_) {}

  const ids = [
    'flightNumber','flightOrigin',
    'jsxFlightNumber','jsxOrigin',
    'tailNumber','pvtOrigin',
    'newDate','newTime'
  ];
  ids.forEach((id)=>{
    const node = document.getElementById(id);
    if (node) node.addEventListener('input', ()=>{
      try { validateAirportConditionalFields(); } catch(_) {}
    });
  });
});
    </script>
    <script>
  /***** CONFIG *****/
  const STRIPE_PK = 'pk_live_51Rr9g0LxdVPME4zrYzx4WKgoT3NUZBSkWbwMnSmGPQCyE4MzzIufo6gM8EvLeTHOjQ5Vcn2V1GY0D9RrcJrOjRCd002MQFljOF';
  const stripe = Stripe(STRIPE_PK);
  const MAX_RESCHEDULES = 2;
  const FLIGHTCHECK_URL = "https://flightcheck-7728622851.us-west3.run.app/flight";

  /***** STATE *****/
  let booking = null;
  let selectedVehicle = 'suv';
  let mgChoice = 'none';
  let map, directionsService, directionsRenderer;
  let pickupPlace = null, dropoffPlace = null;
  let routeMiles = null;
  let calculatedOnce = false;
  let reachedLimit = false;

  /***** UTIL *****/
  function fmtMoney(n){ return Number(n||0).toFixed(2); }
  const el = id => document.getElementById(id);

  /***** PRICING (igual a tu base) *****/
  function calculateBase(mi){
    if (mi <= 10) return 120;
    if (mi <= 35) return 190;
    if (mi <= 39) return 210;
    if (mi <= 48) return 230;
    if (mi <= 55) return 250;
    return mi * 5.4;
  }
  function applyVehicleMultiplier(total){
    return (selectedVehicle === 'van') ? Math.round(total * 1.30) : total;
  }
  function getMGFee(){ return mgChoice !== 'none' ? 50 : 0; }

  const OPERATING_START = "06:00";
  const OPERATING_END   = "23:00";
  function isAfterHours(dateStr, timeStr){
    if(!dateStr || !timeStr) return false;
    const d = new Date(`${dateStr}T${timeStr}:00`);
    const [sh,sm] = OPERATING_START.split(':').map(Number);
    const [eh,em] = OPERATING_END.split(':').map(Number);
    const start = new Date(d); start.setHours(sh, sm, 0, 0);
    const end   = new Date(d); end.setHours(eh, em, 0, 0);
    return (d < start) || (d > end);
  }
  function nextQuarter(d){ const m=d.getMinutes(); const add=15-(m%15||15); d.setMinutes(m+add,0,0); return d; }
  function earliestAllowedDt(){ return nextQuarter(new Date(Date.now() + 24*60*60*1000)); }

  /***** Meet & Greet (SLC) *****/
  const FBO_RX = /\b(fbo|million air|signature|atlantic aviation|ok3 air|ross aviation|tac air|jet center|hangar)\b/i;
  function isAirport(place){ return (place?.types||[]).includes('airport') || /airport/i.test(place?.name||place?.formatted_address||''); }
  function isUtah(place){ const a=(place?.formatted_address||'').toLowerCase(); return /\but\b/.test(a) || /, ut(ah)?\b/.test(a); }
  function isPrivateUtahAirport(place){ if(!place) return false; if(!isAirport(place) || !isUtah(place)) return false; const t=`${place.name||''} ${place.formatted_address||''}`; return FBO_RX.test(t); }
  function isSLCInternational(place){
    if(!place) return false;
    const name=(place.name||'').toLowerCase(), addr=(place.formatted_address||'').toLowerCase();
    const hits=/salt lake city international/.test(name)||/\bslc\b/.test(name)||/salt lake city international/.test(addr)||/\bslc\b/.test(addr);
    return hits && isAirport(place) && !isPrivateUtahAirport(place);
  }
  function updateMeetGreetVisibility(){
    const show = selectedVehicle==='suv' && (isSLCInternational(pickupPlace||null));
    el('mgWrap').style.display = show ? 'block' : 'none';
    if (!show){
      mgChoice='none';
      document.querySelectorAll('#mgWrap .mg-btn').forEach(b=>{b.classList.toggle('active', b.dataset.choice==='none');});
    }
  }

  /***** DATE/TIME INIT *****/
  (function mountDateTime(){
    const dEl = el('newDate'), tEl = el('newTime');
    const minDt = earliestAllowedDt();
    const toISO = dt => { const off = dt.getTimezoneOffset()*60000; return new Date(dt.getTime()-off).toISOString().slice(0,10); };
    if (dEl){ dEl.min = toISO(minDt); if(!dEl.value) dEl.value = toISO(minDt); }
    if (tEl && !tEl.value){ tEl.value = String(minDt.getHours()).padStart(2,'0')+':'+String(minDt.getMinutes()).padStart(2,'0'); }
    const upd = ()=>{
      el('newDateHelp').textContent = dEl.value ? `Selected: ${new Date(dEl.value+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})} (min 24h)` : '';
      el('newTimeHelp').textContent = tEl.value ? `Selected: ${tEl.value}` : '';
    };
    dEl?.addEventListener('change', ()=>{upd(); if(calculatedOnce) recalc();});
    tEl?.addEventListener('change', ()=>{upd(); if(calculatedOnce) recalc();});
    upd();
  })();

  /***** VEH & MG TOGGLES *****/
  (function wireVehicle(){
    const wrap = el('vehToggle');
    wrap.querySelectorAll('.veh-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        if (reachedLimit) return;
        if (b.classList.contains('disabled')) return;
        wrap.querySelectorAll('.veh-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        selectedVehicle = b.dataset.type || 'suv';
        updateMeetGreetVisibility();
        if(calculatedOnce) recalc();
      });
    });
  })();
  (function wireMG(){
    const wrap = el('mgWrap');
    function set(choice){
      mgChoice = choice;
      wrap.querySelectorAll('.mg-btn').forEach(x=>{
        const on = x.dataset.choice===choice;
        x.classList.toggle('active', on);
        x.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
      if(calculatedOnce) recalc();
    }
    wrap.querySelectorAll('.mg-btn').forEach(b=> b.addEventListener('click', ()=>{
      if (reachedLimit) return;
      if (b.classList.contains('disabled')) return;
      set(b.dataset.choice);
    }));
  })();

  /***** LOAD BY CN *****/
  function getQueryCN(){ const u = new URL(window.location.href); return (u.searchParams.get('cn')||'').trim(); }
  function extractRescheduleCount(bk){
    if (typeof bk?.reschedulesCount === 'number') return bk.reschedulesCount;
    if (Array.isArray(bk?.reschedules)) return bk.reschedules.length;
    if (typeof bk?.reschedules_count === 'number') return bk.reschedules_count;
    return 0;
  }
  function lockForLimit(){
    reachedLimit = true;
    document.querySelectorAll('#changeCard input, #btnRoute, #btnSave').forEach(n=>{
      n.setAttribute('disabled','disabled');
      n.classList.add('muted');
      n.setAttribute('aria-disabled','true');
    });
    document.querySelectorAll('#changeCard .veh-btn, #changeCard .mg-btn').forEach(n=>{
      n.classList.add('disabled','muted');
      n.setAttribute('aria-disabled','true');
    });
    el('saveHint').textContent = 'You have reached the maximum number of reschedules for this reservation.';
  }

  // ——— Única versión global de hydratePickupFromInput ———
  async function hydratePickupFromInput(){
    const input = document.getElementById('pickup');
    if (!input || !input.value.trim()) { pickupPlace = null; updateFlightVisibility(); return; }
    const geocoder = new google.maps.Geocoder();
    await new Promise((resolve)=>{
      geocoder.geocode({ address: input.value.trim(), componentRestrictions:{ country: "US" } }, (results, status)=>{
        if (status === "OK" && results && results[0]){
          pickupPlace = {
            name: results[0].name || results[0].formatted_address,
            formatted_address: results[0].formatted_address,
            place_id: results[0].place_id,
            types: results[0].types || [],
            address_components: results[0].address_components
          };
        } else {
          pickupPlace = null;
        }
        updateFlightVisibility();
        resolve();
      });
    });
  }

  async function loadBooking(cn){
    el('loadHint').textContent = 'Loading booking...';
    try{
      const resp = await fetch(`/api/book/get?cn=${encodeURIComponent(cn)}`);
      const data = await resp.json();
      if(!resp.ok || !data?.ok) throw new Error(data?.error || `Error ${resp.status}`);
      booking = data.booking || data;

      el('currentCard').style.display = 'block';
      el('changeCard').style.display = 'block';

      el('bookingSummary').innerHTML = `
        <div><strong>Name:</strong> ${booking.fullname || '-'}</div>
        <div><strong>Phone:</strong> ${booking.phone || '-'}</div>
        <div><strong>Email:</strong> ${booking.email || '-'}</div>
        <div><strong>Pickup:</strong> ${booking.pickup || '-'}</div>
        <div><strong>Drop-off:</strong> ${booking.dropoff || '-'}</div>
        <div><strong>Date/Time:</strong> ${(booking.date_iso||booking.date||'-')} ${(booking.time_hhmm||booking.time||'')}</div>
        <div><strong>CN:</strong> ${booking.cn || cn}</div>
      `;

      selectedVehicle = (booking.vehicleType || 'suv');
      document.querySelectorAll('.veh-btn').forEach(b=> b.classList.toggle('active', b.dataset.type===selectedVehicle));
      el('kpiVehicle').textContent = (selectedVehicle==='van'?'Van':'SUV');
      el('kpiMiles').textContent   = (booking.distanceMiles!=null) ? Number(booking.distanceMiles).toFixed(1) : '—';
      el('kpiOriginal').textContent= fmtMoney(booking.quotedTotal || 0);

      // Prefill
      el('pickup').value  = booking.pickup || '';
      el('dropoff').value = booking.dropoff || '';

      // Hidrata pickup → muestra Flight/JSX/Private según reglas
      try { await hydratePickupFromInput(); } catch(_) {}
updateMeetGreetVisibility();
updateFlightVisibility();   // asegura que se muestren los campos correctos tras el prefill
      // Límite de reschedules
      const used = extractRescheduleCount(booking);
      if (used >= MAX_RESCHEDULES){
        el('reschedWarn').style.display = 'block';
        el('reschedWarn').textContent = `Limit reached: you have already rescheduled ${used} time(s). Further changes are not allowed.`;
        lockForLimit();
      } else {
        el('reschedWarn').style.display = 'block';
        el('reschedWarn').textContent = `You have used ${used}/${MAX_RESCHEDULES} reschedules.`;
      }

      el('loadHint').textContent = 'Booking loaded ✔︎';
      calculatedOnce = false;
      el('btnSave').disabled = true;
      el('saveHint').textContent = 'First, click “Calculate Route” to generate your full quote.';
    }catch(e){
      el('loadHint').textContent = '❌ ' + (e.message || e);
    }
  }

  /***** PRICE ENGINE *****/
  function currentMiles(){
    if (routeMiles != null) return routeMiles;
    return Number(booking?.distanceMiles || 0);
  }
  function recalc(){
    if(!booking) return;
    const miles = currentMiles();
    const base  = calculateBase(miles || 0);
    const dateStr = el('newDate').value;
    const timeStr = el('newTime').value;
    const afterHours = isAfterHours(dateStr, timeStr);
    const ahFee = afterHours ? (base * 0.20) : 0;
    const mgFee = getMGFee();
    const newTotal = applyVehicleMultiplier(base + ahFee + mgFee);
    const original = Number(booking.quotedTotal || 0);
    const diff = Math.round((newTotal - original) * 100) / 100;

    el('kpiNew').textContent  = fmtMoney(newTotal);
    el('kpiDiff').textContent = fmtMoney(diff);
    el('kpiAH').textContent   = afterHours ? 'Yes (+20%)' : 'No';
    el('kpiMiles').textContent= miles ? miles.toFixed(1) : '—';

    const rows = [];
    rows.push(`<div class="row"><span>Base (${miles?miles.toFixed(1):'—'} mi)</span><span>$${fmtMoney(base)}</span></div>`);
    if (ahFee>0) rows.push(`<div class="row"><span>After-Hours (20%)</span><span>$${fmtMoney(ahFee)}</span></div>`);
    if (mgFee>0) rows.push(`<div class="row"><span>Meet & Greet (SLC)</span><span>$${fmtMoney(mgFee)}</span></div>`);
    rows.push(`<div class="divider"></div><div class="row total"><span>Total</span><span>$${fmtMoney(newTotal)}</span></div>`);
    el('breakdown').innerHTML = rows.join('');

    booking.__calc = { newTotal, diff, afterHours, miles, mgFee, selectedVehicle, mgChoice, dateStr, timeStr };

    const canSave = calculatedOnce && !!dateStr && !!timeStr && !reachedLimit;
    el('btnSave').disabled = !canSave;
  }

  /***** SAVE *****/
  el('btnSave').addEventListener('click', async ()=>{
    if(!booking || reachedLimit) return;
    const { diff, newTotal, afterHours, miles, mgFee, dateStr, timeStr } = booking.__calc || {};
    if(!dateStr || !timeStr){ alert('Please choose a Date & Time (min 24h).'); return; }

    const payload = {
      cn: booking.cn,
      newDate: dateStr,
      newTime: timeStr,
      vehicleType: selectedVehicle,
      meetGreet: mgChoice,
      distanceMiles: miles || null,
      newQuotedTotal: newTotal,
      flags: { afterHours, mgFee }
    };

    el('resultCard').style.display = 'block';
    el('result').className = 'hint';
    el('result').textContent = 'Saving changes...';

    try{
      const resp = await fetch('/api/book/reschedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok || !data?.ok) throw new Error(data?.error || `Bad response (${resp.status})`);

      if (diff > 0){
        el('result').textContent = `New total $${fmtMoney(newTotal)}. You need to pay $${fmtMoney(diff)} to confirm. Redirecting to payment...`;
        const pResp = await fetch('/api/create-checkout-session', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            amount: Math.round(diff * 100),
            purpose: 'reschedule-diff',
            cn: booking.cn,
            fullname: booking.fullname,
            email: booking.email,
            phone: booking.phone
          })
        });
        const pData = await pResp.json().catch(()=>({}));
        if(!pResp.ok || !pData?.id) throw new Error(pData?.error || `Bad payment response (${pResp.status})`);
        const { error } = await stripe.redirectToCheckout({ sessionId: pData.id });
        if (error) throw error;
        return;
      }

      if (diff === 0){
        el('result').className = 'hint ok';
        el('result').textContent = `✅ Rescheduled to ${dateStr} ${timeStr}. Price unchanged.`;
      } else {
        el('result').className = 'hint ok';
        el('result').textContent = `✅ Rescheduled to ${dateStr} ${timeStr}. New price is lower. A credit/refund of $${fmtMoney(Math.abs(diff))} will be issued.`;
      }
    }catch(e){
      el('result').className = 'hint err';
      el('result').textContent = '❌ ' + (e.message || e);
    }
  });

  /***** LOAD BTN & URL PARAM *****/
  el('btnLoad').addEventListener('click', ()=>{
    const cn = el('cn').value.trim();
    if(!cn){ el('cn').classList.add('invalid'); return; }
    loadBooking(cn);
    const u = new URL(window.location.href); u.searchParams.set('cn', cn); window.history.replaceState({}, '', u.toString());
  });
  (function(){
    const cn = getQueryCN();
    if (cn){ el('cn').value = cn; loadBooking(cn); }
    else { el('loadHint').textContent = 'Enter your confirmation number (CN) and click Load.'; }
  })();

  /***** MAPS + AUTOCOMPLETE + ROUTE *****/
  function routeAsync(opts){
    return new Promise((res,rej)=>{
      directionsService.route(opts,(r,s)=> s==='OK'&&r?res(r):rej(s||'ROUTE_ERROR'));
    });
  }
  function initMapReschedule(){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:40.7587,lng:-111.8762}, zoom:10 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });

    const opts = {
      componentRestrictions:{country:['us']},
      fields:["place_id","name","types","formatted_address","geometry","address_components"]
    };
    const acPickup  = new google.maps.places.Autocomplete(document.getElementById('pickup'),  opts);
    const acDropoff = new google.maps.places.Autocomplete(document.getElementById('dropoff'), opts);

    acPickup.addListener('place_changed', ()=>{
      pickupPlace = acPickup.getPlace() || null;
      updateMeetGreetVisibility();
      updateFlightVisibility();       // << asegura visibilidad de bloques
    });
    acDropoff.addListener('place_changed', ()=>{
      dropoffPlace = acDropoff.getPlace() || null;
    });

    // Inicial
    updateFlightVisibility();
    wireFlightValidation();
    wireFlightBackendTriggers();
    setTimeout(maybeCheckBackend, 100);

    document.getElementById('btnRoute').addEventListener('click', async ()=>{
      if(reachedLimit) return;

      if(pickupPlace?.place_id && dropoffPlace?.place_id){
        try{
          const trip = await routeAsync({
            origin:{placeId: pickupPlace.place_id},
            destination:{placeId: dropoffPlace.place_id},
            travelMode: google.maps.TravelMode.DRIVING
          });
          directionsRenderer.setDirections(trip);
          const leg = trip.routes[0].legs[0];
          routeMiles = leg.distance.value / 1609.34;
        }catch(err){
          alert('Could not calculate route: ' + err);
          return;
        }
      } else {
        if(!booking){
          alert('Load your booking first.');
          return;
        }
        routeMiles = null; // usa booking.distanceMiles
      }

      updateMeetGreetVisibility();
      calculatedOnce = true;
      recalc();

      const dOk = !!el('newDate').value;
      const tOk = !!el('newTime').value;
      el('btnSave').disabled = !(dOk && tOk) || reachedLimit;
      el('saveHint').textContent = 'Review the quote and click “Save Changes” to confirm.';
    });
  }
  window.initMapReschedule = initMapReschedule;
// --- EXponer helpers del primer bloque al scope global ---
window.updateFlightVisibility   = updateFlightVisibility;
window.wireFlightValidation     = wireFlightValidation;
window.wireFlightBackendTriggers= wireFlightBackendTriggers;
window.maybeCheckBackend        = maybeCheckBackend;
</script>
  <!-- Google Maps Loader (usa tu misma key pública de index.html) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMapReschedule"></script>
</body>
</html>
