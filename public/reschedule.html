<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>
  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,Helvetica,sans-serif}
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo{width:160px;height:160px;border-radius:50%;border:2px solid var(--copper);object-fit:cover;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    main{max-width:820px;width:92vw;margin:0 auto 40px;padding:0 16px}
    h1{margin:0 0 8px;color:#ffddae;font-size:1.35rem}
    .card{border:1px solid rgba(168,116,79,.45);border-radius:14px;background:linear-gradient(180deg,#121212,#0b0b0b);
      box-shadow:0 12px 28px rgba(0,0,0,.45);padding:16px;margin:12px 0}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,select,textarea{
      display:block;width:100%;height:44px;padding:10px 12px;background:#1a1a1a;color:#ffddae;
      border:1px solid #444;border-radius:10px;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    .input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:520px){.input-row{grid-template-columns:1fr}}
    .helper{font-size:.85rem;opacity:.95;margin-top:6px;color:#ffddae;}
    .hint{font-size:.9rem;margin-top:6px}
    .hint.ok{color:var(--ok)} .hint.err{color:var(--err)} .hint.warn{color:var(--warn)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:10px}
    .kpi .label{font-size:.75rem;opacity:.85;margin-bottom:6px}
    .kpi .value{font-size:1.25rem;font-weight:800;color:#f0d1ad}
    .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
    .row.total{font-weight:800;color:#ffddae;font-size:1.05rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:8px 0}
    button{width:100%;padding:14px 16px;margin-top:14px;background:var(--copper);color:#000;font-weight:800;
      font-size:18px;border:0;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .veh-toggle{display:flex;gap:8px}
    .veh-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);color:var(--copper);
      padding:10px;border-radius:10px;cursor:pointer;font-weight:700;text-align:center}
    .veh-btn.active{background:var(--copper);color:#000;border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.25)}
    .mg-options{display:flex;gap:8px;margin-top:6px}
    .mg-btn{flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);color:var(--copper);
      padding:10px;border-radius:8px;cursor:pointer;font-weight:700;text-align:center}
    .mg-btn.active{background:var(--copper);color:#000;border-color:var(--copper)}
    .tax-note{font-size:13px;color:#c9a97c;font-style:italic;text-align:right;opacity:.85}
    .muted{opacity:.8}
    .invalid{border-color:var(--err)!important;box-shadow:0 0 0 3px rgba(255,107,107,.25)!important;}
    #map{height:360px;border-radius:12px;overflow:hidden;margin-top:10px}
    .disabled{pointer-events:none;opacity:.6;}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="/images/bonanza-logo.PNG" alt="Bonanza Transportation Logo"/>
  </header>

  <main>
    <h1>Reschedule</h1>

    <!-- LOAD -->
    <div class="card" id="loadCard">
      <label for="cn">Reservation Code (CN)</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="cn" placeholder="BZ-20250821-ABCD" style="flex:1 1 auto" autocomplete="off"/>
        <button id="btnLoad" style="width:auto;padding:10px 14px;">Load</button>
      </div>
      <div id="loadHint" class="hint muted"></div>
    </div>

    <!-- CURRENT -->
    <div class="card" id="currentCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Current Booking</h3>
      <div id="bookingSummary" class="muted" style="line-height:1.5"></div>
      <div class="divider"></div>
      <div class="kpis">
        <div class="kpi"><div class="label">Vehicle</div><div class="value" id="kpiVehicle">SUV</div></div>
        <div class="kpi"><div class="label">Distance</div><div class="value"><span id="kpiMiles">—</span> mi</div></div>
        <div class="kpi"><div class="label">Original Total</div><div class="value">$<span id="kpiOriginal">—</span></div></div>
      </div>
      <div id="reschedWarn" class="hint warn" style="display:none"></div>
    </div>

    <!-- CHANGES -->
    <div class="card" id="changeCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Change Date, Time & Route</h3>

      <div class="input-row">
        <div>
          <label for="newDate">New Date</label>
          <input type="date" id="newDate"/>
          <div id="newDateHelp" class="helper"></div>
        </div>
        <div>
          <label for="newTime">New Time</label>
          <input type="time" id="newTime" step="900"/>
          <div id="newTimeHelp" class="helper"></div>
        </div>
      </div>

      <label style="margin-top:10px">Pickup</label>
      <input id="pickup" placeholder="e.g. SLC Airport" autocomplete="off"/>
      <label style="margin-top:10px">Drop-off</label>
      <input id="dropoff" placeholder="e.g. Montage Deer Valley" autocomplete="off"/>

      <!-- JSX -->
      <div id="jsxContainer" style="display:none; margin-top:10px;">
        <label for="jsxFlightNumber">JSX Flight Number:</label>
        <input id="jsxFlightNumber" placeholder="e.g. XE1234" />
        <label for="jsxOrigin" style="margin-top:12px;">JSX Origin City:</label>
        <input id="jsxOrigin" placeholder="e.g. Burbank (BUR)" />
      </div>

      <!-- Comercial -->
      <div id="flightContainer" style="display:none;">
        <label for="flightNumber">Flight Number</label>
        <input id="flightNumber" placeholder="e.g. DL1234" />
        <div id="flightHint" class="hint warn" style="display:none"></div>

        <label for="flightOrigin" style="margin-top:12px;">Flight Origin City</label>
        <input id="flightOrigin" placeholder="e.g. Miami (MIA)" />
        <div id="originHelp" class="hint" style="display:none"></div>
      </div>

      <div id="backendResult" class="hint" style="display:block; margin-top:6px;"></div>

      <!-- Privado -->
      <div id="privateFlightContainer" style="display:none;">
        <label for="tailNumber">Jet Tail Number (N-Number)</label>
        <input id="tailNumber" placeholder="e.g., N123AB" />
        <div id="tailHelp" class="hint" style="display:none"></div>

        <label for="pvtOrigin" style="margin-top:12px;">Flight Origin City</label>
        <input id="pvtOrigin" placeholder="e.g., Van Nuys (VNY)" />
        <div id="pvtOriginHelp" class="hint" style="display:none"></div>
      </div>

      <button id="btnRoute" style="margin-top:12px">Calculate Route</button>
      <div id="map"></div>

      <label style="margin-top:14px">Vehicle</label>
      <div class="veh-toggle" id="vehToggle">
        <div class="veh-btn active" data-type="suv">SUV (1–5)</div>
        <div class="veh-btn" data-type="van">Van (up to 12)</div>
      </div>

      <div id="mgWrap" style="display:none; margin-top:10px;">
        <label>Meet & Greet — SLC Only</label>
        <div class="mg-options">
          <div class="mg-btn" data-choice="tsa_exit">TSA Exit (+$50)</div>
          <div class="mg-btn" data-choice="baggage_claim">Baggage Claim (+$50)</div>
          <div class="mg-btn active" data-choice="none">No Meet & Greet</div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:6px 0 8px;color:#ffddae">New Quote</h3>
      <div class="kpis">
        <div class="kpi"><div class="label">New Total</div><div class="value">$<span id="kpiNew">—</span></div></div>
        <div class="kpi"><div class="label">Difference</div><div class="value">$<span id="kpiDiff">—</span></div></div>
        <div class="kpi"><div class="label">After-Hours</div><div class="value" id="kpiAH">No</div></div>
      </div>

      <div id="breakdown" style="margin-top:6px"></div>
      <div class="tax-note">Taxes & gratuity included</div>

      <button id="btnSave" disabled>Save Changes</button>
      <div id="saveHint" class="hint muted">First, click “Calculate Route” to generate your full quote.</div>
    </div>

    <div class="card" id="resultCard" style="display:none">
      <h3 style="margin:0 0 8px;color:#ffddae">Result</h3>
      <div id="result" class="hint"></div>
    </div>
  </main>

  <script src="https://js.stripe.com/v3"></script>

  <script>
  /************ CONFIG ************/
  const STRIPE_PK = 'pk_live_51Rr9g0LxdVPME4zrYzx4WKgoT3NUZBSkWbwMnSmGPQCyE4MzzIufo6gM8EvLeTHOjQ5Vcn2V1GY0D9RrcJrOjRCd002MQFljOF';
  const stripe = Stripe(STRIPE_PK);
  const MAX_RESCHEDULES = 2;
  const FLIGHTCHECK_URL = "https://flightcheck-7728622851.us-west3.run.app/flight";

  /************ STATE ************/
  let booking = null;
  let selectedVehicle = 'suv';
  let mgChoice = 'none';
  let map, directionsService, directionsRenderer;
  let pickupPlace = null, dropoffPlace = null;
  let routeMiles = null;
  let calculatedOnce = false;
  let reachedLimit = false;

  /************ UTILS ************/
  const el = id => document.getElementById(id);
  const fmtMoney = n => Number(n||0).toFixed(2);

  function isAirport(place){ const t=place?.types||[]; return t.includes('airport') || /airport/i.test(place?.name||place?.formatted_address||''); }
  function isUtah(place){ const a=(place?.formatted_address||'').toLowerCase(); return /\but\b/.test(a) || /, ut(ah)?\b/.test(a); }

  const FBO_RX = /\b(fbo|million air|signature( aviation| flight| support)?|atlantic aviation|ok3 air|ross aviation|tac air|jet center|hangar)\b/i;
  function isPrivateUtahAirport(place){ if(!place) return false; if(!isAirport(place)||!isUtah(place)) return false; const t=`${place.name||''} ${place.formatted_address||''}`; return FBO_RX.test(t); }
  function isSLCInternational(place){
    if(!place) return false;
    const name=(place.name||'').toLowerCase(), addr=(place.formatted_address||'').toLowerCase();
    const hits=/salt lake city international/.test(name)||/\bslc\b/.test(name)||/salt lake city international/.test(addr)||/\bslc\b/.test(addr);
    return hits && isAirport(place) && !isPrivateUtahAirport(place);
  }

  function updateMeetGreetVisibility(){
    const show = selectedVehicle==='suv' && isSLCInternational(pickupPlace||null);
    el('mgWrap').style.display = show ? 'block' : 'none';
    if (!show){
      mgChoice='none';
      document.querySelectorAll('#mgWrap .mg-btn').forEach(b=>b.classList.toggle('active', b.dataset.choice==='none'));
    }
  }

  // === Mostrar/ocultar bloques de vuelo (GLOBAL) ===
  window.updateFlightVisibility = function(){
    const commWrap = el('flightContainer');
    const pvtWrap  = el('privateFlightContainer');
    const jsxWrap  = el('jsxContainer');

    const place = pickupPlace || null;
    const isAirportUT = !!place && isAirport(place) && isUtah(place);

    const isJSX = !!place && (place.name||place.formatted_address||'').toUpperCase().includes('JSX');
    const isProvo = !!place && /provo|pvu/i.test(place.name||'') && isUtah(place) && !isPrivateUtahAirport(place);
    const isSLC  = isSLCInternational(place);
    const isComm = isAirportUT && (isSLC || isProvo) && !isJSX;

    if (jsxWrap) jsxWrap.style.display = isJSX ? 'block' : 'none';

    if (commWrap){
      commWrap.style.display = isComm && !isJSX ? 'block' : 'none';
      if (!(isComm && !isJSX)){
        const n = el('flightNumber'), o = el('flightOrigin');
        if(n){ n.value=''; n.setCustomValidity(''); }
        if(o){ o.value=''; o.setCustomValidity(''); }
        el('flightHint')?.style?.setProperty('display','none');
        el('originHelp')?.style?.setProperty('display','none');
      } else {
        initFlightOriginAutocomplete();
      }
    }
    if (pvtWrap){
      const showPvt = isAirportUT && !isComm && !isJSX;
      pvtWrap.style.display = showPvt ? 'block' : 'none';
      if (!showPvt){
        const t = el('tailNumber'), p = el('pvtOrigin');
        if(t){ t.value=''; t.setCustomValidity(''); }
        if(p){ p.value=''; p.setCustomValidity(''); }
        el('tailHelp')?.style?.setProperty('display','none');
        el('pvtOriginHelp')?.style?.setProperty('display','none');
      }
    }
  };

  // Autocomplete para ciudad de origen (comercial)
  function initFlightOriginAutocomplete(){
    const input = el("flightOrigin");
    if (!input || !window.google?.maps?.places?.Autocomplete) return;
    const ac = new google.maps.places.Autocomplete(input, {
      types:["(cities)"], fields:["name","place_id","geometry"]
    });
    ac.addListener("place_changed", ()=>{ window._flightOrigin = ac.getPlace(); });
  }

  // ——— Geocode helpers (pickup y dropoff) ———
  async function geocodeToPlace(text){
    if (!text?.trim()) return null;
    if (!window.google?.maps?.Geocoder) {
      // fallback mínimo
      return { name:text, formatted_address:text, place_id:null, types: (/airport/i.test(text)?['airport']:[]) };
    }
    const geocoder = new google.maps.Geocoder();
    return new Promise(res=>{
      geocoder.geocode({ address:text.trim(), componentRestrictions:{country:'US'} }, (results,status)=>{
        if (status==='OK' && results && results[0]){
          res({
            name: results[0].name || results[0].formatted_address,
            formatted_address: results[0].formatted_address,
            place_id: results[0].place_id,
            types: results[0].types || [],
            address_components: results[0].address_components
          });
        } else {
          res({ name:text.trim(), formatted_address:text.trim(), place_id:null, types:[] });
        }
      });
    });
  }

  async function hydratePickupFromInput(){
    pickupPlace = await geocodeToPlace(el('pickup')?.value);
    try { updateFlightVisibility(); } catch(_){}
  }
  async function hydrateDropoffFromInput(){
    dropoffPlace = await geocodeToPlace(el('dropoff')?.value);
  }

  // ——— Booking loader ———
  function extractRescheduleCount(bk){
    if (typeof bk?.reschedulesCount === 'number') return bk.reschedulesCount;
    if (Array.isArray(bk?.reschedules)) return bk.reschedules.length;
    if (typeof bk?.reschedules_count === 'number') return bk.reschedules_count;
    return 0;
  }
  function lockForLimit(){
    reachedLimit = true;
    document.querySelectorAll('#changeCard input, #btnRoute, #btnSave').forEach(n=>{
      n.setAttribute('disabled','disabled'); n.classList.add('muted'); n.setAttribute('aria-disabled','true');
    });
    document.querySelectorAll('#changeCard .veh-btn, #changeCard .mg-btn').forEach(n=>{
      n.classList.add('disabled','muted'); n.setAttribute('aria-disabled','true');
    });
    el('saveHint').textContent = 'You have reached the maximum number of reschedules for this reservation.';
  }

  async function loadBooking(cn){
    el('loadHint').textContent = 'Loading booking...';
    try{
      const resp = await fetch(`/api/book/get?cn=${encodeURIComponent(cn)}`);
      const data = await resp.json();
      if(!resp.ok || !data?.ok) throw new Error(data?.error || `Error ${resp.status}`);
      booking = data.booking || data;

      el('currentCard').style.display = 'block';
      el('changeCard').style.display = 'block';

      el('bookingSummary').innerHTML = `
        <div><strong>Name:</strong> ${booking.fullname || '-'}</div>
        <div><strong>Phone:</strong> ${booking.phone || '-'}</div>
        <div><strong>Email:</strong> ${booking.email || '-'}</div>
        <div><strong>Pickup:</strong> ${booking.pickup || '-'}</div>
        <div><strong>Drop-off:</strong> ${booking.dropoff || '-'}</div>
        <div><strong>Date/Time:</strong> ${(booking.date_iso||booking.date||'-')} ${(booking.time_hhmm||booking.time||'')}</div>
        <div><strong>CN:</strong> ${booking.cn || cn}</div>
      `;

      selectedVehicle = (booking.vehicleType || 'suv');
      document.querySelectorAll('.veh-btn').forEach(b=> b.classList.toggle('active', b.dataset.type===selectedVehicle));
      el('kpiVehicle').textContent = (selectedVehicle==='van'?'Van':'SUV');
      el('kpiMiles').textContent   = (booking.distanceMiles!=null) ? Number(booking.distanceMiles).toFixed(1) : '—';
      el('kpiOriginal').textContent= fmtMoney(booking.quotedTotal || 0);

      // Prefill inputs
      el('pickup').value  = booking.pickup || '';
      el('dropoff').value = booking.dropoff || '';

      // Hidratar ambos
      await hydratePickupFromInput();
      await hydrateDropoffFromInput();
      updateMeetGreetVisibility();
      updateFlightVisibility();

      // Límite
      const used = extractRescheduleCount(booking);
      el('reschedWarn').style.display = 'block';
      if (used >= MAX_RESCHEDULES){
        el('reschedWarn').textContent = `Limit reached: you have already rescheduled ${used} time(s). Further changes are not allowed.`;
        lockForLimit();
      } else {
        el('reschedWarn').textContent = `You have used ${used}/${MAX_RESCHEDULES} reschedules.`;
      }

      el('loadHint').textContent = 'Booking loaded ✔︎';
      calculatedOnce = false;
      el('btnSave').disabled = true;
      el('saveHint').textContent = 'First, click “Calculate Route” to generate your full quote.';
    }catch(e){
      el('loadHint').textContent = '❌ ' + (e.message || e);
    }
  }

  // ——— Precio ———
  function calculateBase(mi){
    if (mi <= 10) return 120;
    if (mi <= 35) return 190;
    if (mi <= 39) return 210;
    if (mi <= 48) return 230;
    if (mi <= 55) return 250;
    return mi * 5.4;
  }
  function applyVehicleMultiplier(total){ return (selectedVehicle==='van') ? Math.round(total*1.30) : total; }
  function getMGFee(){ return mgChoice!=='none' ? 50 : 0; }
  const OPERATING_START="06:00", OPERATING_END="23:00";
  function isAfterHours(dateStr, timeStr){
    if(!dateStr || !timeStr) return false;
    const d = new Date(`${dateStr}T${timeStr}:00`);
    const [sh,sm]=OPERATING_START.split(':').map(Number), [eh,em]=OPERATING_END.split(':').map(Number);
    const start=new Date(d); start.setHours(sh,sm,0,0);
    const end  =new Date(d); end.setHours(eh,em,0,0);
    return (d<start)||(d>end);
  }

  function recalc(){
    if(!booking) return;
    const miles = routeMiles != null ? routeMiles : Number(booking?.distanceMiles||0);
    const base  = calculateBase(miles||0);
    const dateStr = el('newDate').value;
    const timeStr = el('newTime').value;
    const afterHours = isAfterHours(dateStr,timeStr);
    const ahFee = afterHours ? (base*0.20) : 0;
    const mgFee = getMGFee();
    const newTotal = applyVehicleMultiplier(base + ahFee + mgFee);
    const original = Number(booking.quotedTotal || 0);
    const diff = Math.round((newTotal - original)*100)/100;

    el('kpiNew').textContent  = fmtMoney(newTotal);
    el('kpiDiff').textContent = fmtMoney(diff);
    el('kpiAH').textContent   = afterHours ? 'Yes (+20%)' : 'No';
    el('kpiMiles').textContent= miles ? miles.toFixed(1) : '—';

    const rows = [];
    rows.push(`<div class="row"><span>Base (${miles?miles.toFixed(1):'—'} mi)</span><span>$${fmtMoney(base)}</span></div>`);
    if (ahFee>0) rows.push(`<div class="row"><span>After-Hours (20%)</span><span>$${fmtMoney(ahFee)}</span></div>`);
    if (mgFee>0) rows.push(`<div class="row"><span>Meet & Greet (SLC)</span><span>$${fmtMoney(mgFee)}</span></div>`);
    rows.push(`<div class="divider"></div><div class="row total"><span>Total</span><span>$${fmtMoney(newTotal)}</span></div>`);
    el('breakdown').innerHTML = rows.join('');

    booking.__calc = { newTotal, diff, afterHours, miles, mgFee, selectedVehicle, mgChoice, dateStr, timeStr };
    const canSave = calculatedOnce && !!dateStr && !!timeStr && !reachedLimit;
    el('btnSave').disabled = !canSave;
  }

  // ——— Eventos DOM ———
  document.addEventListener('DOMContentLoaded', ()=>{
    // LOAD
    el('btnLoad').addEventListener('click', ()=>{
      const cn = el('cn').value.trim();
      if(!cn){ el('cn').classList.add('invalid'); return; }
      loadBooking(cn);
      const u = new URL(window.location.href); u.searchParams.set('cn', cn); window.history.replaceState({}, '', u.toString());
    });
    const qcn = new URL(window.location.href).searchParams.get('cn');
    if (qcn){ el('cn').value=qcn; loadBooking(qcn); }

    // Vehicle & M&G
    document.querySelectorAll('#vehToggle .veh-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        if (reachedLimit) return;
        document.querySelectorAll('#vehToggle .veh-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        selectedVehicle = b.dataset.type || 'suv';
        updateMeetGreetVisibility();
        if (calculatedOnce) recalc();
      });
    });
    document.querySelectorAll('#mgWrap .mg-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        if (reachedLimit) return;
        mgChoice = b.dataset.choice;
        document.querySelectorAll('#mgWrap .mg-btn').forEach(x=>x.classList.toggle('active', x===b));
        if (calculatedOnce) recalc();
      });
    });
  });

  // ——— Google Maps ———
  function routeAsync(opts){
    return new Promise((res,rej)=>{
      directionsService.route(opts,(r,s)=> s==='OK'&&r?res(r):rej(s||'ROUTE_ERROR'));
    });
  }
  function locationFromPlace(p){
    if (!p) return null;
    if (p.place_id) return { placeId: p.place_id };
    return p.formatted_address || p.name || null;
  }
  function initMapReschedule(){
    map = new google.maps.Map(el('map'), { center:{lat:40.7587,lng:-111.8762}, zoom:10 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });

    const opts = {
      componentRestrictions:{country:['us']},
      fields:["place_id","name","types","formatted_address","geometry","address_components"]
    };
    const acPickup  = new google.maps.places.Autocomplete(el('pickup'),  opts);
    const acDropoff = new google.maps.places.Autocomplete(el('dropoff'), opts);

    acPickup.addListener('place_changed', ()=>{
      pickupPlace = acPickup.getPlace() || null;
      updateMeetGreetVisibility();
      updateFlightVisibility();
    });
    acDropoff.addListener('place_changed', ()=>{
      dropoffPlace = acDropoff.getPlace() || null;
    });

    // Mostrar bloques correctos al inicio
    updateFlightVisibility();

    // Botón calcular
    el('btnRoute').addEventListener('click', async ()=>{
      if(reachedLimit) return;

      // Asegura place objects si el usuario solo escribió texto
      if(!pickupPlace)  await hydratePickupFromInput();
      if(!dropoffPlace) await hydrateDropoffFromInput();

      const origin = locationFromPlace(pickupPlace);
      const destination = locationFromPlace(dropoffPlace);

      if(!origin || !destination){
        alert('Please set Pickup and Drop-off.');
        return;
      }

      try{
        const trip = await routeAsync({
          origin, destination,
          travelMode: google.maps.TravelMode.DRIVING
        });
        directionsRenderer.setDirections(trip);
        const leg = trip.routes[0].legs[0];
        routeMiles = leg.distance.value / 1609.34;
      }catch(err){
        alert('Could not calculate route: ' + err);
        return;
      }

      updateMeetGreetVisibility();
      calculatedOnce = true;
      recalc();

      const dOk = !!el('newDate').value;
      const tOk = !!el('newTime').value;
      el('btnSave').disabled = !(dOk && tOk) || reachedLimit;
      el('saveHint').textContent = 'Review the quote and click “Save Changes” to confirm.';
    });
  }
  window.initMapReschedule = initMapReschedule;
  </script>

  <!-- Google Maps -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMapReschedule"></script>
</body>
</html>
