<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bonanza — Headquarters (Stable)</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --line:#2d3650;
    --text:#e9eef7; --muted:#9fb0c8; --ok:#28d07f; --bad:#ff6464; --accent:#f7b06a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid #0002;background:#0b0f1d}
  header h1{font-size:18px;margin:0;font-weight:800}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #ffffff1a;font-size:12px;color:#cfe}
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:#27314a;color:var(--text);border:1px solid #ffffff1f;border-radius:8px;padding:8px 12px;cursor:pointer}
  button:hover{filter:brightness(1.06)}
  .danger{background:#3a2230}
  .primary{background:#3a4364}
  .spacer{flex:1}
  .msg{margin:10px 0 12px;font-size:14px}
  .msg.ok{color:var(--muted)} .msg.err{color:var(--bad)}
  table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px;text-align:left}
  th{background:#10162a;color:#cdd6ea;position:sticky;top:58px;z-index:1}
  tbody tr:hover{background:#1a2035}
  .right{text-align:right}
  .badge{padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid #ffffff22}
  .on{background:#163723;color:#87f1bb;border-color:#2aa66d}
  .off{background:#3a2424;color:#ffb0b0;border-color:#b44}
  /* Drawer (form) */
  .drawer{position:fixed;top:0;right:-420px;width:min(420px,96vw);height:100%;
          background:#151c31;border-left:1px solid #2a3550;box-shadow:-10px 0 40px #0008;
          transition:right .25s ease;z-index:50;display:flex;flex-direction:column}
  .drawer.open{right:0}
  .drawer header{background:#1a2340;border-bottom:1px solid #2a3550}
  .drawer .body{padding:16px;overflow:auto;flex:1}
  .field{margin-bottom:12px}
  .field label{display:block;font-size:12px;color:#cbd3e7;margin-bottom:6px}
  input,select{width:100%;height:40px;border-radius:8px;border:1px solid #30405a;background:#0f152a;color:#e9eef7;padding:0 10px}
  .drawer .actions{padding:12px 16px;border-top:1px solid #2a3550;display:flex;gap:8px;justify-content:flex-end}
  .err{color:var(--bad);font-size:12px;min-height:16px}
</style>
</head>
<body>
<header>
  <h1>Bonanza — Headquarters</h1>
  <span id="env" class="pill"></span>
  <div class="spacer"></div>
  <button id="logout" class="danger">Logout</button>
</header>

<div class="wrap">
  <div class="toolbar" id="toolbar">
    <button data-filter="ALL">All</button>
    <button data-filter="SUV">SUV</button>
    <button data-filter="VAN">VAN</button>
    <button id="reload">Reload</button>
    <button id="add" class="primary">Add Vehicle</button>
    <div class="spacer"></div>
    <small class="pill">API: /api/admin/vehicles</small>
    <small id="count" style="margin-left:8px;color:var(--muted)"></small>
  </div>

  <div id="msg" class="msg"></div>

  <table>
    <thead>
      <tr>
        <th style="width:120px">Plate</th>
        <th>Driver</th>
        <th style="width:90px">Type</th>
        <th style="width:80px">Year</th>
        <th>Model</th>
        <th style="width:110px">Active</th>
        <th class="right" style="width:220px">Actions</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="7">Loading…</td></tr>
    </tbody>
  </table>
</div>

<!-- Drawer -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <header>
    <h2 id="drawTitle" style="font-size:16px;font-weight:800;margin:0">Add Vehicle</h2>
    <div class="spacer"></div>
    <button id="close">Close</button>
  </header>
  <div class="body">
    <div class="field"><label for="fPlate">Plate</label><input id="fPlate" placeholder="UT-123 ABC"></div>
    <div class="field"><label for="fDriver">Driver Name</label><input id="fDriver" placeholder="John Doe"></div>
    <div class="field"><label for="fKind">Type</label>
      <select id="fKind"><option value="SUV">SUV</option><option value="VAN">VAN</option></select>
    </div>
    <div class="field"><label for="fYear">Year</label><input id="fYear" type="number" min="2000" max="2099" placeholder="2025"></div>
    <div class="field"><label for="fModel">Model / Subtype</label><input id="fModel" placeholder="Suburban LT / Sprinter 2500"></div>
    <div class="field"><label><input type="checkbox" id="fActive"> Active</label></div>
    <div id="formErr" class="err"></div>
  </div>
  <div class="actions">
    <button id="save" class="primary">Save</button>
  </div>
</aside>

<script>
/* ===== Config ===== */
const ADMIN_KEY = 'supersecreto123';
const API_URL   = '/api/admin/vehicles';
document.getElementById('env').textContent = location.hostname.includes('vercel.app') ? 'vercel' : 'local';

/* ===== State ===== */
let all = [];
let filter = 'ALL';
let editingId = null;

/* ===== Shortcuts ===== */
const $ = (s)=>document.querySelector(s);
const rows   = $('#rows');
const msg    = $('#msg');
const count  = $('#count');
const drawer = $('#drawer');
const drawTitle = $('#drawTitle');
const fPlate = $('#fPlate');
const fDriver= $('#fDriver');
const fKind  = $('#fKind');
const fYear  = $('#fYear');
const fModel = $('#fModel');
const fActive= $('#fActive');
const formErr= $('#formErr');

/* ===== Helpers ===== */
const esc = s => (s??'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
const show = (t, ok=true)=>{ msg.className='msg ' + (ok?'ok':'err'); msg.textContent=t; };
const normKind = k => (String(k||'').trim().toUpperCase()==='VAN') ? 'VAN' : 'SUV';
const normalize = v => ({
  id: v.id!=null ? String(v.id) : '',
  plate: String(v.plate||'').trim(),
  driver_name: String(v.driver_name||'').trim(),
  kind: normKind(v.kind),
  year: (v.year==null || isNaN(v.year)) ? null : Number(v.year),
  model: String(v.model||'').trim(),
  active: !!v.active
});

/* ===== Fetch with timeout (robusto) ===== */
async function api(method, body, qs='', timeoutMs=12000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  const url = API_URL + (qs?`?${qs}`:'');
  const opt = { method, headers:{ 'x-admin-key': ADMIN_KEY }, signal: controller.signal };
  if (body){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
  const r = await fetch(url, opt).catch(e=>{ throw new Error(e.name==='AbortError'?'Timeout':'Network error'); });
  clearTimeout(t);
  let data={}; try{ data=await r.json(); }catch{}
  if (r.status===401) throw new Error('Unauthorized');
  if (!r.ok || data.ok===false) throw new Error(data.error || ('HTTP '+r.status));
  return data;
}

/* ===== Render ===== */
function visible(){ return filter==='ALL' ? all : all.filter(v => v.kind===filter); }
function render(){
  const list = visible();
  count.textContent = `Loaded ${list.length} vehicle${list.length===1?'':'s'}`;
  rows.innerHTML = list.length ? list.map(v=>{
    const on = !!v.active;
    return `<tr data-id="${esc(v.id)}">
      <td>${esc(v.plate)}</td>
      <td>${esc(v.driver_name)}</td>
      <td>${esc(v.kind)}</td>
      <td>${esc(v.year??'')}</td>
      <td>${esc(v.model??'')}</td>
      <td><span class="badge ${on?'on':'off'}">${on?'ACTIVE':'OFF'}</span></td>
      <td class="right">
        <button data-act="edit">Edit</button>
        <button data-act="del" class="danger">Delete</button>
        <button data-act="${on?'off':'on'}">${on?'Turn Off':'Turn On'}</button>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="7">No vehicles.</td></tr>`;
}

/* ===== Drawer ===== */
function openAdd(){
  editingId=null; drawTitle.textContent='Add Vehicle';
  fPlate.value=''; fDriver.value=''; fKind.value='SUV'; fYear.value=new Date().getFullYear();
  fModel.value=''; fActive.checked=false; formErr.textContent='';
  drawer.classList.add('open');
}
function openEdit(id){
  const v = all.find(x=>x.id===id); if(!v) return;
  editingId = id; drawTitle.textContent='Edit Vehicle';
  fPlate.value=v.plate||''; fDriver.value=v.driver_name||'';
  fKind.value=v.kind||'SUV'; fYear.value=v.year||new Date().getFullYear();
  fModel.value=v.model||''; fActive.checked=!!v.active; formErr.textContent='';
  drawer.classList.add('open');
}
function closeDrawer(){ drawer.classList.remove('open'); }

/* ===== CRUD ===== */
async function load(){
  rows.innerHTML = `<tr><td colspan="7">Loading…</td></tr>`;
  count.textContent='';
  try{
    const data = await api('GET');
    all = (data.vehicles||[]).map(normalize);
    render();
    show('Loaded successfully.');
  }catch(e){
    all = [];
    render();
    show('Load error: '+(e.message||e), false);
  }
}

async function save(){
  formErr.textContent='';
  const plate = fPlate.value.trim();
  const driver = fDriver.value.trim();
  const year   = parseInt(fYear.value,10);
  const model  = fModel.value.trim();
  const kind   = normKind(fKind.value);
  const active = !!fActive.checked;

  if (!plate || !driver || !year || !model){
    formErr.textContent = 'Plate, Driver, Year and Model are required.';
    return;
  }
  const body = { id: editingId || undefined, plate, driver_name: driver, kind, year, model, active };
  try{
    const data = await api('POST', body);
    const v = normalize(data.vehicle || body);
    const i = all.findIndex(x=>x.id===v.id);
    if (i>=0) all[i] = { ...all[i], ...v }; else all.push(v);
    render(); closeDrawer();
    show(editingId ? 'Saved changes.' : 'Vehicle added.');
  }catch(e){
    formErr.textContent = e.message || 'Save error';
  }
}

async function toggle(id, on){
  try{
    await api('POST', { id, active:on });
    const v = all.find(x=>x.id===id); if (v) v.active=!!on;
    render(); show('Updated.');
  }catch(e){ show('Update error: '+(e.message||e), false); }
}

async function removeOne(id){
  const v = all.find(x=>x.id===id);
  if (!v) return;
  if (!confirm(`Delete vehicle "${v.plate}"?`)) return;
  try{
    await api('DELETE', null, 'id='+encodeURIComponent(id));
    all = all.filter(x=>x.id!==id);
    render(); show('Deleted.');
  }catch(e){ show('Delete error: '+(e.message||e), false); }
}

/* ===== Wire events (sin inline onclick) ===== */
document.getElementById('reload').addEventListener('click', load);
document.getElementById('add').addEventListener('click', openAdd);
document.getElementById('close').addEventListener('click', closeDrawer);
document.getElementById('save').addEventListener('click', save);
document.getElementById('logout').addEventListener('click', ()=>{
  localStorage.removeItem('ADMIN_KEY');
  localStorage.removeItem('bonanza_admin_ok');
  location.href='/login.html';
});
document.getElementById('toolbar').addEventListener('click', e=>{
  const f = e.target?.dataset?.filter; if (!f) return;
  filter = f; render();
});
rows.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const tr  = e.target.closest('tr[data-id]'); if(!tr) return;
  const id  = tr.getAttribute('data-id');
  const act = btn.dataset.act;
  if (act==='edit') openEdit(id);
  else if (act==='del') removeOne(id);
  else if (act==='on')  toggle(id, true);
  else if (act==='off') toggle(id, false);
});

/* ===== Start ===== */
load();
</script>
</body>
</html>
