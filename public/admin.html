<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bonanza Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --line:#344158;
      --text:#e9eef7; --muted:#a7b0c3; --ok:#28d07f; --bad:#ff5d5d; --accent:#f7b06a;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
    header{ display:flex; gap:10px; align-items:center; padding:14px 18px; background:rgba(0,0,0,.25); position:sticky; top:0; border-bottom:1px solid #0002 }
    header h1{ font-size:18px; margin:0; font-weight:700; letter-spacing:.3px }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff10; color:var(--muted); border:1px solid #ffffff14 }
    .wrap{ max-width:1100px; margin:18px auto; padding:0 16px }

    .controls{ display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap }
    button{ background:#2a3550; color:var(--text); border:1px solid #ffffff1f; border-radius:8px; padding:8px 12px; cursor:pointer }
    button:hover{ filter:brightness(1.08) }
    .danger{ background:#3a2030; border-color:#ffffff22 }
    .accent{ background:#3a2d1c; border-color:#f7b06a55 }
    .banner{ padding:10px 12px; border:1px dashed #f7b06a55; background:#f7b06a14; color:#f7d3a1; border-radius:8px; margin:8px 0 12px; display:none }

    table{ width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; font-size:14px; vertical-align:middle }
    th{ background:#11162a; color:#cdd6ea; position:sticky; top:50px; z-index:1 }
    tbody tr:hover{ background:#1b2136 }
    .badge{ padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .on{ background:#173523; color:var(--ok); border:1px solid #25a866 }
    .off{ background:#3a2323; color:var(--bad); border:1px solid #b84a4a }
    .right{ text-align:right }
    .muted{ color:var(--muted) }
    .count{ margin-left:8px; color:var(--muted); font-size:13px }
    .spacer{ flex:1 }

    /* Loader */
    .loader{ display:flex; align-items:center; gap:10px; color:var(--muted); }
    .dot{ width:8px;height:8px;border-radius:50%; background:#6f86b7; opacity:.6; animation:b 1.2s infinite }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes b{ 0%,100%{transform:translateY(0);opacity:.5} 50%{transform:translateY(-4px);opacity:1} }

    /* Modal */
    .backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999 }
    .backdrop.open{ display:flex }
    .modal{ width:min(560px,94vw); background:var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.6); overflow:hidden }
    .modal header{ position:unset; border:0; background:#11162a; padding:12px 14px; display:flex; align-items:center; justify-content:space-between }
    .modal .body{ padding:14px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .grid > div{ display:flex; flex-direction:column; gap:6px }
    label{ font-weight:700; font-size:13px }
    input,select{ height:40px; border-radius:8px; border:1px solid var(--line); background:#0f1524; color:var(--text); padding:0 10px; outline:none }
    .row{ display:flex; align-items:center; gap:10px; margin-top:10px }
    .row .spacer{ flex:1 }
    .small{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>

<header>
  <h1>Bonanza Admin — Cuartel General</h1>
  <span class="pill" id="envInfo"></span>
  <div class="spacer"></div>
  <button class="danger" id="btnLogout">Logout</button>
</header>

<div class="wrap">
  <div class="controls">
    <button id="btnAll">All</button>
    <button id="btnSUV">SUV</button>
    <button id="btnVAN">VAN</button>
    <button id="btnReload">Reload</button>
    <button id="btnAdd" class="accent">Add Vehicle</button>
    <span class="count" id="count"></span>
    <span class="spacer"></span>
    <span class="muted">API route: <code>/api/admin/vehicles</code></span>
  </div>

  <div id="demoBanner" class="banner">Demo data loaded (API unreachable). This is only for visualization.</div>

  <div id="msg" class="muted" style="margin:8px 0 12px;"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:120px">Plate</th>
        <th>Driver</th>
        <th style="width:120px">Type</th>
        <th style="width:90px">Year</th>
        <th style="width:140px">Model</th>
        <th style="width:110px">Active</th>
        <th class="right" style="width:220px">Actions</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="7">
        <div class="loader">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span>Loading vehicles…</span>
        </div>
      </td></tr>
    </tbody>
  </table>
</div>

<!-- Modal Add/Edit -->
<div class="backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <header>
      <h3 id="mTitle" style="margin:0">Vehicle</h3>
      <button id="mClose">✕</button>
    </header>
    <div class="body">
      <div class="grid">
        <div>
          <label for="fPlate">Plate</label>
          <input id="fPlate" placeholder="UT-123 ABC" />
        </div>
        <div>
          <label for="fDriver">Driver Name</label>
          <input id="fDriver" placeholder="John Doe" />
        </div>
        <div>
          <label for="fKind">Kind</label>
          <select id="fKind">
            <option value="SUV">SUV</option>
            <option value="VAN">VAN</option>
          </select>
        </div>
        <div>
          <label for="fYear">Year</label>
          <input id="fYear" type="number" min="2000" max="2100" placeholder="2024" />
        </div>
        <div style="grid-column:1 / -1">
          <label for="fModel">Model / Subtype (e.g., Suburban LT)</label>
          <input id="fModel" placeholder="Suburban LT / Sprinter 2500" />
        </div>
      </div>

      <div class="row">
        <label><input id="fActive" type="checkbox" checked /> Active</label>
        <span class="spacer"></span>
        <span class="small" id="mHint"></span>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="mSave" class="accent">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== Login compatibility =====
  (function ensureAdminKey(){
    const ok = localStorage.getItem('bonanza_admin_ok') === '1';
    const k  = localStorage.getItem('ADMIN_KEY');
    if (!k && ok) localStorage.setItem('ADMIN_KEY', 'DEMO'); // compat
  })();

  const ADMIN_KEY = localStorage.getItem('ADMIN_KEY');
  if (!ADMIN_KEY) location.href = "/login.html";

  // UI
  const rowsEl  = document.getElementById('rows');
  const countEl = document.getElementById('count');
  const msgEl   = document.getElementById('msg');
  const envInfo = document.getElementById('envInfo');
  const demoBanner = document.getElementById('demoBanner');

  envInfo.textContent = location.hostname.includes('vercel.app') ? 'vercel' : 'local';

  // Modal refs
  const modal   = document.getElementById('modal');
  const mTitle  = document.getElementById('mTitle');
  const mClose  = document.getElementById('mClose');
  const mSave   = document.getElementById('mSave');
  const mHint   = document.getElementById('mHint');

  const fPlate  = document.getElementById('fPlate');
  const fDriver = document.getElementById('fDriver');
  const fKind   = document.getElementById('fKind');
  const fYear   = document.getElementById('fYear');
  const fModel  = document.getElementById('fModel');
  const fActive = document.getElementById('fActive');

  // State
  let allVehicles = [];
  let filterKind = 'ALL';
  let editingId = null;     // null = create

  // Demo fallback
  let USE_DEMO = false;
  const DEMO_LIST = [
    {id:'SUV-01', plate:'UT-7A2 3BC', driver_name:'Luis Guerrero', kind:'SUV', year:2023, model:'Suburban LT', active:true},
    {id:'SUV-02', plate:'UT-9C1 7DZ', driver_name:'Maria Gomez',   kind:'SUV', year:2022, model:'Yukon XL',    active:false},
    {id:'VAN-01', plate:'UT-2K4 1LM', driver_name:'John Smith',    kind:'VAN', year:2021, model:'Sprinter 2500',active:true},
  ];

  function setMsg(t){ msgEl.textContent = t || ''; }

  async function loadVehicles() {
    rowsEl.innerHTML = `
      <tr><td colspan="7">
        <div class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span>Loading vehicles…</span></div>
      </td></tr>`;
    countEl.textContent = '';
    setMsg('');

    try {
      const r = await fetch('/api/admin/vehicles', { headers: { 'x-admin-key': ADMIN_KEY } });
      if (r.status === 401) {
        localStorage.removeItem('ADMIN_KEY');
        return location.href = '/login.html';
      }
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      if (!data.ok || !Array.isArray(data.vehicles)) throw new Error(data.error || 'Malformed response');

      allVehicles = data.vehicles.map(v => normalizeServerVehicle(v));
      demoBanner.style.display = 'none'; USE_DEMO = false;
      render();
      setMsg('Loaded successfully.');
    } catch (e) {
      // Fallback demo
      allVehicles = DEMO_LIST.slice();
      demoBanner.style.display = 'block'; USE_DEMO = true;
      render();
      setMsg('API not reachable. Showing demo data.');
      console.warn('Vehicles load failed:', e);
    }
  }

  function normalizeServerVehicle(v){
    return {
      id: String(v.id || v.plate || cryptoId()),
      plate: v.plate || '',
      driver_name: v.driver_name || '',
      kind: (v.kind || 'SUV').toUpperCase(),
      year: Number(v.year || 2024),
      model: v.model || '',
      active: !!v.active
    };
  }

  function visibleList() {
    if (filterKind === 'ALL') return allVehicles;
    return allVehicles.filter(v => (v.kind || '').toUpperCase() === filterKind);
  }

  function render() {
    const list = visibleList();
    countEl.textContent = `Loaded ${list.length} vehicles`;
    rowsEl.innerHTML = list.map(v => {
      const on = !!v.active;
      return `
        <tr>
          <td>${h(v.plate)}</td>
          <td>${h(v.driver_name)}</td>
          <td>${h((v.kind||'').toUpperCase())}</td>
          <td>${Number(v.year)||''}</td>
          <td>${h(v.model||'')}</td>
          <td><span class="badge ${on?'on':'off'}">${on?'ACTIVE':'OFF'}</span></td>
          <td class="right">
            <button onclick="openEdit('${esc(v.id)}')">Edit</button>
            <button class="danger" onclick="confirmDelete('${esc(v.id)}')">Delete</button>
            <button onclick="toggleActive('${esc(v.id)}', ${on? 'false':'true'})">
              ${on ? 'Turn Off' : 'Turn On'}
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ===== Actions =====
  async function toggleActive(id, active) {
    const v = allVehicles.find(x => x.id === id);
    if (!v) return;
    if (USE_DEMO) {
      v.active = !!active; render(); setMsg('Updated (demo).'); return;
    }
    try {
      const r = await fetch('/api/admin/vehicles', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'x-admin-key': ADMIN_KEY },
        body: JSON.stringify({ action:'update', id, active })
      });
      if (r.status === 401) { localStorage.removeItem('ADMIN_KEY'); return location.href = '/login.html'; }
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'Toggle failed');
      v.active = !!active;
      render(); setMsg('Updated.');
    } catch (e) { setMsg('Error updating.'); }
  }
  window.toggleActive = toggleActive;

  function openCreate(){
    editingId = null;
    mTitle.textContent = 'Add Vehicle';
    fPlate.value=''; fDriver.value=''; fKind.value='SUV'; fYear.value=new Date().getFullYear(); fModel.value=''; fActive.checked=true;
    mHint.textContent = '';
    modal.classList.add('open');
  }
  document.getElementById('btnAdd').onclick = openCreate;

  function openEdit(id){
    const v = allVehicles.find(x => x.id === id);
    if (!v) return;
    editingId = id;
    mTitle.textContent = 'Edit Vehicle';
    fPlate.value = v.plate || '';
    fDriver.value = v.driver_name || '';
    fKind.value = (v.kind || 'SUV').toUpperCase();
    fYear.value = v.year || new Date().getFullYear();
    fModel.value = v.model || '';
    fActive.checked = !!v.active;
    mHint.textContent = `ID: ${v.id}`;
    modal.classList.add('open');
  }
  window.openEdit = openEdit;

  function closeModal(){ modal.classList.remove('open'); }
  mClose.onclick = closeModal;
  modal.addEventListener('click', e=>{ if(e.target === modal) closeModal(); });

  function validateFields(){
    const plate = fPlate.value.trim();
    const driver = fDriver.value.trim();
    const year = Number(fYear.value);
    if (!plate) return 'Plate is required';
    if (!driver) return 'Driver name is required';
    if (!year || year<2000 || year>2100) return 'Year must be between 2000 and 2100';
    return '';
  }

  function cryptoId(){
    try{
      return 'ID-' + ([...crypto.getRandomValues(new Uint8Array(6))].map(x=>x.toString(16).padStart(2,'0')).join('')).toUpperCase();
    }catch{ return 'ID-'+Math.random().toString(36).slice(2,10).toUpperCase(); }
  }

  async function saveVehicle(){
    const err = validateFields();
    if (err){ mHint.textContent = err; return; }

    const payload = {
      id: editingId || cryptoId(),
      plate: fPlate.value.trim(),
      driver_name: fDriver.value.trim(),
      kind: (fKind.value || 'SUV').toUpperCase(),
      year: Number(fYear.value),
      model: fModel.value.trim(),
      active: !!fActive.checked
    };

    if (USE_DEMO){
      if (editingId){
        const i = allVehicles.findIndex(v=>v.id===editingId);
        if (i>=0) allVehicles[i] = payload;
      } else {
        allVehicles.push(payload);
      }
      render(); closeModal(); setMsg('Saved (demo).');
      return;
    }

    try {
      const r = await fetch('/api/admin/vehicles', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'x-admin-key': ADMIN_KEY },
        body: JSON.stringify({ action: editingId ? 'update':'create', vehicle: payload })
      });
      if (r.status === 401) { localStorage.removeItem('ADMIN_KEY'); return location.href = '/login.html'; }
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'Save failed');

      if (editingId){
        const i = allVehicles.findIndex(v=>v.id===editingId);
        if (i>=0) allVehicles[i] = payload;
      } else {
        allVehicles.push(payload);
      }
      render(); closeModal(); setMsg('Saved.');
    } catch (e) { mHint.textContent = 'Error saving.'; }
  }
  mSave.onclick = saveVehicle;

  async function confirmDelete(id){
    const v = allVehicles.find(x => x.id === id);
    if (!v) return;
    const ok = confirm(`Delete ${v.kind} ${v.plate} (driver: ${v.driver_name})?`);
    if (!ok) return;

    if (USE_DEMO){
      allVehicles = allVehicles.filter(x => x.id !== id);
      render(); setMsg('Deleted (demo).');
      return;
    }

    try{
      const r = await fetch('/api/admin/vehicles', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'x-admin-key': ADMIN_KEY },
        body: JSON.stringify({ action:'delete', id })
      });
      if (r.status === 401) { localStorage.removeItem('ADMIN_KEY'); return location.href = '/login.html'; }
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'Delete failed');

      allVehicles = allVehicles.filter(x => x.id !== id);
      render(); setMsg('Deleted.');
    }catch(e){ setMsg('Error deleting.'); }
  }
  window.confirmDelete = confirmDelete;

  function h(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
  function esc(s){ return String(s).replace(/'/g,"\\'"); }

  // Filters & actions
  document.getElementById('btnAll').onclick    = () => { filterKind='ALL'; render(); };
  document.getElementById('btnSUV').onclick    = () => { filterKind='SUV'; render(); };
  document.getElementById('btnVAN').onclick    = () => { filterKind='VAN'; render(); };
  document.getElementById('btnReload').onclick = () => loadVehicles();

  // Logout
  document.getElementById('btnLogout').onclick = () => {
    localStorage.removeItem('ADMIN_KEY');
    localStorage.removeItem('bonanza_admin_ok');
    location.href = '/login.html';
  };

  // Init
  loadVehicles();
</script>
</body>
</html>
