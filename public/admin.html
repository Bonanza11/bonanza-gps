<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bonanza â€” Headquarters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --line:#344158;
      --text:#e9eef7; --muted:#a7b0c3; --ok:#28d07f; --bad:#ff5d5d; --accent:#f7b06a;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
    header{ display:flex; gap:10px; align-items:center; padding:14px 18px; background:rgba(0,0,0,.25); position:sticky; top:0; border-bottom:1px solid #0002 }
    header h1{ font-size:18px; margin:0; font-weight:700; letter-spacing:.3px }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff10; color:var(--muted); border:1px solid #ffffff14 }
    .wrap{ max-width:1100px; margin:18px auto; padding:0 16px }
    .controls{ display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap }
    button{ background:#2a3550; color:var(--text); border:1px solid #ffffff1f; border-radius:8px; padding:8px 12px; cursor:pointer }
    button:hover{ filter:brightness(1.08) }
    .primary{ background:#3b4364 }
    .muted{ color:var(--muted) }
    .count{ margin-left:8px; color:var(--muted); font-size:13px }
    .spacer{ flex:1 }
    table{ width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; font-size:14px }
    /* ðŸ‘‡ Fix: sin sticky para evitar que tape la primera fila */
    th{ background:#11162a; color:#cdd6ea; }
    tbody tr:hover{ background:#1b2136 }
    .badge{ padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .on{ background:#173523; color:var(--ok); border:1px solid #25a866 }
    .off{ background:#3a2323; color:var(--bad); border:1px solid #b84a4a }
    .right{ text-align:right }
    .msg{ margin:8px 0 12px }
  </style>
</head>
<body>
<header>
  <h1>Bonanza Admin â€” Cuartel General</h1>
  <span class="pill" id="envInfo"></span>
  <div class="spacer"></div>
  <button class="primary" id="btnReload">Reload</button>
  <button id="btnLogout">Logout</button>
</header>

<div class="wrap">
  <div class="controls">
    <button id="btnAll">All</button>
    <button id="btnSUV">SUV</button>
    <button id="btnVAN">VAN</button>
    <span class="count" id="count"></span>
    <span class="spacer"></span>
    <span class="muted">API: <code>/api/admin/vehicles</code></span>
  </div>

  <div id="msg" class="msg muted"></div>

  <table>
    <thead>
      <tr>
        <th style="width:120px">Plate</th>
        <th>Driver</th>
        <th style="width:90px">Type</th>
        <th style="width:80px">Year</th>
        <th>Model</th>
        <th style="width:110px">Active</th>
        <th class="right" style="width:180px">Actions</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="7">Loadingâ€¦</td></tr>
    </tbody>
  </table>
</div>

<script>
/* ====== CONFIG / AUTH ====== */
const API_URL = '/api/admin/vehicles';
function getAdminKey(){
  const k = localStorage.getItem('ADMIN_KEY') || sessionStorage.getItem('ADMIN_KEY');
  return k || 'supersecreto123';
}
(function guard(){
  const k = getAdminKey();
  if (!k) location.href = '/login.html';
})();

/* ====== STATE & UI ====== */
const envInfo = document.getElementById('envInfo');
envInfo.textContent = location.hostname.includes('vercel.app') ? 'vercel' : 'local';

const rowsEl  = document.getElementById('rows');
const countEl = document.getElementById('count');
const msgEl   = document.getElementById('msg');

let allVehicles = [];
let filterKind = 'ALL'; // ALL | SUV | VAN

/* ====== HELPERS ====== */
function h(s){ return (s??'').toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function normalize(v){
  const kind = String(v.kind||'').trim().toUpperCase();
  return {
    id: (v.id!=null? String(v.id):''),
    plate: String(v.plate||'').trim(),
    driver_name: String(v.driver_name||'').trim(),
    kind: (kind==='VAN' ? 'VAN' : 'SUV'),
    year: (v.year!=null? Number(v.year):''),
    model: String(v.model||'').trim(),
    active: !!v.active
  };
}

/* ====== API (GET only) ====== */
async function apiGetVehicles(){
  const r = await fetch(API_URL, {
    headers: { 'x-admin-key': getAdminKey() }
  });
  if (r.status === 401) throw new Error('Unauthorized (revisa ADMIN_KEY en Vercel o vuelve a iniciar sesiÃ³n).');
  const data = await r.json().catch(()=>({}));
  if (!r.ok || data.ok===false) throw new Error(data.error || ('HTTP '+r.status));
  return Array.isArray(data.vehicles) ? data.vehicles.map(normalize) : [];
}

/* ====== LOAD & RENDER ====== */
async function load(){
  rowsEl.innerHTML = '<tr><td colspan="7">Loadingâ€¦</td></tr>';
  countEl.textContent = '';
  msgEl.textContent = '';
  try{
    allVehicles = await apiGetVehicles();
    render();
    msgEl.textContent = 'Loaded successfully.';
  }catch(e){
    allVehicles = [];
    render();
    msgEl.style.color = 'var(--bad)';
    msgEl.textContent = 'Error loading: ' + (e.message||e);
  }
}

function visible(){
  if (filterKind==='ALL') return allVehicles;
  return allVehicles.filter(v => v.kind === filterKind);
}

function render(){
  const list = visible();
  countEl.textContent = `Loaded ${list.length} vehicles`;
  rowsEl.innerHTML = list.map(v=>{
    return `
      <tr>
        <td>${h(v.plate)}</td>
        <td>${h(v.driver_name)}</td>
        <td>${h(v.kind)}</td>
        <td>${h(v.year)}</td>
        <td>${h(v.model)}</td>
        <td><span class="badge ${v.active?'on':'off'}">${v.active?'ACTIVE':'OFF'}</span></td>
        <td class="right">
          <button disabled title="Coming soon">Edit</button>
          <button disabled title="Coming soon">Delete</button>
          <button disabled title="Coming soon">${v.active?'Turn Off':'Turn On'}</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7">No vehicles.</td></tr>';
}

/* ====== FILTERS / ACTIONS ====== */
document.getElementById('btnAll').onclick = ()=>{ filterKind='ALL'; render(); };
document.getElementById('btnSUV').onclick = ()=>{ filterKind='SUV'; render(); };
document.getElementById('btnVAN').onclick = ()=>{ filterKind='VAN'; render(); };
document.getElementById('btnReload').onclick = ()=> load();

document.getElementById('btnLogout').onclick = ()=>{
  localStorage.removeItem('ADMIN_KEY');
  sessionStorage.removeItem('ADMIN_KEY');
  location.href = '/login.html';
};

/* go */
load();
</script>
</body>
</html>
