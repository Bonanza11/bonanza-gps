<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bonanza — Headquarters</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* ===== Tokens globales ===== */
  :root{
    --bg:#0f1220; --card:#171a2b; --line:#2a3550;
    --text:#e9eef7; --muted:#a7b0c3; --ok:#28d07f; --bad:#ff5d5d; --accent:#f7b06a;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }

  /* ===== Header ===== */
  header{
    position:sticky; top:0; z-index:1000;
    display:flex; align-items:center; gap:12px;
    padding:14px 18px; background:rgba(0,0,0,.35); border-bottom:1px solid #0003;
    backdrop-filter: blur(6px);
  }
  header h1{ margin:0; font-size:18px; font-weight:800 }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff12; color:var(--muted); border:1px solid #ffffff22 }

  /* ===== Layout general ===== */
  .wrap{ max-width:1100px; margin:18px auto; padding:0 16px }

  .controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    margin:0 0 12px 0;
  }
  button{
    background:#2a3550; color:var(--text);
    border:1px solid #ffffff1f; border-radius:8px; padding:8px 12px; cursor:pointer;
    font-size:14px;
  }
  button:hover{ filter:brightness(1.08) }
  .primary{ background:#3b4364 }
  .danger{ background:#3a2030 }

  /* ===== Summary cards ===== */
  #summary{ display:flex; gap:12px; flex-wrap:wrap; margin:0 0 12px 0 }
  .card{
    flex:1 1 140px; background:var(--card); border:1px solid var(--line);
    border-radius:10px; padding:12px; text-align:center;
  }
  .card h2{ margin:0; font-size:12px; letter-spacing:.35px; color:var(--muted) }
  .card p{ margin:6px 0 0; font-size:20px; font-weight:800 }

  .msg{ margin:8px 0 12px; color:var(--muted); min-height:20px }

  /* ===== Tabla ===== */
  table{
    width:100%; border-collapse:collapse;
    background:var(--card); border:1px solid var(--line);
    border-radius:12px; overflow:hidden;
  }
  th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; font-size:14px }

  /* Encabezado sticky */
  thead th{
    background:#11162a; color:#cdd6ea;
    position:sticky; top:0; z-index:5;
  }

  /* Espaciador invisible (útil si header fijo tapa filas) */
  #stickySpacer{ height:0px; }

  tbody tr:hover{ background:#1b2136 }
  .badge{ padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
  .on{ background:#173523; color:var(--ok); border:1px solid #25a866 }
  .off{ background:#3a2323; color:var(--bad); border:1px solid #b84a4a }
  .right{ text-align:right }
  .muted{ color:var(--muted) }

  /* ===== Modal ===== */
  .backdrop{
    position:fixed; inset:0; background:#0008;
    display:none; align-items:center; justify-content:center; z-index:2000;
  }
  .backdrop.open{ display:flex }
  .modal{
    width:min(720px,96vw);
    background:#1b2136; border:1px solid #2b3853; border-radius:12px;
    box-shadow:0 18px 50px #000a;
  }
  .modal header{
    position:unset; background:#1e2740;
    border-bottom:1px solid #2b3853; border-radius:12px 12px 0 0;
    padding:12px 16px; display:flex; align-items:center; gap:10px;
  }
  .modal .body{ padding:16px }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .grid .full{ grid-column:1/-1 }
  .field label{ display:block; font-size:12px; color:#cbd3e7; margin-bottom:6px }
  .field input, .field select{
    width:100%; height:40px; border-radius:8px;
    border:1px solid #30405a; background:#12182a; color:#e9eef7;
    padding:0 10px;
  }
  .modal .actions{
    display:flex; gap:10px; justify-content:flex-end;
    padding:12px 16px 16px;
  }
  .err-msg{ color:#ff8080; font-size:12px; min-height:16px; padding-top:4px }
  /* ===== Badges más intensos ===== */
.badge.on{
  background:#0f3f23;
  color:#22c55e;                /* verde brillante */
  border:1px solid #16a34a;
}
.badge.off{
  background:#3b0f12;
  color:#ff6b6b;                /* rojo vivo */
  border:1px solid #dc2626;
}

/* ===== Celda de acciones y grupo de botones ===== */
.actions{
  display:flex;
  justify-content:flex-end;
}
.btns{
  display:inline-flex;
  gap:8px;                      /* separación constante */
  align-items:center;
}

/* Botón base */
.btn{
  height:32px;
  padding:0 10px;
  border-radius:8px;
  border:1px solid #ffffff22;
  background:#2a3550;
  color:#e9eef7;
  font-size:13px;
  line-height:30px;
  cursor:pointer;
  transition:transform .03s ease, filter .15s ease, border-color .15s ease;
}
.btn:active{ transform:translateY(1px) }

/* Variantes */
.btn-edit{
  background:#293249;
  border-color:#46536d;
}
.btn-edit:hover{ filter:brightness(1.12) }

.btn-danger{
  background:#3a1b22;
  border-color:#b02a2a;
  color:#ffd4d4;
}
.btn-danger:hover{ filter:brightness(1.08) }

.btn-toggle-on{                  /* Botón para apagar (está ON) */
  background:#12351e;
  border-color:#16a34a;
  color:#9ff5be;
}
.btn-toggle-on:hover{ filter:brightness(1.08) }

.btn-toggle-off{                 /* Botón para encender (está OFF) */
  background:#3a1b1b;
  border-color:#dc2626;
  color:#ffcccc;
}
.btn-toggle-off:hover{ filter:brightness(1.08) }

/* Responsive pequeño: apilar acciones si el ancho es chico */
@media (max-width: 720px){
  .btns{ gap:6px; flex-wrap:wrap }
  .btn{ height:30px; line-height:28px; padding:0 8px; font-size:12px }
}
</style>
</head>
<body>
<header>
  <h1>Bonanza — Headquarters</h1>
  <span class="pill" id="envInfo"></span>
  <div style="flex:1"></div>
  <button id="btnLogout" class="danger">Logout</button>
</header>
<div id="stickySpacer"></div>
<div class="wrap">
       <!-- Controles -->
  <div class="controls affects-sticky" id="controls">
    <button data-filter="ALL">All</button>
    <button data-filter="SUV">SUV</button>
    <button data-filter="VAN">VAN</button>
    <button id="btnReload">Reload</button>
    <button id="btnAdd" class="primary">Add Vehicle</button>
    <span class="muted" style="margin-left:auto">API: <code>/api/admin/vehicles</code></span>
  </div>

  <!-- Resumen -->
  <div id="summary" class="affects-sticky">
    <div class="card"><h2>TOTAL VEHICLES</h2><p id="statTotal">0</p></div>
    <div class="card"><h2>ACTIVE</h2><p id="statActive">0</p></div>
    <div class="card"><h2>INACTIVE</h2><p id="statInactive">0</p></div>
    <div class="card"><h2>SUV</h2><p id="statSUV">0</p></div>
    <div class="card"><h2>VAN</h2><p id="statVAN">0</p></div>
  </div>

  <div id="msg" class="msg"></div>

  <!-- Tabla -->
  <table role="grid" aria-label="Vehicles">
    <thead>
      <tr>
        <th style="width:120px">Plate</th>
        <th>Driver</th>
        <th style="width:90px">Type</th>
        <th style="width:80px">Year</th>
        <th>Model</th>
        <th style="width:110px">Active</th>
        <th class="right" style="width:220px">Actions</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="7">Loading…</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal Add/Edit -->
<div class="backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h2 id="modalTitle" style="margin:0;font-size:16px;font-weight:800">Add Vehicle</h2>
      <div style="flex:1"></div>
      <button id="btnClose">Close</button>
    </header>
    <div class="body">
      <div class="grid">
        <div class="field">
          <label for="fPlate">Plate</label>
          <input id="fPlate" placeholder="UT-123 ABC" autocomplete="off">
        </div>
        <div class="field">
          <label for="fDriver">Driver Name</label>
          <input id="fDriver" placeholder="John Doe" autocomplete="off">
        </div>
        <div class="field">
          <label for="fKind">Type</label>
          <select id="fKind">
            <option value="SUV">SUV</option>
            <option value="VAN">VAN</option>
          </select>
        </div>
        <div class="field">
          <label for="fYear">Year</label>
          <input id="fYear" type="number" min="2000" max="2099" placeholder="2025">
        </div>
        <div class="field full">
          <label for="fModel">Model / Subtype (e.g., Suburban LT / Sprinter)</label>
          <input id="fModel" placeholder="Suburban LT / Sprinter 2500">
        </div>
        <div class="field full">
          <label><input type="checkbox" id="fActive"> Active</label>
        </div>
      </div>
      <div id="formErr" class="err-msg"></div>
      <div class="actions">
        <button id="btnSave" class="primary">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
const ADMIN_KEY = 'supersecreto123';      // header fijo
const API_URL   = '/api/admin/vehicles';  // ruta de la API

/* =================== STICKY HEAD =================== */
function setTheadTop(){
  const header   = document.querySelector('header');
  const blocks   = document.querySelectorAll('.affects-sticky');
  let top = 0;
  if (header) top += header.getBoundingClientRect().height;
  blocks.forEach(el => top += el.getBoundingClientRect().height);
  // margen visual
  top += 6;
  document.documentElement.style.setProperty('--theadTop', top + 'px');
}
window.addEventListener('load', setTheadTop);
window.addEventListener('resize', setTheadTop);

/* =================== STATE & UI =================== */
const envInfo = document.getElementById('envInfo');
envInfo.textContent = location.hostname.includes('vercel.app') ? 'vercel' : 'local';

const rowsEl   = document.getElementById('rows');
const msgEl    = document.getElementById('msg');
const stat = {
  total: document.getElementById('statTotal'),
  active: document.getElementById('statActive'),
  inactive: document.getElementById('statInactive'),
  suv: document.getElementById('statSUV'),
  van: document.getElementById('statVAN'),
};

const backdrop   = document.getElementById('backdrop');
const btnClose   = document.getElementById('btnClose');
const btnSave    = document.getElementById('btnSave');
const fPlate = document.getElementById('fPlate');
const fDriver= document.getElementById('fDriver');
const fKind  = document.getElementById('fKind');
const fYear  = document.getElementById('fYear');
const fModel = document.getElementById('fModel');
const fActive= document.getElementById('fActive');
const formErr= document.getElementById('formErr');
const modalTitle = document.getElementById('modalTitle');

let allVehicles = [];
let filterKind  = 'ALL';
let editingId   = null;

/* =================== HELPERS =================== */
function normalizeVehicle(v){
  const kindNorm = ((v.kind||'').toString().trim().toUpperCase() === 'VAN') ? 'VAN' : 'SUV';
  return {
    id: v.id != null ? String(v.id) : '',
    plate: (v.plate||'').trim(),
    driver_name: (v.driver_name||'').trim(),
    kind: kindNorm,
    year: v.year != null ? Number(v.year) : null,
    model: (v.model||'').trim(),
    active: !!v.active
  };
}
function showMsg(text, ok=true){ msgEl.textContent = text || ''; msgEl.style.color = ok ? 'var(--muted)' : 'var(--bad)'; }
function computeStats(){
  const total = allVehicles.length;
  const active = allVehicles.filter(v=>!!v.active).length;
  const suv = allVehicles.filter(v=>v.kind==='SUV').length;
  const van = allVehicles.filter(v=>v.kind==='VAN').length;
  stat.total.textContent = total;
  stat.active.textContent = active;
  stat.inactive.textContent = Math.max(0, total - active);
  stat.suv.textContent = suv;
  stat.van.textContent = van;
}
function visibleList(){
  if (filterKind === 'ALL') return allVehicles;
  return allVehicles.filter(v=>v.kind === filterKind);
}
function render(){
  computeStats();
  const list = visibleList();
  rowsEl.innerHTML = list.map(v=>{
    const on = !!v.active;
    return `
      <tr data-id="${v.id}">
        <td>${escapeHtml(v.plate)}</td>
        <td>${escapeHtml(v.driver_name)}</td>
        <td>${v.kind}</td>
        <td>${v.year ?? ''}</td>
        <td>${escapeHtml(v.model || '')}</td>
        <td><span class="badge ${on?'on':'off'}">${on?'ACTIVE':'OFF'}</span></td>
        <td class="right">
          <button data-action="edit">Edit</button>
          <button data-action="delete" class="danger">Delete</button>
          <button data-action="toggle">${on?'Turn Off':'Turn On'}</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7">No vehicles.</td></tr>';
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function sortVehicles(a,b){
  const ka = (a.kind||'').localeCompare(b.kind||'');
  if (ka!==0) return ka;
  return (a.plate||'').localeCompare(b.plate||'');
}

/* =================== API =================== */
async function api(method, body, qs=''){
  const url = API_URL + (qs ? `?${qs}` : '');
  const opt = { method, headers:{ 'x-admin-key': ADMIN_KEY } };
  if (body){ opt.headers['Content-Type']='application/json'; opt.body = JSON.stringify(body); }
  const r = await fetch(url, opt);
  let data = {};
  try{ data = await r.json(); }catch{}
  if (r.status === 401) throw new Error('Unauthorized (ADMIN_KEY)');
  if (!r.ok || data.ok === false) throw new Error(data.error || ('HTTP '+r.status));
  return data;
}

/* =================== LOAD =================== */
async function loadVehicles(){
  rowsEl.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  showMsg('');
  try{
    const data = await api('GET');
    const raw  = Array.isArray(data.vehicles) ? data.vehicles : [];
    allVehicles = raw.map(normalizeVehicle).sort(sortVehicles);
    render();
    showMsg('Loaded successfully.');
    setTheadTop(); // por si cambió el alto del resumen
  }catch(e){
    allVehicles = [];
    render();
    showMsg('Error loading: ' + (e.message||e), false);
  }
}

/* =================== MODAL ADD/EDIT =================== */
function openAdd(){
  editingId = null;
  modalTitle.textContent = 'Add Vehicle';
  fPlate.value=''; fDriver.value='';
  fKind.value='SUV';
  fYear.value = new Date().getFullYear();
  fModel.value=''; fActive.checked=false;
  formErr.textContent='';
  backdrop.classList.add('open');
  setTimeout(()=>fPlate.focus(), 50);
}
function openEditById(id){
  const v = allVehicles.find(x=>x.id===id);
  if (!v) return;
  editingId = id;
  modalTitle.textContent = 'Edit Vehicle';
  fPlate.value = v.plate || '';
  fDriver.value = v.driver_name || '';
  fKind.value = v.kind || 'SUV';
  fYear.value = v.year || new Date().getFullYear();
  fModel.value = v.model || '';
  fActive.checked = !!v.active;
  formErr.textContent='';
  backdrop.classList.add('open');
  setTimeout(()=>fPlate.focus(), 50);
}
function closeModal(){ backdrop.classList.remove('open'); }

/* Guardar (add/update) */
btnSave.addEventListener('click', async ()=>{
  formErr.textContent='';
  const plate = fPlate.value.trim();
  const driver_name = fDriver.value.trim();
  const kind = (fKind.value || 'SUV').toUpperCase();
  const year = Number(fYear.value || 0);
  const model = fModel.value.trim();
  const active = !!fActive.checked;

  if (!plate || !driver_name || !year){
    formErr.textContent = 'Plate, Driver and Year are required.'; return;
  }

  btnSave.disabled = true;
  try{
    const payload = { id: editingId, plate, driver_name, kind, year, model, active };
    const data = await api('POST', payload);
    const v = normalizeVehicle(data.vehicle || payload);
    const i = allVehicles.findIndex(x=>x.id === v.id);
    if (i>=0) allVehicles[i] = { ...allVehicles[i], ...v };
    else allVehicles.push(v);
    allVehicles.sort(sortVehicles);
    render();
    showMsg(editingId ? 'Saved changes.' : 'Vehicle added.');
    closeModal();
  }catch(e){
    formErr.textContent = e.message || 'Error saving.';
  }finally{
    btnSave.disabled = false;
  }
});

btnClose.addEventListener('click', closeModal);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

/* =================== TABLE ACTIONS (delegation) =================== */
rowsEl.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button[data-action]');
  if (!btn) return;
  const tr = btn.closest('tr[data-id]');
  if (!tr) return;
  const id = tr.getAttribute('data-id');
  const action = btn.getAttribute('data-action');

  if (action === 'edit'){
    openEditById(id);
    return;
  }

  if (action === 'delete'){
    const v = allVehicles.find(x=>x.id===id);
    if (!v) return;
    const sure = confirm(`Delete vehicle "${v.plate}"? This cannot be undone.`);
    if (!sure) return;
    try{
      await api('DELETE', null, 'id='+encodeURIComponent(id));
      allVehicles = allVehicles.filter(x=>x.id!==id);
      render(); showMsg('Deleted.');
    }catch(e){
      showMsg('Error deleting: ' + (e.message||e), false);
    }
    return;
  }

  if (action === 'toggle'){
    const v = allVehicles.find(x=>x.id===id); if(!v) return;
    const next = !v.active;
    try{
      await api('POST', { id, active: next });
      v.active = next;
      render(); showMsg('Updated.');
    }catch(e){
      showMsg('Error updating: ' + (e.message||e), false);
    }
    return;
  }
});

/* =================== FILTERS & GLOBAL BTNS =================== */
document.getElementById('btnAdd').addEventListener('click', openAdd);
document.getElementById('btnReload').addEventListener('click', loadVehicles);
document.getElementById('controls').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-filter]'); if(!b) return;
  filterKind = b.getAttribute('data-filter') || 'ALL';
  render();
});
document.getElementById('btnLogout').addEventListener('click', ()=>{
  localStorage.removeItem('ADMIN_KEY');
  localStorage.removeItem('bonanza_admin_ok');
  location.href = '/login.html';
});

/* =================== BOOT =================== */
loadVehicles();
</script>
  <script>
  function ajustarEspaciador(){
    const header = document.querySelector("header");
    const spacer = document.getElementById("stickySpacer");
    if(header && spacer){
      spacer.style.height = header.offsetHeight + "px";
    }
  }

  // Ajusta cuando carga la página
  window.addEventListener("load", ajustarEspaciador);
  // Ajusta también si redimensionas la ventana
  window.addEventListener("resize", ajustarEspaciador);
</script>
</body>
</html>
