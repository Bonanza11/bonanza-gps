<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bonanza — Headquarters</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* ===== Tokens globales ===== */
  :root{
    --bg:#0f1220; --card:#171a2b; --line:#2a3550;
    --text:#e9eef7; --muted:#a7b0c3; --ok:#22c55e; --bad:#ff6b6b; --accent:#f7b06a;
    --theadTop: 0px; /* se ajusta con JS según header + barras */
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }

  /* ===== Header superior ===== */
  header{
    position:sticky; top:0; z-index:1000;
    display:flex; align-items:center; gap:12px;
    padding:14px 18px; background:rgba(0,0,0,.35); border-bottom:1px solid #0003;
    backdrop-filter: blur(6px);
  }
  header h1{ margin:0; font-size:18px; font-weight:800 }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#ffffff12; color:#cbd5e1; border:1px solid #ffffff22 }

  /* ===== Tabs (nav) ===== */
  .tabs{
    display:flex; gap:8px; align-items:center; padding:10px 16px;
    background:rgba(0,0,0,.2); border-bottom:1px solid #0003;
  }
  .tab-btn{
    padding:8px 12px; border-radius:8px; border:1px solid #ffffff1f;
    background:#24304a; color:#e9eef7; cursor:pointer; font-size:14px;
  }
  .tab-btn[aria-selected="true"]{ background:#3b4364 }
  .tabs .spacer{ flex:1 }
  .muted{ color:var(--muted) }

  /* ===== Layout de cada vista ===== */
  .wrap{ max-width:1100px; margin:18px auto; padding:0 16px }
  .controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:0 0 12px 0;
  }
  button{
    background:#2a3550; color:var(--text);
    border:1px solid #ffffff1f; border-radius:8px; padding:8px 12px; cursor:pointer; font-size:14px;
  }
  button:hover{ filter:brightness(1.08) }
  .primary{ background:#3b4364 }
  .danger{ background:#3a2030 }

  /* ===== Summary cards ===== */
  #summaryVehicles, #summaryClients{
    display:flex; gap:12px; flex-wrap:wrap; margin:0 0 12px 0
  }
  .card{
    flex:1 1 140px; background:var(--card); border:1px solid var(--line);
    border-radius:10px; padding:12px; text-align:center;
  }
  .card h2{ margin:0; font-size:12px; letter-spacing:.35px; color:var(--muted) }
  .card p{ margin:6px 0 0; font-size:20px; font-weight:800 }

  .msg{ margin:8px 0 12px; color:var(--muted); min-height:20px }

  /* ===== Tabla genérica ===== */
  table{
    width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line);
    border-radius:12px; overflow:hidden;
  }
  th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; font-size:14px }

  thead th{
    background:#11162a; color:#cdd6ea;
    position: sticky;
    top: 0;
    z-index: 5;
  }

  #stickySpacerVehicles,
  #stickySpacerClients,
  #stickySpacerReservations{
    height: var(--theadTop, 0px);
  }

  tbody tr:hover{ background:#1b2136 }
  .badge{ padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
  .badge.on { background:#0f3f23; color:#22c55e; border:1px solid #16a34a }
  .badge.off{ background:#3b0f12; color:#ff6b6b; border:1px solid #dc2626 }

  .right{ text-align:right }

  .actions{ display:flex; justify-content:flex-end }
  .btns{ display:inline-flex; gap:8px; align-items:center }
  .btn{ height:32px; padding:0 10px; border-radius:8px; border:1px solid #ffffff22; background:#2a3550; color:#e9eef7; font-size:13px; line-height:30px; cursor:pointer }
  .btn:active{ transform:translateY(1px) }

  /* ===== Modal ===== */
  .backdrop{ position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:2000 }
  .backdrop.open{ display:flex }
  .modal{ width:min(720px,96vw); background:#1b2136; border:1px solid #2b3853; border-radius:12px; box-shadow:0 18px 50px #000a }
  .modal header{ background:#1e2740; border-bottom:1px solid #2b3853; border-radius:12px 12px 0 0; padding:12px 16px; display:flex; align-items:center; gap:10px }
  .modal .body{ padding:16px }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .grid .full{ grid-column:1/-1 }
  .field label{ display:block; font-size:12px; color:#cbd3e7; margin-bottom:6px }
  .field input, .field select, textarea{ width:100%; border-radius:8px; border:1px solid #30405a; background:#12182a; color:#e9eef7; padding:6px 10px }
  .err-msg{ color:#ff8080; font-size:12px; min-height:16px; padding-top:4px }
  .modal .actions{ display:flex; justify-content:flex-end; gap:10px; padding:12px 16px 16px }
</style>
</head>
<body>

<header>
  <h1>Bonanza — Headquarters</h1>
  <span class="pill" id="envInfo"></span>
  <div style="flex:1"></div>
  <button id="btnLogout" class="danger">Logout</button>
</header>

<nav class="tabs affects-sticky" id="tabs">
  <button class="tab-btn" data-tab="vehicles" aria-selected="true">Vehículos</button>
  <button class="tab-btn" data-tab="clients"  aria-selected="false">Clientes</button>
  <button class="tab-btn" data-tab="reservations" aria-selected="false">Reservations</button>
  <button class="tab-btn" data-tab="settings" aria-selected="false">Ajustes</button>
  <div class="spacer"></div>
  <span class="muted">API Vehicles: <code>/api/admin/vehicles</code></span>
</nav>

<!-- VIEW: VEHICLES -->
<section id="view-vehicles"> ... </section>

<!-- VIEW: CLIENTS -->
<section id="view-clients" hidden> ... </section>

<!-- VIEW: RESERVATIONS -->
<section id="view-reservations" hidden>
  <div class="wrap">
    <div class="controls affects-sticky" id="resControls">
      <button id="btnReloadRes">Reload</button>
    </div>
    <div class="card affects-sticky" style="margin-bottom:12px">
      <h2 style="margin:0; font-size:12px; color:var(--muted)">RESERVATIONS</h2>
      <p id="resMsg" class="msg" style="margin:6px 0 0"></p>
    </div>
    <div id="stickySpacerReservations"></div>
    <table role="grid" aria-label="Reservations">
      <thead>
        <tr>
          <th style="width:60px">ID</th>
          <th style="width:210px">Customer</th>
          <th>Pickup → Dropoff</th>
          <th style="width:190px">Time</th>
          <th style="width:80px">Vehicle</th>
          <th style="width:110px">Status</th>
          <th class="right" style="width:280px">Actions</th>
        </tr>
      </thead>
      <tbody id="resRows">
        <tr><td colspan="7">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- MODAL: ASSIGN RESERVATION -->
<div class="backdrop" id="assignBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h2>Assign Reservation</h2>
      <div style="flex:1"></div>
      <button id="assignBtnClose">Close</button>
    </header>
    <div class="body">
      <div class="grid">
        <div class="field">
          <label for="aVehicle">Vehicle *</label>
          <select id="aVehicle"></select>
        </div>
        <div class="field">
          <label for="aDriver">Driver (optional)</label>
          <input id="aDriver" placeholder="Name or ID" />
        </div>
        <div class="field full">
          <label for="aNotes">Notes (optional)</label>
          <textarea id="aNotes" placeholder="Internal notes for dispatch"></textarea>
        </div>
      </div>
      <div id="assignErr" class="err-msg"></div>
      <div class="actions">
        <button id="assignBtnSave" class="primary">Assign</button>
      </div>
    </div>
  </div>
</div>
<!-- VIEW: SETTINGS (placeholder) -->
<section id="view-settings" hidden>
  <div class="wrap">
    <div class="card">
      <h2>Información</h2>
      <p style="font-size:14px; margin-top:8px; color:var(--muted)">
        Aquí podrás administrar reglas de temporada, excepción SLC, bloqueos, etc.
        (placeholder – se conecta más adelante).
      </p>
    </div>
  </div>
</section>

<!-- MODAL VEHICLE -->
<div class="backdrop" id="vehBackdrop"> ... </div>

<!-- MODAL CLIENT -->
<div class="backdrop" id="cliBackdrop"> ... </div>

<script>
/* =================== CONFIG =================== */
const ADMIN_KEY = 'supersecreto123';
const API_VEH   = '/api/admin/vehicles';
const API_CLI   = '/api/admin/clients';
const API_RES   = '/api/reservations';

/* =================== STICKY TOP =================== */
function setTheadTop(){ ... }
window.addEventListener('load', setTheadTop);
window.addEventListener('resize', setTheadTop);

/* =================== TABS =================== */
const tabsEl = document.getElementById('tabs');
const views = {
  vehicles: document.getElementById('view-vehicles'),
  clients : document.getElementById('view-clients'),
  reservations: document.getElementById('view-reservations'),
  settings: document.getElementById('view-settings'),
};
tabsEl.addEventListener('click', (e)=>{
  const b = e.target.closest('.tab-btn'); if(!b) return;
  const t = b.dataset.tab;
  [...tabsEl.querySelectorAll('.tab-btn')].forEach(x=>x.setAttribute('aria-selected', String(x===b)));
  Object.entries(views).forEach(([key,sec])=> sec.hidden = key!==t );
  setTheadTop();
  if (t==='vehicles') loadVehicles();
  if (t==='clients')  loadClients();
  if (t==='reservations') loadReservations();
});

/* =================== ENV / LOGOUT =================== */
const envInfo = document.getElementById('envInfo');
envInfo.textContent = location.hostname.includes('vercel.app') ? 'vercel' : 'local';
document.getElementById('btnLogout').addEventListener('click', ()=>{
  localStorage.removeItem('ADMIN_KEY');
  localStorage.removeItem('bonanza_admin_ok');
  location.href = '/login.html';
});

/* ========== HELPERS GENERALES ========== */
function escapeHtml(s){ ... }
async function api(url, method='GET', body=null){ ... }

/* =========================================================
   VEHÍCULOS (CRUD completo)
   ========================================================= */
...   // tu bloque de vehicles tal como ya lo tenías

/* =========================================================
   CLIENTES (CRUD completo)
   ========================================================= */
...   // tu bloque de clients tal como ya lo tenías

/* =========================================================
   RESERVATIONS (nuevo)
   ========================================================= */
const resMsg  = document.getElementById('resMsg');
const resRows = document.getElementById('resRows');

function resShowMsg(t, ok=true){ resMsg.textContent=t||''; resMsg.style.color = ok?'var(--muted)':'var(--bad)'; }
function fmtWhen(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }
function badgeStatus(s){ ... }  // como ya lo tenías

function renderReservations(list){
  resRows.innerHTML = (list||[]).map(r => `
    <tr data-id="${r.id}">
      <td>${r.id}</td>
      <td>
        <div><strong>${escapeHtml(r.customer_name||'')}</strong></div>
        <div style="color:var(--muted);font-size:12px">
          ${escapeHtml(r.phone||'')} ${r.email? ' · '+escapeHtml(r.email):''}
        </div>
      </td>
      <td>${escapeHtml(r.pickup_location)} → ${escapeHtml(r.dropoff_location)}</td>
      <td>${fmtWhen(r.pickup_time)}</td>
      <td>${escapeHtml(r.vehicle_type||'-')}</td>
      <td>${badgeStatus(r.status)}</td>
      <td class="right actions">
        <div class="btns">
          <button class="btn" data-action="assign">Assign</button>
          <button class="btn" data-action="start">Start</button>
          <button class="btn" data-action="done">Done</button>
          <button class="btn btn-danger" data-action="cancel">Cancel</button>
        </div>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="7">No reservations.</td></tr>';
}

async function loadReservations(){
  resRows.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  try{
    const r = await fetch(API_RES, { headers:{ 'x-admin-key': ADMIN_KEY } });
    const data = await r.json();
    renderReservations(Array.isArray(data) ? data : []);
    resShowMsg('Loaded successfully.');
    setTheadTop();
  }catch(e){
    renderReservations([]);
    resShowMsg('Error loading: '+(e.message||e), false);
  }
}

async function patchReservation(id, payload){
  const r = await fetch(`${API_RES}/${id}`, {
    method: 'PATCH',
    headers:{ 'Content-Type':'application/json', 'x-admin-key': ADMIN_KEY },
    body: JSON.stringify(payload)
  });
  if (!r.ok) throw new Error('update_failed');
  return r.json();
}

/* Delegación acciones tabla Reservations */
resRows.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button[data-action]'); if(!btn) return;
  const tr  = btn.closest('tr[data-id]'); if(!tr) return;
  const id  = tr.getAttribute('data-id');
  const a   = btn.getAttribute('data-action');

  try {
    if (a === 'assign') {
      openAssignModal(id);
      return;
    } else if (a === 'start') {
      await patchReservation(id, { status: 'in_progress' });
    } else if (a === 'done') {
      await patchReservation(id, { status: 'done' });
    } else if (a === 'cancel') {
      if (!confirm('Cancel this reservation?')) return;
      await patchReservation(id, { status: 'canceled' });
    }
    await loadReservations();
  } catch (e) {
    resShowMsg('Error updating: ' + (e.message || e), false);
  }
});

/* Botón Reload Reservations */
document.getElementById('btnReloadRes').addEventListener('click', loadReservations);

/* ---------- ASSIGN MODAL ---------- */
const assignBackdrop  = document.getElementById('assignBackdrop');
const assignBtnClose = document.getElementById('assignBtnClose');
const assignBtnSave  = document.getElementById('assignBtnSave');
const assignErr      = document.getElementById('assignErr');
const aVehicle       = document.getElementById('aVehicle');
const aDriver        = document.getElementById('aDriver');
const aNotes         = document.getElementById('aNotes');

let assignReservationId = null;

async function ensureVehiclesLoadedForAssign() {
  try {
    if (!Array.isArray(allVehicles) || allVehicles.length === 0) {
      const data = await api(API_VEH, 'GET');
      const raw  = Array.isArray(data.vehicles) ? data.vehicles : [];
      allVehicles = raw.map(v => ({
        id: String(v.id),
        plate: (v.plate||'').trim(),
        driver_name: (v.driver_name||'').trim(),
        kind: ((v.kind||'SUV').toUpperCase()==='VAN')?'VAN':'SUV'
      }));
    }
    aVehicle.innerHTML = allVehicles.map(v =>
      `<option value="${v.id}">${v.plate} — ${v.kind} — ${v.driver_name||'No driver'}</option>`
    ).join('');
  } catch (e) {
    assignErr.textContent = 'Error loading vehicles: ' + (e.message||e);
  }
}

function openAssignModal(reservationId) {
  assignReservationId = reservationId;
  assignErr.textContent = '';
  aDriver.value = '';
  aNotes.value = '';
  ensureVehiclesLoadedForAssign().then(()=>{
    assignBackdrop.classList.add('open');
    aVehicle.focus();
  });
}
function closeAssignModal(){
  assignBackdrop.classList.remove('open');
  assignReservationId = null;
}

assignBtnClose.addEventListener('click', closeAssignModal);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAssignModal(); });

assignBtnSave.addEventListener('click', async ()=>{
  assignErr.textContent = '';
  const vehicle_id = aVehicle.value;
  if (!vehicle_id) { assignErr.textContent = 'Please select a vehicle.'; return; }
  assignBtnSave.disabled = true;
  try{
    await patchReservation(assignReservationId, { status:'assigned', vehicle_id });
    closeAssignModal();
    await loadReservations();
  }catch(e){
    assignErr.textContent = e.message || 'Error assigning.';
  }finally{
    assignBtnSave.disabled = false;
  }
});

/* =================== BOOT =================== */
loadVehicles(); // Tab inicial
</script>
</body>
</html>
