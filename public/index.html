<!<div id="info"></div> html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,sans-serif}

    /* Header / Logo */
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo-wrap{ position:relative }
    .logo{
      width:180px;height:180px;border-radius:50%;border:2px solid var(--copper);
      object-fit:cover;display:block;position:relative;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    .logo-wrap::after{content:"";position:absolute;inset:-8px;border-radius:50%;box-shadow:0 0 22px 10px rgba(192,139,92,.35);pointer-events:none;}

    /* Layout */
    main{max-width:760px;width:92vw;margin:0 auto 40px;padding:0 16px}
    label{display:block;margin:12px 0 6px;font-weight:700}

    /* Inputs: oscuros en todos (incl. autofill) */
    input,select{
      display:block;width:100%;height:44px;padding:10px 12px;
      background:#1a1a1a;color:var(--copper);border:1px solid #444;border-radius:8px;
      outline:none;
    }
    /* Campos inválidos (falta completar) */
.invalid{
  border-color: var(--err) !important;
  box-shadow: 0 0 0 3px rgba(255,107,107,.25) !important;
}
    input:focus,select:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    ::placeholder{color:#cba686;opacity:.65}

    /* Fuerza oscuro también cuando el navegador autocompleta */
    input:-webkit-autofill,
    input:-webkit-autofill:focus{
      -webkit-text-fill-color: var(--copper);
      transition: background-color 50000s ease-in-out 0s;
      box-shadow: 0 0 0 1000px #1a1a1a inset;
      border:1px solid #444;
    }

    button{
      width:100%;padding:14px 16px;margin-top:18px;background:var(--copper);color:#000;
      font-weight:700;font-size:18px;border:0;border-radius:10px;cursor:pointer;
    }
    button:disabled{opacity:0.5;cursor:not-allowed;}
    
    #map{height:380px;margin-top:10px;border-radius:12px;overflow:hidden}
        /* Trip Summary */
    #info{
      display:none;margin-top:18px;border-radius:16px;padding:18px;
      background:linear-gradient(180deg,#121212,#0b0b0b);
      border:1px solid rgba(192,139,92,.28);box-shadow:0 18px 40px rgba(0,0,0,.55);
      color:#e9d5c1;font-size:.95em;
    }
    .info-title{font-weight:800;margin:0 0 4px;font-size:1.05rem}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 12px;}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:12px;}
    .kpi .label{font-size:.75rem;opacity:.8;margin-bottom:6px}
    .kpi .value{font-size:1.35rem;font-weight:800;color:#f0d1ad}
    .kpi .unit{font-size:.9rem;opacity:.7;margin-left:4px}
    .kpi .value.price{color:#ffddae}
    .breakdown{margin:6px 0 12px;}
    .breakdown .row{display:flex;justify-content:space-between;padding:6px 0;}
    .breakdown .row.total{font-weight:800;color:#ffddae;font-size:1.05rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:6px 0}
        /* Date/Time */
    .input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.input-row{grid-template-columns:1fr;}}
    #date,#time{
      height:56px;font-size:17px;border-radius:12px;background:#1f1f1f;color:#fff;
      border:2px solid var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18);
    }
    #date:focus,#time:focus{outline:none;border-color:#ffd9a1;box-shadow:0 0 0 4px rgba(255,217,161,.22);}
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      filter:invert(80%) sepia(20%) saturate(180%) hue-rotate(340deg) brightness(110%);
      opacity:.95;cursor:pointer;
    }
    .helper{font-size:.85rem;opacity:.95;margin-top:6px;color:#ffddae;}

    /* Vehicle visual */
    .turntable{margin:10px 0 6px; display:flex; flex-direction:column; align-items:center;}
    .turntable .car{width:260px;height:auto;filter:drop-shadow(0 12px 18px rgba(0,0,0,.6))}
    .turntable .platform{
      width:220px;height:22px;border-radius:50%;
      background:radial-gradient(ellipse at center, rgba(0,0,0,.7) 0%, rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 70%);
      margin-top:6px;
    }
    .vehicle-caption{font-weight:700;color:#ffddae;margin-top:6px;letter-spacing:.2px;}

    /* Vehicle selector */
    .veh-toggle{display:flex;gap:8px;margin:10px 0}
    .veh-btn{
      flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);
      color:var(--copper);padding:12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    .veh-btn.active{
      background:var(--copper);color:#000;border-color:var(--copper);
      box-shadow:0 0 0 3px rgba(168,116,79,.25)
    }

    /* Terms compact box */
    .terms-box{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .terms-summary{
      display:flex;align-items:center;gap:10px;cursor:pointer;
    }
    .terms-summary .chev{
      width:10px;height:10px;border-right:2px solid var(--copper);
      border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto;
    }
    .terms-box.open .terms-summary .chev{transform:rotate(45deg)}

    /* Switch (único) */
    .accept-pill{
      min-width:28px;height:20px;border-radius:999px;border:1px solid #666;
      display:flex;align-items:center;padding:0 2px;position:relative;background:#1a1a1a;
    }
    .accept-dot{
      width:14px;height:14px;border-radius:50%;background:#333;transition:.2s;
      border:1px solid #555;
    }
    .accept-pill.on{border-color:var(--ok);background:rgba(23,201,100,.12)}
    .accept-pill.on .accept-dot{transform:translateX(8px);background:var(--ok);border-color:var(--ok)}
    .accept-label{font-size:.85rem;opacity:.9;margin-left:8px}
        /* Read-more (2 líneas + degradado) */
    .terms-body{margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .terms-content.clamped{
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      overflow:hidden;position:relative;
    }
    .terms-content.clamped::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:2.2em;
      background:linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,1));
      pointer-events:none;
    }
    .readmore-btn{
      display:inline-block;margin-top:8px;padding:6px 10px;border:1px solid rgba(168,116,79,.55);
      border-radius:8px;background:#1a1a1a;color:#ffddae;font-weight:700;font-size:.85rem;cursor:pointer;
    }

    /* Hints */
    .hint{font-size:.85rem;margin-top:6px}
    .hint.warn{color:var(--warn)}
    .hint.err{color:var(--err)}
    .hint.ok{color:var(--ok)}

    /* === Added: Luggage Accordion (discreto, mismo estilo) === */
    .luggage-accordion{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .luggage-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
    .luggage-title{font-weight:700}
    .luggage-chev{width:10px;height:10px;border-right:2px solid var(--copper);border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto}
    .luggage-accordion.open .luggage-chev{transform:rotate(45deg)}
    .luggage-body{display:none;margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .luggage-accordion.open .luggage-body{display:block}
    .lug-section h4{margin:6px 0 4px;color:#ffddae}
    .lug-note{opacity:.9;margin:2px 0 8px}
    .lug-list{margin:0 0 10px 18px}

    /* ===== Modal (ligero, sin cambios al layout) ===== */
    .modal-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,.74);align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal-backdrop.open{display:flex}
    .modal{max-width:860px;width:100%;max-height:86vh;background:#0e0e0e;border:1px solid rgba(168,116,79,.45);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.7);overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(168,116,79,.28);background:#101010}
    .modal-title{font-weight:800;color:#ffddae}
    .modal-body{padding:14px 16px 18px;overflow:auto;color:#e9d5c1;line-height:1.6}
    .close-btn{background:#1a1a1a;border:1px solid rgba(168,116,79,.45);color:#ffddae;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
/* Jet Faux 3D (placeholder sin video) */
.jet-showcase {
  margin: 16px 0 6px;
  background: #0b0b0b;
  border: 1px solid rgba(168,116,79,.35);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 18px 40px rgba(0,0,0,.55);
}
.jet-faux3d {
  position: relative;
  border: 1px solid rgba(168,116,79,.28);
  border-radius: 12px;
  overflow: hidden;
  background: radial-gradient(ellipse at 50% 85%, rgba(0,0,0,.7), rgba(0,0,0,0) 60%);
}
.jet-faux3d .jet {
  width: 88%;
  max-width: 780px;
  display: block;
  margin: 20px auto 12px;
  transform-style: preserve-3d;
  animation: jetYaw 9s linear infinite;
}
@keyframes jetYaw {
  0%   {transform: perspective(800px) rotateY(-12deg) translateY(0);}
  50%  {transform: perspective(800px) rotateY(12deg)  translateY(-2px);}
  100% {transform: perspective(800px) rotateY(-12deg) translateY(0);}
}
.jet-caption {
  font-weight: 700;
  color: #ffddae;
  text-align: center;
  margin-top: 6px;
  letter-spacing: .2px;
  opacity: .95;
}
    /* ---- Total & note styling ---- */
.breakdown .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.breakdown .row.total {
  font-weight: 800;
  color: #ffddae;
  font-size: 1.05rem;
}
/* Nota de impuestos y propina */
.tax-note {
  font-size: 13px;              
  color: #c9a97c;               
  font-style: italic;           
  text-align: right;            
  margin-top: 4px;              
  opacity: 0.85;                
}    
@media (prefers-reduced-motion: reduce){
  .jet-faux3d .jet {animation: none;}
}   
    /* === Meet & Greet card (SLC only) === */
.mg-card {
  display: none; /* oculto por defecto; lo mostraremos luego por JS */
  margin: 16px 0;
  border-radius: 14px;
  border: 1px solid rgba(168,116,79,.45);
  background: linear-gradient(180deg,#121212,#0b0b0b);
  box-shadow: 0 12px 24px rgba(0,0,0,.35);
  padding: 16px;
  animation: mgFadeIn .25s ease;
}
.mg-card h3 { margin: 0 0 4px; color: #ffddae; font-size: 1.1rem; }
.mg-card p  { margin: 0 0 12px; font-size: .9rem; opacity: .85; }
.mg-options { display: flex; gap: 8px; margin-bottom: 8px; }
.mg-btn {
  flex: 1 1 0;
  background: #1a1a1a;
  border: 1px solid rgba(168,116,79,.55);
  color: var(--copper);
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  text-align: center;
  user-select: none;
}
.mg-btn.active { background: var(--copper); color: #000; border-color: var(--copper); }
.mg-note { font-size: .8rem; color: #aa8b72; }
@keyframes mgFadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
 </style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img class="logo" src="/images/bonanza-logo.PNG" alt="Bonanza Transportation Logo">
    </div>
  </header>

  <main>
    <label for="fullname">Full Name:</label>
    <input id="fullname" type="text" placeholder="e.g. John Doe" autocomplete="name" required />

    <label for="phone">Phone Number (US):</label>
    <input id="phone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="(555) 123-4567" required />
    <div id="phoneHelp" class="hint"></div>

    <label for="email">Email Address:</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />
    <div id="emailHelp" class="hint"></div>

    <label for="pickup">Pick-up Address:</label>
    <input id="pickup" placeholder="e.g. SLC Airport" required />
<!-- JSX fields: aparecen solo si el pick-up es JSX -->
<div id="jsxContainer" style="display:none; margin-top:10px;">
  <label for="jsxFlightNumber">JSX Flight Number:</label>
  <input id="jsxFlightNumber" placeholder="e.g. XE1234" />

  <label for="jsxOrigin" style="margin-top:12px;">JSX Origin City:</label>
  <input id="jsxOrigin" placeholder="e.g. Burbank (BUR)" />
</div>
    <label for="dropoff">Drop-off Address:</label>
    <input id="dropoff" placeholder="e.g. Montage Deer Valley" required />
<!-- Meet & Greet — SLC Only (visual, sin lógica) -->
<div class="mg-card" id="meetGreetCard" aria-label="Meet & Greet options">
  <h3>Meet & Greet — SLC Only</h3>
  <p>Choose where you want your driver to meet you inside the terminal.</p>
  <div class="mg-options" role="group" aria-label="Meet & Greet selection">
    <div class="mg-btn" data-choice="tsa_exit" aria-pressed="false">TSA Exit (+$50)</div>
    <div class="mg-btn" data-choice="baggage_claim" aria-pressed="false">Baggage Claim (+$50)</div>
    <div class="mg-btn active" data-choice="none" aria-pressed="true">No Meet & Greet</div>
  </div>
  <div class="mg-note">
    Available only for SUV arrivals at Salt Lake City International (SLC). Vans must use the designated curbside pickup area.
  </div>
</div>
    <!-- Special Instructions -->    
  <label for="specialInstructions">Special Instructions:</label>

<textarea id="specialInstructions"
  placeholder="Add any important details for your driver (e.g., gate code, luggage, pickup location)"
  style="display:block;width:100%;height:60px;padding:12px 10px; background:#1a1a1a;color:#fff; border:1px solid #444;border-radius:10px;font-size:14px;">
</textarea>
        <div id="flightContainer" style="display:none;">
      <label for="flightNumber">Flight Number:</label>
      <input id="flightNumber" placeholder="e.g. DL1234" />
      <div id="flightHint" class="hint warn" style="display:none">
        ✈️ Enter the complete flight number exactly as it appears on your boarding pass or itinerary.
      </div>

      <label for="flightOrigin" style="margin-top:12px;">Flight Origin City:</label>
      <input id="flightOrigin" placeholder="e.g. Miami (MIA)" />
      <div id="originHelp" class="hint" style="display:none"></div>
    </div>
    <!-- 🔹 Resultado del backend (mensajes de validación de vuelo) -->
<div id="backendResult" class="hint" style="display:block; margin-top:6px;"></div>

    <!-- Private Jet (FBO) — solo si es aeropuerto privado en Utah -->
    <div id="privateFlightContainer" style="display:none;">
      <label for="tailNumber">Jet Tail Number (N‑Number):</label>
      <input id="tailNumber" placeholder="e.g., N123AB" />
      <div id="tailHelp" class="hint" style="display:none"></div>

      <label for="pvtOrigin" style="margin-top:12px;">Flight Origin City:</label>
      <input id="pvtOrigin" placeholder="e.g., Van Nuys (VNY)" />
      <div id="pvtOriginHelp" class="hint" style="display:none"></div>
    </div>

    <div class="input-row">
      <div>
        <label for="date">Date:</label>
        <input id="date" type="date" />
        <div id="dateHelp" class="helper"></div>
      </div>
      <div>
        <label for="time">Time:</label>
        <input id="time" type="time" step="900" />
        <div id="timeHelp" class="helper"></div>
      </div>
    </div>
        <!-- Vehicle Selector -->
    <div class="veh-toggle">
      <button class="veh-btn active" data-type="suv">SUV (1-5 Passengers)</button>
      <button class="veh-btn" data-type="van">Van (up to 12 Passengers)</button>
    </div>
    <div class="turntable">
     <img class="car" src="/images/suburban.png" alt="Selected Vehicle">
      <div class="platform"></div>
      <div class="vehicle-caption">SUV — Max 5 passengers, 5 suitcases</div>
    </div>

    <!-- Luggage Accordion -->
    <div class="luggage-accordion" id="luggageAccordion">
      <div class="luggage-summary">
        <span class="luggage-title">Luggage Guidelines</span>
        <span class="luggage-chev"></span>
      </div>


<div class="luggage-body">

  <div class="lug-section">
    <h4>SUV – 1 to 5 Passengers</h4>

    <div class="lug-option">
      <h5>Option 1 – With Sports Equipment</h5>
      <ul>
        <li>5 sports equipment items (ski bags or golf bags)</li>
        <li>3 large suitcases (28–32”)</li>
        <li>3 small suitcases (20–24”)</li>
      </ul>
    </div>

    <div class="lug-option">
      <h5>Option 2 – Without Sports Equipment</h5>
      <ul>
        <li>4 large suitcases (28–32”)</li>
        <li>4 small suitcases (20–24”)</li>
      </ul>
    </div>
  </div>

  <div class="lug-section">
    <h4>Van – Up to 12 Passengers</h4>

    <div class="lug-option">
      <h5>Option 1 – With Sports Equipment</h5>
      <ul>
        <li>8 sports equipment items (ski bags or golf bags)</li>
        <li>8 large suitcases (28–32”)</li>
        <li>Carry-on: 1 per passenger (backpack or small bag)</li>
      </ul>
    </div>

    <div class="lug-option">
      <h5>Option 2 – Without Sports Equipment</h5>
      <ul>
        <li>12–14 large suitcases (28–32”)</li>
        <li>Carry-on: 1 per passenger (backpack or small bag)</li>
      </ul>
    </div>
  </div>
</div>      
</div>
    </div>
        <!-- Terms -->
    <div class="terms-box" id="terms-box">
      <div class="terms-summary">
        <div class="accept-pill" id="acceptPill" tabindex="0" role="switch" aria-checked="false">
          <div class="accept-dot"></div>
        </div>
        <div class="accept-label">I accept the Terms & Conditions</div>
        <ul style="font-size:13px; color:#ccc; margin:10px 0 0 0; padding-left:18px;">
  <li>Full payment required to confirm reservation.</li>
  <li>Cancellations within 24h are non-refundable.</li>
  <li>Not liable for delays caused by traffic, weather, or airlines.</li>
  <li>Customer is responsible for accuracy of submitted information.</li>
  <li>We may text you to confirm details, but all bookings are processed exactly as entered.</li>
</ul>
      </div>
      <div class="terms-body">
        <div id="terms-content" class="terms-content clamped">
          By booking with Bonanza Transportation, you agree to our policies including but not limited to payment terms,
          cancellation policy, and liability limits. Please read carefully before proceeding. Bonanza Transportation
          reserves the right to modify or cancel reservations if conditions warrant. Full terms are available upon request.
        </div>
        <button type="button" id="openTermsModal" class="readmore-btn">View Full Terms</button>
      </div>
    </div>
        <!-- Botones -->
    <button id="calculate" disabled>Calculate Price</button>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- PAY NOW movido debajo del mapa -->
    <button id="pay" disabled style="display:none">PAY NOW</button>

    <!-- Resumen -->
       <div id="info"></div>
    <!-- Reschedule (solo CN + botón que redirige) -->
<section id="reschedule" style="margin-top:24px;">
  <h3 style="color:#ffddae;margin:0 0 8px;">Reschedule</h3>

  <label for="cn">Reservation Code (CN)</label>
  <div style="display:flex; gap:8px; align-items:center;">
    <input id="cn" type="text" placeholder="BZ-TEST-01" required style="flex:1 1 auto;" />
    <button type="button" id="btnLoadCN" class="veh-btn" style="width:auto; padding:10px 14px;">
      Load Reservation
    </button>
  </div>
</section>

<script>
  // Redirige a reschedule.html con ?cn=...
  document.getElementById('btnLoadCN')?.addEventListener('click', () => {
    const cn = (document.getElementById('cn')?.value || '').trim();
    if (!cn) { alert('Enter your reservation code'); return; }
    window.location.href = `/reschedule.html?cn=${encodeURIComponent(cn)}`;
  });
</script>
        <div><strong>CN:</strong> ${b.confirmation_number}</div>
        <div><strong>Status:</strong> ${b.status}</div>
        <div><strong>Current:</strong> ${b.date_iso} ${b.time_hhmm}</div>
        <div><strong>From:</strong> ${b.pickup}</div>
        <div><strong>To:</strong> ${b.dropoff}</div>
      `;

      // preparar min 24h
      const minDt = earliestAllowedDt();
      newDate.min = localISODate(minDt);
      if(!newDate.value) newDate.value = localISODate(minDt);
      if(!newTime.value) setTimeValue(newTime, minDt.getHours(), minDt.getMinutes());

      // enviar reschedule
      resForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        result.textContent = 'Submitting…'; result.className = 'hint';

        const body = {
          cn: b.confirmation_number,
          newDate: newDate.value,
          newTime: newTime.value
        };

        try{
          const r = await fetch('/api/book/reschedule', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          const j = await r.json();

          if(!r.ok || !j?.ok){
            throw new Error(j?.error || `Error (${r.status})`);
          }

          result.textContent = `✅ Rescheduled to ${j.booking.date_iso} ${j.booking.time_hhmm}`;
          result.className = 'hint ok';
        }catch(err){
          result.textContent = '❌ ' + (err?.message || 'Reschedule failed');
          result.className = 'hint err';
        }
      });

    }catch(err){
      status.textContent = '❌ ' + (err?.message || 'Unable to load reservation');
    }
  })();
})();
</script>
        <!-- Modal Términos -->
    <div class="modal-backdrop" id="termsModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-labelledby="termsTitle" aria-modal="true">
        <div class="modal-header">
          <h2 id="termsTitle" class="modal-title">Terms & Conditions</h2>
          <button id="closeTerms" class="close-btn">Close</button>
        </div>
        <div class="modal-body" style="line-height:1.6">
  <h3 style="margin:0 0 8px;color:#ffddae">Terms and Conditions</h3>
  <div style="opacity:.85;margin-bottom:8px">Bonanza Transportation — Last updated: 2024</div>
  <div class="divider" style="height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:8px 0 14px"></div>

  <h4 style="color:#ffddae;margin:10px 0 6px">1. Introduction and Acceptance</h4>
  <p>Welcome to Bonanza Transportation. By booking, hiring, or using our services, you agree to comply with these Terms and Conditions. We reserve the right to modify them at any time; updated versions will be available on our website and will take effect immediately.</p>

  <h4 style="color:#ffddae;margin:10px 0 6px">2. Definitions</h4>
  <ul>
    <li><strong>Client:</strong> The individual or entity booking services from Bonanza Transportation.</li>
    <li><strong>Service:</strong> Private transportation provided by Bonanza Transportation, including airport pickups, events, transfers, and private trips.</li>
    <li><strong>Booking:</strong> A confirmed service agreement with Bonanza Transportation.</li>
    <li><strong>Cancellation:</strong> Termination of a confirmed booking.</li>
    <li><strong>Fare:</strong> The agreed price for the contracted service.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">3. Bookings and Payments</h4>
  <ul>
    <li>Bookings must be made in advance via our website, mobile app, text message, phone, or email.</li>
    <li>Payments may be made by credit/debit card or secure platforms such as Stripe.</li>
    <li>Bonanza Transportation may require partial or full payment at the time of booking confirmation.</li>
    <li>All fares are quoted in U.S. Dollars (USD) and include applicable taxes unless otherwise stated.</li>
    <li>All information provided by the client is their sole responsibility. Bonanza Transportation will honor details exactly as written; we are not responsible for errors or omissions caused by typos or incorrect information.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">4. Cancellation and Rescheduling Policy</h4>
  <ul>
    <li>More than 24 hours before service: rescheduling at no cost, subject to availability.</li>
    <li>Within 24 hours before service: rescheduling allowed with a 50% fee of the agreed fare.</li>
    <li>Rescheduling must be confirmed directly with Bonanza Transportation via phone or email.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">5. No-Show and Waiting Times</h4>
  <ul>
    <li>A “No-Show” will be considered if the client does not arrive at the agreed location and time without prior notice.</li>
    <li>Included waiting time: non-airport — up to 20 minutes; airport pickups — up to 1 hour after landing if the flight is on time.</li>
    <li>After this period, additional waiting charges will apply.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">6. Flight Delays</h4>
  <ul>
    <li>We monitor flights to adjust pickup times.</li>
    <li>If the flight is delayed, we will make every effort to pick up the client at the new arrival time.</li>
    <li>If the delay is excessive and we cannot wait, the service may be rescheduled subject to availability.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">7. Luggage and Personal Belongings</h4>
  <ul>
    <li>The client is responsible for informing us at the time of booking about the quantity and size of luggage.</li>
    <li>Bonanza Transportation is not liable for damage or loss of personal belongings left in the vehicle.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">8. Client Conduct</h4>
  <ul>
    <li>Smoking, drinking alcohol, or using illegal substances inside the vehicles is prohibited.</li>
    <li>Respect towards the driver and vehicle is required.</li>
    <li>The driver may refuse service if the client exhibits aggressive, unsafe, or unlawful behavior.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">9. Limitation of Liability</h4>
  <ul>
    <li>Bonanza Transportation will not be liable for delays, losses, or damages caused by circumstances beyond our control, such as traffic, weather conditions, accidents, or force majeure events.</li>
    <li>Claims for indirect losses, loss of income, or consequential damages will not be accepted.</li>
  </ul>

  <h4 style="color:#ffddae;margin:10px 0 6px">10. Insurance</h4>
  <p>All our services are covered by commercial insurance in accordance with the laws of the State of Utah.</p>

  <h4 style="color:#ffddae;margin:10px 0 6px">11. Privacy and Personal Data</h4>
  <p>Personal information provided by the client will be treated confidentially and used solely for purposes related to the provision of the service, in accordance with our Privacy Policy.</p>

  <h4 style="color:#ffddae;margin:10px 0 6px">12. Jurisdiction</h4>
  <p>These terms are governed by the laws of the State of Utah, USA. Any dispute will be submitted to the competent courts of Utah.</p>

  <div class="divider" style="height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:14px 0"></div>
  <p><strong>Contact</strong><br>
  📱 Text messages only: (786) 683-5128<br>
  📧 Email: bonanzatransportation1@outlook.com<br>
  📍 Park City, Utah — USA</p>
</div>
 </div>
    </div>
        <script>
/* ===== Config ===== */
const SUV_IMG = "/images/suburban.png";
const VAN_IMG = "/images/van-sprinter.png";

/* ===== Globals ===== */
let map, directionsService, directionsRenderer, geocoder;
const BASE_ADDRESS = "13742 N Jordanelle Pkwy, Kamas, UT";
          // === FlightCheck (Cloud Run) ===
// Reemplaza por tu URL exacta (la que ves en Cloud Run).
// Ejemplo: https://flightcheck-7728622851.us-west3.run.app
const FLIGHTCHECK_URL = "https://flightcheck-7728622851.us-west3.run.app/flight";
          // Evita que respuestas viejas sobreescriban el estado (debounce por secuencia)
let __flightSeq = 0;
let pickupPlace = null, dropoffPlace = null;
let selectedVehicle = 'suv';
/* ===== Operating hours (6:00–23:00) ===== */
const OPERATING_START = "06:00";
const OPERATING_END   = "23:00";

/* ===== Pricing (tabla oficial) ===== */
function calculateBase(mi){
  if (mi <= 10) return 120;
  if (mi <= 35) return 190;
  if (mi <= 39) return 210;
  if (mi <= 48) return 230;
  if (mi <= 55) return 250;
  return mi * 5.4;
}
function applyVehicleMultiplier(total){
  return (selectedVehicle === 'van') ? Math.round(total * 1.30) : total;
}
function recalcFromCache(){
  const el = document.getElementById('info');
  if (!el || window.__lastBase == null) return;
  const base = window.__lastBase, surcharge = window.__lastSurcharge||0, ahFee = window.__lastAhFee||0;
 const finalTotal = applyVehicleMultiplier(base + surcharge + ahFee + getMGFee());
  const priceEl = el.querySelector('.kpi .value.price');
  const totalEl = el.querySelector('.row.total span:last-child');
  if (priceEl) priceEl.textContent = `$${finalTotal.toFixed(2)}`;
  if (totalEl) totalEl.textContent = `$${finalTotal.toFixed(2)}`;
  window.__lastQuotedTotal = finalTotal;
  window.__vehicleType = selectedVehicle;
}
// ====== Validación mínima antes de calcular precio ======

// Lista de IDs de campos básicos
const requiredFields = [
  'fullname','phone','email',
  'pickup','dropoff',
  'date','time'
];

// Revisa campos y aplica/quita .invalid
function validateForm(){
  let valid = true;
  requiredFields.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    if(!el.value || el.value.trim()===""){
      el.classList.add("invalid");
      valid = false;
    } else {
      el.classList.remove("invalid");
    }
  });
  return valid;
}

// Cuando se presiona "Calculate Price"
document.getElementById("calculate")?.addEventListener("click", function(e){
  if(!validateForm()){
    e.preventDefault(); // detiene cálculo si faltan campos
   alert("Please complete all required fields.");
    return;
  }

  // 👉 Aquí continúa tu lógica normal de cálculo
  console.log("Todo listo para calcular precio ✅");
});
/* ===== Time helpers ===== */
function nextQuarter(d){ const m=d.getMinutes(); const add=15-(m%15||15); d.setMinutes(m+add,0,0); return d; }
function localISODate(d){ const off=d.getTimezoneOffset()*60000; return new Date(d-off).toISOString().slice(0,10); }
function setTimeValue(el,h,m){ if(el) el.value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }

/* MOD/ADDED (acordado): mínimo 24h */
function earliestAllowedDt(){ return nextQuarter(new Date(Date.now() + 24*60*60*1000)); }

function mountDateTime(){
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  const dateHelp = document.getElementById('dateHelp');
  const timeHelp = document.getElementById('timeHelp');

  const minDt = earliestAllowedDt();              /* MOD */
  if(dateEl) dateEl.min = localISODate(minDt);    /* MOD */

  if(dateEl && !dateEl.value) dateEl.value = localISODate(minDt);  /* MOD */
  if(timeEl && !timeEl.value) setTimeValue(timeEl, minDt.getHours(), minDt.getMinutes()); /* MOD */

  function update(){
    if(dateHelp && dateEl?.value){
      const d = new Date(dateEl.value + 'T00:00:00');
      dateHelp.textContent = `Selected: ${d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})} (min 24h)`;
    }
    if(timeHelp && timeEl?.value){ timeHelp.textContent = `Selected: ${timeEl.value}`; }
  }
  dateEl?.addEventListener('change', update);
  timeEl?.addEventListener('change', update);
  update();
}

/* After-hours helper (sin cambios de reglas) */
function isAfterHours(dateStr, timeStr){
  if(!dateStr || !timeStr) return false;
  const d = new Date(`${dateStr}T${timeStr}:00`);
  const [sh,sm] = OPERATING_START.split(':').map(Number);
  const [eh,em] = OPERATING_END.split(':').map(Number);
  const start = new Date(d); start.setHours(sh, sm, 0, 0);
  const end   = new Date(d); end.setHours(eh, em, 0, 0);
  return (d < start) || (d > end);
}
          /* ===== Google Places helpers ===== */
function isAirport(place){
  const t = place?.types || [];
  return t.includes("airport") || /airport/i.test(place?.name || place?.formatted_address || "");
}
function isUtah(place){
  const addr=(place?.formatted_address||'').toLowerCase();
  return /\but\b/.test(addr) || /, ut(ah)?\b/.test(addr);
}
// ===== Autofill para JSX en Special Instructions (sin validaciones) =====
const JSX_MARK = "[AUTO-JSX]";  // identifica que el texto lo puso el sistema

function buildJSXNote() {
  const origin = (document.getElementById("flightOrigin")?.value || "").trim();
  const date   = (document.getElementById("date")?.value || "").trim();
  const time   = (document.getElementById("time")?.value || "").trim();
  const eta    = (date && time) ? `${date} ${time}` : "";

  return `${JSX_MARK}
Pick up at the JSX terminal
Please include your arrival time${eta ? ` (${eta})` : ""} and origin city${origin ? ` (${origin})` : ""}.`;
}

function writeJSXNote() {
  const ta = document.getElementById("specialInstructions");
  if (!ta) return;
  // Solo autocompleta si está vacío o ya era auto-generado
  if (!ta.value || ta.value.startsWith(JSX_MARK)) {
    ta.value = buildJSXNote();
  }
}

function clearJSXNote() {
  const ta = document.getElementById("specialInstructions");
  if (!ta) return;
  // Si era auto-generado, lo dejamos vacío para que se vea el placeholder normal
  if (ta.value.startsWith(JSX_MARK)) ta.value = "";
}

// Si cambian origen/fecha/hora y la nota era auto-generada, la refrescamos
["flightOrigin","date","time"].forEach(id=>{
  document.getElementById(id)?.addEventListener("input", () => {
    const ta = document.getElementById("specialInstructions");
    if (ta && ta.value.startsWith(JSX_MARK)) ta.value = buildJSXNote();
  });
});        
/* Heurística FBO (aeropuerto privado) en Utah */
const FBO_KEYWORDS = /\b(fbo|jet center|private terminal|general aviation|hangar|atlantic aviation|million air|signature( aviation| flight| support)?|ross aviation|tac air|ok3 air|provo jet center|sheltair|jet linx|jet aviation|magellan jets|aero charter|aero center|modern aviation|banyan air service|cutter aviation|lynx|western aircraft)\b/i;

function isPrivateUtahAirport(place){
  if(!place) return false;
  if(!isAirport(place) || !isUtah(place)) return false;
  const text = `${place.name||""} ${place.formatted_address||""}`;
  return FBO_KEYWORDS.test(text);
}
function pickupIsUtahAirport(){ return pickupPlace && isAirport(pickupPlace) && isUtah(pickupPlace); }
/* === SLC helpers para visibilidad de Meet & Greet === */
/* Detecta el aeropuerto comercial SLC (no FBO) por nombre/dirección y “SLC” */
function isSLCInternational(place){
  if(!place) return false;
  const name = (place.name || "").toLowerCase();
  const addr = (place.formatted_address || "").toLowerCase();
  // Coincidencias típicas que devuelve Google Places
  const hitsName = /salt lake city international/.test(name) || /\bslc\b/.test(name);
  const hitsAddr = /salt lake city international/.test(addr) || /\bslc\b/.test(addr);
  // Aseguramos que sea aeropuerto “grande” y no un FBO
  return (hitsName || hitsAddr) && isAirport(place) && !isPrivateUtahAirport(place);
}
 // === Provo Airport (PVU) ===
// Detecta el aeropuerto de Provo (comercial regional) y evita FBOs.
function isProvoAirport(place){
  if(!place) return false;
  const name = (place.name || "").toLowerCase();
  const addr = (place.formatted_address || "").toLowerCase();

  // Señales por nombre o IATA
  const nameHit =
    /\bprovo\b/.test(name) ||                 // “Provo …”
    /\bpvu\b/.test(name)  ||                  // IATA PVU
    /municipal/.test(name) ||                 // “Provo Municipal …”
    /regional/.test(name);                    // “Provo Regional …” (por si acaso)

  // Señales por dirección conocidas
  const addrHit =
    (/\bprovo\b/.test(addr) && /\but\b/.test(addr)) ||
    /\b84601\b/.test(addr) ||
    /mike\s*jense\s*pkwy/.test(addr);

  // Debe ser aeropuerto en Utah y no FBO
  return (nameHit || addrHit) && isAirport(place) && isUtah(place) && !isPrivateUtahAirport(place);
}
// Solo SLC, Provo o JSX en Utah activan la captura de vuelo
function isCommercialPickup(place){
  return !!place && isUtah(place) && (
    isSLCInternational(place) ||
    isProvoAirport(place) ||
    isJSXUtah(place)
  );
}
// ARRIVAL = el pickup es SLC o JSX (no aplica si solo el drop-off es aeropuerto)
function isArrivalAtAirport(){
  return !!pickupPlace && isCommercialPickup(pickupPlace);
}     
/* “Arrival en SLC” = cuando el PICK-UP es SLC comercial (si es drop-off SLC, NO aplica) */
function isArrivalAtSLC(){
  return !!pickupPlace && isSLCInternational(pickupPlace);
}
function countyFrom(place){
  const comps=place?.address_components||[];
  const c=comps.find(x=>x.types?.includes("administrative_area_level_2"));
  return c?.long_name||"";
}
function routeAsync(opts){ return new Promise((res,rej)=>{ directionsService.route(opts,(r,s)=> s==="OK"&&r?res(r):rej(s||"ROUTE_ERROR")); }); }
function geocodeAsync(req){ return new Promise((res,rej)=>{ geocoder.geocode(req,(results,status)=>{ if(status==="OK"&&results?.[0]) res(results[0]); else rej(status||"GEOCODE_ERROR"); }); }); }
async function countyByPlaceId(placeId){ try{ const r=await geocodeAsync({placeId}); const c=r.address_components.find(c=>c.types.includes("administrative_area_level_2")); return c?.long_name||""; }catch(_){ return ""; } }
async function computeMilesFromBase(placeId){ const r=await routeAsync({origin:BASE_ADDRESS,destination:{placeId},travelMode:google.maps.TravelMode.DRIVING}); return r.routes[0].legs[0].distance.value/1609.34; }


/* ===== Vuelo comercial ===== */
const AIRLINES = new Set(["AA","DL","UA","WN","AS","B6","F9","NK","HA","AC","AM","AF","BA","KL","LH","VS","IB","TK","QR","EK","CM","AV","QF","CX","AZ","SK","LA","AR","TS","WS","DY","NH","JL","KE","XE"]);
const FLIGHT_REGEX = /^([A-Z0-9]{2})\s?-?\s?(\d{1,4})([A-Z])?$/;

function normalizeFlight(v){
  return (v||'').toUpperCase().trim().replace(/\s+/g,' ').replace('–','-');
}

/* Extrae IATA del campo "Flight Origin" (acepta "Miami (MIA)" o "MIA") */
function parseOriginIata(text){
  const t = (text || "").trim().toUpperCase();
  const m = t.match(/\(([A-Z]{3})\)$/);   // termina en "(MIA)"
  if (m) return m[1];
  if (/^[A-Z]{3}$/.test(t)) return t;     // solo "MIA"
  return null;                             // otro formato (ciudad sin IATA)
}
// Intenta derivar un IATA cuando el usuario selecciona una ciudad con Autocomplete
function cityPlaceToIata(place){
  if(!place) return "";
  const name = (place.name || "").toUpperCase();

  // Mapa mínimo (puedes ampliarlo luego)
  const MAP = {
    "BOSTON": "BOS",
    "MIAMI": "MIA",
    "LAS VEGAS": "LAS",
    "LOS ANGELES": "LAX",
    "NEW YORK": "JFK",
    "SAN FRANCISCO": "SFO",
    "DALLAS": "DFW",
    "DENVER": "DEN",
    "CHICAGO": "ORD",
    "HOUSTON": "IAH",
    "PHOENIX": "PHX",
    "ATLANTA": "ATL",
    "SEATTLE": "SEA"
  };

  if (MAP[name]) return MAP[name];

  // Heurísticas básicas
  if (/MIAMI/.test(name)) return "MIA";
  if (/LAS\s*VEGAS/.test(name)) return "LAS";
  if (/BOSTON/.test(name)) return "BOS";
  if (/LOS\s*ANGELES/.test(name)) return "LAX";
  if (/NEW\s*YORK/.test(name)) return "JFK";
  if (/SAN\s*FRANCISCO/.test(name)) return "SFO";

  return "";}
function validateFlightValue(v){
  const m = normalizeFlight(v).match(FLIGHT_REGEX);
  if (!m) return {ok:false,msg:'Invalid format. Use AA1234 or WN 987.'};
  const code = m[1], num = m[2];
  if(!AIRLINES.has(code)) return {ok:false,msg:'Unknown airline code.'};
  if(/^0+$/.test(num)) return {ok:false,msg:'Invalid flight number.'};
  return {ok:true,msg:''};
}
// --- Validación en vivo del Flight Number (DL1234, WN 987, etc.)
function wireFlightValidation(){
  const input = document.getElementById('flightNumber');
  const hint  = document.getElementById('flightHint');
  if(!input || !hint) return;

  function update(){
    const r = validateFlightValue(input.value || "");
    // Mensaje y clases
    hint.textContent = r.ok ? "Format looks good" : r.msg;
    hint.className   = "hint " + (r.ok ? "ok" : "err");
    // Constraint para el formulario
    input.setCustomValidity(r.ok ? "" : r.msg);
  }

  input.addEventListener('input', update);
  // Disparo inicial por si ya hay valor
  update();
}         
/* ===== Private Jet ===== */
const N_NUMBER_REGEX = /^N[1-9]\d{0,4}([A-HJ-NP-Z]{1,2})?$/i;
function validateNNumber(v){
  const val=(v||"").toUpperCase().trim();
  if(!val) return {ok:false,msg:"Please enter the aircraft tail number (e.g., N123AB)."};
  if(!N_NUMBER_REGEX.test(val)) return {ok:false,msg:"Format: N + 1–5 digits + optional 1–2 letters (no I/O)."};
  return {ok:true,msg:"Tail number captured."};
}
function validateCityLike(v, label="origin city"){
  const val=(v||"").trim();
  if(!val) return {ok:false,msg:`Please enter the ${label} (e.g., Van Nuys or Van Nuys (VNY)).`};
  const ok = /^[A-Za-z .,'-]{2,}( \([A-Z]{3}\))?$/.test(val);
  return ok ? {ok:true,msg:`${label[0].toUpperCase()+label.slice(1)} captured.`} : {ok:false,msg:`Use letters and optional airport code, e.g., Van Nuys (VNY).`};
}
          function isJSXUtah(place){
  if (!place) return false;
  const text = (place.name || place.formatted_address || "").toUpperCase();
  return text.includes("JSX");
}
/* === Mostrar/ocultar secciones según tipo de aeropuerto (comercial vs privado) === */
function updateFlightVisibility(){
  const jsxNote = document.getElementById("jsxNote");
  const commWrap = document.getElementById('flightContainer');
  const commNum  = document.getElementById('flightNumber');
  const commHint = document.getElementById('flightHint');
  const commOrig = document.getElementById('flightOrigin');
  const commOrigHelp = document.getElementById('originHelp');

  const pvtWrap  = document.getElementById('privateFlightContainer');
  const tail     = document.getElementById('tailNumber');
  const tailHelp = document.getElementById('tailHelp');
  const pvtOrig  = document.getElementById('pvtOrigin');
  const pvtOrigHelp = document.getElementById('pvtOriginHelp');

  const place = pickupPlace;
  const isAirportUT = !!place && isAirport(place) && isUtah(place);
  const isComm      = isCommercialPickup(place);   // SLC / PVU / SGU / JSX
  // Mostrar/ocultar la nota elegante solo para JSX
if (jsxNote) {
  const isJSX = isJSXUtah(place);
  jsxNote.style.display = isJSX ? "block" : "none";
}

  // 1) Aeropuertos comerciales -> Flight Number + Flight Origin
  if (commWrap){
    const showComm = isComm;
    commWrap.style.display = showComm ? 'block' : 'none';
    if(!showComm){
      if(commNum){  commNum.value="";  commNum.setCustomValidity(""); }
      if(commHint){ commHint.style.display='none'; }
      if(commOrig){ commOrig.value=""; commOrig.setCustomValidity(""); }
      if(commOrigHelp){ commOrigHelp.style.display='none'; }
    }
    initFlightOriginAutocomplete();   // <<— nuevo
  }
  // 2) Aeropuertos de Utah que NO son comerciales -> Tail Number + Origin privado
  if (pvtWrap){
    const showPvt = isAirportUT && !isComm;
    pvtWrap.style.display = showPvt ? 'block' : 'none';
    if(!showPvt){
      if(tail){ tail.value=""; tail.setCustomValidity(""); }
      if(tailHelp){ tailHelp.style.display='none'; }
      if(pvtOrig){ pvtOrig.value=""; pvtOrig.setCustomValidity(""); }
      if(pvtOrigHelp){ pvtOrigHelp.style.display='none'; }
    }
  }

  // 3) Si NO es aeropuerto -> ocultar ambas
  if(!isAirportUT){
    if(commWrap) commWrap.style.display = 'none';
    if(pvtWrap)  pvtWrap.style.display  = 'none';
  }
}
const getDateISO = () => {
  const v = (document.getElementById('date')?.value || '').trim();
  if (!v) return '';
  // Convierte respetando la zona horaria local → YYYY-MM-DD
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return v; // fallback
  const localMs = d.getTime() - d.getTimezoneOffset() * 60000;
  return new Date(localMs).toISOString().slice(0, 10);
};
// === Autocomplete para Flight Origin ===
function initFlightOriginAutocomplete() {
  const input = document.getElementById("flightOrigin");
  if (!input) return;

  const autocomplete = new google.maps.places.Autocomplete(input, {
    types: ["(cities)"],
    fields: ["name", "place_id", "geometry"],
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place || !place.place_id) {
      console.warn("⚠️ No se seleccionó ciudad válida en Flight Origin");
      return;
    }
    console.log("✅ Ciudad seleccionada como origen:", place.name, place.place_id);
    // Aquí podrías guardar en variable global si lo necesitas:
    window._flightOrigin = place;
  });
}
/* ===== Llamada al backend (Cloud Run) + validación estricta ===== */

// Normalizador de número de vuelo (quita espacios, mayúsculas)
function normFlight(x) {
  return (x || "").replace(/\s+/g, "").toUpperCase(); 
}

// Normalizador de ciudad de origen (mayúsculas)
function normOrigin(x) {
  return (x || "").toUpperCase();
}
async function maybeCheckBackend() {
  const fl  = (document.getElementById("flightNumber")?.value || "").trim();
  const org = (document.getElementById("flightOrigin")?.value || "").trim();
  const dt = getDateISO(); // 👈 siempre devuelve YYYY-MM-DD limpio

  if (!fl || !org || !dt) return;

  // Normaliza el vuelo (ej: "DL 0464" -> "DL0464")
  const normFl = fl.replace(/\s+/g, "").toUpperCase();

  // Nuevo: obtenemos IATA del origen; si no hay, dejamos vacío
  const originIata = parseOriginIata(org) || "";

  const mySeq = ++__flightSeq;

  const hint = document.getElementById("flightHint");
  const originHelp = document.getElementById("originHelp");
  const backendRes = document.getElementById("backendResult");

  try {
    // IMPORTANTE: FLIGHTCHECK_URL ya debe incluir /flight
    const qs = new URLSearchParams({ fn: normFl, originIata, date: dt });
    const resp = await fetch(`${FLIGHTCHECK_URL}?${qs.toString()}`);

    if (!resp.ok) {
      if (hint) { hint.textContent = "✗ Flight not found"; hint.className="hint err"; hint.style.display="block"; }
      if (originHelp) { originHelp.textContent = "✗ Invalid origin"; originHelp.className="hint err"; originHelp.style.display="block"; }
      if (backendRes) backendRes.textContent = `Service error (${resp.status})`;
      return;
    }

    const data = await resp.json().catch(() => ({}));
    if (mySeq !== __flightSeq) return; // evita escribir si llegó una respuesta vieja

    if (data.ok) {
      if (hint) { hint.textContent = "✅ Flight confirmed"; hint.className = "hint ok"; hint.style.display = "block"; }
      if (originHelp) { originHelp.textContent = "✅ Origin city confirmed"; originHelp.className = "hint ok"; originHelp.style.display = "block"; }

      // Si llega arrivalLocal (o lo calculó el backend), autocompleta la hora HH:MM
      const t = String(data.arrivalLocal || "").match(/T(\d{2}:\d{2})/);
      if (t) {
        const timeEl = document.getElementById("time");
        if (timeEl) timeEl.value = t[1];
      }
      if (backendRes) backendRes.textContent = data.arrivalLocal ? `ETA: ${data.arrivalLocal}` : "No ETA provided";
    } else {
      if (hint) { hint.textContent = "✗ Flight not found"; hint.className="hint err"; hint.style.display="block"; }
      if (originHelp) { originHelp.textContent = data.msg || "✗ Invalid origin"; originHelp.className="hint err"; originHelp.style.display="block"; }
      if (backendRes) backendRes.textContent = data.msg || "Vuelo no válido";
    }
  } catch (e) {
    console.error(e);
    if (hint) { hint.textContent = "⚠️ Network error"; hint.className="hint err"; hint.style.display="block"; }
    if (backendRes) backendRes.textContent = "⚠️ Error consultando backend: " + e.message;
  }
}
/* ===== Disparadores para el backend ===== */
function wireFlightBackendTriggers(){
  const fn   = document.getElementById('flightNumber');
  const orig = document.getElementById('flightOrigin');
  const date = document.getElementById('date');

  const run = () => setTimeout(maybeCheckBackend, 200);
  if (fn)   fn.addEventListener('input', run);
  if (orig) orig.addEventListener('input', run);
  if (date) date.addEventListener('change', run);
}
 /* === Meet & Greet: SLC (UI + pricing) === */
window.__mgChoice = 'none';                          // default
function getMGFee(){ return window.__mgChoice !== 'none' ? 50 : 0; }

/* Se muestra solo si: vehículo = SUV y el PICK-UP es SLC comercial (no FBO). */
function shouldShowMeetGreet(){
  return selectedVehicle === 'suv' && isSLCInternational(pickupPlace || null);
}

function updateMeetGreetVisibility(){
  const card = document.getElementById('meetGreetCard');
  if(!card) return;

  const show = shouldShowMeetGreet();
  if(show){
    card.style.display = 'block';
    card.style.animation = 'mgFadeIn .25s ease';
  } else {
    // ocultar y reset
    card.style.display = 'none';
    window.__mgChoice = 'none';
    const btns = card.querySelectorAll('.mg-btn');
    btns.forEach(b=>{
      const on = (b.dataset.choice === 'none');
      b.classList.toggle('active', on);
      b.setAttribute('aria-pressed', String(on));
    });
    if (typeof recalcFromCache === 'function') recalcFromCache();
  }
}

/* Botones Meet & Greet */
(function wireMeetGreetButtons(){
  const card = document.getElementById('meetGreetCard');
  if(!card) return;
  const btns = Array.from(card.querySelectorAll('.mg-btn'));

  function activate(choice){
    window.__mgChoice = choice;
    btns.forEach(b=>{
      const on = b.dataset.choice === choice;
      b.classList.toggle('active', on);
      b.setAttribute('aria-pressed', String(on));
    });
    if (typeof recalcFromCache === 'function') recalcFromCache();
  }

  btns.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.choice)));
  activate('none'); // default
})();

/* Cambiar vehículo (asegura que se re-evalue Meet & Greet y cambia la foto) */
(function wireVehicleToggle(){
  const btns = document.querySelectorAll('.veh-btn');
  const carImg = document.querySelector('.turntable .car');
  const caption = document.querySelector('.turntable .vehicle-caption');
  if(!btns.length) return;

  btns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.veh-btn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      selectedVehicle = btn.dataset.type || 'suv';
      // 🔹 Actualizar imagen y caption según vehículo
      if (selectedVehicle === 'suv') {
        if (carImg) carImg.src = SUV_IMG;
        if (caption) caption.textContent = "SUV — Max 5 passengers, 5 suitcases";
      } else {
        if (carImg) carImg.src = VAN_IMG;
        if (caption) caption.textContent = "Van — Up to 12 passengers, luggage varies";
      }

      updateMeetGreetVisibility();
      recalcFromCache?.();
    });
  });
})();          
function renderInfo(leg, base, surcharge, afterHours){
  const miles = leg.distance.value / 1609.34;
  const mgFee = getMGFee();                // $50 si hay Meet & Greet
  const ahFee = afterHours ? (base + surcharge) * 0.20 : 0;

  window.__lastBase = base;
  window.__lastSurcharge = surcharge;
  window.__lastAhFee = ahFee;

  const finalTotal = applyVehicleMultiplier(base + surcharge + ahFee + mgFee);
  const hasExtra = (surcharge > 0) || (ahFee > 0) || (mgFee > 0);

  const el = document.getElementById("info");
  el.style.display = "block";
  el.innerHTML = `
    <h3 class="info-title">Trip Summary</h3>
    <div class="kpis">
      <div class="kpi"><div class="label">Distance</div><div class="value">${miles.toFixed(1)}<span class="unit">mi</span></div></div>
      <div class="kpi"><div class="label">Duration</div><div class="value">${leg.duration.text}</div></div>
      <div class="kpi"><div class="label">Price</div><div class="value price">$${finalTotal.toFixed(2)}</div></div>
    </div>

    ${hasExtra ? `
      <div class="divider"></div>
      <div class="breakdown">
        ${surcharge > 0 ? `<div class="row"><span>Distance Surcharge</span><span>$${surcharge.toFixed(2)}</span></div>` : ''}
        ${ahFee > 0 ? `<div class="row"><span>After-Hours Fee (20%)</span><span>$${ahFee.toFixed(2)}</span></div>` : ''}
        ${mgFee > 0 ? `<div class="row"><span>Meet & Greet (SLC)</span><span>$${mgFee.toFixed(2)}</span></div>` : ''}
      </div>
    ` : ''}
    
    <div class="row total"><span>Total</span><span>$${finalTotal.toFixed(2)}</span></div>
    <div class="tax-note">Taxes & gratuity included</div>
  `;

  window.__lastQuotedTotal = finalTotal;
  window.__lastDistanceMiles = miles;
  window.__vehicleType = selectedVehicle;
  syncButtons();
}
/* ===== Init Google Maps ===== */
function initMap(){
  // Map and services
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:40.7587,lng:-111.8762}, zoom:10
  });
  directionsService  = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  geocoder = new google.maps.Geocoder();

  // Autocomplete (restricted to US)
  const opts = {
    componentRestrictions:{country:["us"]},
    fields:["place_id","name","types","formatted_address","geometry","address_components"]
  };

  const pickupInput  = document.getElementById("pickup");
  const dropoffInput = document.getElementById("dropoff");

  const acPickup  = new google.maps.places.Autocomplete(pickupInput,  opts);
  const acDropoff = new google.maps.places.Autocomplete(dropoffInput, opts);

  // === Update UI depending on pickup location (SLC / PVU / JSX / FBO) ===
  function applyJSXUI(){
    updateFlightVisibility?.();    // Update SLC / JSX / FBO visibility
    updateMeetGreetVisibility?.(); // Re-evaluate Meet & Greet (SUV/SLC only)

    const jsxContainer    = document.getElementById("jsxContainer");
    const flightContainer = document.getElementById("flightContainer");

    if (isJSXUtah(pickupPlace)) {
      if (jsxContainer)    jsxContainer.style.display = "block";
      if (flightContainer) flightContainer.style.display = "none";
    } else {
      if (jsxContainer)    jsxContainer.style.display = "none";
      if (flightContainer) flightContainer.style.display =
        isCommercialPickup(pickupPlace) ? "block" : "none";
    }
  }

  // === Listeners: remove .invalid and sync buttons ===
  acPickup.addListener("place_changed", ()=>{
    pickupPlace = acPickup.getPlace() || null;
    pickupInput?.classList.remove('invalid');   // remove red highlight on valid input
    applyJSXUI();
    syncButtons?.();
  });

  acDropoff.addListener("place_changed", ()=>{
    dropoffPlace = acDropoff.getPlace() || null;
    dropoffInput?.classList.remove('invalid');  // remove red highlight on valid input
    syncButtons?.();
  });
}
window.initMap = initMap;   // <— MUY IMPORTANTE: fuera de la función

/* ===== Modal Read More (términos) ===== */
(function wireModalReadMore(){
  const content = document.getElementById('modal-terms-content');
  const btn = document.getElementById('modalReadMoreBtn');
  if(!content || !btn) return;
  btn.addEventListener('click', ()=>{
    const clamped = content.classList.toggle('clamped');
    const expanded = !clamped;
    btn.textContent = expanded ? 'Read Less' : 'Read More';
    btn.setAttribute('aria-expanded', String(expanded));
  });
})();

/* ===== Términos + botones ===== */
const acceptPill  = document.getElementById('acceptPill');
const calcBtn = document.getElementById('calculate');
const payBtn = document.getElementById('pay');

function setAcceptedState(on){
  if(!acceptPill) return;
  acceptPill.classList.toggle('on', on);
  acceptPill.setAttribute('aria-checked', on ? 'true' : 'false');
  syncButtons();
}
function isAccepted(){ return acceptPill?.classList.contains('on'); }
function syncButtons(){
  const accepted = isAccepted();
  if(calcBtn) calcBtn.disabled = !accepted;
  const readyPay = !!window.__lastQuotedTotal && accepted;
  if(payBtn){
    payBtn.disabled = !readyPay;
    payBtn.style.display = 'block';
    payBtn.style.opacity = readyPay ? 1 : .5;
    payBtn.style.cursor = readyPay ? 'pointer' : 'not-allowed';
  }
}
acceptPill?.addEventListener('click', ()=> setAcceptedState(!isAccepted()));
acceptPill?.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setAcceptedState(!isAccepted()); }});

/* ===== Email (igual a base) ===== */
(function wireEmail(){
  const input = document.getElementById('email');
  const help  = document.getElementById('emailHelp');
  if(!input) return;

  function validateEmail(v){
    const val = (v||'').trim();
    const basic = /^[^\s@]+@[^\s@]+\.[^\s@]{2,24}$/.test(val);
    if(!basic) return {ok:false,msg:'Please enter a valid email, e.g., name@domain.com'};
    if(/\.\./.test(val)) return {ok:false,msg:'Email cannot contain consecutive dots'};
    const typos = [/@gmal\.com$/i, /@gmial\.com$/i, /@hotnail\.com$/i, /@yaho\.com$/i];
    if(typos.some(rx=>rx.test(val))) return {ok:false,msg:'Please correct the domain spelling (e.g., @gmail.com)'};
    return {ok:true,msg:'Email looks good'};
  }

  input.addEventListener('input', ()=>{
    const r = validateEmail(input.value);
    input.setCustomValidity(r.ok ? '' : r.msg);
    if(help){
      help.textContent = r.ok ? 'Valid email' : r.msg;
      help.className = 'hint ' + (r.ok ? 'ok' : 'err');
    }
  });

  input.addEventListener('blur', ()=> {
    if(!input.checkValidity() && help){
      help.className = 'hint err';
    }
  });
})();

/* ===== Teléfono US (igual a base) ===== */
(function wirePhone(){
  const input = document.getElementById('phone');
  const help  = document.getElementById('phoneHelp');
  if(!input) return;

  function formatUS(digits){
    if(digits.startsWith('1')) digits = digits.slice(1);
    digits = digits.slice(0,10);
    const a = digits.slice(0,3), b = digits.slice(3,6), c = digits.slice(6,10);
    if(digits.length > 6) return `(${a}) ${b}-${c}`;
    if(digits.length > 3) return `(${a}) ${b}`;
    if(digits.length > 0) return `(${a}`;
    return '';
  }
  function validateNANP(digits){
    if(digits.length===11 && digits.startsWith('1')) digits = digits.slice(1);
    if(digits.length!==10) return {ok:false,msg:'Enter a 10-digit US number'};
    if(!/^[2-9]/.test(digits[0])) return {ok:false,msg:'Area code must start 2–9'};
    if(!/^[2-9]/.test(digits[3])) return {ok:false,msg:'Exchange must start 2–9'};
    return {ok:true,msg:'Valid US number'};
  }

  input.addEventListener('input', ()=>{
    const digits = input.value.replace(/\D/g,'').slice(0,11);
    input.value = formatUS(digits);
    const v = validateNANP(digits);
    input.setCustomValidity(v.ok ? '' : v.msg);
    if(help){
      help.textContent = v.ok ? 'Valid US number' : v.msg;
      help.className = 'hint ' + (v.ok ? 'ok' : 'err');
    }
  });

  input.addEventListener('blur', ()=> {
    if(!input.checkValidity() && help){
      help.className = 'hint err';
    }
  });
})();

/* ===== MOD/ADDED (acordado): alertas para Pick‑up / Drop‑off vacíos ===== */
(function wirePickupDropoffAlerts(){
  const pickup  = document.getElementById('pickup');
  const dropoff = document.getElementById('dropoff');
  pickup?.addEventListener('blur', ()=>{
    if(!pickup.value.trim()){ alert('Please enter the Pick-up Address.'); pickup.focus(); }
  });
  dropoff?.addEventListener('blur', ()=>{
    if(!dropoff.value.trim()){ alert('Please enter the Drop-off Address.'); dropoff.focus(); }
  });
})();

/* ===== Helpers 24h ===== */
/* Ya fijamos min por defecto en mountDateTime(); aquí validamos al calcular */
function getSelectedDateTime(){
  const ds = document.getElementById('date')?.value;
  const ts = document.getElementById('time')?.value;
  if(!ds || !ts) return null;
  return new Date(`${ds}T${ts}:00`);
}
function isAtLeast24hAhead(d){
  if(!d) return false;
  const now = new Date();
  return d.getTime() - now.getTime() >= 24*60*60*1000;
}

/* ===== Calculate (con validaciones mínimas acordadas) ===== */
calcBtn?.addEventListener("click", async ()=>{
  if (!isAccepted()){
    alert("Please accept Terms & Conditions first.");
    return;
  }

  /* MOD/ADDED: pick-up/drop-off no vacíos */
  const pickupStr  = document.getElementById('pickup')?.value.trim();
  const dropoffStr = document.getElementById('dropoff')?.value.trim();
  if(!pickupStr){ alert("Pick-up Address is required."); return; }
  if(!dropoffStr){ alert("Drop-off Address is required."); return; }

  /* MOD/ADDED: fecha/hora mínimo 24h de antelación */
  const selDt = getSelectedDateTime();
  if(!selDt || !isAtLeast24hAhead(selDt)){
    alert("Please choose a Date & Time at least 24 hours in advance.");
    return;
  }

  if (!pickupPlace?.place_id || !dropoffPlace?.place_id){
    alert("Please select addresses from the suggestions.");
    return;
  }

  try{
    const trip = await routeAsync({
      origin:{placeId: pickupPlace.place_id},
      destination:{placeId: dropoffPlace.place_id},
      travelMode: google.maps.TravelMode.DRIVING
    });
    directionsRenderer.setDirections(trip);
    const leg = trip.routes[0].legs[0];
    const miles = leg.distance.value/1609.34;
    const basePrice = calculateBase(miles);
    let surcharge = 0;

    const pickupAir = isAirport(pickupPlace);
    let pickupCounty = countyFrom(pickupPlace) || await countyByPlaceId(pickupPlace.place_id);
    let dropCounty   = countyFrom(dropoffPlace) || await countyByPlaceId(dropoffPlace.place_id);
    const pickupAllowed = /Summit County|Wasatch County/.test(pickupCounty||"");
    const dropAllowed   = /Summit County|Wasatch County/.test(dropCounty||"");

    if (pickupAir){
      if (!dropAllowed){ const m = await computeMilesFromBase(pickupPlace.place_id); surcharge = m * 3; }
    }else{
      if (!pickupAllowed){ const m = await computeMilesFromBase(pickupPlace.place_id); surcharge = m * 3; }
    }

    const afterHours = isAfterHours(document.getElementById("date").value, document.getElementById("time").value);
    renderInfo(leg, basePrice, surcharge, afterHours);
    if(payBtn) payBtn.style.display = "block";
    syncButtons();
  }catch(err){
    alert("Could not calculate route: " + err);
  }
});

/* ===== PAY (sin cambios, solo lo acordado se mantiene) ===== */
function generateConfirmationNumber(){
  const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  const rand=Math.random().toString(36).slice(2,6).toUpperCase();
  return `BZ-${y}${m}${day}-${rand}`;
}
/* ===== Luggage Accordion ===== */
(function wireLuggageAccordion(){
  const acc = document.getElementById('luggageAccordion');
  const sum = document.querySelector('#luggageAccordion .luggage-summary');
  if(!acc || !sum) return;
  sum.addEventListener('click', ()=>{
    const open = acc.classList.toggle('open');
    acc.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
})();

/* ===== Modal abrir/cerrar ===== */
(function wireTermsModal(){
  const modal   = document.getElementById('termsModal');
  const openBtn = document.getElementById('openTermsModal');
  const closeBtn= document.getElementById('closeTerms');

  function openModal(){
    if(!modal) return;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    closeBtn?.focus();
  }
  function closeModal(){
    if(!modal) return;
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    openBtn?.focus();
  }
  openBtn?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=> { if(e.target === modal) closeModal(); });
  document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && modal?.classList.contains('open')) closeModal(); });
})();
// ====== Limpieza en vivo de campos inválidos ======
function wireLiveCleanup(){
  const ids = [
    'fullname','phone','email','pickup','dropoff',
    'date','time',
    // Condicionales (si existen en tu HTML)
    'flightNumber','flightOrigin',      // SLC/PVU
    'jsxFlightNumber','jsxOrigin',      // JSX
    'tailNumber','pvtOrigin'            // FBO
  ];

  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    const evt = (el.type === 'date' || el.type === 'time') ? 'change' : 'input';
    el.addEventListener(evt, ()=>{
      const hasValue = (el.value || '').trim() !== '';
      const ok = typeof el.checkValidity === 'function' ? el.checkValidity() : true;
      if (hasValue && ok) el.classList.remove('invalid');
    });
  });
}        
/* ===== On Load ===== */
document.addEventListener('DOMContentLoaded', () => {
  mountDateTime();          // fija mín 24h y valores por defecto
  wireFlightValidation();   // validaciones vuelo
  wireFlightBackendTriggers(); // disparadores backend (llamadas a Cloud Run)
  wireLiveCleanup();        // 👈 activa limpieza en vivo
  syncButtons();
  setTimeout(maybeCheckBackend, 100);
});
</script>
<!-- Google Maps Loader -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap"></script>
<!-- Stripe.js (OBLIGATORIO) -->
<script src="https://js.stripe.com/v3"></script>
<script>
  // Tu Publishable Key (pk_live_...)
  const STRIPE_PK = 'pk_live_51Rr9g0LxdVPME4zrYzx4WKgoT3NUZBSkWbwMnSmGPQCyE4MzzIufo6gM8EvLeTHOjQ5Vcn2V1GY0D9RrcJrOjRCd002MQFljOF';

  // NO redeclaramos 'payBtn' ni 'isAccepted' para evitar el error
  // "Identifier 'payBtn' has already been declared". Usamos un alias local.
  (function attachStripe(){
    const btn = document.getElementById('pay');
    if (!btn) return;

    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      // isAccepted() ya existe en tu JS de términos
      if (typeof isAccepted === 'function' && !isAccepted()) {
        alert('Please accept Terms & Conditions first.');
        return;
      }

      const total = Number(window.__lastQuotedTotal);
      if (!total || Number.isNaN(total)) {
        alert('Please calculate a price first.');
        return;
      }

      // Validación mínima de campos
      const requiredIds = ['fullname','phone','email','pickup','dropoff'];
      let missing = [];
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        const empty = !el || !el.value || el.value.trim() === '';
        if (el) el.classList.toggle('invalid', empty);
        if (empty) missing.push(id);
      });
      if (missing.length) { alert('Please complete all required fields.'); return; }

      const amount = Math.round(total * 100);

      // generateConfirmationNumber() ya existe en tu JS; si no, quita esta llamada o define la función
      const payload = {
        amount,
        fullname: document.getElementById('fullname').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        pickup: document.getElementById('pickup').value,
        dropoff: document.getElementById('dropoff').value,
        specialInstructions: document.getElementById('specialInstructions')?.value || null,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        flightNumber: document.getElementById('flightNumber')?.value || null,
        flightOriginCity: document.getElementById('flightOrigin')?.value || null,
        tailNumber: document.getElementById('tailNumber')?.value || null,
        privateFlightOriginCity: document.getElementById('pvtOrigin')?.value || null,
        vehicleType: window.__vehicleType || 'suv',
        distanceMiles: window.__lastDistanceMiles || null,
        quotedTotal: window.__lastQuotedTotal || null,
        confirmationNumber: (typeof generateConfirmationNumber === 'function')
          ? generateConfirmationNumber()
          : ''
      };

      try {
        const resp = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data?.id) {
          throw new Error(data?.error || `Bad response (${resp.status})`);
        }

        const stripe = Stripe(STRIPE_PK);
        const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
        if (error) alert(error.message);
      } catch (e) {
        alert('Payment error: ' + (e?.message || e));
        console.error(e);
      }
    });
  })();
</script>
<script>
// ===== Init campos de reschedule: min 24h y default =====
(function initRescheduleMin(){
  const d = document.getElementById('newDate');
  const t = document.getElementById('newTime');
  if (!d || !t) return;
  const minDt = (typeof earliestAllowedDt === 'function')
    ? earliestAllowedDt()
    : new Date(Date.now()+24*60*60*1000);

  const toISO = (dt)=> {
    const off = dt.getTimezoneOffset()*60000;
    return new Date(dt.getTime()-off).toISOString().slice(0,10);
  };
  d.min = toISO(minDt);
  if (!d.value) d.value = toISO(minDt);
  if (!t.value) {
    const hh = String(minDt.getHours()).padStart(2,'0');
    const mm = String(minDt.getMinutes()).padStart(2,'0');
    t.value = `${hh}:${mm}`;
  }
})();

// ===== Wire “Load Reservation” y “Reschedule” =====
(function wireReschedule(){
  const form = document.getElementById('rescheduleForm');
  const cnEl = document.getElementById('cn');
  const newDateEl = document.getElementById('newDate');
  const newTimeEl = document.getElementById('newTime');
  const out = document.getElementById('rescheduleOutput');
  const btnLoad = document.getElementById('btnLoadCN');

  function hhmm(v){                   // normaliza "HH:MM:SS" -> "HH:MM"
    if (!v) return v;
    const m = String(v).match(/^(\d{2}:\d{2})/);
    return m ? m[1] : v;
  }

  // --- Cargar reserva por CN (prefill básico) ---
  btnLoad?.addEventListener('click', async ()=>{
    const cn = (cnEl?.value || '').trim();
    if (!cn) return alert("Ingrese el código de reserva (CN).");

    out.textContent = "Buscando reserva...";
    try{
      const resp = await fetch(`/api/book/get?cn=${encodeURIComponent(cn)}`);
      const data = await resp.json();
      if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

      const b = data.booking;
      out.textContent =
        `CN ${b.confirmation_number} — status: ${b.status}
Actual: ${b.date_iso} ${hhmm(b.time_hhmm)} — Total: $${Number(b.quoted_total||0).toFixed(2)}`;

      // (Opcional) Prefill fecha/hora nuevas a +48h de ahora
      const base = new Date(Date.now()+48*60*60*1000);
      const off = base.getTimezoneOffset()*60000;
      const iso = new Date(base.getTime()-off).toISOString().slice(0,10);
      newDateEl.value = iso;
      newTimeEl.value = `${String(base.getHours()).padStart(2,'0')}:${String((base.getMinutes()/15|0)*15).padStart(2,'0')}`;
    }catch(e){
      out.textContent = "❌ Error al cargar: " + (e?.message||e);
    }
  });

  // --- Enviar reschedule ---
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const cn = (cnEl?.value || '').trim();
    const newDate = (newDateEl?.value || '').trim();
    const newTime = (newTimeEl?.value || '').trim();
    if (!cn || !newDate || !newTime) return alert("Complete CN, fecha y hora.");

    out.textContent = "Enviando solicitud de reprogramación...";

    try{
      // 1) Llamada al backend (valida 24h y actualiza fecha/hora)
      const resp = await fetch('/api/book/reschedule', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ cn, newDate, newTime })
      });
      const data = await resp.json();
      if (!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

      // 2) Mensaje base
      let msg = `✅ Reprogramado para ${data.booking.date_iso} ${hhmm(data.booking.time_hhmm)}`;

      // 3) Obtener precio original (snake_case!)
      //    Si acabas de cargar la reserva, ya lo viste arriba, pero lo pedimos otra vez por seguridad.
      const respGet = await fetch(`/api/book/get?cn=${encodeURIComponent(cn)}`);
      const latest = await respGet.json();
      const original = Number(latest?.booking?.quoted_total || 0);

      // 4) Recalcular nuevo precio (tu misma lógica del front)
      const miles = Number(window.__lastDistanceMiles || 0);
      const base = calculateBase(miles);
      const afterHours = isAfterHours(newDate, newTime);
      const ahFee = afterHours ? base * 0.20 : 0;
      const mgFee = getMGFee();
      const newTotal = applyVehicleMultiplier(base + ahFee + mgFee);

      const diff = Math.round((newTotal - original) * 100) / 100;

      if (diff === 0) {
        msg += `.\n💲 Precio sin cambios.`;
      } else if (diff > 0) {
        msg += `.\n💰 Nuevo total $${newTotal.toFixed(2)} → paga diferencia de $${diff.toFixed(2)}.`;
        // Aquí podrías redirigir a tu endpoint de Stripe “diff”
        // const {url} = await (await fetch('/api/create-checkout-session-diff',{...})).json();
        // window.location.href = url;
      } else {
        msg += `.\n✅ Nuevo total más bajo ($${newTotal.toFixed(2)}).`;
        msg += `\nRecibirás reembolso/CR por $${Math.abs(diff).toFixed(2)} (manual).`;
      }

      out.textContent = msg;
    }catch(err){
      out.textContent = "❌ Error: " + (err?.message || err);
    }
  });
})();
</script>
</body>
</html>
