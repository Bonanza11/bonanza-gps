<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,sans-serif}

    /* Header / Logo */
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo-wrap{ position:relative }
    .logo{
      width:180px;height:180px;border-radius:50%;border:2px solid var(--copper);
      object-fit:cover;display:block;position:relative;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    .logo-wrap::after{content:"";position:absolute;inset:-8px;border-radius:50%;box-shadow:0 0 22px 10px rgba(192,139,92,.35);pointer-events:none;}

    /* Layout */
    main{max-width:760px;width:92vw;margin:0 auto 40px;padding:0 16px}
    label{display:block;margin:12px 0 6px;font-weight:700}

    /* Inputs: oscuros en todos (incl. autofill) */
    input,select{
      display:block;width:100%;height:44px;padding:10px 12px;
      background:#1a1a1a;color:var(--copper);border:1px solid #444;border-radius:8px;
      outline:none;
    }
    input:focus,select:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    ::placeholder{color:#cba686;opacity:.65}

    /* Fuerza oscuro también cuando el navegador autocompleta */
    input:-webkit-autofill,
    input:-webkit-autofill:focus{
      -webkit-text-fill-color: var(--copper);
      transition: background-color 50000s ease-in-out 0s;
      box-shadow: 0 0 0 1000px #1a1a1a inset;
      border:1px solid #444;
    }

    button{
      width:100%;padding:14px 16px;margin-top:18px;background:var(--copper);color:#000;
      font-weight:700;font-size:18px;border:0;border-radius:10px;cursor:pointer;
    }
    button:disabled{opacity:0.5;cursor:not-allowed;}
    
    #map{height:380px;margin-top:10px;border-radius:12px;overflow:hidden}

    /* Trip Summary */
    #info{
      display:none;margin-top:18px;border-radius:16px;padding:18px;
      background:linear-gradient(180deg,#121212,#0b0b0b);
      border:1px solid rgba(192,139,92,.28);box-shadow:0 18px 40px rgba(0,0,0,.55);
      color:#e9d5c1;font-size:.95em;
    }
    .info-title{font-weight:800;margin:0 0 4px;font-size:1.05rem}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 12px;}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:12px;}
    .kpi .label{font-size:.75rem;opacity:.8;margin-bottom:6px}
    .kpi .value{font-size:1.35rem;font-weight:800;color:#f0d1ad}
    .kpi .unit{font-size:.9rem;opacity:.7;margin-left:4px}
    .kpi .value.price{color:#ffddae}
    .breakdown{margin:6px 0 12px;}
    .breakdown .row{display:flex;justify-content:space-between;padding:6px 0;}
    .breakdown .row.total{font-weight:800;color:#ffddae;font-size:1.05rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:6px 0}

    /* Date/Time */
    .input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.input-row{grid-template-columns:1fr;}}
    #date,#time{
      height:56px;font-size:17px;border-radius:12px;background:#1f1f1f;color:#fff;
      border:2px solid var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18);
    }
    #date:focus,#time:focus{outline:none;border-color:#ffd9a1;box-shadow:0 0 0 4px rgba(255,217,161,.22);}
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      filter:invert(80%) sepia(20%) saturate(180%) hue-rotate(340deg) brightness(110%);
      opacity:.95;cursor:pointer;
    }
    .helper{font-size:.85rem;opacity:.95;margin-top:6px;color:#ffddae;}

    /* Vehicle visual */
    .turntable{margin:10px 0 6px; display:flex; flex-direction:column; align-items:center;}
    .turntable .car{width:260px;height:auto;filter:drop-shadow(0 12px 18px rgba(0,0,0,.6))}
    .turntable .platform{
      width:220px;height:22px;border-radius:50%;
      background:radial-gradient(ellipse at center, rgba(0,0,0,.7) 0%, rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 70%);
      margin-top:6px;
    }
    .vehicle-caption{font-weight:700;color:#ffddae;margin-top:6px;letter-spacing:.2px;}
        /* Vehicle selector */
    .veh-toggle{display:flex;gap:8px;margin:10px 0}
    .veh-btn{
      flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);
      color:var(--copper);padding:12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    .veh-btn.active{
      background:var(--copper);color:#000;border-color:var(--copper);
      box-shadow:0 0 0 3px rgba(168,116,79,.25)
    }

    /* Terms compact box */
    .terms-box{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .terms-summary{
      display:flex;align-items:center;gap:10px;cursor:pointer;
    }
    .terms-summary .chev{
      width:10px;height:10px;border-right:2px solid var(--copper);
      border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto;
    }
    .terms-box.open .terms-summary .chev{transform:rotate(45deg)}

    /* Switch (único) */
    .accept-pill{
      min-width:28px;height:20px;border-radius:999px;border:1px solid #666;
      display:flex;align-items:center;padding:0 2px;position:relative;background:#1a1a1a;
    }
    .accept-dot{
      width:14px;height:14px;border-radius:50%;background:#333;transition:.2s;
      border:1px solid #555;
    }
    .accept-pill.on{border-color:var(--ok);background:rgba(23,201,100,.12)}
    .accept-pill.on .accept-dot{transform:translateX(8px);background:var(--ok);border-color:var(--ok)}
    .accept-label{font-size:.85rem;opacity:.9;margin-left:8px}

    /* Read-more (2 líneas + degradado) */
    .terms-body{margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .terms-content.clamped{
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      overflow:hidden;position:relative;
    }
    .terms-content.clamped::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:2.2em;
      background:linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,1));
      pointer-events:none;
    }
    .readmore-btn{
      display:inline-block;margin-top:8px;padding:6px 10px;border:1px solid rgba(168,116,79,.55);
      border-radius:8px;background:#1a1a1a;color:#ffddae;font-weight:700;font-size:.85rem;cursor:pointer;
    }

    /* Hints */
    .hint{font-size:.85rem;margin-top:6px}
    .hint.warn{color:var(--warn)}
    .hint.err{color:var(--err)}
    .hint.ok{color:var(--ok)}

    /* Luggage Accordion */
    .luggage-accordion{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .luggage-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
    .luggage-title{font-weight:700}
    .luggage-chev{width:10px;height:10px;border-right:2px solid var(--copper);border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto}
    .luggage-accordion.open .luggage-chev{transform:rotate(45deg)}
    .luggage-body{display:none;margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .luggage-accordion.open .luggage-body{display:block}
    .lug-section h4{margin:6px 0 4px;color:#ffddae}
    .lug-note{opacity:.9;margin:2px 0 8px}
    .lug-list{margin:0 0 10px 18px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,.74);align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal-backdrop.open{display:flex}
    .modal{max-width:860px;width:100%;max-height:86vh;background:#0e0e0e;border:1px solid rgba(168,116,79,.45);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.7);overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(168,116,79,.28);background:#101010}
    .modal-title{font-weight:800;color:#ffddae}
    .modal-body{padding:14px 16px 18px;overflow:auto;color:#e9d5c1;line-height:1.6}
    .close-btn{background:#1a1a1a;border:1px solid rgba(168,116,79,.45);color:#ffddae;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img src="logo.png" alt="Bonanza Transportation" class="logo"/>
    </div>
  </header>

  <main>
    <label for="fullname">Full Name</label>
    <input type="text" id="fullname" placeholder="Enter your full name"/>

    <label for="phone">Phone</label>
    <input type="tel" id="phone" placeholder="(xxx) xxx-xxxx"/>

    <label for="email">Email</label>
    <input type="email" id="email" placeholder="you@example.com"/>

    <label for="pickup">Pick-up Location</label>
    <input type="text" id="pickup" placeholder="Enter pick-up address"/>
    <div id="pickupHint" class="hint"></div>

    <label for="dropoff">Drop-off Location</label>
    <input type="text" id="dropoff" placeholder="Enter drop-off address"/>
    <div id="dropoffHint" class="hint"></div>

    <div class="input-row">
      <div>
        <label for="date">Date</label>
        <input type="date" id="date"/>
        <div id="dateHelp" class="helper"></div>
      </div>
      <div>
        <label for="time">Time</label>
        <input type="time" id="time" step="900"/>
        <div id="timeHelp" class="helper"></div>
      </div>
    </div>

    <label for="flightNumber">Flight Number</label>
    <input type="text" id="flightNumber" placeholder="Required for airport pick-up"/>

    <label for="flightOrigin">Flight Origin City</label>
    <input type="text" id="flightOrigin" placeholder="Required for airport pick-up"/>

    <label for="tailNumber">Tail Number (Private Flight)</label>
    <input type="text" id="tailNumber" placeholder="If applicable"/>

    <label for="pvtOrigin">Private Flight Origin City</label>
    <input type="text" id="pvtOrigin" placeholder="If applicable"/>

    <label for="specialInstructions">Special Instructions</label>
    <input type="text" id="specialInstructions" placeholder="Optional"/>

    <div class="veh-toggle">
      <button class="veh-btn active" data-type="suv">SUV (1–5 passengers)</button>
      <button class="veh-btn" data-type="van">Van (12 passengers)</button>
    </div>

    <div class="turntable">
      <img src="suv.png" alt="SUV" class="car"/>
      <div class="platform"></div>
      <div class="vehicle-caption">SUV – 6 large bags</div>
    </div>

    <div class="terms-box" id="termsBox">
      <div class="terms-summary">
        <div class="accept-pill" id="acceptSwitch"><div class="accept-dot"></div></div>
        <div class="accept-label">I accept the Terms & Conditions</div>
        <div class="chev"></div>
      </div>
      <div class="terms-body">
        <div class="terms-content clamped" id="termsContent">
          Full terms and conditions go here. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
        </div>
        <button type="button" class="readmore-btn" id="readMoreBtn">View Full Terms</button>
      </div>
    </div>

    <div class="luggage-accordion" id="luggageAccordion">
      <div class="luggage-summary">
        <div class="luggage-title">Luggage Guide</div>
        <div class="luggage-chev"></div>
      </div>
      <div class="luggage-body">
        <div class="lug-section">
          <h4>SUV (1–5 passengers)</h4>
          <p class="lug-note">6 large bags</p>
          <ul class="lug-list">
            <li>Max 50 lbs each</li>
            <li>Standard size</li>
          </ul>
        </div>
        <div class="lug-section">
          <h4>Van (12 passengers)</h4>
          <p class="lug-note">12 large bags</p>
          <ul class="lug-list">
            <li>Max 50 lbs each</li>
            <li>Standard size</li>
          </ul>
        </div>
      </div>
    </div>
        <div id="map"></div>

    <button id="calcBtn" disabled>Calculate Price</button>
    <button id="payBtn" disabled>PAY NOW</button>

    <div id="info">
      <div class="info-title">Trip Summary</div>
      <div class="kpis">
        <div class="kpi">
          <div class="label">Distance</div>
          <div><span id="distance" class="value">0</span><span class="unit">mi</span></div>
        </div>
        <div class="kpi">
          <div class="label">Duration</div>
          <div><span id="duration" class="value">0</span><span class="unit">min</span></div>
        </div>
        <div class="kpi">
          <div class="label">Price</div>
          <div><span id="price" class="value price">0</span><span class="unit">USD</span></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="breakdown">
        <div class="row"><span>Base Fare</span><span id="baseFare">0</span></div>
        <div class="row"><span>County Surcharge</span><span id="countyFee">0</span></div>
        <div class="row"><span>After-hours Fee</span><span id="afterHoursFee">0</span></div>
        <div class="row"><span>Vehicle Type Adj.</span><span id="vehicleAdj">0</span></div>
        <div class="row total"><span>Total</span><span id="totalPrice">0</span></div>
      </div>
    </div>
  </main>

  <div class="modal-backdrop" id="termsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Terms & Conditions</div>
        <button type="button" class="close-btn" id="closeTerms">Close</button>
      </div>
      <div class="modal-body">
        <p>Full detailed terms and conditions text goes here.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque at justo sed turpis gravida facilisis. Donec quis nunc nec urna gravida porta.</p>
      </div>
    </div>
  </div>
    <script>
    let map, pickupAutocomplete, dropoffAutocomplete, directionsService, directionsRenderer, geocoder;
    let pickupLatLng = null;
    let dropoffLatLng = null;
    let selectedVehicle = 'suv';
    let termsAccepted = false;
    let distanceMiles = 0;
    let durationMins = 0;
    let totalPrice = 0;

    const allowedCounties = ["Summit County", "Wasatch County"];
    const baseAddress = "13742 N Jordanelle Pkwy, Kamas, UT";

    const suvMultiplier = 1.0;
    const vanMultiplier = 1.3;

    function initMap(){
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat:40.646, lng:-111.498},
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles:[
          {elementType:"geometry",stylers:[{color:"#1d2c4d"}]},
          {elementType:"labels.text.fill",stylers:[{color:"#8ec3b9"}]},
          {elementType:"labels.text.stroke",stylers:[{color:"#1a3646"}]},
          {featureType:"administrative.country",elementType:"geometry.stroke",stylers:[{color:"#4b6878"}]},
          {featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#64779e"}]},
          {featureType:"administrative.province",elementType:"geometry.stroke",stylers:[{color:"#4b6878"}]},
          {featureType:"landscape.man_made",elementType:"geometry.stroke",stylers:[{color":"#334e87"}]},
          {featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#023e58"}]},
          {featureType:"poi",elementType:"geometry",stylers:[{color:"#283d6a"}]},
          {featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#6f9ba5"}]},
          {featureType:"poi",elementType:"labels.text.stroke",stylers:[{color:"#1d2c4d"}]},
          {featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#023e58"}]},
          {featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#3C7680"}]},
          {featureType:"road",elementType:"geometry",stylers:[{color:"#304a7d"}]},
          {featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#212a37"}]},
          {featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#98a5be"}]},
          {featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#304a7d"}]},
          {featureType:"road.highway",elementType:"geometry",stylers:[{color:"#2c6675"}]},
          {featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#255763"}]},
          {featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#b0d5ce"}]},
          {featureType:"road.highway",elementType:"labels.text.stroke",stylers:[{color:"#023e58"}]},
          {featureType:"transit",elementType:"labels.text.fill",stylers:[{color:"#98a5be"}]},
          {featureType:"transit",elementType:"labels.text.stroke",stylers:[{color:"#1d2c4d"}]},
          {featureType:"transit.line",elementType:"geometry.fill",stylers:[{color:"#283d6a"}]},
          {featureType:"transit.station",elementType:"geometry",stylers:[{color:"#3a4762"}]},
          {featureType:"water",elementType:"geometry",stylers:[{color:"#0e1626"}]},
          {featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#4e6d70"}]}
        ]
      });
      directionsRenderer.setMap(map);

      const pickupInput = document.getElementById("pickup");
      const dropoffInput = document.getElementById("dropoff");

      pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
      dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput);

      pickupAutocomplete.addListener("place_changed", () => {
        const place = pickupAutocomplete.getPlace();
        if(place.geometry){
          pickupLatLng = place.geometry.location;
          document.getElementById("pickupHint").textContent = "";
        }
      });

      dropoffAutocomplete.addListener("place_changed", () => {
        const place = dropoffAutocomplete.getPlace();
        if(place.geometry){
          dropoffLatLng = place.geometry.location;
          document.getElementById("dropoffHint").textContent = "";
        }
      });
    }
          // === Tiempo: mínimo 24 horas de antelación ===
    function nextQuarter(d){
      const m = d.getMinutes();
      const add = 15 - (m % 15 || 15);
      d.setMinutes(m + add, 0, 0);
      return d;
    }
    function localISODate(d){
      const off = d.getTimezoneOffset()*60000;
      return new Date(d - off).toISOString().slice(0,10);
    }
    function setTimeValue(el,h,m){
      if(!el) return;
      el.value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }
    function setDateTimeDefaults24h(){
      const dateEl = document.getElementById('date');
      const timeEl = document.getElementById('time');
      const dateHelp = document.getElementById('dateHelp');
      const timeHelp = document.getElementById('timeHelp');

      const minDt = nextQuarter(new Date(Date.now() + 24*60*60*1000));
      if(dateEl) dateEl.min = localISODate(minDt);
      if(dateEl && !dateEl.value) dateEl.value = localISODate(minDt);
      if(timeEl && !timeEl.value) setTimeValue(timeEl, minDt.getHours(), minDt.getMinutes());

      function update(){
        if(dateHelp && dateEl?.value){
          const d = new Date(dateEl.value + 'T00:00:00');
          dateHelp.textContent = `Selected: ${d.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})} (min. 24h)`;
        }
        if(timeHelp && timeEl?.value){
          timeHelp.textContent = `Selected: ${timeEl.value}`;
        }
      }
      dateEl?.addEventListener('change', update);
      timeEl?.addEventListener('change', update);
      update();
    }

    function getSelectedLocalDateTime(){
      const dateEl = document.getElementById('date');
      const timeEl = document.getElementById('time');
      if(!dateEl?.value || !timeEl?.value) return null;
      const [h,m] = timeEl.value.split(':').map(Number);
      const d = new Date(dateEl.value + 'T00:00:00');
      d.setHours(h, m, 0, 0);
      return d;
    }

    function validateLeadTime24h(){
      const dt = getSelectedLocalDateTime();
      if(!dt){
        alert('Please select both Date and Time.');
        (document.getElementById('date') || document.getElementById('time'))?.focus();
        return false;
      }
      const min = new Date(Date.now() + 24*60*60*1000);
      if(dt < min){
        const earliest = nextQuarter(min).toLocaleString(undefined,{weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
        alert(`Bookings must be made at least 24 hours in advance.\nEarliest available: ${earliest}`);
        document.getElementById('date')?.focus();
        return false;
      }
      return true;
    }

    // === Validación Pick-up / Drop-off (obligatorios y desde sugerencias) ===
    function validatePickupDropoff(){
      const pu = document.getElementById('pickup');
      const dof = document.getElementById('dropoff');
      const puHint = document.getElementById('pickupHint');
      const dofHint = document.getElementById('dropoffHint');

      if(!pu?.value?.trim()){
        if(puHint) puHint.textContent = 'Pick-up address is required.';
        alert('Pick-up address is required.');
        pu?.focus();
        return false;
      }
      if(!dof?.value?.trim()){
        if(dofHint) dofHint.textContent = 'Drop-off address is required.';
        alert('Drop-off address is required.');
        dof?.focus();
        return false;
      }
      if(!pickupLatLng){
        if(puHint) puHint.textContent = 'Please choose the Pick-up from the suggestions.';
        alert('Please choose the Pick-up from the suggestions.');
        pu?.focus();
        return false;
      }
      if(!dropoffLatLng){
        if(dofHint) dofHint.textContent = 'Please choose the Drop-off from the suggestions.';
        alert('Please choose the Drop-off from the suggestions.');
        dof?.focus();
        return false;
      }
      if(puHint) puHint.textContent = '';
      if(dofHint) dofHint.textContent = '';
      return true;
    }

    // === Precio: mismas reglas base por distancia + ajuste de vehículo (sin tocar nada más) ===
    function calculateBase(mi){
      if (mi <= 10) return 120;
      if (mi <= 35) return 190;
      if (mi <= 39) return 210;
      if (mi <= 48) return 230;
      if (mi <= 55) return 250;
      return mi * 5.4;
    }
    function applyVehicleMultiplier(total){
      return Math.round( (selectedVehicle === 'van' ? total * vanMultiplier : total * suvMultiplier) );
    }
    function fmtUSD(n){ return `$${Number(n).toFixed(2)}`; }
          // === Geocoder & rutas auxiliares ===
    function geocodeLatLng(latlng){
      return new Promise((resolve,reject)=>{
        geocoder.geocode({location:latlng}, (results,status)=>{
          if(status === 'OK' && results && results[0]) resolve(results[0]);
          else reject(status || 'GEOCODE_ERROR');
        });
      });
    }
    function countyFromResult(result){
      const c = (result.address_components||[]).find(x => x.types?.includes('administrative_area_level_2'));
      return c?.long_name || '';
    }
    function routeDistanceMiles(from, to){
      return new Promise((resolve,reject)=>{
        directionsService.route({
          origin: from, destination: to, travelMode: google.maps.TravelMode.DRIVING
        }, (res, status)=>{
          if(status === 'OK' && res?.routes?.[0]?.legs?.[0]){
            resolve(res.routes[0].legs[0].distance.value / 1609.34);
          }else{
            reject(status || 'ROUTE_ERROR');
          }
        });
      });
    }

    // === Horario operativo para after-hours ===
    const OPERATING_START = '06:00';
    const OPERATING_END   = '23:00';
    function isAfterHours(){
      const dateEl = document.getElementById('date');
      const timeEl = document.getElementById('time');
      if(!dateEl?.value || !timeEl?.value) return false;
      const d = new Date(`${dateEl.value}T${timeEl.value}:00`);
      const [sh,sm] = OPERATING_START.split(':').map(Number);
      const [eh,em] = OPERATING_END.split(':').map(Number);
      const start = new Date(d); start.setHours(sh,sm,0,0);
      const end   = new Date(d); end.setHours(eh,em,0,0);
      return (d < start) || (d > end);
    }

    // === Render del panel de resumen (usa los IDs de tu markup) ===
    function renderSummary(miles, durationText, base, surcharge, ahFee, finalTotal){
      const vehicleAdj = finalTotal - (base + surcharge + ahFee);

      document.getElementById('info').style.display = 'block';
      const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };

      set('distance', miles.toFixed(1));
      set('duration', durationText);
      set('price', fmtUSD(finalTotal));
      set('baseFare', fmtUSD(base));
      set('countyFee', fmtUSD(surcharge));
      set('afterHoursFee', fmtUSD(ahFee));
      set('vehicleAdj', fmtUSD(vehicleAdj));
      set('totalPrice', fmtUSD(finalTotal));

      totalPrice = finalTotal; // cache
      // habilitar PAY si términos aceptados
      const payBtn = document.getElementById('payBtn');
      if(payBtn){
        payBtn.disabled = !termsAccepted || !totalPrice;
      }
    }

    // === Selector de vehículo (no cambia estilos/HTML) ===
    (function wireVehicleSelector(){
      const buttons = Array.from(document.querySelectorAll('.veh-btn'));
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          selectedVehicle = btn.dataset.type === 'van' ? 'van' : 'suv';
          // Si ya hay cálculo, re-aplicamos multiplicador
          if(totalPrice){
            // Recalcular solo el ajuste visual (recalcular completo al darle Calculate)
            document.getElementById('calcBtn')?.focus();
          }
        });
      });
    })();

    // === Switch de aceptación de términos ===
    (function wireTerms(){
      const pill = document.getElementById('acceptSwitch');
      const calcBtn = document.getElementById('calcBtn');
      const payBtn  = document.getElementById('payBtn');
      if(!pill) return;
      const toggle = ()=>{
        termsAccepted = !termsAccepted;
        pill.classList.toggle('on', termsAccepted);
        calcBtn && (calcBtn.disabled = !termsAccepted);
        payBtn  && (payBtn.disabled  = !termsAccepted || !totalPrice);
      };
      pill.addEventListener('click', toggle);
      pill.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggle(); }});
    })();
          // === Cálculo principal (usa SOLO lo acordado) ===
    async function calculatePrice(){
      // 1) Validación pick-up / drop-off obligatorios
      if(!validatePickupDropoff()) return;

      // 2) Regla: solo citas con 24 horas de antelación
      if(!validateLeadTime24h()) return;

      // 3) Ruta y distancia
      const origin = pickupLatLng;
      const destination = dropoffLatLng;

      const routeResult = await new Promise((resolve,reject)=>{
        directionsService.route({
          origin, destination, travelMode: google.maps.TravelMode.DRIVING
        }, (res,status)=>{
          if(status==='OK' && res?.routes?.[0]?.legs?.[0]) resolve(res.routes[0].legs[0]);
          else reject(status || 'ROUTE_ERROR');
        });
      });

      // 4) Métricas
      distanceMiles = routeResult.distance.value / 1609.34;
      durationMins  = Math.round(routeResult.duration.value/60);

      // 5) Precio base por tabla oficial (sin tocar nada más)
      const base = calculateBase(distanceMiles);

      // 6) Recargos (mantengo en 0 salvo after-hours, para no introducir reglas nuevas)
      const countySurcharge = 0;

      // 7) After-hours (6:00–23:00 fuera de horario)
      const ah = isAfterHours() ? Math.round((base + countySurcharge) * 0.20) : 0;

      // 8) Multiplicador por vehículo
      const preVehicle = base + countySurcharge + ah;
      const finalTotal = applyVehicleMultiplier(preVehicle);

      // 9) Pintar ruta en el mapa y render del panel
      directionsRenderer.setDirections({routes:[{legs:[routeResult]}]}); // truco mínimo para reusar leg
      renderSummary(distanceMiles, routeResult.duration.text, base, countySurcharge, ah, finalTotal);
    }

    // === Wire botón Calculate ===
    (function wireCalculate(){
      const btn = document.getElementById('calcBtn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        try{
          await calculatePrice();
        }catch(err){
          console.error(err);
          alert('Could not calculate route. Please try again.');
        }
      });
    })();

    // === Wire botón PAY (no cambia lógica de cobro; solo respeta validaciones) ===
    (function wirePay(){
      const btn = document.getElementById('payBtn');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        if(!termsAccepted){
          alert('Please accept Terms & Conditions first.');
          return;
        }
        if(!totalPrice){
          alert('Please calculate the price first.');
          return;
        }
        alert('Proceeding to payment…');
        // Aquí iría tu POST a /checkout (sin modificar flujos existentes)
      });
    })();
          // === Modal Términos (abrir/cerrar) ===
    (function wireTermsModal(){
      const modal    = document.getElementById('termsModal');
      const openBtn  = document.getElementById('readMoreBtn');
      const closeBtn = document.getElementById('closeTerms');

      function openModal(){
        if(!modal) return;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
        closeBtn?.focus();
      }
      function closeModal(){
        if(!modal) return;
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        openBtn?.focus();
      }

      openBtn?.addEventListener('click', openModal);
      closeBtn?.addEventListener('click', closeModal);
      modal?.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal?.classList.contains('open')) closeModal(); });
    })();

    // === Acordeón de equipaje ===
    (function wireLuggageAccordion(){
      const acc  = document.getElementById('luggageAccordion');
      const head = acc?.querySelector('.luggage-summary');
      if(!acc || !head) return;
      head.addEventListener('click', ()=>{
        const open = acc.classList.toggle('open');
        acc.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    })();

    // === Arranque por defecto (regla de 24h mínima) ===
    document.addEventListener('DOMContentLoaded', ()=>{
      setDateTimeDefaults24h();
    });
  </script>

  <!-- Google Maps (Places) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap" async defer></script>
</body>
</html>
