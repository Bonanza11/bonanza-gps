<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bonanza Transportation</title>
  <link rel="icon" href="/images/bonanza-logo.png">
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#b66a2c" />

  <style>
    :root{
      --copper:#a8744f; --copper-2:#c08b5c; --copper-3:#ffddae;
      --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b;
      --bg:#000; --panel:#0e0e0e; --panel-2:#101010;
      --field:#121212; --field-2:#1a1a1a; --border:#444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--copper-3);font-family:Inter,system-ui,Arial,sans-serif}
    header{display:flex;justify-content:center;padding:20px 16px}
    .logo{width:170px;height:170px;border-radius:50%;object-fit:cover;border:2px solid var(--copper);
      box-shadow:0 0 2px rgba(192,139,92,.35) inset, 0 0 8px rgba(0,0,0,.6), 0 0 10px rgba(192,139,92,.35)}
    main{max-width:860px;width:92vw;margin:0 auto 36px;padding:0 4px}

    /* Labels + hints */
    label{display:block;margin:12px 0 6px;font-weight:800;color:var(--copper)}
    .hint{font-size:.85rem;margin-top:6px}
    .hint.ok{color:var(--ok)} .hint.warn{color:var(--warn)} .hint.err{color:var(--err)}

    /* Inputs */
    input,select,textarea{
      width:100%;height:46px;padding:10px 12px;color:var(--copper-3);background:var(--field-2);
      border:1px solid rgba(168,116,79,.45);border-radius:10px;outline:none;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03),0 0 0 1px rgba(0,0,0,.45),0 0 0 0 rgba(168,116,79,.0);
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    textarea{height:64px}
    input:focus,select:focus,textarea:focus{
      border-color:var(--copper);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.04),0 0 0 1px rgba(0,0,0,.55),0 0 0 3px rgba(168,116,79,.26),0 0 14px 2px rgba(192,139,92,.16);
      background:var(--field);
    }
    ::placeholder{color:#cba686;opacity:.7}

    /* Autofill oscuro */
    input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{
      -webkit-box-shadow:0 0 0 1000px var(--field-2) inset !important;
      -webkit-text-fill-color: var(--copper-3) !important; transition: background-color 9999s ease-out 0s; caret-color: var(--copper-3);
    }

    /* Quitar rojo nativo en inválidos */
    input:invalid, textarea:invalid, select:invalid{ box-shadow:none!important; outline:0!important; border-color:rgba(168,116,79,.45)!important; background:var(--field-2)!important }
    input:focus:invalid, textarea:focus:invalid, select:focus:invalid{ border-color:var(--copper)!important; box-shadow:0 0 0 3px rgba(168,116,79,.26)!important; background:var(--field)!important }
    :-moz-ui-invalid{ box-shadow:none!important; outline:0!important; border-color:rgba(168,116,79,.45)!important; background:var(--field-2)!important }

    /* Grid fecha/hora */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}

    /* Vehicle selector */
    .veh-toggle{display:flex;gap:10px;margin:12px 0}
    .veh-btn{flex:1;background:var(--field-2);color:var(--copper-3);border:1px solid rgba(168,116,79,.55);padding:12px;border-radius:10px;cursor:pointer;font-weight:800}
    .veh-btn.active{background:var(--copper);color:#000;border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.25)}

    /* Vehicle visual */
    .turntable{margin:10px 0 6px; display:flex; flex-direction:column; align-items:center;}
    .turntable .car{width:260px;height:auto;filter:drop-shadow(0 12px 18px rgba(0,0,0,.6))}
    .turntable .platform{width:220px;height:22px;border-radius:50%;background:radial-gradient(ellipse at center, rgba(0,0,0,.7), rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 70%);margin-top:6px}
    .vehicle-caption{font-weight:800;color:#ffddae;margin-top:6px;letter-spacing:.2px}

    /* Meet & Greet */
    .mg-card{display:none;margin:16px 0;border-radius:14px;border:1px solid rgba(168,116,79,.45);background:linear-gradient(180deg,#121212,#0b0b0b);box-shadow:0 12px 24px rgba(0,0,0,.35);padding:16px}
    .mg-card h3{margin:0 0 4px;color:#ffddae;font-size:1.1rem}
    .mg-card p{margin:0 0 12px;font-size:.9rem;opacity:.85}
    .mg-options{display:flex;gap:8px;margin-bottom:8px}
    .mg-btn{flex:1;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);color:var(--copper);padding:10px;border-radius:8px;cursor:pointer;font-weight:700;text-align:center}
    .mg-btn.active{background:var(--copper);color:#000;border-color:var(--copper)}
    .mg-note{font-size:.85rem;color:#aa8b72}

    /* Luggage */
    .luggage-accordion{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .luggage-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
    .luggage-title{font-weight:800;color:var(--copper)}
    .luggage-chev{width:10px;height:10px;border-right:2px solid var(--copper);border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto}
    .luggage-accordion.open .luggage-chev{transform:rotate(45deg)}
    .luggage-body{display:none;margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .luggage-accordion.open .luggage-body{display:block}

    /* Terms */
    .terms-box{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .terms-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
    .accept-pill{min-width:28px;height:20px;border-radius:999px;border:1px solid #666;display:flex;align-items:center;padding:0 2px;background:#1a1a1a}
    .accept-dot{width:14px;height:14px;border-radius:50%;background:#333;transition:.2s;border:1px solid #555}
    .accept-pill.on{border-color:var(--ok);background:rgba(23,201,100,.12)}
    .accept-pill.on .accept-dot{transform:translateX(8px);background:var(--ok);border-color:var(--ok)}
    .accept-label{font-size:.95rem;color:#ffddae}

    /* Buttons */
    button{width:100%;padding:14px 16px;margin-top:14px;background:var(--copper);color:#000;font-weight:800;border:0;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}

    /* Map + Info */
    #map{height:380px;margin-top:10px;border-radius:12px;border:1px solid #333}

    /* ===== Trip Summary Card ===== */
    #info{display:none}
    .summary-card{
      display:block; margin-top:14px; border-radius:16px; padding:18px;
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(192,139,92,.28); box-shadow:0 18px 40px rgba(0,0,0,.55); color:#e9d5c1;
    }
    .summary-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .summary-title{margin:0;font-weight:900;color:#ffedd2;font-size:1.15rem;letter-spacing:.3px}
    .summary-cn{font-weight:800;padding:6px 10px;border-radius:10px;background:#141414;border:1px solid rgba(192,139,92,.35);color:#ffddb3}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:12px}
    .kpi .label{font-size:.76rem;opacity:.8;margin-bottom:6px;color:#d7bb9a}
    .kpi .value{font-size:1.35rem;font-weight:900;color:#ffedd2}
    .kpi .unit{font-size:.9rem;opacity:.7;margin-left:4px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:6px 0 10px}
    .breakdown{margin-top:4px}
    .row{display:flex;justify-content:space-between;gap:10px;padding:6px 0}
    .row.total{font-weight:900;color:#ffddae;font-size:1.06rem}
    .note{font-size:.88rem;color:#caa57e;margin-top:6px;font-style:italic}
    @media (max-width:560px){ .kpis{grid-template-columns:1fr 1fr} .summary-top{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="/images/bonanza-logo.png" alt="Bonanza Transportation">
  </header>

  <main>
    <!-- Passenger -->
    <label for="fullname">Full Name</label>
    <input id="fullname" autocomplete="name" placeholder="John Doe" />

    <label for="phone">Phone Number (US)</label>
    <input id="phone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="(555) 123-4567" />
    <div id="phoneHelp" class="hint"></div>

    <label for="email">Email Address</label>
    <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
    <div id="emailHelp" class="hint"></div>

    <!-- Route -->
    <label for="pickup">Pick-up Address</label>
    <input id="pickup" placeholder="e.g. SLC Airport" />

    <label for="dropoff">Drop-off Address</label>
    <input id="dropoff" placeholder="e.g. Montage Deer Valley" />

    <!-- Meet & Greet (SLC) -->
    <div class="mg-card" id="meetGreetCard" aria-label="Meet & Greet options">
      <h3>Meet & Greet — SLC Only</h3>
      <p>Choose where you want your driver to meet you inside the terminal.</p>
      <div class="mg-options" role="group" aria-label="Meet & Greet selection">
        <div class="mg-btn" data-choice="tsa_exit" aria-pressed="false">TSA Exit (+$50)</div>
        <div class="mg-btn" data-choice="baggage_claim" aria-pressed="false">Baggage Claim (+$50)</div>
        <div class="mg-btn active" data-choice="none" aria-pressed="true">No Meet & Greet</div>
      </div>
      <div class="mg-note">Available only for SUV arrivals at Salt Lake City International (SLC). Vans must use the designated curbside pickup area.</div>
    </div>

    <!-- Notes -->
    <label for="specialInstructions">Special Instructions</label>
    <textarea id="specialInstructions" placeholder="Gate code, luggage, pickup location…"></textarea>

    <!-- Date/Time -->
    <div class="grid2" style="margin-top:10px">
      <div>
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label for="time">Time</label>
        <input id="time" type="time" step="900" />
      </div>
    </div>

    <!-- Vehicle selector -->
    <div class="veh-toggle">
      <button class="veh-btn active" data-type="suv">SUV (1–5 Passengers)</button>
      <button class="veh-btn" data-type="van">Van (up to 12 Passengers)</button>
    </div>

    <!-- Vehicle visual -->
    <div id="vehTurntable" class="turntable">
      <img id="vehImg" class="car" src="/images/suburban.png" alt="Selected Vehicle">
      <div class="platform"></div>
      <div id="vehCap" class="vehicle-caption">SUV — Max 5 passengers, 5 suitcases</div>
    </div>

    <!-- Luggage accordion -->
    <div class="luggage-accordion" id="luggageAccordion">
      <div class="luggage-summary">
        <span class="luggage-title">Luggage Guidelines</span>
        <span class="luggage-chev"></span>
      </div>
      <div class="luggage-body">
        <div class="lug-section">
          <h4>SUV – 1 to 5 Passengers</h4>
          <h5>Option 1 – With Sports Equipment</h5>
          <ul>
            <li>5 sports equipment items (ski bags or golf bags)</li>
            <li>3 large suitcases (28–32”)</li>
            <li>3 small suitcases (20–24”)</li>
          </ul>
          <h5>Option 2 – Without Sports Equipment</h5>
          <ul>
            <li>4 large suitcases (28–32”)</li>
            <li>4 small suitcases (20–24”)</li>
          </ul>
        </div>
        <div class="lug-section">
          <h4>Van – Up to 12 Passengers</h4>
          <h5>Option 1 – With Sports Equipment</h5>
          <ul>
            <li>8 sports equipment items</li>
            <li>8 large suitcases (28–32”)</li>
            <li>Carry-on: 1 per passenger</li>
          </ul>
          <h5>Option 2 – Without Sports Equipment</h5>
          <ul>
            <li>12–14 large suitcases (28–32”)</li>
            <li>Carry-on: 1 per passenger</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Terms -->
    <div class="terms-box" id="termsBox">
      <div class="terms-summary" id="termsToggle" aria-controls="termsBody" aria-expanded="false">
        <div class="accept-pill" id="acceptPill" tabindex="0" role="switch" aria-checked="false">
          <div class="accept-dot"></div>
        </div>
        <div class="accept-label">I accept the Terms &amp; Conditions</div>
        <div class="chev" style="margin-left:auto;width:10px;height:10px;border-right:2px solid var(--copper);border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s"></div>
      </div>
      <div id="termsBody" class="terms-body" hidden>
        <div style="line-height:1.6">
          <h3 style="margin:0 0 8px;color:#ffddae">Terms and Conditions</h3>
          <p style="opacity:.85;margin:0 0 10px">Bonanza Transportation — Last updated: <span id="tncDate">2025</span></p>
          <div class="divider" style="height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:6px 0 12px"></div>
          <p>By booking or using our services, you agree to these Terms and Conditions. We may update them at any time; the latest version will be posted on our website and becomes effective immediately.</p>
          <p>Bookings must be made in advance; payments are processed securely (e.g., Stripe). Cancellation/reschedule: &gt;24h no fee (subject to availability); &lt;24h 50% charge. Waiting time: 20 min non-airport / 60 min airport. Flight delays are accommodated when possible. No smoking or illegal substances. Utah law applies. Commercial insurance in place. Privacy respected.</p>
          <p>Contact: (786) 683-5128 • bonanzatransportation1@outlook.com • Park City, Utah, USA.</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <button id="calculate" disabled>Calculate Price</button>
    <div id="map"></div>
    <button id="pay" disabled style="display:none">PAY NOW</button>

    <!-- Trip Summary (custom renderer llenará aquí) -->
    <div id="info"></div>
  </main>

  <!-- ====== Scripts (ORDEN OBLIGATORIO) ====== -->
  <script src="/app/scripts/validators.js"></script>
  <script src="/app/scripts/core.js"></script>
  <script src="/app/scripts/booking.js"></script>
  <script src="/app/scripts/maps.js"></script>
  <script src="https://js.stripe.com/v3"></script>
  <script>window.STRIPE_PK="pk_test_xxxxxxxxxxxxxxxxxxxxxxxxx";</script>
  <script src="/app/scripts/stripe.js"></script>

  <!-- Vehicle visual -->
  <script>
    (function vehicleVisualInline(){
      const SUV_IMG="/images/suburban.png", VAN_IMG="/images/van-sprinter.png";
      window.__vehicleType=window.__vehicleType||"suv";
      const btns=document.querySelectorAll('.veh-btn');
      const img=document.getElementById('vehImg');
      const cap=document.getElementById('vehCap');
      function applyVisual(){
        if(!img||!cap) return;
        if(window.__vehicleType==='van'){ img.src=VAN_IMG; cap.textContent="Van — Up to 12 passengers (luggage varies)"; }
        else{ img.src=SUV_IMG; cap.textContent="SUV — Max 5 passengers, 5 suitcases"; }
      }
      function setActive(t){
        window.__vehicleType=(t==='van')?'van':'suv';
        btns.forEach(b=>b.classList.toggle('active', b.dataset.type===window.__vehicleType));
        applyVisual();
        if(typeof window.recalcFromCache==='function') window.recalcFromCache();
      }
      btns.forEach(b=>b.addEventListener('click',()=>setActive(b.dataset.type||'suv')));
      if(img){ img.onerror=()=>{ img.removeAttribute('src'); img.alt=window.__vehicleType.toUpperCase();
        img.style.width='120px'; img.style.height='80px'; img.style.background='#1a1a1a'; img.style.border='1px solid #444'; img.style.borderRadius='8px';};}
      setActive(window.__vehicleType);
    })();

    // Luggage accordion
    (function(){
      const acc=document.getElementById('luggageAccordion');
      const sum=acc?.querySelector('.luggage-summary');
      sum?.addEventListener('click',()=>acc.classList.toggle('open'));
    })();
  </script>

  <!-- Terms logic: switch + habilitar botones + desplegable -->
  <script>
    (function termsAndButtons(){
      const pill = document.getElementById('acceptPill');
      const label = document.querySelector('.accept-label');
      const toggle = document.getElementById('termsToggle');
      const body = document.getElementById('termsBody');
      const chev = toggle?.querySelector('.chev');
      const btnCalc = document.getElementById('calculate');
      const btnPay  = document.getElementById('pay');
      function setAccepted(on){
        pill.classList.toggle('on', on);
        pill.setAttribute('aria-checked', on ? 'true' : 'false');
        if (btnCalc) btnCalc.disabled = !on;
        if (btnPay)  btnPay.disabled  = !on;
        window.__termsAccepted = !!on;
      }
      function toggleTerms(){
        const isOpen = !body.hasAttribute('hidden');
        if (isOpen) { body.setAttribute('hidden',''); toggle?.setAttribute('aria-expanded','false'); if (chev) chev.style.transform='rotate(-45deg)'; }
        else { body.removeAttribute('hidden'); toggle?.setAttribute('aria-expanded','true'); if (chev) chev.style.transform='rotate(45deg)'; }
      }
      toggle?.addEventListener('click', (e)=>{ if (e.target === pill || pill.contains(e.target)) return; toggleTerms(); });
      pill?.addEventListener('click', ()=> setAccepted(!pill.classList.contains('on')));
      pill?.addEventListener('keydown',(e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setAccepted(!pill.classList.contains('on')); }});
      label?.addEventListener('click', ()=> setAccepted(!pill.classList.contains('on')));
      function guard(e){ if (!pill.classList.contains('on')){ e?.preventDefault?.(); alert('Please accept the Terms & Conditions to continue.'); return false; } return true; }
      btnCalc?.addEventListener('click', guard, true);
      btnPay?.addEventListener('click', guard, true);
      setAccepted(false);
      const el=document.getElementById('tncDate'); if(el) el.textContent=new Date().getFullYear();
    })();
  </script>

  <!-- Pretty Trip Summary renderer (auto-formatea lo que ponga booking.js) -->
  <script>
    (function summaryRenderer(){
      const info = document.getElementById('info');

      // Utilidad: dinero
      const money = v => {
        if (typeof v === 'number') return '$' + v.toFixed(2);
        const n = parseFloat(String(v).replace(/[^0-9.]/g,'')); return isNaN(n)?'$0.00':'$'+n.toFixed(2);
      };

      // CN helper: si tu backend expone uno, úsalo; si no, generamos uno temporal
      function getCN(){
        if (window.__confirmationNumber) return window.__confirmationNumber;
        const now = new Date();
        const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
        const rnd = Math.random().toString(36).slice(2,6).toUpperCase();
        return `BZ-${y}${m}${d}-${rnd}`;
      }

      // API pública por si booking.js quiere llamarla directamente:
      window.renderTripSummary = function(payload){
        const p = payload || {};
        const distanceMi = p.distance_miles ?? p.distance ?? '';
        const duration   = p.duration_text ?? p.duration ?? '';
        const base       = p.base_price ?? p.price ?? '';
        const surge      = p.distance_surcharge ?? p.surcharge ?? 0;
        const mg         = p.meet_greet_fee ?? p.meet_and_greet ?? 0;
        const total      = p.total ?? p.total_price ?? base;

        const html = `
          <section class="summary-card" role="region" aria-label="Trip Summary">
            <div class="summary-top">
              <h2 class="summary-title">Trip Summary</h2>
              <div class="summary-cn">Confirmation # <span>${getCN()}</span></div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Distance</div>
                <div class="value">${(distanceMi&&+distanceMi)?(+distanceMi).toFixed(1):'—'}<span class="unit">mi</span></div>
              </div>
              <div class="kpi">
                <div class="label">Duration</div>
                <div class="value">${duration||'—'}</div>
              </div>
              <div class="kpi">
                <div class="label">Vehicle</div>
                <div class="value">${(window.__vehicleType||'SUV').toUpperCase()}</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="breakdown">
              <div class="row"><span>Base Price</span><span>${money(base)}</span></div>
              <div class="row"><span>Distance Surcharge</span><span>${money(surge)}</span></div>
              <div class="row"><span>Meet &amp; Greet (SLC)</span><span>${money(mg)}</span></div>
              <div class="row total"><span>Total</span><span>${money(total)}</span></div>
              <div class="note">Taxes &amp; gratuity included.</div>
            </div>
          </section>
        `;
        info.innerHTML = html;
        info.style.display = 'block';
      };

      // Fallback automático: si booking.js deja texto plano, lo parseamos y re-renderizamos
      const parseFromText = txt => {
        const g = (label) => {
          const m = txt.match(new RegExp(label+"\\s*\\$?([0-9.,a-zA-Z ]+)", "i"));
          return m ? m[1].trim() : "";
        };
        const distance = (txt.match(/Distance\s*([0-9.]+)\s*mi/i)||[])[1];
        const duration = (txt.match(/Duration\s*([0-9a-z\s]+)/i)||[])[1];
        const base     = g("Price");
        const surcharge= g("Distance Surcharge");
        const mg       = g("Meet & Greet");
        const total    = g("Total");
        return {distance_miles: distance?parseFloat(distance):null, duration_text: duration||'', base_price: parseFloat((base||'').replace(/[^0-9.]/g,''))||0, distance_surcharge: parseFloat((surcharge||'').replace(/[^0-9.]/g,''))||0, meet_greet_fee: parseFloat((mg||'').replace(/[^0-9.]/g,''))||0, total: parseFloat((total||'').replace(/[^0-9.]/g,''))||0};
      };

      const mo = new MutationObserver(() => {
        if (!info || !info.isConnected) return;
        const raw = info.innerText || info.textContent || "";
        if (!raw) return;
        // Si no es nuestra tarjeta, lo convertimos:
        if (!info.querySelector('.summary-card')) {
          const data = parseFromText(raw);
          window.renderTripSummary(data);
        }
      });
      mo.observe(info, {childList:true, subtree:true});

      // Por si tu JS guarda un objeto global con el último cálculo:
      if (window.__lastQuote) { try{ window.renderTripSummary(window.__lastQuote); }catch(_){} }
    })();
  </script>

  <!-- Google Maps -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap"></script>
</body>
</html>
