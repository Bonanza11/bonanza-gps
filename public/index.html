<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,sans-serif}

    /* Header / Logo */
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo-wrap{position:relative}
    .logo{width:120px;height:120px;border-radius:50%;opacity:.18;object-fit:cover}

    /* Cards & layout */
    .container{max-width:980px;margin:0 auto;padding:0 16px 32px}
    .card{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:16px;margin:14px 0;background:rgba(255,255,255,.02)}

    /* Vehicle block */
    .vehicle{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .vehicle img{max-width:320px;width:100%;border-radius:10px}
    .vehicle h3{margin:6px 0 2px;color:#f2d3bd}
    .vehicle small{color:#caa78d}

    /* Luggage details */
    details#luggage{border:1px solid rgba(168,116,79,.35);border-radius:10px;background:rgba(255,255,255,.01)}
    details#luggage > summary{cursor:pointer;list-style:none;margin:0;padding:14px 16px;color:#f2d3bd;font-weight:600}
    details#luggage .luggage-body{padding:12px 16px 16px;color:#d9b89e;border-top:1px solid rgba(168,116,79,.35)}
    ul.clean{margin:8px 0 0 16px}
    ul.clean li{margin:6px 0}

    /* Terms pill */
    .terms-wrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;
      border:1px solid rgba(168,116,79,.45);cursor:pointer;user-select:none;background:rgba(255,255,255,.02);
      position:relative
    }
    .dot{width:16px;height:16px;border-radius:50%;background:#2e2e2e;box-shadow:inset 0 0 0 2px rgba(168,116,79,.55)}
    .pill.on .dot{background:var(--ok);box-shadow:none}
    .terms-note{font-size:.92rem;color:#caa78d}
    .terms-box{border:1px solid rgba(168,116,79,.35);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
    .readmore{display:inline-block;margin-top:8px;padding:8px 12px;border:1px solid rgba(168,116,79,.45);border-radius:10px}

    /* === Cambio #1: quitar flecha del pill de Terms (cualquier chevron decorativo) === */
    #acceptPill::after{content:'' !important;display:none !important}
    #acceptPill{background-image:none !important}

    /* Buttons */
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    button{
      outline:0;border:0;border-radius:12px;padding:14px 18px;font-weight:700;letter-spacing:.3px;
      background:linear-gradient(#c1885d,#995e35);color:#26170d;cursor:pointer
    }
    button[disabled]{opacity:.5;cursor:not-allowed}

    /* === Cambio #3: botones estáticos (sin animaciones/saltos) === */
    button{animation:none !important;transform:none !important;transition:none !important}

    /* Inputs */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    input,select{
      background:#0e0e0e;border:1px solid rgba(168,116,79,.35);border-radius:10px;padding:12px;color:#e6d4c6
    }

    /* Map */
    #map{width:100%;height:320px;border:1px solid rgba(168,116,79,.35);border-radius:12px;overflow:hidden}
    .price-summary{color:#f2d3bd}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .muted{color:#caa78d}

    @media (max-width:760px){
      .grid{grid-template-columns:1fr}
      .vehicle{flex-direction:column}
      #map{height:280px}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img class="logo" src="https://images.unsplash.com/photo-1542367597-8849eb23bd8a?q=80&w=1600&auto=format&fit=crop" alt="Logo watermark"/>
    </div>
  </header>

  <main class="container">
    <!-- Vehicle -->
    <section class="card">
      <div class="vehicle">
        <img src="https://images.unsplash.com/photo-1542367597-8849eb23bd8a?q=80&w=1600&auto=format&fit=crop" alt="Van">
        <div>
          <h3>This will be your Van</h3>
          <small>Van: Fits up to 12 passengers, 12 large bags, 8 carry‑ons</small>
        </div>
      </div>
    </section>

    <!-- Luggage guide -->
    <section class="card">
      <details id="luggage">
        <summary>Detailed Luggage Guide</summary>
        <div class="luggage-body">
          <ul class="clean">
            <li>SUV (1–5): 5–6 medium bags + 4 carry‑ons</li>
            <li>Van (up to 12): 12 large bags + 8 carry‑ons</li>
            <li>Extra luggage subject to availability</li>
          </ul>
        </div>
      </details>
    </section>
        <!-- Terms -->
    <section class="card">
      <div class="terms-wrap">
        <div id="acceptPill" class="pill">
          <span class="dot"></span>
          <span>I accept the Terms & Conditions</span>
        </div>
        <div class="terms-note">
          By booking with Bonanza Transportation, you agree to our policies including but not limited to payment terms, cancellation policy, and liability limits.
        </div>
      </div>
      <div class="terms-box" style="margin-top:12px">
        <small>Operating hours: 06:00–23:00. Trips outside this window incur a 20% after‑hours fee.</small><br/>
        <a class="readmore" href="#" onclick="alert('Terms preview');return false;">Read More</a>
      </div>
    </section>

    <!-- Trip form -->
    <section class="card">
      <h3>Trip Details</h3>
      <div class="grid">
        <div class="field">
          <label for="pickup">Pickup</label>
          <input id="pickup" placeholder="Enter pickup location"/>
        </div>
        <div class="field">
          <label for="dropoff">Drop‑off</label>
          <input id="dropoff" placeholder="Enter drop‑off location"/>
        </div>
        <div class="field">
          <label for="date">Date</label>
          <input id="date" type="date"/>
        </div>
        <div class="field">
          <label for="time">Time</label>
          <input id="time" type="time"/>
        </div>
        <div class="field">
          <label for="vehicle">Vehicle</label>
          <select id="vehicle">
            <option value="suv" selected>SUV (1–5)</option>
            <option value="van">Van (up to 12)</option>
          </select>
        </div>
        <div class="field">
          <label for="passengers">Passengers</label>
          <input id="passengers" type="number" value="2" min="1" max="12"/>
        </div>
      </div>

      <div class="actions" style="margin-top:16px">
        <button id="calculate" disabled>Calculate Price</button>
        <!-- Cambio #2: PAY NOW se moverá debajo del mapa -->
      </div>
    </section>

    <!-- Map + Route -->
    <section class="card">
      <h3>Route Preview</h3>
      <div id="map"></div>
      <div id="priceBox" class="price-summary" style="margin-top:12px;display:none">
        <div class="row"><span>Miles</span><span id="milesOut">—</span></div>
        <div class="row"><span>Base</span><span id="baseOut">$0</span></div>
        <div class="row"><span>County surcharge</span><span id="surchargeOut">$0</span></div>
        <div class="row"><span>After‑hours (20%)</span><span id="afterOut">$0</span></div>
        <div class="row" style="border-top:1px solid rgba(168,116,79,.35);padding-top:8px">
          <strong>Total</strong><strong id="totalOut">$0</strong>
        </div>
      </div>
    </section>

    <!-- === Cambio #2: PAY NOW debajo del mapa === -->
    <section class="card" style="text-align:center">
      <button id="pay" style="display:none" disabled>PAY NOW</button>
    </section>
        <!-- Contenedores de vuelo (base intacta) -->
    <section class="card" style="display:none">
      <div id="flightContainer">Commercial flight fields…</div>
      <div id="privateFlightContainer" style="display:none">Private flight fields…</div>
    </section>
  </main>

  <script>
  /* ================== STATE ================== */
  let map, directionsService, directionsRenderer, geocoder;
  let pickupPlace = null, dropoffPlace = null;
  window.__vehicleType = 'suv';
  window.__lastQuotedTotal = 0;

  const OPER_START = 6, OPER_END = 23;

  /* ===== Helpers ===== */
  function dollars(n){ return '$' + (Math.round(n*100)/100).toFixed(2); }

  function pickupIsUtahAirport(){
    if(!pickupPlace || !pickupPlace.address_components) return false;
    const name = (pickupPlace.name || '').toLowerCase();
    return /airport|salt lake|slc|heber|ogden|provo/.test(name);
  }
  function isPrivateUtahAirport(place){
    const name = (place?.name||'').toLowerCase();
    return /heber|private|hangar/.test(name);
  }

  function isAfterHours(dateStr,timeStr){
    if(!dateStr || !timeStr) return false;
    const [h] = timeStr.split(':').map(Number);
    return (h < OPER_START || h >= OPER_END);
  }

  function mountDateTime(){
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    const hh = String(Math.max(OPER_START, d.getHours())).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    document.getElementById('date').value = iso;
    document.getElementById('time').value = `${hh}:${mm}`;
  }

  /* ===== Tabla oficial de precios por milla ===== */
  function calculateBase(miles){
    if (miles <= 10) return 120;
    if (miles <= 35) return 190;
    if (miles <= 39) return 210;
    if (miles <= 48) return 230;
    if (miles <= 55) return 250;
    return 5.40 * miles;
  }

  /* ===== County by placeId ===== */
  function countyByPlaceId(placeId){
    return new Promise((resolve)=>{
      geocoder.geocode({placeId}, (res, status)=>{
        if(status !== 'OK' || !res?.length){ resolve(''); return; }
        const comp = res[0].address_components || [];
        const county = comp.find(c => c.types.includes('administrative_area_level_2'));
        resolve(county ? county.long_name : '');
      });
    });
  }
      /* ===== Cálculo de millas base->dropoff (mantenido) ===== */
  const BONANZA_BASE = '13742 N Jordanelle Pkwy, Kamas, UT';
  function computeMilesFromBase(dropPlaceId){
    return new Promise((resolve)=>{
      directionsService.route({
        origin: BONANZA_BASE,
        destination: {placeId: dropPlaceId},
        travelMode: google.maps.TravelMode.DRIVING
      }, (res, status)=>{
        if(status !== 'OK'){ alert('Route error'); resolve(0); return; }
        const meters = res.routes[0].legs.reduce((acc,l)=>acc + l.distance.value, 0);
        const miles = meters / 1609.344;
        resolve(miles);
      });
    });
  }

  /* ===== Recalcular y pintar desde caché ===== */
  function recalcFromCache(){
    const vehicleSel = document.getElementById('vehicle');
    window.__vehicleType = vehicleSel.value;
    const multiplier = (window.__vehicleType === 'van') ? 1.30 : 1.00;

    const base = (window.__lastBase || 0) * multiplier;
    const surcharge = window.__lastSurcharge || 0;
    const after = window.__lastAhFee ? window.__lastAhFee * multiplier : 0;

    const total = base + surcharge + after;
    window.__lastQuotedTotal = Math.round(total * 100) / 100;

    document.getElementById('baseOut').textContent = dollars(base);
    document.getElementById('surchargeOut').textContent = dollars(surcharge);
    document.getElementById('afterOut').textContent = dollars(after);
    document.getElementById('totalOut').textContent = dollars(window.__lastQuotedTotal);
    document.getElementById('priceBox').style.display = 'block';
  }

  /* ===== Validaciones y lógica de vuelo ===== */
  function wireFlightValidation(){
    const pickupEl = document.getElementById('pickup');
    const flightContainer = document.getElementById('flightContainer');
    const privateFlightContainer = document.getElementById('privateFlightContainer');
    pickupEl.addEventListener('change', ()=>{
      if(pickupIsUtahAirport()){
        if(isPrivateUtahAirport(pickupPlace)){
          privateFlightContainer.style.display = 'block';
          flightContainer.style.display = 'none';
        } else {
          flightContainer.style.display = 'block';
          privateFlightContainer.style.display = 'none';
        }
      } else {
        flightContainer.style.display = 'none';
        privateFlightContainer.style.display = 'none';
      }
    });
  }

  /* ===== Sincronizar botones con Terms ===== */
  function syncButtons(){
    const calcBtn = document.getElementById('calculate');
    const payBtn  = document.getElementById('pay');
    const termsPill = document.getElementById('acceptPill');
    function update(){
      const accepted = termsPill.classList.contains('on');
      calcBtn.disabled = !accepted;
      payBtn.disabled  = !accepted;
    }
    termsPill.addEventListener('click', ()=>{
      termsPill.classList.toggle('on');
      update();
    });
    update();
  }

  /* ===== Google Maps init ===== */
  function initMap(){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:40.6461, lng:-111.49797}, zoom:10 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });
    geocoder = new google.maps.Geocoder();

    const pickupInput = document.getElementById('pickup');
    const dropoffInput = document.getElementById('dropoff');
    const pickupAC = new google.maps.places.Autocomplete(pickupInput);
    const dropoffAC = new google.maps.places.Autocomplete(dropoffInput);

    pickupAC.addListener('place_changed', ()=>{
      pickupPlace = pickupAC.getPlace();
    });
    dropoffAC.addListener('place_changed', ()=>{
      dropoffPlace = dropoffAC.getPlace();
    });
  }
      /* ===== Evento calcular precio ===== */
  document.getElementById('calculate').addEventListener('click', async ()=>{
    if(!pickupPlace || !dropoffPlace) return alert("Please select pickup and drop-off locations.");

    const miles = await computeMilesFromBase(dropoffPlace.place_id);
    document.getElementById('milesOut').textContent = miles.toFixed(1);

    let basePrice = calculateBase(miles);

    let county = await countyByPlaceId(dropoffPlace.place_id);
    let surcharge = (county.toLowerCase().includes('summit') || county.toLowerCase().includes('wasatch')) ? 0 : 50;

    let afterHoursFee = isAfterHours(document.getElementById('date').value, document.getElementById('time').value) ? basePrice * 0.20 : 0;

    window.__lastBase = basePrice;
    window.__lastSurcharge = surcharge;
    window.__lastAhFee = afterHoursFee;

    recalcFromCache();

    // Mostrar el botón PAY debajo del mapa
    document.getElementById('pay').style.display = 'inline-block';
  });

  /* ===== Evento pagar ===== */
  document.getElementById('pay').addEventListener('click', async ()=>{
    if(!window.__lastQuotedTotal) return alert("Please calculate the price first.");
    const response = await fetch('/api/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ amount: window.__lastQuotedTotal, vehicle: window.__vehicleType })
    });
    const data = await response.json();
    if(data.url) window.location.href = data.url;
  });

  mountDateTime();
  wireFlightValidation();
  syncButtons();
  </script>

  <!-- Google Maps loader -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap" async defer></script>
</body>
</html>
