<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    /* Reset & base */
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:#000; color:#c08b5c; font-family:Arial, sans-serif; }

    /* Header con logo */
    header { display:flex; justify-content:center; align-items:center; padding:20px 16px; }
    .logo-wrap { position:relative; }
    .logo {
      width:180px; height:180px; border-radius:50%; border:2px solid #c08b5c;
      object-fit:cover; display:block;
      box-shadow: 0 0 2px rgba(192,139,92,.35) inset, 0 0 8px rgba(0,0,0,.6), 0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.7));
    }

    /* Imagen Suburban fija al centro */
    .suburban-center {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px; /* Ajusta tamaño aquí */
      height: auto;
      z-index: 0; /* Detrás del contenido */
      opacity: 0.9;
      pointer-events: none;
    }

    /* Layout */
    main { max-width:768px; width:92%; margin:auto; position:relative; z-index:1; }
    label { display:block; margin:12px 0 6px; font-weight:bold; }
    input, select {
      display:block; width:100%; height:44px; padding:6px;
      background:#1a1a1a; color:#c08b5c; border:1px solid #c08b5c; border-radius:4px;
    }
    button {
      width:100%; padding:14px 16px; margin-top:16px;
      font-weight:700; font-size:18px; border-radius:6px; border:none;
      background:#c08b5c; color:#000; cursor:pointer;
      animation:pulse 1.8s infinite;
    }
    @keyframes pulse {
      0% { transform:scale(1); box-shadow:0 0 0 rgba(192,139,92,0.7); }
      70% { transform:scale(1.05); box-shadow:0 0 15px rgba(192,139,92,0.7); }
      100% { transform:scale(1); box-shadow:0 0 0 rgba(192,139,92,0.7); }
    }
    #map { height:380px; margin-top:18px; border-radius:8px; overflow:hidden; }
    #info {
      display:none;
      margin-top:18px; border-radius:16px; padding:14px;
      background:linear-gradient(180deg,#1a1a1a,#000);
      border:1px solid #c08b5c;
    }
  </style>
</head>
<body>
  <!-- Imagen Suburban fija -->
<img src="/images/suburban.png" alt="Black Chevrolet Suburban SUV" class="suburban-center">

<header>
  <div class="logo-wrap">
    <img class="logo" src="/images/bonanza-logo.PNG" alt="Bonanza Transportation Logo">
  </div>
</header>

<main>
  <label for="fullname">Full Name:</label>
  <input id="fullname" placeholder="e.g. John Doe" />

  <label for="phone">Phone Number:</label>
  <input id="phone" placeholder="e.g. +1 385 123 4567" />

  <label for="email">Email Address:</label>
  <input id="email" type="email" placeholder="you@example.com" />

  <label for="pickup">Pick-up Address:</label>
  <input id="pickup" placeholder="e.g. SLC Airport" />

  <label for="dropoff">Drop-off Address:</label>
  <input id="dropoff" placeholder="e.g. Montage Deer Valley" />

  <!-- Flight number -->
  <div id="flightContainer" style="display:none;">
    <label for="flightNumber">Flight Number:</label>
    <input id="flightNumber" placeholder="e.g. DL1234" />
  </div>

  <div style="display:flex; gap:10px;">
    <div style="flex:1;">
      <label for="date">Date:</label>
      <input id="date" type="date" />
    </div>
    <div style="flex:1;">
      <label for="time">Time:</label>
      <input id="time" type="time" step="900" />
    </div>
  </div>

  <label>Luggage Options:</label>
  <div>2 Large Suitcases + 3 Small Bags + 5 Ski Bags/Golf Clubs</div>
  <div>3 Large Suitcases + 5 Small Bags</div>

  <button id="calculate">Calculate Price</button>
  <div id="map"></div>

  <!-- Trip Summary -->
  <div id="info"></div>

  <button id="pay" style="display:none;">PAY NOW</button>
</main>
<script>
/* =======================
   Globals & constants
======================= */
let map, directionsService, directionsRenderer, geocoder;
const BASE_ADDRESS = "13742 N Jordanelle Pkwy, Kamas, UT";
const ALLOWED_COUNTIES = ["Summit County", "Wasatch County"];

/* Horario de operación */
const OPERATING_START = "06:00"; // 6:00 AM
const OPERATING_END   = "23:30"; // 11:30 PM

/* =======================
   Pricing (tax & tip incluidos en base)
======================= */
function calculateBase(mi){
  if (mi <= 10) return 120;
  if (mi <= 35) return 190;
  if (mi <= 39) return 210;
  if (mi <= 48) return 230;
  if (mi <= 55) return 250;
  return mi * 5.4;
}

/* =======================
   Date/Time helpers
======================= */
function nextQuarter(d){ const m=d.getMinutes(); const add=15-(m%15||15); d.setMinutes(m+add,0,0); return d; }
function localISODate(d){ const off=d.getTimezoneOffset()*60000; return new Date(d-off).toISOString().slice(0,10); }
function setTimeValue(el,h,m){ if(el) el.value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }

function isAfterHours(dateStr, timeStr){
  if(!dateStr || !timeStr) return false;
  const d = new Date(`${dateStr}T${timeStr}:00`);
  const [sh,sm] = OPERATING_START.split(':').map(Number);
  const [eh,em] = OPERATING_END.split(':').map(Number);
  const start = new Date(d); start.setHours(sh, sm, 0, 0);
  const end   = new Date(d); end.setHours(eh, em, 0, 0);
  return (d < start) || (d > end);
}

function mountDateTime(){
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  const dateHelp = document.getElementById('dateHelp');
  const timeHelp = document.getElementById('timeHelp');

  const nx = nextQuarter(new Date());
  if(dateEl && !dateEl.value) dateEl.value = localISODate(nx);
  if(timeEl && !timeEl.value) setTimeValue(timeEl, nx.getHours(), nx.getMinutes());
  if(dateEl) dateEl.min = localISODate(new Date());

  function update(){
    if(dateHelp && dateEl?.value){
      const d = new Date(dateEl.value + 'T00:00:00');
      dateHelp.textContent = `Selected: ${d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}`;
    }
    if(timeHelp && timeEl?.value){ timeHelp.textContent = `Selected: ${timeEl.value}`; }
  }
  dateEl?.addEventListener('change', update);
  timeEl?.addEventListener('change', update);
  update();
}

/* =======================
   Places / routing
======================= */
function isAirport(place){
  const t = place?.types || [];
  const addr = (place?.formatted_address || "").toLowerCase();
  const extra = [
    "salt lake city international airport","slc airport",
    "provo municipal airport","ogden-hinckley airport",
    "st. george regional airport","cedar city regional airport",
    "canyonlands regional airport","moab canyonlands regional airport",
    "jsx, n 2360 w st, salt lake city, ut, usa"
  ];
  return t.includes("airport") || /airport/i.test(place?.name || place?.formatted_address || "") || extra.some(a=>addr.includes(a));
}
function isUtah(place){ const addr=(place?.formatted_address||'').toLowerCase(); return /\but\b/.test(addr) || /, ut(ah)?\b/.test(addr); }
function countyFrom(place){ const comps=place?.address_components||[]; const c=comps.find(x=>x.types?.includes("administrative_area_level_2")); return c?.long_name||""; }
function countyIncludesAllowed(name){ return ALLOWED_COUNTIES.some(x=>(name||"").includes(x)); }

function routeAsync(opts){ return new Promise((res,rej)=>{ directionsService.route(opts,(r,s)=> s==="OK"&&r?res(r):rej(s||"ROUTE_ERROR")); }); }
function geocodeAsync(req){ return new Promise((res,rej)=>{ geocoder.geocode(req,(results,status)=>{ if(status==="OK"&&results?.[0]) res(results[0]); else rej(status||"GEOCODE_ERROR"); }); }); }
async function countyByPlaceId(placeId){ try{ const r=await geocodeAsync({placeId}); const c=r.address_components.find(c=>c.types.includes("administrative_area_level_2")); return c?.long_name||""; }catch(_){ return ""; } }
async function computeMilesFromBase(placeId){ const r=await routeAsync({origin:BASE_ADDRESS,destination:{placeId},travelMode:google.maps.TravelMode.DRIVING}); return r.routes[0].legs[0].distance.value/1609.34; }

/* =======================
   Flight field (green, validado)
======================= */
function pickupIsUtahAirport(){
  const pickupInput = document.getElementById("pickup");
  // El Autocomplete setea pickupPlace en initMap
  return window.pickupPlace && isAirport(window.pickupPlace) && isUtah(window.pickupPlace);
}
const AIRLINES = new Set(["AA","DL","UA","WN","AS","B6","F9","NK","HA","AC","AM","AF","BA","KL","LH","VS","IB","TK","QR","EK","CM","AV","QF","CX","AZ","SK","LA","AR","TS","WS","DY","NH","JL","KE","XE"]);
const FLIGHT_REGEX = /^([A-Z0-9]{2})\s?-?\s?(\d{1,4})([A-Z])?$/;
function normalizeFlight(v){ return (v||'').toUpperCase().trim().replace(/\s+/g,' ').replace('–','-'); }
function validateFlightValue(v){
  const m = normalizeFlight(v).match(FLIGHT_REGEX);
  if (!m) return {ok:false,msg:'Invalid format. Use AA1234 or WN 987.'};
  const code=m[1], num=m[2];
  if(!AIRLINES.has(code)) return {ok:false,msg:'Unknown airline code.'};
  if(/^0+$/.test(num)) return {ok:false,msg:'Invalid flight number.'};
  return {ok:true,msg:''};
}
function updateFlightVisibility(){
  const wrap=document.getElementById('flightContainer');
  const input=document.getElementById('flightNumber');
  if(!wrap||!input) return;
  const show = pickupIsUtahAirport();
  wrap.style.display = show ? 'block' : 'none';
  if(!show){ input.value=""; input.setCustomValidity(""); }
}
function wireFlightValidation(){
  const input=document.getElementById('flightNumber');
  if(!input) return;
  input.addEventListener('input', ()=>{
    if(!pickupIsUtahAirport()){ input.setCustomValidity(""); return; }
    const r=validateFlightValue(input.value); input.setCustomValidity(r.ok?"":r.msg);
  });
}

/* =======================
   Render Trip Summary
======================= */
function renderInfo(leg, base, surcharge, afterHours){
  const miles = leg.distance.value / 1609.34;
  const ahFee = afterHours ? (base + surcharge) * 0.25 : 0; // recargo fuera de horario
  const total = base + surcharge + ahFee;

  const el = document.getElementById("info");
  el.style.display = "block";
  el.innerHTML = `
    <h3 class="info-title">Trip Summary</h3>
    <p class="info-sub">Private Black Suburban · 1–5 passengers</p>

    <div class="kpis">
      <div class="kpi"><div class="label">Distance</div><div class="value">${miles.toFixed(1)}<span class="unit">mi</span></div></div>
      <div class="kpi"><div class="label">Duration</div><div class="value">${leg.duration.text}</div></div>
      <div class="kpi"><div class="label">Price (includes taxes & gratuity)</div><div class="value price">$${total.toFixed(2)}</div></div>
    </div>

    <div class="divider"></div>
    <div class="breakdown">
      <div class="row"><span>Base Fare</span><span>$${base.toFixed(2)}</span></div>
      ${surcharge>0 ? `<div class="row"><span>Distance Surcharge</span><span>$${surcharge.toFixed(2)}</span></div>` : ""}
      ${ahFee>0 ? `<div class="row"><span>Off-Hours Fee (25%)</span><span>$${ahFee.toFixed(2)}</span></div>` : ""}
      <div class="divider"></div>
      <div class="row total"><span>Total</span><span>$${total.toFixed(2)}</span></div>
    </div>
  `;
}

/* =======================
   Google Maps init
======================= */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), { center:{lat:40.7587,lng:-111.8762}, zoom:10 });
  directionsService  = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  geocoder = new google.maps.Geocoder();

  const opts = { componentRestrictions:{country:["us"]}, fields:["place_id","name","types","formatted_address","geometry","address_components"] };
  const acPickup  = new google.maps.places.Autocomplete(document.getElementById("pickup"), opts);
  const acDropoff = new google.maps.places.Autocomplete(document.getElementById("dropoff"), opts);

  acPickup.addListener("place_changed", ()=>{
    window.pickupPlace = acPickup.getPlace() || null;
    updateFlightVisibility();
  });
  acDropoff.addListener("place_changed", ()=>{
    window.dropoffPlace = acDropoff.getPlace() || null;
  });
}
window.initMap = initMap;

/* =======================
   Calculate button
======================= */
document.getElementById("calculate").addEventListener("click", async ()=>{
  const pickupPlace = window.pickupPlace;
  const dropoffPlace = window.dropoffPlace;
  if (!pickupPlace?.place_id || !dropoffPlace?.place_id){
    alert("Please select addresses from the suggestions.");
    return;
  }

  try{
    const trip = await routeAsync({
      origin:{placeId: pickupPlace.place_id},
      destination:{placeId: dropoffPlace.place_id},
      travelMode: google.maps.TravelMode.DRIVING
    });
    directionsRenderer.setDirections(trip);

    const leg = trip.routes[0].legs[0];
    const miles = leg.distance.value/1609.34;
    const basePrice = calculateBase(miles); // taxes & gratuity incluidos

    // Surcharges por distancia (misma lógica de antes)
    let surcharge = 0;
    const pickupAir = isAirport(pickupPlace);
    let pickupCounty = countyFrom(pickupPlace) || await countyByPlaceId(pickupPlace.place_id);
    let dropCounty   = countyFrom(dropoffPlace) || await countyByPlaceId(dropoffPlace.place_id);
    const pickupAllowed = countyIncludesAllowed(pickupCounty);
    const dropAllowed   = countyIncludesAllowed(dropCounty);

    if (pickupAir){
      if (!dropAllowed){ const m = await computeMilesFromBase(pickupPlace.place_id); surcharge = m * 3; }
    }else{
      if (!pickupAllowed){ const m = await computeMilesFromBase(pickupPlace.place_id); surcharge = m * 3; }
    }

    const afterHours = isAfterHours(document.getElementById("date").value, document.getElementById("time").value);
    renderInfo(leg, basePrice, surcharge, afterHours);
    document.getElementById("pay").style.display = "block";
  }catch(err){
    alert("Could not calculate route: " + err);
  }
});

/* =======================
   On load
======================= */
mountDateTime();
wireFlightValidation();
</script>

<!-- Loader de Google Maps (debe ir al final del body) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap" async defer></script>
