<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,sans-serif}

    /* Header / Logo */
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo-wrap{ position:relative }
    .logo{
      width:180px;height:180px;border-radius:50%;border:2px solid var(--copper);
      object-fit:cover;display:block;position:relative;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    .logo-wrap::after{content:"";position:absolute;inset:-8px;border-radius:50%;box-shadow:0 0 22px 10px rgba(192,139,92,.35);pointer-events:none;}

    /* Layout */
    main{max-width:760px;width:92vw;margin:0 auto 40px;padding:0 16px}
    label{display:block;margin:12px 0 6px;font-weight:700}

    /* Inputs */
    input,select,textarea{
      display:block;width:100%;height:44px;padding:10px 12px;
      background:#1a1a1a;color:var(--copper);border:1px solid #444;border-radius:8px;
      outline:none;
    }
    textarea{height:60px;resize:none}
    input:focus,select:focus,textarea:focus{border-color:var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18)}
    ::placeholder{color:#cba686;opacity:.65}

    /* Autofill oscuro */
    input:-webkit-autofill,
    input:-webkit-autofill:focus{
      -webkit-text-fill-color: var(--copper);
      transition: background-color 50000s ease-in-out 0s;
      box-shadow: 0 0 0 1000px #1a1a1a inset;
      border:1px solid #444;
    }

    button{
      width:100%;padding:14px 16px;margin-top:18px;background:var(--copper);color:#000;
      font-weight:700;font-size:18px;border:0;border-radius:10px;cursor:pointer;
    }
    button:disabled{opacity:0.5;cursor:not-allowed;}
    
    #map{height:380px;margin-top:10px;border-radius:12px;overflow:hidden}

    /* Trip Summary */
    #info{
      display:none;margin-top:18px;border-radius:16px;padding:18px;
      background:linear-gradient(180deg,#121212,#0b0b0b);
      border:1px solid rgba(192,139,92,.28);box-shadow:0 18px 40px rgba(0,0,0,.55);
      color:#e9d5c1;font-size:.95em;
    }
    .info-title{font-weight:800;margin:0 0 4px;font-size:1.05rem}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 12px;}
    .kpi{background:#0e0e0e;border:1px solid rgba(192,139,92,.18);border-radius:12px;padding:12px;}
    .kpi .label{font-size:.75rem;opacity:.8;margin-bottom:6px}
    .kpi .value{font-size:1.35rem;font-weight:800;color:#f0d1ad}
    .kpi .unit{font-size:.9rem;opacity:.7;margin-left:4px}
    .kpi .value.price{color:#ffddae}
    .breakdown{margin:6px 0 12px;}
    .breakdown .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;}
    .breakdown .row.total{font-weight:800;color:#ffddae;font-size:1.05rem}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent);margin:6px 0}
    .tax-note{font-size:13px;color:#c9a97c;font-style:italic;text-align:right;margin-top:4px;opacity:.85;}

    /* Date/Time */
    .input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.input-row{grid-template-columns:1fr;}}
    #date,#time{
      height:56px;font-size:17px;border-radius:12px;background:#1f1f1f;color:#fff;
      border:2px solid var(--copper);box-shadow:0 0 0 3px rgba(168,116,79,.18);
    }
    #date:focus,#time:focus{outline:none;border-color:#ffd9a1;box-shadow:0 0 0 4px rgba(255,217,161,.22);}
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      filter:invert(80%) sepia(20%) saturate(180%) hue-rotate(340deg) brightness(110%);
      opacity:.95;cursor:pointer;
    }
    .helper{font-size:.85rem;opacity:.95;margin-top:6px;color:#ffddae;}

    /* Vehicle visual */
    .turntable{margin:10px 0 6px; display:flex; flex-direction:column; align-items:center;}
    .turntable .car{width:260px;height:auto;filter:drop-shadow(0 12px 18px rgba(0,0,0,.6))}
    .turntable .platform{
      width:220px;height:22px;border-radius:50%;
      background:radial-gradient(ellipse at center, rgba(0,0,0,.7) 0%, rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 70%);
      margin-top:6px;
    }
    .vehicle-caption{font-weight:700;color:#ffddae;margin-top:6px;letter-spacing:.2px;}

    /* Vehicle selector */
    .veh-toggle{display:flex;gap:8px;margin:10px 0}
    .veh-btn{
      flex:1 1 0;background:#1a1a1a;border:1px solid rgba(168,116,79,.55);
      color:var(--copper);padding:12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    .veh-btn.active{
      background:var(--copper);color:#000;border-color:var(--copper);
      box-shadow:0 0 0 3px rgba(168,116,79,.25)
    }

    /* Terms compact box */
    .terms-box{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .terms-summary{display:flex;align-items:center;gap:10px;cursor:pointer;}
    .terms-summary .chev{
      width:10px;height:10px;border-right:2px solid var(--copper);
      border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto;
    }
    .terms-box.open .terms-summary .chev{transform:rotate(45deg)}
    .accept-pill{
      min-width:28px;height:20px;border-radius:999px;border:1px solid #666;
      display:flex;align-items:center;padding:0 2px;position:relative;background:#1a1a1a;
    }
    .accept-dot{width:14px;height:14px;border-radius:50%;background:#333;transition:.2s;border:1px solid #555;}
    .accept-pill.on{border-color:var(--ok);background:rgba(23,201,100,.12)}
    .accept-pill.on .accept-dot{transform:translateX(8px);background:var(--ok);border-color:var(--ok)}
    .accept-label{font-size:.85rem;opacity:.9;margin-left:8px}

    /* Read-more */
    .terms-body{margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .terms-content.clamped{
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      overflow:hidden;position:relative;
    }
    .terms-content.clamped::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:2.2em;
      background:linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,1));
      pointer-events:none;
    }
    .readmore-btn{
      display:inline-block;margin-top:8px;padding:6px 10px;border:1px solid rgba(168,116,79,.55);
      border-radius:8px;background:#1a1a1a;color:#ffddae;font-weight:700;font-size:.85rem;cursor:pointer;
    }

    /* Hints */
    .hint{font-size:.85rem;margin-top:6px}
    .hint.warn{color:var(--warn)}
    .hint.err{color:var(--err)}
    .hint.ok{color:var(--ok)}

    /* Luggage Accordion */
    .luggage-accordion{border:1px solid rgba(168,116,79,.45);border-radius:12px;padding:10px 12px;margin-top:10px;background:#0e0e0e}
    .luggage-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
    .luggage-title{font-weight:700}
    .luggage-chev{width:10px;height:10px;border-right:2px solid var(--copper);border-bottom:2px solid var(--copper);transform:rotate(-45deg);transition:.2s;margin-left:auto}
    .luggage-accordion.open .luggage-chev{transform:rotate(45deg)}
    .luggage-body{display:none;margin-top:10px;color:#e9d5c1;font-size:.95rem;line-height:1.55}
    .luggage-accordion.open .luggage-body{display:block}
    .lug-section h4{margin:6px 0 4px;color:#ffddae}
    .lug-note{opacity:.9;margin:2px 0 8px}
    .lug-list{margin:0 0 10px 18px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,.74);align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal-backdrop.open{display:flex}
    .modal{max-width:860px;width:100%;max-height:86vh;background:#0e0e0e;border:1px solid rgba(168,116,79,.45);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.7);overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(168,116,79,.28);background:#101010}
    .modal-title{font-weight:800;color:#ffddae}
    .modal-body{padding:14px 16px 18px;overflow:auto;color:#e9d5c1;line-height:1.6}
    .close-btn{background:#1a1a1a;border:1px solid rgba(168,116,79,.45);color:#ffddae;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

    /* Jet Faux 3D */
    .jet-showcase { margin: 16px 0 6px; background: #0b0b0b; border: 1px solid rgba(168,116,79,.35); border-radius: 14px; padding: 10px; box-shadow: 0 18px 40px rgba(0,0,0,.55);}
    .jet-faux3d { position: relative; border: 1px solid rgba(168,116,79,.28); border-radius: 12px; overflow: hidden; background: radial-gradient(ellipse at 50% 85%, rgba(0,0,0,.7), rgba(0,0,0,0) 60%);}
    .jet-faux3d .jet { width: 88%; max-width: 780px; display: block; margin: 20px auto 12px; transform-style: preserve-3d; animation: jetYaw 9s linear infinite; }
    @keyframes jetYaw { 0% {transform: perspective(800px) rotateY(-12deg) translateY(0);} 50% {transform: perspective(800px) rotateY(12deg)  translateY(-2px);} 100% {transform: perspective(800px) rotateY(-12deg) translateY(0);} }
    .jet-caption { font-weight: 700; color: #ffddae; text-align: center; margin-top: 6px; letter-spacing: .2px; opacity: .95; }

    /* Mensajes inline */
    .field-error{border-color:#ff6b6b !important; box-shadow:0 0 0 3px rgba(255,107,107,.15) !important;}
    .msg-inline{font-size:.85rem;margin-top:6px}
    .msg-inline.err{color:#ff6b6b}
    .msg-inline.ok{color:#17c964}

    @media (prefers-reduced-motion: reduce){
      .jet-faux3d .jet {animation: none;}
      .turntable .car {filter:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img src="/images/logo.png" alt="Bonanza Transportation Logo" class="logo" />
    </div>
  </header>
  <main>
    <form id="bookingForm" novalidate>
      <!-- Full Name -->
      <label for="fullname">Full Name</label>
      <input id="fullname" name="fullname" type="text" placeholder="Your full name" required />

      <!-- Phone -->
      <label for="phone">Phone Number</label>
      <input id="phone" name="phone" type="tel" placeholder="(123) 456-7890" required />

      <!-- Email -->
      <label for="email">Email Address</label>
      <input id="email" name="email" type="email" placeholder="you@example.com" required />

      <!-- Pickup -->
      <label for="pickup">Pickup Location</label>
      <input id="pickup" name="pickup" type="text" placeholder="Enter pickup address" required />

      <!-- Dropoff -->
      <label for="dropoff">Dropoff Location</label>
      <input id="dropoff" name="dropoff" type="text" placeholder="Enter dropoff address" required />

      <!-- Date & Time -->
      <div class="input-row">
        <div>
          <label for="date">Pickup Date</label>
          <input id="date" name="date" type="date" required />
          <div id="dateHelp" class="helper"></div>
        </div>
        <div>
          <label for="time">Pickup Time</label>
          <input id="time" name="time" type="time" required />
          <div id="timeHelp" class="helper"></div>
        </div>
      </div>

      <!-- Vehicle Selector -->
      <div class="turntable">
        <img src="/images/suburban.png" alt="Selected vehicle" class="car" />
        <div class="platform"></div>
        <div class="vehicle-caption">SUV — Max 5 passengers, 5 suitcases</div>
      </div>
      <div class="veh-toggle">
        <button type="button" class="veh-btn active" data-type="suv" aria-pressed="true">SUV</button>
        <button type="button" class="veh-btn" data-type="van" aria-pressed="false">Van</button>
      </div>

      <!-- Terms -->
      <div class="terms-box">
        <div class="terms-summary">
          <div class="accept-pill" id="acceptPill" role="switch" aria-checked="false" tabindex="0">
            <div class="accept-dot"></div>
          </div>
          <span class="accept-label">I accept the <button type="button" id="openTermsModal" style="background:none;border:none;color:var(--copper);cursor:pointer;text-decoration:underline;padding:0;">Terms & Conditions</button></span>
          <div class="chev"></div>
        </div>
      </div>

      <!-- Luggage -->
      <div class="luggage-accordion" id="luggageAccordion" aria-expanded="false">
        <div class="luggage-summary">
          <span class="luggage-title">Luggage Information</span>
          <div class="luggage-chev"></div>
        </div>
        <div class="luggage-body">
          <div class="lug-section">
            <h4>SUV</h4>
            <p class="lug-note">Max 5 suitcases</p>
          </div>
          <div class="lug-section">
            <h4>Van</h4>
            <p class="lug-note">Up to 12 passengers with luggage</p>
          </div>
        </div>
      </div>

      <!-- Special Instructions -->
      <label for="specialInstructions">Special Instructions</label>
      <textarea id="specialInstructions" name="specialInstructions" placeholder="Optional notes..."></textarea>

      <!-- Calculate Button -->
      <button id="calculate" type="button" disabled>Calculate Price</button>
            <!-- Map -->
      <div id="map" role="region" aria-label="Map with route preview"></div>

      <!-- Form Errors -->
      <div id="formErrors" aria-live="polite" class="hint err" style="margin-top:8px;display:none"></div>

      <!-- Trip Summary -->
      <div id="info" aria-live="polite"></div>

      <!-- Pay Now Button -->
      <button id="pay" type="submit" disabled style="display:none">PAY NOW</button>
    </form>
  </main>

  <!-- Terms Modal -->
  <div class="modal-backdrop" id="termsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="termsTitle" aria-modal="true" tabindex="-1" data-focus-scope>
      <div class="modal-header">
        <h2 id="termsTitle" class="modal-title">Terms & Conditions</h2>
        <button type="button" id="closeTerms" class="close-btn">Close</button>
      </div>
      <div class="modal-body">
        <p>
          These Terms & Conditions govern your booking and travel with Bonanza Transportation. 
          Please read them carefully before confirming your reservation.
        </p>
        <p>
          Reservations must be made at least 24 hours in advance. After-hours fees apply for pickups outside 6:00 am to 11:00 pm.
        </p>
        <p>
          Cancellations must be requested at least 12 hours before pickup time to avoid charges.
        </p>
        <p>
          All fares include taxes and gratuity unless otherwise specified.
        </p>
      </div>
    </div>
  </div>
</body>
<script>
(() => {
  'use strict';

  /* ============ CONFIG ============ */
  const CONFIG = Object.freeze({
    images:{ suv:"/images/suburban.png", van:"/images/van-sprinter.png" },
    baseAddress:"13742 N Jordanelle Pkwy, Kamas, UT",
    hours:{ start:"06:00", end:"23:00" },           // horario operación
    pricing:{
      base(mi){ if(mi<=10)return 120; if(mi<=35)return 190; if(mi<=39)return 210; if(mi<=48)return 230; if(mi<=55)return 250; return mi*5.4; },
      vehicleMultiplier(type, total){ return (type==='van') ? Math.round(total*1.30) : total; },
      afterHoursRate:0.20,
      perMileSurcharge:3
    },
    airlines:new Set(["AA","DL","UA","WN","AS","B6","F9","NK","HA","AC","AM","AF","BA","KL","LH","VS","IB","TK","QR","EK","CM","AV","QF","CX","AZ","SK","LA","AR","TS","WS","DY","NH","JL","KE","XE"]),
    fboKeywords:/\b(fbo|jet center|private terminal|general aviation|hangar|atlantic aviation|million air|signature( aviation| flight| support)?|ross aviation|tac air|ok3 air|provo jet center|sheltair|jet linx|jet aviation|magellan jets|aero charter|aero center|modern aviation|banyan air service|cutter aviation|lynx|western aircraft)\b/i
  });

  /* ============ STATE ============ */
  const S = {
    map:null, ds:null, dr:null, gc:null,
    pickup:null, dropoff:null,
    vehicle:'suv',
    accepted:false,
    last:{base:0,surcharge:0,ahFee:0,total:null,distanceMiles:0}
  };

  /* ============ HELPERS (puros) ============ */
  const $ = id => document.getElementById(id);
  const nextQuarter = d => { const m=d.getMinutes(); const add=15-(m%15||15); d.setMinutes(m+add,0,0); return d; };
  const localISO = d => { const off=d.getTimezoneOffset()*60000; return new Date(d-off).toISOString().slice(0,10); };
  const earliestAllowed = ()=> nextQuarter(new Date(Date.now()+24*60*60*1000)); // regla 24 h
  const is24hAhead = d => d && (d - Date.now()) >= 24*60*60*1000;

  const isAirport = p => (p?.types||[]).includes("airport") || /airport/i.test(p?.name||p?.formatted_address||"");
  const isUtah = p => /\but\b/i.test(p?.formatted_address||"") || /,\s*ut(ah)?\b/i.test(p?.formatted_address||"");
  const isPrivateUtahAirport = p => p && isAirport(p) && isUtah(p) && CONFIG.fboKeywords.test(`${p.name||""} ${p.formatted_address||""}`);

  // Flight / N-number
  const FLIGHT_REGEX=/^([A-Z0-9]{2})\s?-?\s?(\d{1,4})([A-Z])?$/;
  const normalizeFlight=v=>(v||'').toUpperCase().trim().replace(/\s+/g,' ').replace('–','-');
  const validateFlightValue=v=>{
    const m = normalizeFlight(v).match(FLIGHT_REGEX);
    if(!m) return {ok:false,msg:'Invalid format. Use AA1234 or WN 987.'};
    const code=m[1], num=m[2];
    if(!CONFIG.airlines.has(code)) return {ok:false,msg:'Unknown airline code.'};
    if(/^0+$/.test(num)) return {ok:false,msg:'Invalid flight number.'};
    return {ok:true,msg:''};
  };
  const N_NUMBER_REGEX=/^N[1-9]\d{0,4}([A-HJ-NP-Z]{1,2})?$/i;
  const validateNNumber=v=>{
    const val=(v||"").toUpperCase().trim();
    if(!val) return {ok:false,msg:"Please enter the aircraft tail number (e.g., N123AB)."};
    if(!N_NUMBER_REGEX.test(val)) return {ok:false,msg:"Format: N + 1–5 digits + optional 1–2 letters (no I/O)."};
    return {ok:true,msg:"Tail number captured."};
  };

  // Pricing
  const quotePrice = ({miles, vehicle, afterHours, surchargeMiles})=>{
    const base = CONFIG.pricing.base(miles);
    const surcharge = (surchargeMiles>0) ? surchargeMiles * CONFIG.pricing.perMileSurcharge : 0;
    const ahFee = afterHours ? (base+surcharge)*CONFIG.pricing.afterHoursRate : 0;
    const total = CONFIG.pricing.vehicleMultiplier(vehicle, base+surcharge+ahFee);
    return {base,surcharge,ahFee,total};
  };

  // UI helpers
  const setText = (el,txt)=>{ if(el){ el.textContent=txt; el.style.display = txt ? 'block':'none'; } };
  const showFormError = msg => setText($('formErrors'), msg||'');
  const markError = (input, on)=> input && input.classList.toggle('field-error', !!on);

  /* ============ Mount básicos ============ */
  function mountDateTime(){
    const dateEl=$('date'), timeEl=$('time'), dateHelp=$('dateHelp'), timeHelp=$('timeHelp');
    const min = earliestAllowed();
    if(dateEl){ dateEl.min = localISO(min); if(!dateEl.value) dateEl.value = localISO(min); }
    if(timeEl && !timeEl.value){
      const h=String(min.getHours()).padStart(2,'0'); const m=String(min.getMinutes()).padStart(2,'0'); timeEl.value=`${h}:${m}`;
    }
    const update=()=>{
      if(dateHelp && dateEl?.value){
        const d=new Date(dateEl.value+'T00:00:00');
        dateHelp.textContent = `Selected: ${d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})} (min 24h)`;
      }
      if(timeHelp && timeEl?.value) timeHelp.textContent = `Selected: ${timeEl.value}`;
    };
    dateEl?.addEventListener('change', update);
    timeEl?.addEventListener('change', update);
    update();
  }

  function mountVehicleSelector(){
    const suv=document.querySelector('.veh-btn[data-type="suv"]');
    const van=document.querySelector('.veh-btn[data-type="van"]');
    const photo=document.querySelector('.turntable .car');
    const caption=document.querySelector('.vehicle-caption');

    const setVehicle = type=>{
      S.vehicle = type;
      suv?.classList.toggle('active', type==='suv');
      van?.classList.toggle('active', type==='van');
      suv?.setAttribute('aria-pressed', String(type==='suv'));
      van?.setAttribute('aria-pressed', String(type==='van'));
      if(photo) photo.src = (type==='van') ? CONFIG.images.van : CONFIG.images.suv;
      if(caption) caption.textContent = (type==='van') ? 'Van — Up to 12 passengers' : 'SUV — Max 5 passengers, 5 suitcases';
      recalcFromCache();
    };

    suv?.addEventListener('click', ()=> setVehicle('suv'));
    van?.addEventListener('click', ()=> setVehicle('van'));
    setVehicle('suv');
  }

  function mountTerms(){
    const pill=$('acceptPill'), calc=$('calculate'), pay=$('pay');
    const setAccepted=on=>{
      S.accepted=!!on;
      pill?.classList.toggle('on', S.accepted);
      pill?.setAttribute('aria-checked', S.accepted ? 'true':'false');
      if(calc) calc.disabled = !S.accepted;
      syncPayBtn();
    };
    pill?.addEventListener('click', ()=> setAccepted(!S.accepted));
    pill?.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setAccepted(!S.accepted); }});
    setAccepted(false);
  }
  function syncPayBtn(){
    const pay=$('pay'); const ready = S.accepted && S.last.total!=null;
    if(pay){ pay.disabled=!ready; pay.style.display='block'; pay.style.opacity=ready?1:.5; pay.style.cursor=ready?'pointer':'not-allowed'; }
  }

  function mountModal(){
    const modal=$('termsModal'), openBtn=$('openTermsModal'), closeBtn=$('closeTerms');
    let lastFocus=null;
    const getFocusables=()=> modal?.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])') || [];
    const trap=(e)=>{
      if(e.key!=='Tab') return;
      const nodes=Array.from(getFocusables()); if(nodes.length===0) return;
      const first=nodes[0], last=nodes[nodes.length-1];
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    };
    const open=()=>{ if(!modal) return; lastFocus=document.activeElement; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; closeBtn?.focus(); document.addEventListener('keydown',trap); };
    const close=()=>{ if(!modal) return; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; lastFocus?.focus(); document.removeEventListener('keydown',trap); };
    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    modal?.addEventListener('click', e=>{ if(e.target===modal) close(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal?.classList.contains('open')) close(); });
  }

  /* ============ Google Maps ============ */
  window.initMap = function(){
    S.map = new google.maps.Map($("map"), { center:{lat:40.7587,lng:-111.8762}, zoom:10 });
    S.ds = new google.maps.DirectionsService();
    S.dr = new google.maps.DirectionsRenderer(); S.dr.setMap(S.map);
    S.gc = new google.maps.Geocoder();

    const opts={ componentRestrictions:{country:["us"]}, fields:["place_id","name","types","formatted_address","geometry","address_components"] };
    const acPickup  = new google.maps.places.Autocomplete($("pickup"), opts);
    const acDropoff = new google.maps.places.Autocomplete($("dropoff"), opts);

    acPickup.addListener("place_changed", ()=>{ S.pickup = acPickup.getPlace() || null; updateFlightVisibility(); });
    acDropoff.addListener("place_changed", ()=>{ S.dropoff = acDropoff.getPlace() || null; });
  };

  const routeAsync = o=> new Promise((res,rej)=>{ S.ds.route(o,(r,s)=> s==="OK"&&r?res(r):rej(s||"ROUTE_ERROR")); });
  const geocodeAsync=req=> new Promise((res,rej)=>{ S.gc.geocode(req,(results,status)=>{ if(status==="OK"&&results?.[0]) res(results[0]); else rej(status||"GEOCODE_ERROR"); }); });
  const countyByPlaceId = async placeId => { try{ const r=await geocodeAsync({placeId}); const c=r.address_components.find(c=>c.types.includes("administrative_area_level_2")); return c?.long_name||""; }catch(_){ return ""; } };
  const milesFromBase = async placeId => { const r=await routeAsync({origin:CONFIG.baseAddress,destination:{placeId},travelMode:google.maps.TravelMode.DRIVING}); return r.routes[0].legs[0].distance.value/1609.34; };

  /* ============ Vuelo UI ============ */
  const pickupIsUtahAirport = ()=> S.pickup && isAirport(S.pickup) && isUtah(S.pickup);
  function updateFlightVisibility(){
    const isUTA = pickupIsUtahAirport();
    const isPvt = isPrivateUtahAirport(S.pickup);
    const commWrap=$('flightContainer'), pvtWrap=$('privateFlightContainer');
    if(commWrap){ commWrap.style.display = (isUTA && !isPvt) ? 'block':'none'; if(!(isUTA && !isPvt)) resetFlightCommercial(); }
    if(pvtWrap){  pvtWrap.style.display = (isUTA &&  isPvt) ? 'block':'none'; if(!(isUTA &&  isPvt)) resetFlightPrivate(); }
  }
  function resetFlightCommercial(){ const n=$('flightNumber'), o=$('flightOrigin'), oh=$('originHelp'), h=$('flightHint'); if(n){n.value="";n.setCustomValidity("");} if(h)h.style.display='none'; if(o){o.value="";o.setCustomValidity("");} if(oh)oh.style.display='none'; }
  function resetFlightPrivate(){ const t=$('tailNumber'), th=$('tailHelp'), po=$('pvtOrigin'), poh=$('pvtOriginHelp'); if(t){t.value="";t.setCustomValidity("");} if(th)th.style.display='none'; if(po){po.value="";po.setCustomValidity("");} if(poh)poh.style.display='none'; }

  function wireFlightValidation(){
    const input=$('flightNumber'), hint=$('flightHint');
    const origin=$('flightOrigin'), originHelp=$('originHelp');
    const tail=$('tailNumber'), tailHelp=$('tailHelp');
    const pvtOrigin=$('pvtOrigin'), pvtOriginHelp=$('pvtOriginHelp');

    input?.addEventListener('input', ()=>{
      if(!pickupIsUtahAirport() || isPrivateUtahAirport(S.pickup)){ input.setCustomValidity(""); hint&&(hint.style.display='none'); return; }
      const r = validateFlightValue(input.value);
      input.setCustomValidity(r.ok?"":r.msg); hint&&(hint.style.display = input.value.trim().length ? 'block':'none');
    });
    origin?.addEventListener('input', ()=>{
      if(!pickupIsUtahAirport() || isPrivateUtahAirport(S.pickup)){ origin.setCustomValidity(""); originHelp&&(originHelp.style.display='none'); return; }
      const ok = /^[A-Za-z .,'-]{2,}( \([A-Z]{3}\))?$/.test((origin.value||"").trim());
      origin.setCustomValidity(ok?"":"Use letters and optional airport code, e.g., Van Nuys (VNY).");
      if(originHelp){ originHelp.textContent = ok ? 'Origin city captured.' : 'Use letters and optional airport code, e.g., Van Nuys (VNY).'; originHelp.className = 'hint ' + (ok ? 'ok' : 'warn'); originHelp.style.display='block'; }
    });
    tail?.addEventListener('input', ()=>{
      if(!isPrivateUtahAirport(S.pickup)){ tail.setCustomValidity(""); tailHelp&&(tailHelp.style.display='none'); return; }
      const r = validateNNumber(tail.value);
      tail.setCustomValidity(r.ok?"":r.msg);
      if(tailHelp){ tailHelp.textContent = r.msg || 'Tail number captured.'; tailHelp.className='hint ' + (r.ok ? 'ok':'warn'); tailHelp.style.display='block'; }
    });
    pvtOrigin?.addEventListener('input', ()=>{
      if(!isPrivateUtahAirport(S.pickup)){ pvtOrigin.setCustomValidity(""); pvtOriginHelp&&(pvtOriginHelp.style.display='none'); return; }
      const ok = /^[A-Za-z .,'-]{2,}( \([A-Z]{3}\))?$/.test((pvtOrigin.value||"").trim());
      pvtOrigin.setCustomValidity(ok?"":"Use letters and optional airport code, e.g., Van Nuys (VNY).");
      if(pvtOriginHelp){ pvtOriginHelp.textContent = ok ? 'Origin city captured.' : 'Use letters and optional airport code, e.g., Van Nuys (VNY).'; pvtOriginHelp.className='hint ' + (ok ? 'ok':'warn'); pvtOriginHelp.style.display='block'; }
    });
  }

  /* ============ Summary / recálculo ============ */
  function renderInfo(leg, q){
    const miles = leg.distance.value/1609.34;
    const el = $("info");
    el.style.display = "block";
    el.innerHTML = `
      <h3 class="info-title">Trip Summary</h3>
      <div class="kpis">
        <div class="kpi"><div class="label">Distance</div><div class="value">${miles.toFixed(1)}<span class="unit">mi</span></div></div>
        <div class="kpi"><div class="label">Duration</div><div class="value">${leg.duration.text}</div></div>
        <div class="kpi"><div class="label">Price</div><div class="value price">$${q.total.toFixed(2)}</div></div>
      </div>
      ${(q.surcharge>0 || q.ahFee>0) ? `
        <div class="divider"></div>
        <div class="breakdown">
          ${q.surcharge>0 ? `<div class="row"><span>Distance Surcharge</span><span>$${q.surcharge.toFixed(2)}</span></div>`:''}
          ${q.ahFee>0 ? `<div class="row"><span>After-Hours Fee (20%) – Regular Hours: 6:00 am to 11:00 pm</span><span>$${q.ahFee.toFixed(2)}</span></div>`:''}
          <div class="divider"></div>
          <div class="row total"><span>Total</span><span>$${q.total.toFixed(2)}</span></div>
          <div class="tax-note">Taxes &amp; gratuity included</div>
        </div>` : ``}
    `;
  }
  function recalcFromCache(){
    const info=$("info"); if(!info || S.last.base==null) return;
    const final = CONFIG.pricing.vehicleMultiplier(S.vehicle, S.last.base + S.last.surcharge + S.last.ahFee);
    const priceEl = info.querySelector('.kpi .value.price');
    const totalEl = info.querySelector('.row.total span:last-child');
    if(priceEl) priceEl.textContent = `$${final.toFixed(2)}`;
    if(totalEl) totalEl.textContent = `$${final.toFixed(2)}`;
    S.last.total = final; syncPayBtn();
  }

  /* ============ Form flow ============ */
  function wireForm(){
    const form=$('bookingForm'), calc=$('calculate');

    // Email
    (function(){
      const input = $('email'), help=$('emailHelp');
      const validateEmail=v=>{
        const val=(v||'').trim();
        const basic=/^[^\s@]+@[^\s@]+\.[^\s@]{2,24}$/.test(val);
        if(!basic) return {ok:false,msg:'Please enter a valid email, e.g., name@domain.com'};
        if(/\.\./.test(val)) return {ok:false,msg:'Email cannot contain consecutive dots'};
        const typos=[/@gmal\.com$/i,/@gmial\.com$/i,/@hotnail\.com$/i,/@yaho\.com$/i];
        if(typos.some(rx=>rx.test(val))) return {ok:false,msg:'Please correct the domain spelling (e.g., @gmail.com)'};
        return {ok:true,msg:'Email looks good'};
      };
      input?.addEventListener('input', ()=>{
        const r=validateEmail(input.value); input.setCustomValidity(r.ok?'':r.msg);
        if(help){ help.textContent=r.ok?'Valid email':r.msg; help.className='hint ' + (r.ok?'ok':'err'); }
      });
    })();

    // Phone
    (function(){
      const input=$('phone'), help=$('phoneHelp');
      const formatUS=d=>{ if(d.startsWith('1')) d=d.slice(1); d=d.slice(0,10); const a=d.slice(0,3), b=d.slice(3,6), c=d.slice(6,10);
        if(d.length>6) return `(${a}) ${b}-${c}`; if(d.length>3) return `(${a}) ${b}`; if(d.length>0) return `(${a}`; return ''; };
      const validateNANP=d=>{ if(d.length===11 && d.startsWith('1')) d=d.slice(1); if(d.length!==10) return {ok:false,msg:'Enter a 10-digit US number'};
        if(!/^[2-9]/.test(d[0])) return {ok:false,msg:'Area code must start 2–9'}; if(!/^[2-9]/.test(d[3])) return {ok:false,msg:'Exchange must start 2–9'}; return {ok:true,msg:'Valid US number'}; };
      input?.addEventListener('input', ()=>{ const digits=input.value.replace(/\D/g,'').slice(0,11);
        input.value=formatUS(digits); const v=validateNANP(digits); input.setCustomValidity(v.ok?'':v.msg);
        if(help){ help.textContent=v.ok?'Valid US number':v.msg; help.className='hint ' + (v.ok?'ok':'err'); } });
    })();

    // Blur para pickup/dropoff
    ['pickup','dropoff'].forEach(id=>{
      const el=$(id);
      el?.addEventListener('blur', ()=>{ const empty=!el.value.trim(); markError(el, empty); if(empty) showFormError('This field is required.'); });
    });

    const getDT=()=>{ const ds=$('date')?.value, ts=$('time')?.value; return (ds && ts) ? new Date(`${ds}T${ts}:00`) : null; };

    calc?.addEventListener('click', async ()=>{
      showFormError('');
      if(!S.accepted){ showFormError('Please accept Terms & Conditions to continue.'); return; }

      const pickupEl=$('pickup'), dropoffEl=$('dropoff');
      const dt=getDT();
      let hasErr=false;

      if(!pickupEl.value.trim()){ markError(pickupEl,true); hasErr=true; }
      if(!dropoffEl.value.trim()){ markError(dropoffEl,true); hasErr=true; }
      if(!dt || !is24hAhead(dt)){ showFormError('Choose a date/time at least 24 hours in advance.'); hasErr=true; }
      if(hasErr) return;
      if(!S.pickup?.place_id || !S.dropoff?.place_id){ showFormError('Please select from suggestions.'); return; }

      try{
        const trip=await routeAsync({ origin:{placeId:S.pickup.place_id}, destination:{placeId:S.dropoff.place_id}, travelMode:google.maps.TravelMode.DRIVING });
        S.dr.setDirections(trip);
        const leg=trip.routes[0].legs[0];
        const miles=leg.distance.value/1609.34;

        const countyFrom = p => (p?.address_components||[]).find(x=>x.types?.includes("administrative_area_level_2"))?.long_name || "";
        const pickupCounty = countyFrom(S.pickup) || await countyByPlaceId(S.pickup.place_id);
        const dropCounty   = countyFrom(S.dropoff) || await countyByPlaceId(S.dropoff.place_id);
        const inAllowed = /Summit County|Wasatch County/;
        const pickupAir = isAirport(S.pickup);
        let surchargeMiles=0;

        if(pickupAir){
          if(!inAllowed.test(dropCounty||"")) surchargeMiles = await milesFromBase(S.pickup.place_id);
        }else{
          if(!inAllowed.test(pickupCounty||"")) surchargeMiles = await milesFromBase(S.pickup.place_id);
        }

        const afterHours = (()=> {
          const [sh,sm]=CONFIG.hours.start.split(':').map(Number);
          const [eh,em]=CONFIG.hours.end.split(':').map(Number);
          const d = dt;
          const start=new Date(d); start.setHours(sh,sm,0,0);
          const end=new Date(d); end.setHours(eh,em,0,0);
          return (d<start)||(d>end);
        })();

        const q = quotePrice({ miles, vehicle:S.vehicle, afterHours, surchargeMiles });
        S.last = { base:q.base, surcharge:q.surcharge, ahFee:q.ahFee, total:q.total, distanceMiles:miles };
        renderInfo(leg,q); syncPayBtn();
      }catch(err){
        showFormError(`Could not calculate route: ${err}`);
      }
    });

    form?.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!S.accepted || S.last.total==null){ showFormError('Please accept Terms & Conditions to continue.'); return; }
      const payload = {
        fullname: $('fullname').value,
        phone: $('phone').value,
        email: $('email').value,
        pickup: $('pickup').value,
        dropoff: $('dropoff').value,
        specialInstructions: $('specialInstructions')?.value || null,
        date: $('date').value,
        time: $('time').value,
        flightNumber: $('flightNumber')?.value || null,
        flightOriginCity: $('flightOrigin')?.value || null,
        tailNumber: $('tailNumber')?.value || null,
        privateFlightOriginCity: $('pvtOrigin')?.value || null,
        vehicleType: S.vehicle,
        distanceMiles: S.last.distanceMiles,
        quotedTotal: S.last.total,
        confirmationNumber: genConfirmation(),
        acceptedTermsAt: new Date().toISOString()
      };
      console.log('PAYLOAD →', payload);
      alert(`Your confirmation number is ${payload.confirmationNumber}`);
      // TODO: POST /api/create-checkout-session
    });
  }

  const genConfirmation=()=>{ const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); const rand=Math.random().toString(36).slice(2,6).toUpperCase(); return `BZ-${y}${m}${day}-${rand}`; };

  /* ============ Luggage toggle ============ */
  (function wireLuggage(){
    const acc=$('luggageAccordion'), sum=acc?.querySelector('.luggage-summary');
    sum?.addEventListener('click', ()=>{ const open=acc.classList.toggle('open'); acc.setAttribute('aria-expanded', open?'true':'false'); });
  })();

  /* ============ Init ============ */
  function init(){ mountDateTime(); mountVehicleSelector(); mountTerms(); mountModal(); wireFlightValidation(); wireForm(); }
  init();
})();
</script>

<!-- Google Maps Loader (reemplaza TU_API_KEY_AQUI) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap">
</script>
