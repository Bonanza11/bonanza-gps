<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>

  <style>
    :root{ --copper:#a8744f; --ok:#17c964; --warn:#ffcc66; --err:#ff6b6b; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:var(--copper);font-family:Arial,sans-serif}

    /* Header / Logo */
    header{display:flex;justify-content:center;align-items:center;padding:20px 16px}
    .logo-wrap{ position:relative }
    .logo{
      width:180px;height:180px;border-radius:50%;border:2px solid var(--copper);
      object-fit:cover;display:block;position:relative;
      box-shadow:0 0 2px rgba(192,139,92,.35) inset,0 0 8px rgba(0,0,0,.6),0 0 10px rgba(192,139,92,.45);
      filter: drop-shadow(0 0 5px rgba(192,139,92,.45));
    }
    .logo-wrap::after{content:"";position:absolute;inset:-8px;border-radius:50%;box-shadow:0 0 22px 10px rgba(192,139,92,.35);pointer-events:none;}

    /* Layout */
    main{max-width:760px;width:92vw;margin:0 auto 40px;padding:0 16px}
    label{display:block;margin:12px 0 6px;font-weight:700}

    /* Inputs */
    input,select,textarea{
      width:100%;padding:10px;border:1px solid rgba(168,116,79,.35);
      border-radius:6px;background:#0e0e0e;color:var(--copper);
      font-size:16px;
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--copper);box-shadow:0 0 6px rgba(168,116,79,.5)}

    /* Buttons */
    button{
      background:var(--copper);color:#000;border:none;padding:12px 18px;
      font-size:16px;border-radius:6px;cursor:pointer;transition:all 0.25s ease;
      font-weight:700;
    }
    button:disabled{background:rgba(168,116,79,.35);color:#777;cursor:not-allowed}
    button:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 10px rgba(168,116,79,.6)}

    /* Vehicle selector */
    .veh-wrap{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .veh-btn{flex:1;min-width:120px;background:#111;border:2px solid rgba(168,116,79,.35);border-radius:8px;cursor:pointer;overflow:hidden;transition:all .25s ease}
    .veh-btn img{width:100%;height:80px;object-fit:cover}
    .veh-btn.active{border-color:var(--copper);box-shadow:0 0 8px rgba(168,116,79,.6)}

    /* Terms pill */
    .pill{display:inline-block;padding:6px 12px;background:#222;border-radius:20px;cursor:pointer;transition:.25s}
    .pill.on{background:var(--ok);color:#000}

    /* Info box */
    #info{margin-top:20px;display:none}
    .kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .kpi{flex:1;min-width:100px;text-align:center;background:#111;padding:10px;border-radius:8px}
    .kpi .label{font-size:14px;color:#aaa}
    .kpi .value{font-size:20px;font-weight:700}

    .divider{height:1px;background:rgba(168,116,79,.35);margin:10px 0}
    .breakdown .row{display:flex;justify-content:space-between;padding:4px 0}
    .breakdown .total{font-weight:800;color:#fff}

    /* Meet & Greet */
    #meetGreetBox{
      display:none;margin-top:10px;padding:10px;border:1px solid rgba(168,116,79,.35);
      border-radius:10px;background:#0e0e0e
    }
    #meetGreetBox .mg-title{font-weight:800;color:#ffddae;margin-bottom:6px}
    #meetGreetBox .mg-choice{display:flex;align-items:center;gap:8px;margin:6px 0}
    #meetGreetBox input[type="radio"]{accent-color:var(--copper)}
  </style>
</head>
<body>
  <header>
    <div class="logo-wrap">
      <img src="logo.png" alt="Bonanza Logo" class="logo">
    </div>
  </header>
  <main>
    <label for="fullname">Full Name</label>
    <input type="text" id="fullname" placeholder="John Doe">

    <label for="phone">Phone</label>
    <input type="tel" id="phone" placeholder="(555) 555-5555">

    <label for="email">Email</label>
    <input type="email" id="email" placeholder="you@example.com">

    <label for="pickup">Pickup Location</label>
    <input type="text" id="pickup" placeholder="Enter pickup address">

    <label for="dropoff">Dropoff Location</label>
    <input type="text" id="dropoff" placeholder="Enter dropoff address">

    <!-- Meet & Greet -->
    <div id="meetGreetBox" aria-hidden="true">
      <div class="mg-title">Meet &amp; Greet en SLC — $50</div>
      <div class="mg-choice">
        <input type="radio" id="mg-tsa" name="meetGreetOption" value="tsa_exit">
        <label for="mg-tsa">Salida TSA</label>
      </div>
      <div class="mg-choice">
        <input type="radio" id="mg-baggage" name="meetGreetOption" value="baggage_claim">
        <label for="mg-baggage">Recogida de equipaje</label>
      </div>
      <div class="helper">Se incluye en la base para calcular After-Hours (+20%).</div>
    </div>
        <label for="date">Pickup Date</label>
    <input type="date" id="date">

    <label for="time">Pickup Time</label>
    <input type="time" id="time">

    <label for="vehicle">Select Vehicle</label>
    <div class="veh-wrap">
      <div class="veh-btn" data-type="suv">
        <img src="suv.jpg" alt="SUV 1-5 pax">
        <div class="veh-label">SUV 1–5 pax</div>
      </div>
      <div class="veh-btn" data-type="van">
        <img src="van.jpg" alt="Van 12 pax">
        <div class="veh-label">Van 12 pax</div>
      </div>
    </div>

    <label for="notes">Special Instructions</label>
    <textarea id="notes" placeholder="Any additional details..."></textarea>

    <!-- Flight info -->
    <div id="flightContainer" style="display:none">
      <label for="flight">Flight Number</label>
      <input type="text" id="flight" placeholder="Example: DL1234">
    </div>

    <!-- Terms -->
    <div style="margin-top:12px">
      <span id="acceptPill" class="pill">Accept Terms &amp; Conditions</span>
      <a href="#" id="openTermsModal" style="margin-left:10px;color:var(--copper)">Read Terms</a>
    </div>

    <!-- Modal Terms -->
    <div id="termsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:1000">
      <div style="background:#111;padding:20px;max-width:500px;border-radius:10px">
        <h2>Terms &amp; Conditions</h2>
        <p>By booking with Bonanza Transportation, you agree to our policies, including cancellation fees and service conditions.</p>
        <button id="closeTerms">Close</button>
      </div>
    </div>

    <!-- Map -->
    <div id="map" style="width:100%;height:300px;margin-top:20px;border-radius:8px;overflow:hidden"></div>

    <!-- Buttons -->
    <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
      <button id="calculate" disabled>Calculate Price</button>
      <button id="pay" disabled>PAY NOW</button>
    </div>

    <!-- Info box -->
    <div id="info"></div>

    <script>
      /* ===== Config ===== */
      const MEET_GREET_FEE = 50;
      let meetGreetChoice = null;  // 'tsa_exit' | 'baggage_claim' | null
      const allowedCounties = ["Summit County", "Wasatch County"];
      const vanMultiplier = 1.3;
      const priceTable = [
        { max: 10, price: 120 },
        { max: 35, price: 190 },
        { max: 39, price: 210 },
        { max: 48, price: 230 },
        { max: 55, price: 250 },
        { max: Infinity, perMile: 5.40 }
      ];

      let pickupPlace = null;
      let dropoffPlace = null;
      let selectedVehicle = 'suv';

      /* ===== Helpers ===== */
      function isAirport(place){
        if(!place) return false;
        const types = place.types || [];
        return types.includes("airport") || /airport/i.test(place.name || "");
      }
      function isPrivateUtahAirport(place){
        if(!place) return false;
        const name = (place.name || "").toLowerCase();
        return /fbo|private/i.test(name);
      }
      function isSLCCommercial(place){
        if(!place) return false;
        if(!isAirport(place)) return false;
        if(isPrivateUtahAirport(place)) return false;
        const t = `${place.name||""} ${place.formatted_address||""}`.toLowerCase();
        return /salt lake city international airport|slc airport/.test(t);
      }
            function isAfterHours(dateStr, timeStr){
        if(!dateStr || !timeStr) return false;
        const [hour, minute] = timeStr.split(":").map(Number);
        const mins = hour*60 + minute;
        const start = 6*60; // 6:00 am
        const end = 23*60;  // 11:00 pm
        return (mins < start || mins > end);
      }

      function calculateBase(miles){
        for(const row of priceTable){
          if(miles <= row.max){
            return row.price ?? (row.perMile * miles);
          }
        }
        return 0;
      }

      function applyVehicleMultiplier(amount){
        return selectedVehicle === 'van' ? amount * vanMultiplier : amount;
      }

      function updateFlightVisibility(){
        const show = isAirport(pickupPlace);
        document.getElementById("flightContainer").style.display = show ? 'block' : 'none';
      }

      function updateMeetGreetVisibility(){
        const box = document.getElementById('meetGreetBox');
        if(!box) return;
        const show = isSLCCommercial(pickupPlace);
        box.style.display = show ? 'block' : 'none';
        box.setAttribute('aria-hidden', show ? 'false' : 'true');
        if(!show){
          meetGreetChoice = null;
          document.querySelectorAll('input[name="meetGreetOption"]').forEach(r=> r.checked=false);
        }
      }

      document.querySelectorAll('input[name="meetGreetOption"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{ meetGreetChoice = radio.value; });
      });

      /* ===== Map Init ===== */
      function initMap(){
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 40.7608, lng: -111.8910 },
          zoom: 10
        });
        const pickupInput = document.getElementById("pickup");
        const dropoffInput = document.getElementById("dropoff");
        const acPickup = new google.maps.places.Autocomplete(pickupInput);
        const acDropoff = new google.maps.places.Autocomplete(dropoffInput);

        acPickup.addListener("place_changed", ()=>{
          pickupPlace = acPickup.getPlace() || null;
          updateFlightVisibility();
          updateMeetGreetVisibility();
        });
        acDropoff.addListener("place_changed", ()=>{
          dropoffPlace = acDropoff.getPlace() || null;
          updateMeetGreetVisibility();
        });

        window.mapObj = map;
      }

      /* ===== Events ===== */
      document.getElementById("acceptPill").addEventListener("click", function(){
        this.classList.toggle("on");
        document.getElementById("calculate").disabled = !this.classList.contains("on");
        document.getElementById("pay").disabled = true;
      });

      document.getElementById("openTermsModal").addEventListener("click", e=>{
        e.preventDefault();
        document.getElementById("termsModal").style.display = "flex";
      });
      document.getElementById("closeTerms").addEventListener("click", ()=>{
        document.getElementById("termsModal").style.display = "none";
      });

      document.querySelectorAll(".veh-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".veh-btn").forEach(b=> b.classList.remove("active"));
          btn.classList.add("active");
          selectedVehicle = btn.dataset.type;
        });
      });
            /* ===== Price Calculation ===== */
      document.getElementById("calculate").addEventListener("click", ()=>{
        if(!pickupPlace || !dropoffPlace){
          alert("Please select both pickup and dropoff locations.");
          return;
        }
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins: [pickupPlace.geometry.location],
          destinations: [dropoffPlace.geometry.location],
          travelMode: "DRIVING"
        }, (res, status)=>{
          if(status !== "OK"){
            alert("Error calculating distance");
            return;
          }
          const miles = res.rows[0].elements[0].distance.value / 1609.34;
          let base = calculateBase(miles);

          // Meet & Greet fee
          if(isSLCCommercial(pickupPlace) && meetGreetChoice){
            base += MEET_GREET_FEE;
          }

          // Vehicle multiplier
          base = applyVehicleMultiplier(base);

          // After-Hours
          if(isAfterHours(document.getElementById("date").value, document.getElementById("time").value)){
            base *= 1.20;
          }

          const total = Math.round(base * 100) / 100;

          // Info display
          const infoBox = document.getElementById("info");
          infoBox.innerHTML = `
            <div class="kpis">
              <div class="kpi">
                <div class="label">Distance</div>
                <div class="value">${miles.toFixed(1)} mi</div>
              </div>
              <div class="kpi">
                <div class="label">Vehicle</div>
                <div class="value">${selectedVehicle.toUpperCase()}</div>
              </div>
              <div class="kpi">
                <div class="label">Meet &amp; Greet</div>
                <div class="value">${meetGreetChoice ? "$" + MEET_GREET_FEE : "No"}</div>
              </div>
              <div class="kpi">
                <div class="label">After-Hours</div>
                <div class="value">${isAfterHours(document.getElementById("date").value, document.getElementById("time").value) ? "Yes" : "No"}</div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="breakdown">
              <div class="row"><span>Base</span><span>$${calculateBase(miles).toFixed(2)}</span></div>
              ${meetGreetChoice && isSLCCommercial(pickupPlace) ? `<div class="row"><span>Meet &amp; Greet</span><span>$${MEET_GREET_FEE.toFixed(2)}</span></div>` : ""}
              ${selectedVehicle === "van" ? `<div class="row"><span>Van Multiplier</span><span>x${vanMultiplier}</span></div>` : ""}
              ${isAfterHours(document.getElementById("date").value, document.getElementById("time").value) ? `<div class="row"><span>After-Hours</span><span>+20%</span></div>` : ""}
              <div class="divider"></div>
              <div class="row total"><span>Total</span><span>$${total.toFixed(2)}</span></div>
            </div>
          `;
          infoBox.style.display = "block";

          // Enable pay button
          document.getElementById("pay").disabled = false;
        });
      });

      /* ===== Payment ===== */
      document.getElementById("pay").addEventListener("click", ()=>{
        const totalText = document.querySelector("#info .total span:last-child");
        if(!totalText){ alert("Please calculate price first."); return; }
        const amount = parseFloat(totalText.textContent.replace("$",""));
        fetch("/api/create-checkout-session",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ amount })
        }).then(res=>res.json())
          .then(data=>{
            if(data.url){ window.location.href = data.url; }
            else{ alert("Error creating checkout session."); }
          }).catch(err=>{
            console.error(err);
            alert("Error processing payment.");
          });
      });

      /* ===== Form Validation ===== */
      function validateEmail(email){
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }
      function validatePhone(phone){
        return /^\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/.test(phone);
      }
      const fullnameEl = document.getElementById('fullname');
      const phoneEl = document.getElementById('phone');
      const emailEl = document.getElementById('email');
      [fullnameEl, phoneEl, emailEl, document.getElementById('pickup'), document.getElementById('dropoff'), document.getElementById('date'), document.getElementById('time')]
        .forEach(el=> el.addEventListener('input', checkFormValidity));

      function checkFormValidity(){
        const termsAccepted = document.getElementById('acceptPill').classList.contains('on');
        const isValid = fullnameEl.value.trim() && validatePhone(phoneEl.value) && validateEmail(emailEl.value)
          && document.getElementById('pickup').value.trim()
          && document.getElementById('dropoff').value.trim()
          && document.getElementById('date').value
          && document.getElementById('time').value
          && termsAccepted;
        document.getElementById('calculate').disabled = !isValid;
      }
            /* ===== Initialization ===== */
      window.addEventListener('load', ()=>{
        checkFormValidity();
      });
    </script>

    <!-- Load Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap" async defer></script>

  </main>
</body>
</html>
