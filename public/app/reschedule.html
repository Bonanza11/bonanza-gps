<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>

  <!-- Estilos globales de Bonanza -->
  <link rel="stylesheet" href="/app/styles/app.css"/>

  <style>
    :root{ --copper:#a8744f; }
    body { background:#000; color:#e9d5c1; }
    .hidden{display:none !important;}

    .container{ max-width:1120px; margin:0 auto; padding:8px 16px 20px; }

    .card{
      position:relative;
      background:linear-gradient(180deg,#101010,#0b0b0b);
      border:1px solid rgba(192,139,92,.35);
      border-radius:16px; padding:14px 14px 16px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .brand-badge{
      position:absolute; top:10px; right:12px;
      width:58px; height:58px; border-radius:50%;
      border:2px solid var(--copper);
      background:#000 url("/images/bonanza-logo.PNG") center/cover no-repeat;
      box-shadow:0 0 8px rgba(168,116,79,.35);
    }
    h1{
      margin:0 0 10px; font-size:1.35rem; color:#ffddae; text-align:center;
      letter-spacing:.2px;
    }

    .grid-main{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width:980px){ .grid-main{ grid-template-columns:1fr; } }

    .orig{ background:#0b0b0b; border:1px solid rgba(168,116,79,.45);
      border-radius:12px; padding:12px; }
    .orig .head{display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:8px; border-bottom:1px solid rgba(168,116,79,.25);}
    .orig .label{ color:#cfa47f; font-size:.9rem; }
    .orig .value{ color:#ffddae; font-weight:800; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }

    label{ display:block; margin:8px 0 4px; font-weight:700 }
    input{ height:40px; font-size:14px; }
    .row{ display:flex; gap:8px; }
    .row>*{ flex:1 }
    #map{ height:220px; margin-top:8px; border-radius:12px; overflow:hidden }

    .pillbar{ display:flex; gap:8px; }
    .pillbar .pill{flex:1 1 0; text-align:center; padding:9px; border-radius:10px;
      background:#1a1a1a; color:var(--copper); border:1px solid rgba(168,116,79,.55);
      cursor:pointer; font-weight:700; font-size:.95rem;}
    .pillbar .pill.active{background:var(--copper); color:#000; border-color:var(--copper);
      box-shadow:0 0 0 3px rgba(168,116,79,.22);}

    .status{ min-height:18px; color:#ffcc66; margin:6px 0; font-size:.92rem }
    .muted{ color:#c9a97c; font-size:.9rem; margin-top:6px; }
    .summaryBox{margin-top:8px; background:#0e0e0e; border:1px solid rgba(168,116,79,.28);
      border-radius:12px; padding:10px;}

    button{ margin-top:8px; padding:12px 14px; font-size:16px }
    .ghost{ background:#1a1a1a; color:#ffddae; border:1px solid rgba(168,116,79,.45) }

    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent); margin:10px 0; }
    .toprow{ display:flex; gap:10px; align-items:flex-end; margin-bottom:8px }
    .toprow>*:first-child{ flex:1 }
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <div class="brand-badge" aria-hidden="true"></div>
      <h1>Reschedule Reservation</h1>

      <div class="toprow">
        <div>
          <label for="cn">Reservation Code (CN)</label>
          <input id="cn" placeholder="BZ-2025MMDD-XXXX" autocomplete="off"/>
        </div>
        <button id="load" style="flex:0 0 160px;">Load</button>
      </div>
      <div id="status" class="status"></div>

      <div class="grid-main">
        <section id="original" class="orig hidden">…</section>
        <section id="form" class="hidden">…</section>
      </div>
    </div>
  </main>

  <!-- Callback seguro -->
  <script>
    window.initReschedule = function () {
      const start = () => { window.ResUI && ResUI.initMapAndPlaces && ResUI.initMapAndPlaces(); };
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", start, { once:true });
      } else {
        start();
      }
    };
  </script>

  <!-- Google Maps con async + defer -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initReschedule"></script>

  <!-- Lógica completa -->
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    const $ = id => document.getElementById(id);
    const money = c => '$' + (Math.round(c)/100).toFixed(2);
    let booking=null, vehicleType='suv', mgChoice='none', lastQuote=0, lastMiles=0;

    function activatePills(bar, attr, value){
      if(!bar) return;
      [...bar.querySelectorAll('.pill')].forEach(p=>{
        p.classList.toggle('active', p.getAttribute(attr)===value);
      });
    }
    const mgLabel = k => k==='tsa_exit'?'TSA Exit (+$50)':k==='baggage_claim'?'Baggage Claim (+$50)':'No Meet & Greet';

    async function fetchQuote(miles){
      const r=await fetch('/api/book/quote',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({pickup:$('pickup').value.trim(),dropoff:$('dropoff').value.trim(),distance_miles:miles,vehicleType,meetGreet:mgChoice})});
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'quote_failed'); return j.quote.total_cents;
    }

    window.ResUI = {
      map:null, ds:null, dr:null,
      initMapAndPlaces(){
        const mapDiv = $('#map'); if(!mapDiv) return;
        const center={lat:40.7608,lng:-111.8910};
        this.map=new google.maps.Map(mapDiv,{center,zoom:10,mapTypeControl:false,streetViewControl:false,fullscreenControl:false});
        this.ds=new google.maps.DirectionsService();
        this.dr=new google.maps.DirectionsRenderer({map:this.map,preserveViewport:false});
        this.attachAC('pickup', p=>{ this.toggleFlightFields(); this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });
        this.attachAC('dropoff', p=>{ this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });
      },
      attachAC(id, cb){
        const el=$(id); if(!el) return;
        const ac=new google.maps.places.Autocomplete(el,{fields:["place_id","geometry","name","formatted_address"],componentRestrictions:{country:["us"]}});
        ac.addListener('place_changed',()=>cb(ac.getPlace()));
      },
      toggleFlightFields(){
        const txt=($('#pickup').value||'').toLowerCase();
        const isSLC = /(salt lake city|slc)/i.test(txt);
        $('#flightFields')?.classList.toggle('hidden', !isSLC);
      },
      async draw(pick,drop){
        if(!pick||!drop) return null;
        const res=await this.ds.route({origin:pick,destination:drop,travelMode:google.maps.TravelMode.DRIVING});
        this.dr.setDirections(res);
        const leg = res.routes?.[0]?.legs?.[0]||null;
        if(leg?.distance?.value){ lastMiles = leg.distance.value/1609.344; }
        return leg;
      },
      maybe(){ const p=$('pickup').value.trim(), d=$('dropoff').value.trim(); if(p&&d) this.draw(p,d).catch(()=>{}); }
    };

    // === Eventos ===
    $('#cn')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#load')?.click(); }});
    $('#load')?.addEventListener('click', async ()=>{ /* … tu lógica completa de load CN … */ });
    $('#vehBar')?.addEventListener('click',ev=>{ /* … tu lógica … */ });
    $('#mgBar')?.addEventListener('click',ev=>{ /* … tu lógica … */ });
    $('#recalc')?.addEventListener('click', async ()=>{ /* … tu lógica … */ });
    $('#reset')?.addEventListener('click', ()=>{ /* … tu lógica … */ });
    $('#submit')?.addEventListener('click', async ()=>{ /* … tu lógica … */ });
  });
  </script>
</body>
</html>
