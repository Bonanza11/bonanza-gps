<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>

  <!-- Estilos globales del sitio -->
  <link rel="stylesheet" href="/app/styles/app.css"/>

  <!-- Estilos locales (compacto, 1 pantalla en desktop) -->
  <style>
    :root{ --copper:#a8744f; }
    body { background:#000; color:#e9d5c1; }
    .hidden{display:none !important;}

    .container{ max-width:1120px; margin:0 auto; padding:8px 16px 20px; }

    .card{
      position:relative;
      background:linear-gradient(180deg,#101010,#0b0b0b);
      border:1px solid rgba(192,139,92,.35);
      border-radius:16px; padding:14px 14px 16px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .brand-badge{
      position:absolute; top:10px; right:12px;
      width:58px; height:58px; border-radius:50%;
      border:2px solid var(--copper);
      background:#000 url("/images/bonanza-logo.PNG") center/cover no-repeat;
      box-shadow:0 0 8px rgba(168,116,79,.35);
    }
    h1{
      margin:0 0 10px; font-size:1.35rem; color:#ffddae; text-align:center;
      letter-spacing:.2px;
    }

    /* 2 columnas para que quepa todo sin scroll (desktop) */
    .grid-main{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width:980px){ .grid-main{ grid-template-columns:1fr; } }

    /* Original Trip diferenciado */
    .orig{
      background:#0b0b0b; border:1px solid rgba(168,116,79,.45);
      border-radius:12px; padding:12px;
    }
    .orig .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:8px; border-bottom:1px solid rgba(168,116,79,.25);
    }
    .orig .label{ color:#cfa47f; font-size:.9rem; }
    .orig .value{ color:#ffddae; font-weight:800; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }

    /* Form compacto */
    label{ display:block; margin:8px 0 4px; font-weight:700 }
    input{ height:40px; font-size:14px; }
    .row{ display:flex; gap:8px; }
    .row>*{ flex:1 }
    #map{ height:220px; margin-top:8px; border-radius:12px; overflow:hidden }

    .pillbar{ display:flex; gap:8px; }
    .pillbar .pill{
      flex:1 1 0; text-align:center; padding:9px; border-radius:10px;
      background:#1a1a1a; color:var(--copper); border:1px solid rgba(168,116,79,.55);
      cursor:pointer; font-weight:700; font-size:.95rem;
    }
    .pillbar .pill.active{
      background:var(--copper); color:#000; border-color:var(--copper);
      box-shadow:0 0 0 3px rgba(168,116,79,.22);
    }

    .status{ min-height:18px; color:#ffcc66; margin:6px 0; font-size:.92rem }
    .muted{ color:#c9a97c; font-size:.9rem; margin-top:6px; }
    .summaryBox{
      margin-top:8px; background:#0e0e0e; border:1px solid rgba(168,116,79,.28);
      border-radius:12px; padding:10px;
    }

    /* Botones */
    button{ margin-top:8px; padding:12px 14px; font-size:16px }
    .ghost{ background:#1a1a1a; color:#ffddae; border:1px solid rgba(168,116,79,.45) }

    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent); margin:10px 0; }

    .toprow{ display:flex; gap:10px; align-items:flex-end; margin-bottom:8px }
    .toprow>*:first-child{ flex:1 }
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <div class="brand-badge" aria-hidden="true"></div>
      <h1>Reschedule Reservation</h1>

      <!-- CN -->
      <div class="toprow">
        <div>
          <label for="cn">Reservation Code (CN)</label>
          <input id="cn" placeholder="BZ-2025MMDD-XXXX" autocomplete="off"/>
        </div>
        <button id="load" type="button" style="flex:0 0 160px;">Load</button>
      </div>
      <div id="status" class="status"></div>

      <div class="grid-main">
        <!-- ORIGINAL TRIP -->
        <section id="original" class="orig hidden">
          <div class="head">
            <div>
              <div class="label">Reservation</div>
              <div class="value" id="o_cn">—</div>
            </div>
            <div style="text-align:right">
              <div class="label">Status</div>
              <div class="value" id="o_status">—</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:8px">
            <div>
              <div class="label">Passenger</div>
              <div class="value" id="o_name">—</div>
            </div>
            <div>
              <div class="label">Email / Phone</div>
              <div class="value" id="o_contact">—</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <div class="label">Pickup</div>
              <div class="value" id="o_pickup">—</div>
            </div>
            <div>
              <div class="label">Dropoff</div>
              <div class="value" id="o_dropoff">—</div>
            </div>
          </div>

          <div class="grid3" style="margin-top:8px">
            <div><div class="label">Date</div><div class="value" id="o_date">—</div></div>
            <div><div class="label">Time</div><div class="value" id="o_time">—</div></div>
            <div><div class="label">Vehicle</div><div class="value" id="o_vehicle">—</div></div>
          </div>

          <div class="grid3" style="margin-top:8px">
            <div><div class="label">Meet & Greet</div><div class="value" id="o_mg">—</div></div>
            <div><div class="label">Distance</div><div class="value" id="o_miles">—</div></div>
            <div><div class="label">Original Total</div><div class="value" id="o_total">—</div></div>
          </div>
        </section>

        <!-- NUEVO VIAJE -->
        <section id="form" class="hidden">
          <h2 style="margin:0 0 6px">Trip Details</h2>

          <label for="pickup">Pickup Location</label>
          <input id="pickup" placeholder="e.g. SLC Airport / Address"/>

          <!-- Campos de vuelo (sólo si pickup es SLC) -->
          <div id="flightFields" class="hidden">
            <div class="row">
              <div>
                <label for="flightNumber">Flight Number (SLC)</label>
                <input id="flightNumber" placeholder="e.g. DL1234"/>
              </div>
              <div>
                <label for="flightOrigin">Origin City</label>
                <input id="flightOrigin" placeholder="e.g. Miami (MIA)"/>
              </div>
            </div>
          </div>

          <label for="dropoff" style="margin-top:6px;">Dropoff Location</label>
          <input id="dropoff" placeholder="e.g. Montage Deer Valley"/>

          <div id="map"></div>

          <h2>Vehicle</h2>
          <div id="vehBar" class="pillbar">
            <div class="pill" data-type="suv">SUV (1–5)</div>
            <div class="pill" data-type="van">Van (up to 12)</div>
          </div>

          <h2>Meet & Greet (SLC)</h2>
          <div id="mgBar" class="pillbar">
            <div class="pill" data-mg="tsa_exit">TSA Exit (+$50)</div>
            <div class="pill" data-mg="baggage_claim">Baggage Claim (+$50)</div>
            <div class="pill" data-mg="none">No Meet & Greet</div>
          </div>

          <h2>Pickup Time</h2>
          <div class="row">
            <input id="date" type="date"/>
            <input id="time" type="time" step="900"/>
          </div>

          <div class="row">
            <button id="recalc" type="button">Recalculate Price</button>
            <button id="reset" type="button" class="ghost">Reset changes</button>
          </div>

          <div id="summary" class="summaryBox hidden">
            <div class="grid2">
              <div><span class="label">Pickup</span><div class="value" id="n_pickup">—</div></div>
              <div><span class="label">Dropoff</span><div class="value" id="n_dropoff">—</div></div>
            </div>
            <div class="grid3" style="margin-top:8px">
              <div><span class="label">Date</span><div class="value" id="n_date">—</div></div>
              <div><span class="label">Time</span><div class="value" id="n_time">—</div></div>
              <div><span class="label">Vehicle / M&G</span><div class="value" id="n_vehicle_mg">—</div></div>
            </div>
            <div class="grid3" style="margin-top:8px">
              <div><span class="label">Distance</span><div class="value" id="n_miles">—</div></div>
              <div><span class="label">New Quote</span><div class="value" id="newQuote">$0.00</div></div>
              <div><span class="label">Difference</span><div class="value" id="diff">$0.00</div></div>
            </div>
            <p id="note" class="muted"></p>
            <button id="submit" type="button" style="width:100%;">Submit Reschedule</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- ===== Lógica de la página ===== -->
  <script>
    // Helpers
    const $ = id => document.getElementById(id);
    const money = c => '$' + (Math.round(c)/100).toFixed(2);

    // Estado
    let booking=null, vehicleType='suv', mgChoice='none', lastQuote=0, lastMiles=0;

    // UI de mapa/places (expone initMapAndPlaces que el callback invoca)
    window.ResUI = {
      map:null, ds:null, dr:null,

      initMapAndPlaces(){
        const mapDiv = $('#map');
        if(!mapDiv){ console.warn('[ResUI] map div not found'); return; }

        const center={lat:40.7608,lng:-111.8910};
        this.map=new google.maps.Map(mapDiv,{center,zoom:10,mapTypeControl:false,streetViewControl:false,fullscreenControl:false});
        this.ds=new google.maps.DirectionsService();
        this.dr=new google.maps.DirectionsRenderer({map:this.map,preserveViewport:false});

        this.attachAC('pickup', p=>{ this.toggleFlightFields(); this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });
        this.attachAC('dropoff', p=>{ this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });
      },

      attachAC(id, cb){
        const el=$(id); if(!el) return;
        const ac=new google.maps.places.Autocomplete(el,{fields:["place_id","geometry","name","formatted_address"],componentRestrictions:{country:["us"]}});
        ac.addListener('place_changed',()=>cb(ac.getPlace()));
      },

      toggleFlightFields(){
        const txt=($('#pickup').value||'').toLowerCase();
        const isSLC = /(salt lake city|slc)/i.test(txt);
        $('#flightFields').classList.toggle('hidden', !isSLC);
      },

      async draw(pick,drop){
        if(!pick||!drop) return null;
        const res=await this.ds.route({origin:pick,destination:drop,travelMode:google.maps.TravelMode.DRIVING});
        this.dr.setDirections(res);
        const leg = res.routes?.[0]?.legs?.[0]||null;
        if(leg?.distance?.value){ lastMiles = leg.distance.value/1609.344; }
        return leg;
      },

      maybe(){ const p=$('pickup').value.trim(), d=$('dropoff').value.trim(); if(p&&d) this.draw(p,d).catch(()=>{}); }
    };

    function activatePills(bar, attr, value){
      [...bar.querySelectorAll('.pill')].forEach(p=>p.classList.toggle('active', p.getAttribute(attr)===value));
    }
    const mgLabel = k => k==='tsa_exit'?'TSA Exit (+$50)':k==='baggage_claim'?'Baggage Claim (+$50)':'No Meet & Greet';

    async function fetchQuote(miles){
      const r=await fetch('/api/book/quote',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        cache:'no-store',
        body:JSON.stringify({pickup:$('pickup').value.trim(),dropoff:$('dropoff').value.trim(),distance_miles:miles,vehicleType,meetGreet:mgChoice})
      });
      const j=await r.json().catch(()=>({}));
      if(!r.ok || !j?.ok) throw new Error(j?.error || 'quote_failed');
      return j.quote.total_cents;
    }

    // Callback que invoca Google Maps (se define ANTES de cargar el script)
    window.initReschedule = function () {
      const mapDiv = document.getElementById('map');
      if (mapDiv && window.ResUI && typeof ResUI.initMapAndPlaces === 'function') {
        ResUI.initMapAndPlaces();
      }
    };

    // Wiring dentro de DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[Reschedule] DOM ready');

      // ENTER para cargar CN
      const cnInput = $('#cn');
      if(cnInput){
        cnInput.addEventListener('keydown', e=>{
          if(e.key==='Enter'){ e.preventDefault(); const btn=$('#load'); if(btn) btn.click(); }
        });
      }

      // Load CN
      const loadBtn = $('#load');
      if(loadBtn){
        loadBtn.addEventListener('click', async () => {
          const cn=$('cn').value.trim();
          $('#status').textContent=''; $('#original').classList.add('hidden'); $('#form').classList.add('hidden');
          if(!cn){ $('#status').textContent='Enter a reservation code.'; return; }
          try{
            const r=await fetch('/api/book/get?cn='+encodeURIComponent(cn), { cache:'no-store' });
            const j=await r.json().catch(()=>({}));
            if(!r.ok || !j?.ok) throw new Error(j?.error || 'Not found');
            booking=j.booking;

            // Original
            $('#o_cn').textContent=booking.confirmation_number;
            $('#o_status').textContent=booking.status||'—';
            $('#o_name').textContent=booking.full_name||'—';
            $('#o_contact').textContent=[booking.email,booking.phone].filter(Boolean).join(' • ')||'—';
            $('#o_pickup').textContent=booking.pickup||'—';
            $('#o_dropoff').textContent=booking.dropoff||'—';
            $('#o_date').textContent=booking.date_iso||'—';
            $('#o_time').textContent=booking.time_hhmm||'—';
            $('#o_vehicle').textContent=(booking.vehicle_type||'suv').toUpperCase();
            $('#o_mg').textContent=mgLabel(booking.mg_choice||'none');
            $('#o_miles').textContent=booking.distance_miles?Number(booking.distance_miles).toFixed(1)+' mi':'—';
            $('#o_total').textContent=money(booking.quoted_total||0);
            $('#original').classList.remove('hidden');

            // Prefill form
            $('#pickup').value=booking.pickup||'';
            $('#dropoff').value=booking.dropoff||'';
            $('#date').value=booking.date_iso||'';
            $('#time').value=booking.time_hhmm||'00:00';
            $('#flightNumber').value=booking.flight_number||'';
            $('#flightOrigin').value=booking.flight_origin_city||'';
            vehicleType=booking.vehicle_type||'suv';
            mgChoice=booking.mg_choice||'none';
            activatePills($('#vehBar'),'data-type',vehicleType);
            activatePills($('#mgBar'),'data-mg',mgChoice);
            $('#form').classList.remove('hidden');

            // Si el mapa ya está listo, traza; si no, lo hará initReschedule
            if (window.google && google.maps) { ResUI.toggleFlightFields(); ResUI.maybe(); }
            $('#status').textContent='Reservation loaded: '+booking.confirmation_number;
          }catch(e){
            console.error(e);
            $('#status').textContent='Error: '+(e.message||e);
          }
        });
      }

      // Toggles
      const vb = $('#vehBar'), mb = $('#mgBar');
      if(vb){ vb.addEventListener('click',ev=>{ const el=ev.target.closest('.pill'); if(!el) return; vehicleType=el.getAttribute('data-type'); activatePills(vb,'data-type',vehicleType); ResUI.maybe(); }); }
      if(mb){ mb.addEventListener('click',ev=>{ const el=ev.target.closest('.pill'); if(!el) return; mgChoice=el.getAttribute('data-mg'); activatePills(mb,'data-mg',mgChoice); }); }

      // Recalculate
      const recalcBtn = $('#recalc');
      if(recalcBtn){
        recalcBtn.addEventListener('click', async ()=>{
          $('#status').textContent='';
          try{
            const pick=$('pickup').value.trim(), drop=$('dropoff').value.trim(), d=$('date').value, t=$('time').value;
            if(!pick||!drop) throw new Error('Pickup/Dropoff required');
            if(!d||!t) throw new Error('Date/Time required');
            const leg=await ResUI.draw(pick,drop); if(!leg?.distance?.value) throw new Error('Route not found');
            const cents=await fetchQuote(lastMiles); lastQuote=cents;

            $('#n_pickup').textContent=pick; $('#n_dropoff').textContent=drop;
            $('#n_date').textContent=d; $('#n_time').textContent=t;
            $('#n_vehicle_mg').textContent=vehicleType.toUpperCase()+' • '+mgLabel(mgChoice);
            $('#n_miles').textContent=lastMiles.toFixed(1)+' mi';
            $('#newQuote').textContent=money(cents);

            const orig=booking?.quoted_total||0; const diff=Math.max(0,cents-orig);
            $('#diff').textContent=money(diff);
            $('#note').textContent= diff>0 ? 'You will be asked to pay the difference to complete the reschedule.' : 'New route is cheaper; original price is kept (no refund).';
            $('#summary').classList.remove('hidden');
          }catch(e){ $('#status').textContent='Error: '+(e.message||e); }
        });
      }

      // Reset
      const resetBtn = $('#reset');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          if(!booking) return;
          $('#pickup').value=booking.pickup||''; $('#dropoff').value=booking.dropoff||'';
          $('#date').value=booking.date_iso||''; $('#time').value=booking.time_hhmm||'00:00';
          $('#flightNumber').value=booking.flight_number||''; $('#flightOrigin').value=booking.flight_origin_city||'';
          vehicleType=booking.vehicle_type||'suv'; mgChoice=booking.mg_choice||'none';
          activatePills($('#vehBar'),'data-type',vehicleType); activatePills($('#mgBar'),'data-mg',mgChoice);
          $('#summary').classList.add('hidden'); $('#status').textContent='';
          if (window.google && google.maps) { ResUI.toggleFlightFields(); ResUI.maybe(); }
        });
      }

      // Submit
      const submitBtn = $('#submit');
      if(submitBtn){
        submitBtn.addEventListener('click', async ()=>{
          if(!booking) return;
          try{
            const d=$('date').value, t=$('time').value, pick=$('pickup').value.trim(), drop=$('dropoff').value.trim();
            if(!lastQuote||!lastMiles){
              const leg=await ResUI.draw(pick,drop);
              if(!leg?.distance?.value) throw new Error('Route not found');
              lastQuote=await fetchQuote(lastMiles);
            }
            const orig=booking.quoted_total||0; const diff=Math.max(0,lastQuote-orig);

            const flightVisible = !$('#flightFields').classList.contains('hidden');
            if(flightVisible){
              booking.flight_number = $('#flightNumber').value.trim();
              booking.flight_origin_city = $('#flightOrigin').value.trim();
            }

            if(diff>0){
              const r=await fetch('/api/create-checkout-session-diff',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                cache:'no-store',
                body:JSON.stringify({
                  cn:booking.confirmation_number,
                  diffAmount:diff,
                  customerEmail:booking.email||'',
                  metadata:{reason:'reschedule_diff'},
                  description:`Reschedule difference for ${booking.confirmation_number}`
                })
              });
              const j=await r.json().catch(()=>({}));
              if(!r.ok || !j?.ok) throw new Error(j?.error || 'stripe_failed');
              location.href=j.url; return;
            }

            const r2=await fetch('/api/book/reschedule',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              cache:'no-store',
              body:JSON.stringify({
                cn:booking.confirmation_number,
                newDate:d,
                newTime:t,
                flightNumber:booking.flight_number||null,
                flightOriginCity:booking.flight_origin_city||null
              })
            });
            const j2=await r2.json().catch(()=>({}));
            if(!r2.ok || !j2?.ok) throw new Error(j2?.error || 'reschedule_failed');
            $('#status').textContent='Rescheduled successfully.';
          }catch(e){ $('#status').textContent='Error: '+(e.message||e); }
        });
      }

      // Autorrelleno ?cn=... y carga automática
      const p = new URLSearchParams(location.search);
      const cn = p.get('cn');
      if (cn && $('#cn')) {
        $('#cn').value = cn;
        const btn = $('#load');
        if (btn) btn.click();
      }
    });
  </script>

  <!-- Google Maps JavaScript API (async + defer) -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initReschedule">
  </script>
</body>
</html>
