<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>

  <!-- Global site CSS -->
  <link rel="stylesheet" href="/app/styles/app.css"/>

  <!-- Peluche theme -->
  <style>
    :root{
      --copper:#a8744f;
      --copper-2:#c89366;
      --ink:#0a0a0a;
      --panel:#111;
      --panel-2:#151515;
      --text:#e9d5c1;
      --muted:#c8a989;
      --ok:#84ffa1;
      --warn:#ffd873;
      --err:#ff8585;
      --ring: 0 0 0 3px rgba(168,116,79,.25);
    }

    /* Base */
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 110% -10%, rgba(168,116,79,.08), transparent 60%),
        radial-gradient(900px 600px at -10% 110%, rgba(168,116,79,.06), transparent 55%),
        #000;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
    }
    .container{ max-width:1120px; margin:0 auto; padding:28px 16px 60px; }

    .card{
      position:relative;
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(192,139,92,.32);
      border-radius:18px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .brand-badge{
      position:absolute; top:12px; right:14px;
      width:58px; height:58px; border-radius:50%;
      border:2px solid var(--copper);
      background:#000 url("/images/bonanza-logo.PNG") center/cover no-repeat;
      box-shadow:0 0 10px rgba(168,116,79,.35);
    }

    h1{
      margin:0 64px 14px 0; /* deja aire al badge */
      font-size:1.45rem; color:#ffedd2; text-align:center; letter-spacing:.2px;
      text-shadow:0 1px 0 #000;
    }
    h2{ margin:14px 0 8px; font-size:1.05rem; color:#ffddb3 }

    /* Grid principal */
    .grid-main{ display:grid; grid-template-columns: 1.05fr .95fr; gap:16px; }
    @media (max-width:980px){ .grid-main{ grid-template-columns:1fr; } }

    /* Top row (CN + Botón) */
    .toprow{ display:flex; gap:10px; align-items:flex-end; margin-bottom:10px }
    .toprow .box{ flex:1; }
    label{ display:block; margin:6px 0 6px; font-weight:700; color:#ffddb3; font-size:.95rem }
    input{
      height:42px; width:100%; color:var(--text);
      background:#0d0d0d; border:1px solid rgba(255,255,255,.08);
      border-radius:10px; padding:0 12px; font-size:15px; outline:none;
      transition:border .15s, box-shadow .15s, background .15s;
    }
    input:focus{ border-color:var(--copper); box-shadow:var(--ring); background:#0e0e0e }
    .btn{
      appearance:none; -webkit-appearance:none;
      user-select:none; cursor:pointer;
      min-height:42px; padding:10px 14px; border-radius:10px; font-weight:700; font-size:15px;
      color:#111; background:linear-gradient(180deg, var(--copper-2), var(--copper));
      border:1px solid rgba(0,0,0,.4); box-shadow:0 6px 18px rgba(168,116,79,.35);
      transition:transform .05s ease, box-shadow .2s ease, filter .15s ease;
    }
    .btn:hover{ filter:saturate(1.08) brightness(1.03) }
    .btn:active{ transform:translateY(1px) }
    .btn:disabled{ opacity:.55; cursor:not-allowed; filter:grayscale(.25) }

    .ghost{
      background:#141414; color:#ffedd2; border:1px solid rgba(168,116,79,.35);
      box-shadow:none;
    }
    .stack{ display:flex; gap:8px; }

    /* Panel Original Trip */
    .orig{
      background:linear-gradient( 180deg, #0b0b0b 0%, #0c0c0c 100% );
      border:1px solid rgba(168,116,79,.42);
      border-radius:12px; padding:12px;
    }
    .orig .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:8px; border-bottom:1px solid rgba(168,116,79,.22);
    }
    .orig .label{ color:#cfa47f; font-size:.9rem; }
    .orig .value{ color:#ffedd2; font-weight:800; word-break:break-word }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    @media (max-width:640px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    /* Campos del formulario */
    #map{ height:240px; margin:8px 0 2px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.06) }

    .pillbar{ display:flex; gap:8px; }
    .pill{
      flex:1 1 0; text-align:center; padding:9px 10px; border-radius:10px;
      background:#151515; color:var(--muted); border:1px solid rgba(168,116,79,.45);
      cursor:pointer; font-weight:700; font-size:.95rem; transition:filter .2s, background .2s, color .2s, box-shadow .2s
    }
    .pill:hover{ filter:brightness(1.06) }
    .pill.active{
      background:var(--copper); color:#111; border-color:var(--copper);
      box-shadow:var(--ring);
    }
    .pill[aria-disabled="true"]{
      opacity:.5; cursor:not-allowed; filter:grayscale(.3);
    }

    .status{ min-height:18px; margin:6px 0; font-size:.92rem; color:#ffdca1 }
    .muted{ color:#c9a97c; font-size:.9rem; margin-top:6px; }

    .summaryBox{
      margin-top:10px; background:#0f0f0f; border:1px solid rgba(168,116,79,.28);
      border-radius:12px; padding:12px;
    }
    .divider{ height:1px; background:linear-gradient(90deg,transparent,rgba(192,139,92,.35),transparent); margin:10px 0; }

    /* Toasts */
    .toast{
      position:fixed; left:50%; top:18px; transform:translateX(-50%);
      background:#121212; color:#ffedd2; border:1px solid rgba(168,116,79,.35);
      border-radius:12px; padding:10px 14px; box-shadow:0 14px 40px rgba(0,0,0,.55);
      z-index:9999; display:flex; align-items:center; gap:10px; min-width:260px;
    }
    .toast.ok{ border-color:rgba(132,255,161,.35) }
    .toast.err{ border-color:rgba(255,133,133,.35) }
    .toast.warn{ border-color:rgba(255,216,115,.35) }

    .hidden{ display:none !important; }
    .sr{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0) }
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <div class="brand-badge" aria-hidden="true"></div>
      <h1>Reschedule Reservation</h1>

      <!-- Top: CN -->
      <div class="toprow">
        <div class="box">
          <label for="cn">Reservation Code (CN)</label>
          <input id="cn" placeholder="BZ-2025MMDD-XXXX" autocomplete="off" />
        </div>
        <button id="load" class="btn" style="min-width:160px">Load</button>
      </div>

      <div id="status" class="status"></div>

      <div class="grid-main">
        <!-- ORIGINAL TRIP -->
        <section id="original" class="orig hidden" aria-live="polite">
          <div class="head">
            <div>
              <div class="label">Reservation</div>
              <div class="value" id="o_cn">—</div>
            </div>
            <div style="text-align:right">
              <div class="label">Status</div>
              <div class="value" id="o_status">—</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:8px">
            <div>
              <div class="label">Passenger</div>
              <div class="value" id="o_name">—</div>
            </div>
            <div>
              <div class="label">Email / Phone</div>
              <div class="value" id="o_contact">—</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <div class="label">Pickup</div>
              <div class="value" id="o_pickup">—</div>
            </div>
            <div>
              <div class="label">Dropoff</div>
              <div class="value" id="o_dropoff">—</div>
            </div>
          </div>

          <div class="grid3" style="margin-top:8px">
            <div><div class="label">Date</div><div class="value" id="o_date">—</div></div>
            <div><div class="label">Time</div><div class="value" id="o_time">—</div></div>
            <div><div class="label">Vehicle</div><div class="value" id="o_vehicle">—</div></div>
          </div>

          <div class="grid3" style="margin-top:8px">
            <div><div class="label">Meet & Greet</div><div class="value" id="o_mg">—</div></div>
            <div><div class="label">Distance</div><div class="value" id="o_miles">—</div></div>
            <div><div class="label">Original Total</div><div class="value" id="o_total">—</div></div>
          </div>
        </section>

        <!-- NUEVO VIAJE -->
        <section id="form" class="hidden">
          <h2>Trip Details</h2>

          <label for="pickup">Pickup Location</label>
          <input id="pickup" placeholder="e.g. SLC Airport / Address"/>

          <!-- Campos de vuelo (solo si SLC) -->
          <div id="flightFields" class="hidden">
            <div class="stack">
              <div style="flex:1">
                <label for="flightNumber">Flight Number (SLC)</label>
                <input id="flightNumber" placeholder="e.g. DL1234"/>
              </div>
              <div style="flex:1">
                <label for="flightOrigin">Origin City</label>
                <input id="flightOrigin" placeholder="e.g. Miami (MIA)"/>
              </div>
            </div>
          </div>

          <label for="dropoff" style="margin-top:6px;">Dropoff Location</label>
          <input id="dropoff" placeholder="e.g. Montage Deer Valley"/>
          <div id="map" aria-label="Route map"></div>

          <h2>Vehicle</h2>
          <div id="vehBar" class="pillbar">
            <div class="pill" data-type="suv">SUV (1–5)</div>
            <div class="pill" data-type="van">Van (up to 12)</div>
          </div>

          <h2>Meet &amp; Greet (SLC)</h2>
          <div id="mgBar" class="pillbar" aria-live="polite">
            <div class="pill" data-mg="tsa_exit">TSA Exit (+$50)</div>
            <div class="pill" data-mg="baggage_claim">Baggage Claim (+$50)</div>
            <div class="pill" data-mg="none">No Meet &amp; Greet</div>
          </div>

          <h2>Pickup Time</h2>
          <div class="stack">
            <input id="date" type="date" aria-label="Pickup date"/>
            <input id="time" type="time" step="900" aria-label="Pickup time"/>
          </div>

          <div class="stack" style="margin-top:8px">
            <button id="recalc" class="btn">Recalculate Price</button>
            <button id="reset" class="btn ghost">Reset changes</button>
          </div>

          <div id="summary" class="summaryBox hidden">
            <div class="grid2">
              <div><span class="label">Pickup</span><div class="value" id="n_pickup">—</div></div>
              <div><span class="label">Dropoff</span><div class="value" id="n_dropoff">—</div></div>
            </div>
            <div class="grid3" style="margin-top:8px">
              <div><span class="label">Date</span><div class="value" id="n_date">—</div></div>
              <div><span class="label">Time</span><div class="value" id="n_time">—</div></div>
              <div><span class="label">Vehicle / M&G</span><div class="value" id="n_vehicle_mg">—</div></div>
            </div>
            <div class="grid3" style="margin-top:8px">
              <div><span class="label">Distance</span><div class="value" id="n_miles">—</div></div>
              <div><span class="label">New Quote</span><div class="value" id="newQuote">$0.00</div></div>
              <div><span class="label">Difference</span><div class="value" id="diff">$0.00</div></div>
            </div>
            <p id="note" class="muted"></p>
            <button id="submit" class="btn" style="width:100%;">Submit Reschedule</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <script>
    // ---------- Helpers UI ----------
    const $ = id => document.getElementById(id);
    const money = c => '$' + ((+c||0)/100).toFixed(2);
    const toast = (msg, type='ok')=>{
      const t=$('toast'); if(!t) return;
      t.className = 'toast ' + type; t.textContent = msg; t.classList.remove('hidden');
      clearTimeout(t._h); t._h=setTimeout(()=>t.classList.add('hidden'), 3000);
    };
    const setBusy = (el, busy=true)=>{ if(!el) return; el.disabled = !!busy; el.dataset.busy = busy?'1':''; };

    // Debounce sencillo
    const debounce=(fn,ms=250)=>{ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a),ms); }; };

    // ---------- Estado ----------
    let booking=null, vehicleType='suv', mgChoice='none', lastQuote=0, lastMiles=0;
    let mapsLoaded=false;

    // 24h mínimo (fecha)
    function applyMinDate24h(){
      const d = new Date(); d.setDate(d.getDate()+1);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const min = `${yyyy}-${mm}-${dd}`;
      if ($('date')) $('date').setAttribute('min', min);
    }

    // SLC helper
    const isSLCText = txt => /(salt lake city|slc)/i.test((txt||'').toLowerCase());

    // ---------- Google Maps lazy load ----------
    function ensureGoogleLoaded(){
      return new Promise((resolve, reject)=>{
        if (window.google && google.maps){ mapsLoaded=true; return resolve(); }
        if (document.getElementById('gmaps-loader')){
          const check=()=> (window.google&&google.maps)? resolve(): setTimeout(check,80);
          return check();
        }
        const s=document.createElement('script');
        s.id='gmaps-loader';
        s.src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places';
        s.async=true; s.defer=true; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Google Maps failed'));
        document.head.appendChild(s);
      });
    }

    // ---------- Mapa + Places ----------
    window.ResUI = {
      map:null, ds:null, dr:null,
      async initMapAndPlaces(){
        const mapDiv = $('map');
        if(!mapDiv){ console.warn('[ResUI] map div not found'); return; }
        await ensureGoogleLoaded();

        const center={lat:40.7608,lng:-111.8910};
        this.map=new google.maps.Map(mapDiv,{center,zoom:10,mapTypeControl:false,streetViewControl:false,fullscreenControl:false});
        this.ds=new google.maps.DirectionsService();
        this.dr=new google.maps.DirectionsRenderer({map:this.map,preserveViewport:false});

        this.attachAC('pickup', p=>{ toggleFlightFields(); this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });
        this.attachAC('dropoff', p=>{ this.maybe(); if(p?.geometry?.location){ this.map.panTo(p.geometry.location); this.map.setZoom(12);} });

        // También reaccionar al escribir
        const react = debounce(()=>{ toggleFlightFields(); this.maybe(); }, 350);
        $('pickup')?.addEventListener('input', react);
        $('dropoff')?.addEventListener('input', react);
      },
      attachAC(id, cb){
        const el=$(id); if(!el) return;
        const ac=new google.maps.places.Autocomplete(el,{fields:["place_id","geometry","name","formatted_address"],componentRestrictions:{country:["us"]}});
        ac.addListener('place_changed',()=>cb(ac.getPlace()));
      },
      async draw(pick,drop){
        if(!pick||!drop) return null;
        await ensureGoogleLoaded();
        const res=await this.ds.route({origin:pick,destination:drop,travelMode:google.maps.TravelMode.DRIVING});
        this.dr.setDirections(res);
        const leg = res.routes?.[0]?.legs?.[0]||null;
        if(leg?.distance?.value){ lastMiles = leg.distance.value/1609.344; }
        return leg;
      },
      maybe(){ const p=$('pickup').value.trim(), d=$('dropoff').value.trim(); if(p&&d) this.draw(p,d).catch(()=>{}); }
    };

    // ---------- UI helpers ----------
    function activatePills(bar, attr, value){
      [...bar.querySelectorAll('.pill')].forEach(p=>p.classList.toggle('active', p.getAttribute(attr)===value));
    }
    const mgLabel = k => k==='tsa_exit'?'TSA Exit (+$50)':k==='baggage_claim'?'Baggage Claim (+$50)':'No Meet & Greet';

    // Habilita/Deshabilita M&G según SLC
    function updateMeetGreetAvailability(){
      const txt = ($('pickup').value||'');
      const slc = isSLCText(txt);
      const bar = $('mgBar');
      if(!bar) return;
      [...bar.querySelectorAll('.pill')].forEach(p=>{
        const v=p.getAttribute('data-mg');
        const disabled = !slc && v!=='none';
        p.setAttribute('aria-disabled', disabled?'true':'false');
      });
      if(!slc){
        mgChoice='none';
        activatePills(bar,'data-mg',mgChoice);
      }
    }
    function toggleFlightFields(){
      const txt=($('pickup').value||'');
      const isSLC = isSLCText(txt);
      $('flightFields').classList.toggle('hidden', !isSLC);
      updateMeetGreetAvailability();
    }

    async function fetchQuote(miles){
      const r=await fetch('/api/book/quote',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({pickup:$('pickup').value.trim(),dropoff:$('dropoff').value.trim(),distance_miles:miles,vehicleType,meetGreet:mgChoice})
      });
      const txt = await r.text();
      let j; try{ j=JSON.parse(txt);}catch{ j={ ok:false, error:txt }; }
      if(!r.ok||!j.ok) throw new Error(j.error||'quote_failed');
      return j.quote.total_cents;
    }

    // ---------- Load by Enter ----------
    $('cn').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('load').click(); } });

    // ---------- Load CN ----------
    $('load').addEventListener('click', async ()=>{
      const btn=$('load'); setBusy(btn,true);
      const cn=$('cn').value.trim();
      $('status').textContent = 'Loading reservation…';
      $('original').classList.add('hidden'); $('form').classList.add('hidden');

      try{
        const r=await fetch('/api/book/get?cn='+encodeURIComponent(cn));
        const body=await r.text(); let j; try{ j=JSON.parse(body);}catch{ j={ok:false,error:body}; }
        if(!r.ok||!j.ok) throw new Error(j.error||'Not found');
        booking=j.booking;

        // Pintar original
        $('o_cn').textContent=booking.confirmation_number;
        $('o_status').textContent=booking.status||'—';
        $('o_name').textContent=booking.full_name||'—';
        $('o_contact').textContent=[booking.email,booking.phone].filter(Boolean).join(' • ')||'—';
        $('o_pickup').textContent=booking.pickup||'—';
        $('o_dropoff').textContent=booking.dropoff||'—';
        $('o_date').textContent=booking.date_iso||'—';
        $('o_time').textContent=booking.time_hhmm||'—';
        $('o_vehicle').textContent=(booking.vehicle_type||'suv').toUpperCase();
        $('o_mg').textContent=mgLabel(booking.mg_choice||'none');
        $('o_miles').textContent=booking.distance_miles?Number(booking.distance_miles).toFixed(1)+' mi':'—';
        $('o_total').textContent=money(booking.quoted_total||0);
        $('original').classList.remove('hidden');

        // Prefill
        $('pickup').value=booking.pickup||'';
        $('dropoff').value=booking.dropoff||'';
        $('date').value=booking.date_iso||'';
        $('time').value=booking.time_hhmm||'00:00';
        $('flightNumber').value=booking.flight_number||'';
        $('flightOrigin').value=booking.flight_origin_city||'';
        vehicleType=booking.vehicle_type||'suv';
        mgChoice=booking.mg_choice||'none';
        activatePills($('vehBar'),'data-type',vehicleType);
        activatePills($('mgBar'),'data-mg',mgChoice);

        // Mapa & UI
        $('form').classList.remove('hidden');
        applyMinDate24h();
        await ResUI.initMapAndPlaces();
        toggleFlightFields(); ResUI.maybe();

        $('status').textContent='Reservation loaded: '+booking.confirmation_number;
        toast('Reservation loaded', 'ok');
      }catch(e){
        $('status').textContent='Error: '+(e.message||e); toast('Error loading: '+(e.message||e), 'err');
      }finally{ setBusy(btn,false); }
    });

    // ---------- Toggles ----------
    $('vehBar').addEventListener('click',ev=>{
      const el=ev.target.closest('.pill'); if(!el||el.getAttribute('aria-disabled')==='true') return;
      vehicleType=el.getAttribute('data-type'); activatePills($('vehBar'),'data-type',vehicleType); ResUI.maybe();
    });
    $('mgBar').addEventListener('click',ev=>{
      const el=ev.target.closest('.pill'); if(!el) return;
      if(el.getAttribute('aria-disabled')==='true') return;
      mgChoice=el.getAttribute('data-mg'); activatePills($('mgBar'),'data-mg',mgChoice);
    });

    // ---------- Recalculate ----------
    $('recalc').addEventListener('click', async ()=>{
      setBusy($('recalc'),true); $('status').textContent='';
      try{
        const pick=$('pickup').value.trim(), drop=$('dropoff').value.trim(), d=$('date').value, t=$('time').value;
        if(!pick||!drop) throw new Error('Pickup/Dropoff required');
        if(!d||!t) throw new Error('Date/Time required');

        // Chequeo 24h
        const min = $('date').getAttribute('min');
        if(min && d<min){ throw new Error('Pickup date must be at least 24h from now'); }

        const leg=await ResUI.draw(pick,drop); if(!leg?.distance?.value) throw new Error('Route not found');
        const cents=await fetchQuote(lastMiles); lastQuote=cents;

        $('n_pickup').textContent=pick; $('n_dropoff').textContent=drop;
        $('n_date').textContent=d; $('n_time').textContent=t;
        $('n_vehicle_mg').textContent=vehicleType.toUpperCase()+' • '+mgLabel(mgChoice);
        $('n_miles').textContent=lastMiles.toFixed(1)+' mi';
        $('newQuote').textContent=money(cents);

        const orig=booking?.quoted_total||0; const diff=Math.max(0,cents-orig);
        $('diff').textContent=money(diff);
        $('note').textContent= diff>0 ? 'You will be asked to pay the difference to complete the reschedule.' : 'New route is cheaper; original price is kept (no refund).';
        $('summary').classList.remove('hidden');
        toast('Quote recalculated', 'ok');
      }catch(e){ $('status').textContent='Error: '+(e.message||e); toast(e.message||e,'err'); }
      finally{ setBusy($('recalc'),false); }
    });

    // ---------- Reset ----------
    $('reset').addEventListener('click', ()=>{
      if(!booking) return;
      $('pickup').value=booking.pickup||''; $('dropoff').value=booking.dropoff||'';
      $('date').value=booking.date_iso||''; $('time').value=booking.time_hhmm||'00:00';
      $('flightNumber').value=booking.flight_number||''; $('flightOrigin').value=booking.flight_origin_city||'';
      vehicleType=booking.vehicle_type||'suv'; mgChoice=booking.mg_choice||'none';
      activatePills($('vehBar'),'data-type',vehicleType); activatePills($('mgBar'),'data-mg',mgChoice);
      $('summary').classList.add('hidden'); $('status').textContent='';
      toggleFlightFields(); ResUI.maybe();
    });

    // ---------- Submit ----------
    $('submit').addEventListener('click', async ()=>{
      if(!booking) return;
      setBusy($('submit'),true);
      try{
        const d=$('date').value, t=$('time').value, pick=$('pickup').value.trim(), drop=$('dropoff').value.trim();
        if(!pick||!drop) throw new Error('Pickup/Dropoff required');
        if(!d||!t) throw new Error('Date/Time required');

        const min = $('date').getAttribute('min');
        if(min && d<min){ throw new Error('Pickup date must be at least 24h from now'); }

        if(!lastQuote||!lastMiles){
          const leg=await ResUI.draw(pick,drop); if(!leg?.distance?.value) throw new Error('Route not found');
          lastQuote=await fetchQuote(lastMiles);
        }
        const orig=booking.quoted_total||0; const diff=Math.max(0,lastQuote-orig);

        // Campos vuelo (si visibles)
        const flightVisible = !$('flightFields').classList.contains('hidden');
        const flightNumber = flightVisible ? $('flightNumber').value.trim() : null;
        const flightOriginCity = flightVisible ? $('flightOrigin').value.trim() : null;

        // Si hay diferencia -> Stripe
        if(diff>0){
          const r=await fetch('/api/create-checkout-session-diff',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              cn:booking.confirmation_number,
              diffAmount:diff,
              customerEmail:booking.email||'',
              metadata:{ reason:'reschedule_diff', vehicleType, meetGreet:mgChoice, pickup_new:pick, dropoff_new:drop, date_new:d, time_new:t },
              description:`Reschedule difference for ${booking.confirmation_number}`
            })});
          const txt=await r.text(); let j; try{ j=JSON.parse(txt);}catch{ j={ok:false,error:txt}; }
          if(!r.ok||!j.ok) throw new Error(j.error||'stripe_failed');
          // Redirige a Stripe; el backend debe cerrar la reprogramación vía webhook
          location.href=j.url; return;
        }

        // Sin diferencia -> reprograma directo, incluyendo nuevos datos del viaje
        const r2=await fetch('/api/book/reschedule',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            cn:booking.confirmation_number,
            newDate:d,
            newTime:t,
            pickupNew:pick,
            dropoffNew:drop,
            vehicleTypeNew:vehicleType,
            meetGreetNew:mgChoice,
            flightNumber:flightNumber,
            flightOriginCity:flightOriginCity,
            newDistanceMiles:lastMiles,
            newQuoteCents:lastQuote
          })});
        const txt2=await r2.text(); let j2; try{ j2=JSON.parse(txt2);}catch{ j2={ok:false,error:txt2}; }
        if(!r2.ok||!j2.ok) throw new Error(j2.error||'reschedule_failed');
        $('status').textContent='Rescheduled successfully.'; toast('Rescheduled successfully','ok');
      }catch(e){ $('status').textContent='Error: '+(e.message||e); toast(e.message||e,'err'); }
      finally{ setBusy($('submit'),false); }
    });

    // ---------- Autorelleno ?cn= ----------
    (function(){
      const p = new URLSearchParams(location.search);
      const cn = p.get('cn');
      applyMinDate24h();
      if (cn && $('cn')) {
        $('cn').value = cn;
        $('load').click();
      }
    })();
  </script>
</body>
</html>
