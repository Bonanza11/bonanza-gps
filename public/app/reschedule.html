<!-- /public/app/reschedule.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reschedule — Bonanza Transportation</title>
  <link rel="stylesheet" href="/app/styles/app.css"/>

  <style>
    body { background:#000; color:#eee; margin:0; }
    header {
      display:flex; align-items:center; justify-content:center;
      padding:18px 20px; background:#111;
      border-bottom:1px solid rgba(184,115,51,.4);
    }
    .logo {
      height:60px; 
      display:block;
      object-fit:contain;
    }
    .container { max-width:920px; margin:28px auto; padding:0 16px; }
    .card {
      background: rgba(0,0,0,.85);
      border:1px solid #b87333; border-radius:12px;
      padding:22px; box-shadow:0 6px 28px rgba(0,0,0,.7);
    }
    h1 { margin:0 0 12px; text-align:center; color:#b87333; font-size:1.7rem; }
    h2 { margin:18px 0 8px; font-size:1.05rem; color:#ffddae; font-weight:600; }
    label { display:block; color:#ccc; font-size:.92rem; margin-bottom:6px; }
    input {
      width:100%; padding:10px 12px; border-radius:8px;
      border:1px solid #444; background:#1b1b1b; color:#eee;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .btn {
      border:none; border-radius:10px; padding:11px 14px; cursor:pointer;
      background:#b87333; color:#111; font-weight:700; transition:.2s;
    }
    .btn:hover { filter:brightness(1.05); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .ghost { background:#2a2a2a; color:#eee; font-weight:600; border:1px solid #444; }
    .pillbar { display:flex; gap:10px; flex-wrap:wrap; }
    .pillbar .pill {
      flex:1; min-width:180px; text-align:center; padding:10px; border-radius:10px;
      background:#2b2b2b; color:#eee; border:1px solid #444; cursor:pointer;
    }
    .pillbar .pill.active { background:#b87333; color:#111; border-color:#b87333; font-weight:700; }
    .summary { border-top:1px solid #b87333; margin-top:16px; padding-top:14px; }
    .grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .grid .k { color:#cfa47f; display:block; font-size:.9rem; }
    .grid .v { color:#ffddae; font-weight:700; font-size:1.05rem; }
    .muted { color:#aaa; font-size:.9rem; margin:6px 0 0; }
    .status { margin:8px 0; min-height:20px; color:#ffbfa0; }
    .hidden { display:none; }
    .divider { height:1px; background:rgba(184,115,51,.35); margin:18px 0; }
  </style>
</head>
<body>
  <header>
    <img src="/images/bonanza-logo.PNG" alt="Bonanza Transportation" class="logo" />
  </header>

  <main class="container">
    <div class="card">
      <h1>Reschedule Reservation</h1>

      <!-- CN -->
      <label for="cn">Reservation Code (CN)</label>
      <div class="row">
        <input id="cn" placeholder="BZ-2025MMDD-XXXX" autocomplete="off"/>
        <button id="load" class="btn" style="flex:0 0 160px;">Load</button>
      </div>
      <div id="status" class="status"></div>

      <!-- FORM -->
      <section id="form" class="hidden">
        <div class="divider"></div>

        <h2>Trip Details</h2>
        <label for="pickup">Pickup Location</label>
        <input id="pickup" />
        <label for="dropoff">Dropoff Location</label>
        <input id="dropoff" />

        <h2>Vehicle</h2>
        <div id="vehBar" class="pillbar">
          <div class="pill" data-type="suv">SUV (1–5)</div>
          <div class="pill" data-type="van">Van (up to 12)</div>
        </div>

        <h2>Meet & Greet (SLC)</h2>
        <div id="mgBar" class="pillbar">
          <div class="pill" data-mg="tsa_exit">TSA Exit (+$50)</div>
          <div class="pill" data-mg="baggage_claim">Baggage Claim (+$50)</div>
          <div class="pill" data-mg="none">No Meet & Greet</div>
        </div>

        <h2>Pickup Time</h2>
        <div class="row">
          <input id="date" type="date" />
          <input id="time" type="time" step="900" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="recalc" class="btn">Recalculate Price</button>
          <button id="reset" class="btn ghost">Reset changes</button>
        </div>

        <section id="summary" class="summary hidden">
          <h2>Summary</h2>
          <div class="grid">
            <div><span class="k">Original Total</span><span id="origTotal" class="v">$0.00</span></div>
            <div><span class="k">New Quote</span><span id="newQuote" class="v">$0.00</span></div>
            <div><span class="k">Difference</span><span id="diff" class="v">$0.00</span></div>
          </div>
          <p id="note" class="muted"></p>
          <button id="submit" class="btn" style="width:100%; margin-top:8px;">Submit Reschedule</button>
        </section>
      </section>
    </div>
  </main>

  <!-- Google Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places"></script>

  <script>
    const $ = id => document.getElementById(id);
    const money = c => '$' + (Math.round(c)/100).toFixed(2);
    let booking=null, vehicleType='suv', mgChoice='none', lastQuote=0;

    function activatePills(bar,attr,value){
      [...bar.querySelectorAll('.pill')].forEach(p=>{
        p.classList.toggle('active', p.getAttribute(attr)===value);
      });
    }

    async function estimateMiles(pick,drop){
      return new Promise((resolve,reject)=>{
        new google.maps.DistanceMatrixService().getDistanceMatrix({
          origins:[pick], destinations:[drop], travelMode:'DRIVING'
        },(res,st)=>{
          if(st!=='OK') return reject(st);
          const row=res.rows?.[0]?.elements?.[0];
          if(!row||row.status!=='OK') return reject('NO_ROUTE');
          resolve(row.distance.value/1609.344);
        });
      });
    }

    async function fetchQuote(miles){
      const r=await fetch('/api/book/quote',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({pickup:$('pickup').value.trim(),dropoff:$('dropoff').value.trim(),
          distance_miles:miles,vehicleType,meetGreet:mgChoice})});
      const j=await r.json();
      if(!j.ok) throw new Error(j.error||'quote_failed');
      return j.quote.total_cents;
    }

    $('load').onclick=async()=>{
      const cn=$('cn').value.trim();
      $('status').textContent='Loading…';
      try{
        const r=await fetch('/api/book/get?cn='+encodeURIComponent(cn));
        const j=await r.json();
        if(!r.ok||!j.ok) throw new Error(j.error||'Not found');
        booking=j.booking;
        $('status').textContent='Reservation loaded: '+booking.confirmation_number;
        $('form').classList.remove('hidden');
        $('pickup').value=booking.pickup||''; $('dropoff').value=booking.dropoff||'';
        vehicleType=booking.vehicle_type||'suv'; mgChoice=booking.mg_choice||'none';
        activatePills($('vehBar'),'data-type',vehicleType);
        activatePills($('mgBar'),'data-mg',mgChoice);
        $('date').value=booking.date_iso||''; $('time').value=booking.time_hhmm||'00:00';
        $('origTotal').textContent=money(booking.quoted_total||0);
        $('summary').classList.add('hidden');
      }catch(e){ $('status').textContent='Error: '+(e.message||e); $('form').classList.add('hidden'); }
    };

    $('vehBar').onclick=e=>{const el=e.target.closest('.pill'); if(!el)return; vehicleType=el.dataset.type; activatePills(e.currentTarget,'data-type',vehicleType);};
    $('mgBar').onclick=e=>{const el=e.target.closest('.pill'); if(!el)return; mgChoice=el.dataset.mg; activatePills(e.currentTarget,'data-mg',mgChoice);};

    $('recalc').onclick=async()=>{
      try{
        const miles=await estimateMiles($('pickup').value.trim(),$('dropoff').value.trim());
        lastQuote=await fetchQuote(miles);
        $('newQuote').textContent=money(lastQuote);
        const orig=booking?.quoted_total||0, diff=Math.max(0,lastQuote-orig);
        $('diff').textContent=money(diff);
        $('note').textContent=diff>0?'You will be asked to pay the difference.':'New route is cheaper; original price kept.';
        $('summary').classList.remove('hidden');
      }catch(e){ $('status').textContent='Error: '+(e.message||e); }
    };

    $('reset').onclick=()=>{ if(!booking)return;
      $('pickup').value=booking.pickup||''; $('dropoff').value=booking.dropoff||'';
      $('date').value=booking.date_iso||''; $('time').value=booking.time_hhmm||'00:00';
      vehicleType=booking.vehicle_type||'suv'; mgChoice=booking.mg_choice||'none';
      activatePills($('vehBar'),'data-type',vehicleType); activatePills($('mgBar'),'data-mg',mgChoice);
      $('summary').classList.add('hidden'); $('status').textContent='';
    };

    $('submit').onclick=async()=>{
      if(!booking) return;
      try{
        const d=$('date').value,t=$('time').value;
        const orig=booking.quoted_total||0, diff=Math.max(0,lastQuote-orig);
        if(diff>0){
          const r=await fetch('/api/create-checkout-session-diff',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({cn:booking.confirmation_number,diffAmount:diff,customerEmail:booking.email||'',
              metadata:{reason:'reschedule_diff'},description:`Reschedule diff for ${booking.confirmation_number}`})});
          const j=await r.json(); if(!j.ok) throw new Error(j.error||'stripe_failed'); location.href=j.url; return;
        }
        const r2=await fetch('/api/book/reschedule',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({cn:booking.confirmation_number,newDate:d,newTime:t})});
        const j2=await r2.json(); if(!j2.ok) throw new Error(j2.error||'reschedule_failed');
        $('status').textContent='Rescheduled successfully.';
      }catch(e){ $('status').textContent='Error: '+(e.message||e); }
    };
  </script>
</body>
</html>
