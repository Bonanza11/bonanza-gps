<!doctype html>
<html lang="es">
<head>
  <!-- ===========================================================
       Bonanza Transportation — Admin v2 (INDEX)
       Ruta: /public/admin/index.html
       =========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bonanza Admin v2</title>
  <link rel="icon" href="/images/bonanza-logo.png">
  <link rel="stylesheet" href="./css/admin.css">
  <style>
    /* Extras rápidos para este index */
    .pill{padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
    .status{font-weight:600}
    .status.pending{color:#fbbf24}
    .status.assigned{color:#22c55e}
    .status.in_progress{color:#60a5fa}
    .status.done{color:#a3e635}
    .status.canceled{color:#f87171}
    .toast{position:fixed;right:14px;bottom:14px;background:#111827;border:1px solid #1f2937;border-left:4px solid #ef4444;color:#e5e7eb;border-radius:10px;padding:10px 12px;max-width:420px;box-shadow:0 10px 26px rgba(0,0,0,.35);display:none}
    .ok{border-left-color:#22c55e}
    .mono{font-family:ui-monospace,Menlo,monospace;font-size:12px;opacity:.8}
    .right{text-align:right}
    .small{font-size:12px;color:#9ca3af}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">Bonanza Admin v2</div>
    <div class="actions">
      <span id="envBadge" class="badge">PROD</span>
      <span id="who" class="badge mono" title="token abreviado"></span>
      <button id="btnLogout" class="link">Salir</button>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="reservations" class="active">Reservas</button>
    <button data-tab="vehicles">Vehículos</button>
    <button data-tab="clients">Clientes</button>
    <button data-tab="drivers">Drivers</button>
  </nav>

  <main>
    <!-- ========== RESERVATIONS ========== -->
    <section id="tab-reservations" class="tab active">
      <div class="toolbar">
        <button id="btnRefetchReservations">Refrescar</button>
        <div class="spacer"></div>
        <label class="inline">ID
          <input id="resId" type="number" min="1" placeholder="id" />
        </label>
        <label class="inline">Driver ID
          <input id="resDriverId" type="text" placeholder="uuid o vacío" />
        </label>
        <button id="btnAssign">Asignar/Desasignar</button>
      </div>

      <div class="tableWrap">
        <table id="tblReservations">
          <thead>
          <tr>
            <th>ID</th><th>Pickup</th><th>Cliente</th><th>Desde → Hasta</th>
            <th>Vehículo</th><th>Status</th><th>Driver</th><th>Actualizado</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small">Tip: deja “Driver ID” vacío para **desasignar** (queda PENDING).</div>
    </section>

    <!-- ========== VEHICLES ========== -->
    <section id="tab-vehicles" class="tab">
      <div class="toolbar">
        <button id="btnRefetchVehicles">Refrescar</button>
        <div class="spacer"></div>
        <label class="inline">Placa
          <input id="vPlate" type="text">
        </label>
        <label class="inline">Driver
          <input id="vDriver" type="text" placeholder="opcional">
        </label>
        <label class="inline">Tipo
          <select id="vKind"><option>SUV</option><option>VAN</option></select>
        </label>
        <label class="inline">Año
          <input id="vYear" type="number" min="1990" max="2100">
        </label>
        <label class="inline">Modelo
          <input id="vModel" type="text">
        </label>
        <button id="btnVehicleUpsert">Crear/Actualizar</button>
      </div>

      <div class="tableWrap">
        <table id="tblVehicles">
          <thead>
          <tr>
            <th>ID</th><th>Placa</th><th>Driver</th><th>Tipo</th><th>Año</th>
            <th>Modelo</th><th>Activo</th><th class="right">Acciones</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ========== CLIENTS ========== -->
    <section id="tab-clients" class="tab">
      <div class="toolbar">
        <button id="btnRefetchClients">Refrescar</button>
        <div class="spacer"></div>
        <label class="inline">Nombre <input id="cName" type="text"></label>
        <label class="inline">Email <input id="cEmail" type="email"></label>
        <label class="inline">Phone <input id="cPhone" type="text"></label>
        <button id="btnClientUpsert">Crear/Actualizar</button>
      </div>

      <div class="tableWrap">
        <table id="tblClients">
          <thead>
          <tr>
            <th>ID</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Rating</th><th>Acciones</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ========== DRIVERS ========== -->
    <section id="tab-drivers" class="tab">
      <div class="toolbar">
        <button id="btnRefetchDrivers">Refrescar</button>
        <div class="spacer"></div>
        <label class="inline">Nombre <input id="dName" type="text"></label>
        <label class="inline">Email <input id="dEmail" type="email"></label>
        <label class="inline">Phone <input id="dPhone" type="text"></label>
        <button id="btnDriverCreate">Crear</button>
      </div>

      <div class="tableWrap">
        <table id="tblDrivers">
          <thead>
          <tr>
            <th>ID</th><th>Nombre</th><th>Email</th><th>Teléfono</th>
            <th>Pay Mode</th><th>Rates</th><th>Notifs</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    /* ============================================
       Bonanza Admin v2 — Lógica del panel
       Lee JWT, arma headers, controla tabs y CRUD.
       ============================================ */

    const ls = localStorage;
    const TOAST = document.getElementById('toast');
    const envBadge = document.getElementById('envBadge');
    const who = document.getElementById('who');

    // ------- Auth (JWT + fallback x-admin-key) -------
    function getJWT(){ return ls.getItem('bonanza_admin_jwt') || ''; }
    function getAdminKey(){ return ls.getItem('bonanza_admin_key') || ''; }

    function tokenPreview() {
      const t = getJWT();
      who.textContent = t ? ('jwt ' + t.slice(0, 8) + '…') :
                            (getAdminKey() ? 'x-admin-key' : 'no-auth');
    }
    tokenPreview();

    async function apiFetch(path, opts = {}) {
      const base = '';
      const headers = Object.assign({ 'Content-Type':'application/json' }, opts.headers || {});
      const jwt = getJWT();
      const key = getAdminKey();

      if (jwt) headers['Authorization'] = 'Bearer ' + jwt;
      if (key) headers['x-admin-key'] = key;

      const res = await fetch(base + path, { ...opts, headers });
      if (res.status === 401) {
        showToast('No autorizado. Inicia sesión nuevamente.', false);
        setTimeout(()=>location.href='/admin_v2/login.html', 1200);
        throw new Error('unauthorized');
      }
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ------- UI helpers -------
    function showToast(msg, ok=false){
      TOAST.textContent = msg;
      TOAST.classList.toggle('ok', ok);
      TOAST.style.display = 'block';
      clearTimeout(TOAST._t);
      TOAST._t = setTimeout(()=> TOAST.style.display='none', 3500);
    }

    // ------- Tabs -------
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
        document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
      });
    });

    // ------- Logout -------
    document.getElementById('btnLogout').addEventListener('click', ()=>{
      ls.removeItem('bonanza_admin_jwt');
      showToast('Sesión cerrada', true);
      setTimeout(()=> location.href='/admin_v2/login.html', 500);
    });

    // Env badge
    envBadge.textContent = (location.hostname.includes('localhost') ? 'LOCAL' : 'PROD');

    // =========================================
    // RESERVATIONS
    // =========================================
    const $tblRes = document.querySelector('#tblReservations tbody');
    async function fetchReservations(){
      const rows = await apiFetch('/api/reservations');
      $tblRes.innerHTML = rows.map(r => {
        const status = String(r.status||'').toLowerCase();
        const veh = r.vehicle_label || r.vehicle_plate || '';
        const when = new Date(r.pickup_time).toLocaleString();
        const updated = r.updated_at ? new Date(r.updated_at).toLocaleString() : '';
        return `<tr>
          <td>${r.id}</td>
          <td>${when}</td>
          <td>${escapeHtml(r.customer_name||'')}</td>
          <td>${escapeHtml(r.pickup_location||'')} → ${escapeHtml(r.dropoff_location||'')}</td>
          <td>${escapeHtml(veh)}</td>
          <td><span class="status ${status}">${status}</span></td>
          <td>${escapeHtml(r.driver_name||'')}</td>
          <td>${updated}</td>
        </tr>`;
      }).join('');
    }
    document.getElementById('btnRefetchReservations').addEventListener('click', ()=>{
      fetchReservations().then(()=>showToast('Reservas actualizadas', true))
        .catch(e=>showToast('Error cargando reservas: '+e.message));
    });

    // Asignar / desasignar
    document.getElementById('btnAssign').addEventListener('click', async ()=>{
      const id = Number(document.getElementById('resId').value);
      const driver_id = (document.getElementById('resDriverId').value || '').trim() || null;
      if (!id){ showToast('Debes indicar ID de la reserva'); return; }
      try{
        const r = await apiFetch('/api/reservations', {
          method:'PATCH',
          body: JSON.stringify({ id, driver_id })
        });
        await fetchReservations();
        showToast(`Reserva ${id}: ${driver_id? 'ASSIGNED' : 'PENDING'}`, true);
      }catch(e){ showToast('No se pudo asignar: '+e.message); }
    });

    // =========================================
    // VEHICLES
    // =========================================
    const $tblVeh = document.querySelector('#tblVehicles tbody');

    async function fetchVehicles(){
      const res = await apiFetch('/api/admin/vehicles', { method:'GET' });
      const vehicles = res?.vehicles || res || [];
      $tblVeh.innerHTML = vehicles.map(v => `
        <tr>
          <td class="mono">${v.id||''}</td>
          <td>${escapeHtml(v.plate||'')}</td>
          <td>${escapeHtml(v.driver_name||'')}</td>
          <td>${escapeHtml((v.kind||'').toUpperCase())}</td>
          <td>${v.year||''}</td>
          <td>${escapeHtml(v.model||'')}</td>
          <td>${v.active? '✓' : '—'}</td>
          <td class="right">
            <button data-id="${v.id}" class="secondary btnToggle">${v.active? 'Desactivar':'Activar'}</button>
          </td>
        </tr>
      `).join('');

      // botones toggle
      $tblVeh.querySelectorAll('.btnToggle').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          try{
            const r = await apiFetch('/api/admin/vehicles', {
              method:'POST',
              body: JSON.stringify({ id, active: btn.textContent === 'Activar' })
            });
            await fetchVehicles();
            showToast('Vehículo actualizado', true);
          }catch(e){ showToast('Error actualizando vehículo: '+e.message); }
        });
      });
    }

    document.getElementById('btnRefetchVehicles').addEventListener('click', ()=>{
      fetchVehicles().then(()=>showToast('Vehículos actualizados', true))
        .catch(e=>showToast('Error cargando vehículos: '+e.message));
    });

    document.getElementById('btnVehicleUpsert').addEventListener('click', async ()=>{
      const payload = {
        plate: (document.getElementById('vPlate').value||'').trim(),
        driver_name: (document.getElementById('vDriver').value||'').trim() || null,
        kind: (document.getElementById('vKind').value||'SUV').toUpperCase(),
        year: Number(document.getElementById('vYear').value) || null,
        model: (document.getElementById('vModel').value||'').trim() || null
      };
      if (!payload.plate){ showToast('Placa es obligatoria'); return; }
      try{
        await apiFetch('/api/admin/vehicles', {
          method:'POST',
          body: JSON.stringify(payload)
        });
        await fetchVehicles();
        showToast('Vehículo guardado', true);
      }catch(e){ showToast('Error guardando vehículo: '+e.message); }
    });

    // =========================================
    // CLIENTS
    // =========================================
    const $tblCli = document.querySelector('#tblClients tbody');
    async function fetchClients(){
      const r = await apiFetch('/api/admin/clients', { method:'GET' });
      const clients = r?.clients || r || [];
      $tblCli.innerHTML = clients.map(c => `
        <tr>
          <td class="mono">${c.id||''}</td>
          <td>${escapeHtml(c.name||'')}</td>
          <td>${escapeHtml(c.email||'')}</td>
          <td>${escapeHtml(c.phone||'')}</td>
          <td>${escapeHtml(c.internal_rating||'')}</td>
          <td class="right small">${c.created_at? new Date(c.created_at).toLocaleString() : ''}</td>
        </tr>
      `).join('');
    }
    document.getElementById('btnRefetchClients').addEventListener('click', ()=>{
      fetchClients().then(()=>showToast('Clientes actualizados', true))
        .catch(e=>showToast('Error cargando clientes: '+e.message));
    });

    document.getElementById('btnClientUpsert').addEventListener('click', async ()=>{
      const payload = {
        name: (document.getElementById('cName').value||'').trim(),
        email: (document.getElementById('cEmail').value||'').trim() || null,
        phone: (document.getElementById('cPhone').value||'').trim() || null
      };
      if (!payload.name){ showToast('Nombre es obligatorio'); return; }
      try{
        await apiFetch('/api/admin/clients', { method:'POST', body: JSON.stringify(payload) });
        await fetchClients();
        showToast('Cliente guardado', true);
      }catch(e){ showToast('Error guardando cliente: '+e.message); }
    });

    // =========================================
    // DRIVERS
    // =========================================
    const $tblDrv = document.querySelector('#tblDrivers tbody');
    async function fetchDrivers(){
      const rows = await apiFetch('/api/drivers', { method:'GET' });
      $tblDrv.innerHTML = rows.map(d => `
        <tr>
          <td class="mono">${d.id||''}</td>
          <td>${escapeHtml(d.name||'')}</td>
          <td>${escapeHtml(d.email||'')}</td>
          <td>${escapeHtml(d.phone||'')}</td>
          <td>${escapeHtml(d.pay_mode||'')}</td>
          <td class="small">
            ${d.hourly_rate!=null? ('$'+d.hourly_rate+'/h ') : '' }
            ${d.per_ride_rate!=null? ('$'+d.per_ride_rate+' por ride ') : '' }
            ${d.revenue_share!=null? ((d.revenue_share*100)+'% share'):''}
          </td>
          <td class="small">${d.notify_email? 'email ' : ''}${d.notify_sms? 'sms':''}</td>
        </tr>
      `).join('');
    }
    document.getElementById('btnRefetchDrivers').addEventListener('click', ()=>{
      fetchDrivers().then(()=>showToast('Drivers actualizados', true))
        .catch(e=>showToast('Error cargando drivers: '+e.message));
    });

    document.getElementById('btnDriverCreate').addEventListener('click', async ()=>{
      const name  = (document.getElementById('dName').value||'').trim();
      const email = (document.getElementById('dEmail').value||'').trim() || null;
      const phone = (document.getElementById('dPhone').value||'').trim() || null;
      if (!name){ showToast('Nombre es obligatorio'); return; }
      try{
        await apiFetch('/api/drivers', { method:'POST', body: JSON.stringify({ name, email, phone }) });
        await fetchDrivers();
        showToast('Driver creado', true);
      }catch(e){ showToast('Error creando driver: '+e.message); }
    });

    // ------- Utils -------
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ------- Primera carga -------
    (async function boot(){
      try{
        await Promise.all([
          fetchReservations(),
          fetchVehicles(),
          fetchClients(),
          fetchDrivers()
        ]);
        showToast('Datos cargados', true);
      }catch(e){
        alert('Error cargando datos. Verifica tu Admin Key o la API.');
      }
    })();
  </script>
</body>
</html>
