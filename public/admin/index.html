<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bonanza Admin</title>
  <link rel="icon" href="/images/bonanza-logo.png">
  <!-- estilos base del panel -->
  <link rel="stylesheet" href="/public/admin/css/admin.css">

  <style>
    /* Afinaciones mínimas locales */
    :root{
      --bg:#0b0f14; --panel:#0e141b; --text:#e7edf5; --muted:#9fb0c3;
      --border:#1f2a36; --accent:#77c7ff; --danger:#ff6b6b; --ok:#27d17c; --warn:#facc15;
    }
    body{background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f141b,#0b1016)}
    .brand{font-weight:800;letter-spacing:.2px}
    .badge{border:1px solid var(--border);padding:3px 8px;border-radius:999px;margin-right:8px;background:#0e141b}
    .link{border:1px solid var(--border);background:#0e141b;color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
    .tabs{display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border)}
    .tabs button{background:#0e141b;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
    .tabs button.active{border-color:#2a3a4c; box-shadow:0 0 0 2px #203042 inset; color:#bfe4ff}
    main{padding:14px}
    .tab{display:none}
    .tab.active{display:block}
    .toolbar{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:12px;margin-bottom:10px}
    .toolbar .inline{display:flex;align-items:center;gap:6px}
    .toolbar input,.toolbar select{height:34px;border-radius:8px;border:1px solid var(--border);background:#0a0f14;color:var(--text);padding:6px 8px}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px}
    th{background:#0c1219;color:#bcd0e2;text-align:left}
    .right{text-align:right}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,monospace}
    .status{font-weight:700}
    .status.pending{color:var(--warn)}
    .status.assigned{color:var(--ok)}
    .status.in_progress{color:#60a5fa}
    .status.done{color:#a3e635}
    .status.canceled{color:#ff8484}
    .btn{border:1px solid var(--border);background:#0f151b;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#0a0f14}
    .toast{position:fixed;right:14px;bottom:14px;background:#0e141b;border:1px solid var(--border);border-left:4px solid var(--danger);color:#e7edf5;border-radius:10px;padding:10px 12px;max-width:420px;box-shadow:0 10px 26px rgba(0,0,0,.35);display:none}
    .toast.ok{border-left-color:var(--ok)}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">Bonanza Admin</div>
    <div class="actions">
      <span id="envBadge" class="badge">PROD</span>
      <span id="who" class="badge mono" title="token abreviado"></span>
      <button id="btnLogout" class="link">Salir</button>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="reservations" class="active">Reservas</button>
    <button data-tab="vehicles">Vehículos</button>
    <button data-tab="clients">Clientes</button>
    <button data-tab="drivers">Drivers</button>
  </nav>

  <main>
    <!-- ========== RESERVATIONS ========== -->
    <section id="tab-reservations" class="tab active">
      <div class="toolbar">
        <button id="btnRefetchReservations" class="btn">Refrescar</button>
        <div style="flex:1"></div>
        <label class="inline">ID
          <input id="resId" type="number" min="1" placeholder="id" />
        </label>
        <label class="inline">Driver ID
          <input id="resDriverId" type="text" placeholder="uuid o vacío" />
        </label>
        <button id="btnAssign" class="btn">Asignar/Desasignar</button>
      </div>

      <table id="tblReservations">
        <thead>
        <tr>
          <th>ID</th><th>Pickup</th><th>Cliente</th><th>Desde → Hasta</th>
          <th>Vehículo</th><th>Status</th><th>Driver</th><th>Actualizado</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px">Tip: deja “Driver ID” vacío para <b>desasignar</b> (queda PENDING).</div>
    </section>

    <!-- ========== VEHICLES ========== -->
    <section id="tab-vehicles" class="tab">
      <div class="toolbar">
        <button id="btnRefetchVehicles" class="btn">Refrescar</button>
        <div style="flex:1"></div>
        <label class="inline">Placa <input id="vPlate" type="text"></label>
        <label class="inline">Driver <input id="vDriver" type="text" placeholder="opcional"></label>
        <label class="inline">Tipo
          <select id="vKind"><option>SUV</option><option>VAN</option></select>
        </label>
        <label class="inline">Año <input id="vYear" type="number" min="1990" max="2100"></label>
        <label class="inline">Modelo <input id="vModel" type="text"></label>
        <button id="btnVehicleUpsert" class="btn">Crear/Actualizar</button>
      </div>

      <table id="tblVehicles">
        <thead>
        <tr>
          <th>ID</th><th>Placa</th><th>Driver</th><th>Tipo</th><th>Año</th>
          <th>Modelo</th><th>Activo</th><th class="right">Acciones</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ========== CLIENTS ========== -->
    <section id="tab-clients" class="tab">
      <div class="toolbar">
        <button id="btnRefetchClients" class="btn">Refrescar</button>
        <div style="flex:1"></div>
        <label class="inline">Nombre <input id="cName" type="text"></label>
        <label class="inline">Email <input id="cEmail" type="email"></label>
        <label class="inline">Phone <input id="cPhone" type="text"></label>
        <button id="btnClientUpsert" class="btn">Crear/Actualizar</button>
      </div>

      <table id="tblClients">
        <thead>
        <tr>
          <th>ID</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Rating</th><th>Creado</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ========== DRIVERS ========== -->
    <section id="tab-drivers" class="tab">
      <div class="toolbar">
        <button id="btnRefetchDrivers" class="btn">Refrescar</button>
        <div style="flex:1"></div>
        <label class="inline">Nombre <input id="dName" type="text"></label>
        <label class="inline">Email <input id="dEmail" type="email"></label>
        <label class="inline">Phone <input id="dPhone" type="text"></label>
        <button id="btnDriverCreate" class="btn">Crear</button>
      </div>

      <table id="tblDrivers">
        <thead>
        <tr>
          <th>ID</th><th>Nombre</th><th>Email</th><th>Teléfono</th>
          <th>Pay Mode</th><th>Rates</th><th>Notifs</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // =========================
    // Helpers de panel (inline)
    // =========================
    const ls = localStorage;
    const TOAST = document.getElementById('toast');
    const envBadge = document.getElementById('envBadge');
    const who = document.getElementById('who');

    function getJWT(){ return ls.getItem('bonanza_admin_jwt') || ''; }
    function getAdminKey(){ return ls.getItem('bonanza_admin_key') || ''; }

    function tokenPreview() {
      const t = getJWT();
      who.textContent = t ? ('jwt ' + t.slice(0, 8) + '…') :
                            (getAdminKey() ? 'x-admin-key' : 'no-auth');
    }
    tokenPreview();

    async function apiFetch(path, opts = {}) {
      const headers = Object.assign({ 'Content-Type':'application/json' }, opts.headers || {});
      const jwt = getJWT();
      const key = getAdminKey();
      if (jwt) headers['Authorization'] = 'Bearer ' + jwt;
      if (key) headers['x-admin-key'] = key;

      const res = await fetch(path, { ...opts, headers });
      if (res.status === 401) {
        showToast('No autorizado. Inicia sesión nuevamente.');
        setTimeout(()=>location.href='/public/admin/login.html', 900);
        throw new Error('unauthorized');
      }
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    function showToast(msg, ok=false){
      TOAST.textContent = msg;
      TOAST.classList.toggle('ok', ok);
      TOAST.style.display = 'block';
      clearTimeout(TOAST._t);
      TOAST._t = setTimeout(()=> TOAST.style.display='none', 3000);
    }

    // Tabs
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
        document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
      });
    });

    // Logout
    document.getElementById('btnLogout').addEventListener('click', ()=>{
      ls.removeItem('bonanza_admin_jwt');
      ls.removeItem('bonanza_admin_key');
      showToast('Sesión cerrada', true);
      setTimeout(()=> location.href='/public/admin/login.html', 500);
    });

    envBadge.textContent = (location.hostname.includes('localhost') ? 'LOCAL' : 'PROD');

    // =========================
    // RESERVATIONS
    // =========================
    const $tblRes = document.querySelector('#tblReservations tbody');
    async function fetchReservations(){
      const rows = await apiFetch('/api/reservations');
      $tblRes.innerHTML = rows.map(r => {
        const status = String(r.status||'').toLowerCase();
        const veh = r.vehicle_label || r.vehicle_plate || '';
        const when = r.pickup_time ? new Date(r.pickup_time).toLocaleString() : '';
        const updated = r.updated_at ? new Date(r.updated_at).toLocaleString() : '';
        return `<tr>
          <td>${r.id}</td>
          <td>${when}</td>
          <td>${escapeHtml(r.customer_name||'')}</td>
          <td>${escapeHtml(r.pickup_location||'')} → ${escapeHtml(r.dropoff_location||'')}</td>
          <td>${escapeHtml(veh)}</td>
          <td><span class="status ${status}">${status}</span></td>
          <td>${escapeHtml(r.driver_name||'')}</td>
          <td>${updated}</td>
        </tr>`;
      }).join('');
    }
    document.getElementById('btnRefetchReservations').addEventListener('click', ()=>{
      fetchReservations().then(()=>showToast('Reservas actualizadas', true))
        .catch(e=>showToast('Error: '+e.message));
    });

    // Asignar / desasignar
    document.getElementById('btnAssign').addEventListener('click', async ()=>{
      const id = Number(document.getElementById('resId').value);
      const driver_id = (document.getElementById('resDriverId').value || '').trim() || null;
      if (!id){ showToast('Debes indicar ID de la reserva'); return; }
      try{
        await apiFetch('/api/reservations', { method:'PATCH', body: JSON.stringify({ id, driver_id }) });
        await fetchReservations();
        showToast(`Reserva ${id}: ${driver_id? 'ASSIGNED' : 'PENDING'}`, true);
      }catch(e){ showToast('No se pudo asignar: '+e.message); }
    });

    // =========================
    // VEHICLES
    // =========================
    const $tblVeh = document.querySelector('#tblVehicles tbody');

    async function fetchVehicles(){
      const res = await apiFetch('/api/admin/vehicles', { method:'GET' });
      const vehicles = res?.vehicles || res || [];
      $tblVeh.innerHTML = vehicles.map(v => `
        <tr>
          <td class="mono">${v.id||''}</td>
          <td>${escapeHtml(v.plate||'')}</td>
          <td>${escapeHtml(v.driver_name||'')}</td>
          <td>${escapeHtml((v.kind||'').toUpperCase())}</td>
          <td>${v.year||''}</td>
          <td>${escapeHtml(v.model||'')}</td>
          <td>${v.active? '✓' : '—'}</td>
          <td class="right">
            <button data-id="${v.id}" class="btn secondary btnToggle">${v.active? 'Desactivar':'Activar'}</button>
          </td>
        </tr>
      `).join('');

      $tblVeh.querySelectorAll('.btnToggle').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          try{
            await apiFetch('/api/admin/vehicles', {
              method:'POST',
              body: JSON.stringify({ id, active: btn.textContent === 'Activar' })
            });
            await fetchVehicles();
            showToast('Vehículo actualizado', true);
          }catch(e){ showToast('Error: '+e.message); }
        });
      });
    }
    document.getElementById('btnRefetchVehicles').addEventListener('click', ()=>{
      fetchVehicles().then(()=>showToast('Vehículos actualizados', true))
        .catch(e=>showToast('Error: '+e.message));
    });

    document.getElementById('btnVehicleUpsert').addEventListener('click', async ()=>{
      const payload = {
        plate: (document.getElementById('vPlate').value||'').trim(),
        driver_name: (document.getElementById('vDriver').value||'').trim() || null,
        kind: (document.getElementById('vKind').value||'SUV').toUpperCase(),
        year: Number(document.getElementById('vYear').value) || null,
        model: (document.getElementById('vModel').value||'').trim() || null
      };
      if (!payload.plate){ showToast('Placa es obligatoria'); return; }
      try{
        await apiFetch('/api/admin/vehicles', { method:'POST', body: JSON.stringify(payload) });
        await fetchVehicles();
        showToast('Vehículo guardado', true);
      }catch(e){ showToast('Error: '+e.message); }
    });

    // =========================
    // CLIENTS
    // =========================
    const $tblCli = document.querySelector('#tblClients tbody');
    async function fetchClients(){
      const r = await apiFetch('/api/admin/clients', { method:'GET' });
      const clients = r?.clients || r || [];
      $tblCli.innerHTML = clients.map(c => `
        <tr>
          <td class="mono">${c.id||''}</td>
          <td>${escapeHtml(c.name||'')}</td>
          <td>${escapeHtml(c.email||'')}</td>
          <td>${escapeHtml(c.phone||'')}</td>
          <td>${escapeHtml(c.internal_rating||'')}</td>
          <td class="small right">${c.created_at? new Date(c.created_at).toLocaleString() : ''}</td>
        </tr>
      `).join('');
    }
    document.getElementById('btnRefetchClients').addEventListener('click', ()=>{
      fetchClients().then(()=>showToast('Clientes actualizados', true))
        .catch(e=>showToast('Error: '+e.message));
    });

    document.getElementById('btnClientUpsert').addEventListener('click', async ()=>{
      const payload = {
        name: (document.getElementById('cName').value||'').trim(),
        email: (document.getElementById('cEmail').value||'').trim() || null,
        phone: (document.getElementById('cPhone').value||'').trim() || null
      };
      if (!payload.name){ showToast('Nombre es obligatorio'); return; }
      try{
        await apiFetch('/api/admin/clients', { method:'POST', body: JSON.stringify(payload) });
        await fetchClients();
        showToast('Cliente guardado', true);
      }catch(e){ showToast('Error: '+e.message); }
    });

    // =========================
    // DRIVERS
    // =========================
    const $tblDrv = document.querySelector('#tblDrivers tbody');
    async function fetchDrivers(){
      const rows = await apiFetch('/api/drivers', { method:'GET' });
      $tblDrv.innerHTML = rows.map(d => `
        <tr>
          <td class="mono">${d.id||''}</td>
          <td>${escapeHtml(d.name||'')}</td>
          <td>${escapeHtml(d.email||'')}</td>
          <td>${escapeHtml(d.phone||'')}</td>
          <td>${escapeHtml(d.pay_mode||'')}</td>
          <td class="small">
            ${d.hourly_rate!=null? ('$'+d.hourly_rate+'/h ') : '' }
            ${d.per_ride_rate!=null? ('$'+d.per_ride_rate+' por ride ') : '' }
            ${d.revenue_share!=null? ((d.revenue_share*100)+'% share'):''}
          </td>
          <td class="small">${d.notify_email? 'email ' : ''}${d.notify_sms? 'sms':''}</td>
        </tr>
      `).join('');
    }
    document.getElementById('btnRefetchDrivers').addEventListener('click', ()=>{
      fetchDrivers().then(()=>showToast('Drivers actualizados', true))
        .catch(e=>showToast('Error: '+e.message));
    });

    document.getElementById('btnDriverCreate').addEventListener('click', async ()=>{
      const name  = (document.getElementById('dName').value||'').trim();
      const email = (document.getElementById('dEmail').value||'').trim() || null;
      const phone = (document.getElementById('dPhone').value||'').trim() || null;
      if (!name){ showToast('Nombre es obligatorio'); return; }
      try{
        await apiFetch('/api/drivers', { method:'POST', body: JSON.stringify({ name, email, phone }) });
        await fetchDrivers();
        showToast('Driver creado', true);
      }catch(e){ showToast('Error: '+e.message); }
    });

    // Utils
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Primera carga
    (async function boot(){
      try{
        await Promise.all([ fetchReservations(), fetchVehicles(), fetchClients(), fetchDrivers() ]);
        showToast('Datos cargados', true);
      }catch(e){
        alert('Error cargando datos. Verifica tu Admin Key o la API.');
      }
    })();
  </script>
</body>
</html>
