<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment Confirmation — Bonanza</title>
  <style>
    :root{ --c:#a8744f; }
    body{ background:#000; color:#f5e7d3; font-family:Arial,Helvetica,sans-serif; margin:0; padding:24px; }
    .card{ max-width:760px; margin:0 auto; background:#0e0e0e; border:1px solid rgba(168,116,79,.45);
           border-radius:14px; padding:20px; box-shadow:0 12px 28px rgba(0,0,0,.45) }
    h1{ margin:0 0 8px; color:#ffddae }
    .row{ display:flex; justify-content:space-between; margin:6px 0 }
    .muted{ opacity:.85 }
    .ok{ color:#17c964 } .err{ color:#ff6b6b }
    .divider{ height:1px; margin:12px 0; background:linear-gradient(90deg,transparent,rgba(168,116,79,.45),transparent) }
    button{ background:var(--c); color:#000; font-weight:800; padding:10px 14px; border:0; border-radius:10px; cursor:pointer }
    .actions{ display:flex; gap:8px; margin-top:14px }
    @media print{ .actions{ display:none } body{ background:#fff; color:#000 } .card{ box-shadow:none } }
  </style>
</head>
<body>
  <div class="card">
    <h1>Payment Confirmed</h1>
    <div id="status" class="muted">Loading...</div>
    <div class="divider"></div>

    <div id="receipt" style="display:none">
      <div class="row"><div>Customer</div><div id="r_name"></div></div>
      <div class="row"><div>Email</div><div id="r_email"></div></div>
      <div class="row"><div>Confirmation (CN)</div><div id="r_cn"></div></div>
      <div class="row"><div>Amount</div><div id="r_amount"></div></div>
      <div class="divider"></div>
      <div class="row"><div>Pickup</div><div id="r_pickup"></div></div>
      <div class="row"><div>Drop‑off</div><div id="r_dropoff"></div></div>
      <div class="row"><div>Date/Time</div><div id="r_dt"></div></div>
      <div class="row"><div>Vehicle</div><div id="r_vehicle"></div></div>
      <div class="divider"></div>
      <div class="muted" id="r_pi"></div>
      <div class="actions">
        <button onclick="window.print()">Print</button>
        <button id="btnBack">Back to Reschedule</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const qs = new URLSearchParams(location.search);
  const sessionId = qs.get('session_id');
  const cn = qs.get('cn') || '';
  const status = document.getElementById('status');
  const back = document.getElementById('btnBack');
  back.onclick = () => location.href = `/reschedule.html?cn=${encodeURIComponent(cn)}`;

  if(!sessionId){
    status.className='err';
    status.textContent='Missing session_id.';
    return;
  }

  try{
    const resp = await fetch(`/api/checkout-session?session_id=${encodeURIComponent(sessionId)}`);
    const data = await resp.json();
    if(!resp.ok || !data?.ok) throw new Error(data?.error || `HTTP ${resp.status}`);

    const s = data.session;
    const md = s.metadata || {};
    const amount = (s.amount_total ?? s.line_items?.data?.[0]?.amount_total ?? 0) / 100;

    // Rellenar recibo
    document.getElementById('r_name').textContent   = md.fullname || '—';
    document.getElementById('r_email').textContent  = s.customer_details?.email || md.email || '—';
    document.getElementById('r_cn').textContent     = md.confirmationNumber || cn || '—';
    document.getElementById('r_amount').textContent = `$${amount.toFixed(2)}`;

    document.getElementById('r_pickup').textContent   = md.pickup || '—';
    document.getElementById('r_dropoff').textContent  = md.dropoff || '—';
    const dt = [md.date||'', md.time||''].filter(Boolean).join(' ');
    document.getElementById('r_dt').textContent       = dt || '—';
    document.getElementById('r_vehicle').textContent  = md.vehicleType || '—';

    const pi = s.payment_intent;
    document.getElementById('r_pi').textContent =
      pi ? `Payment Intent: ${pi.id} • Status: ${pi.status}` : '';

    status.className='ok';
    status.textContent='Thank you! Your payment was successful.';
    document.getElementById('receipt').style.display='block';
  }catch(e){
    status.className='err';
    status.textContent='Error loading receipt: ' + (e.message||e);
  }
})();
</script>
</body>
</html>
