<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation</title>
  <style>
    body {
      background-color: #0d0d0d;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #b87333;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }
    input, select {
      width: 100%;
      padding: 10px;
      background-color: #1c1c1c;
      border: 1px solid #333;
      color: #fff;
      border-radius: 5px;
    }
    .valid {
      border-color: green;
    }
    .invalid {
      border-color: red;
    }
    #calculate-btn, #pay-button {
      background-color: #b87333;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: background-color 0.3s;
    }
    #calculate-btn:hover, #pay-button:hover {
      background-color: #a3622b;
    }
    #map {
      height: 200px;
      margin-top: 15px;
      border-radius: 10px;
    }
    .info {
      margin-top: 20px;
      background-color: #1a1a1a;
      padding: 15px;
      border-radius: 10px;
    }
    .info strong {
      color: #b87333;
    }
    img.logo {
      display: block;
      margin: 0 auto 20px;
      max-width: 150px;
    }
  </style>
</head>
<body>
  <img src="bonanza-logo.PNG" alt="Bonanza Transportation" class="logo">
  <h1>Book Your Ride</h1>
  
  <div class="form-group">
    <label for="pickup">Pick-up Address:</label>
    <input type="text" id="pickup" placeholder="Enter pick-up location">
  </div>

  <div class="form-group">
    <label for="dropoff">Drop-off Address:</label>
    <input type="text" id="dropoff" placeholder="Enter drop-off location">
  </div>

  <div class="form-group">
    <label for="date">Date:</label>
    <input type="date" id="date">
  </div>

  <div class="form-group">
    <label for="time">Time:</label>
    <input type="time" id="time">
  </div>

  <button id="calculate-btn">Calculate Price</button>

  <div id="map"></div>

  <div class="info" id="trip-info" style="display:none;">
    <p><strong>Distance:</strong> <span id="distance"></span></p>
    <p><strong>Duration:</strong> <span id="duration"></span></p>
    <p><strong>Estimated Price:</strong> $<span id="price"></span></p>
  </div>

  <button id="pay-button" style="display:none;">PAY NOW</button>

  <script>
    let map;
    let pickupMarker;
    let dropoffMarker;
    let calculatedPrice = 0;

    function initAutocomplete() {
      const pickupInput = document.getElementById('pickup');
      const dropoffInput = document.getElementById('dropoff');
      const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
      const dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput);

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.7608, lng: -111.8910 },
        zoom: 10,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#8ec3b9" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] }
        ]
      });

      pickupAutocomplete.addListener("place_changed", () => {
        const place = pickupAutocomplete.getPlace();
        if (place.geometry && place.geometry.location) {
          if (pickupMarker) pickupMarker.setMap(null);
          pickupMarker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            label: "A"
          });
          map.setCenter(place.geometry.location);
          pickupInput.classList.remove("invalid");
          pickupInput.classList.add("valid");
        } else {
          pickupInput.classList.remove("valid");
          pickupInput.classList.add("invalid");
        }
      });

      dropoffAutocomplete.addListener("place_changed", () => {
        const place = dropoffAutocomplete.getPlace();
        if (place.geometry && place.geometry.location) {
          if (dropoffMarker) dropoffMarker.setMap(null);
          dropoffMarker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            label: "B"
          });
          dropoffInput.classList.remove("invalid");
          dropoffInput.classList.add("valid");
        } else {
          dropoffInput.classList.remove("valid");
          dropoffInput.classList.add("invalid");
        }
      });
    }

    document.getElementById("calculate-btn").addEventListener("click", async () => {
      const pickup = document.getElementById("pickup").value;
      const dropoff = document.getElementById("dropoff").value;

      if (!pickup || !dropoff) {
        alert("Please enter both pick-up and drop-off addresses.");
        return;
      }

      const service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix(
        {
          origins: [pickup],
          destinations: [dropoff],
          travelMode: "DRIVING",
        },
        (response, status) => {
          if (status === "OK") {
            const element = response.rows[0].elements[0];
            const distanceText = element.distance.text;
            const durationText = element.duration.text;
            const distanceInMiles = parseFloat(element.distance.value / 1609.34).toFixed(1);
            calculatedPrice = Math.round(distanceInMiles * 8 * 100); // in cents

            document.getElementById("distance").textContent = distanceText;
            document.getElementById("duration").textContent = durationText;
            document.getElementById("price").textContent = (calculatedPrice / 100).toFixed(2);
            document.getElementById("trip-info").style.display = "block";
            document.getElementById("pay-button").style.display = "block";
          } else {
            alert("Error calculating distance: " + status);
          }
        }
      );
    });

    document.getElementById("pay-button").addEventListener("click", async () => {
      if (!calculatedPrice || calculatedPrice <= 0) {
        alert("Please calculate the price before proceeding to payment.");
        return;
      }

      try {
        const response = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ price: calculatedPrice }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error("No URL returned from Stripe");
        }
      } catch (error) {
        console.error("Payment initiation error:", error);
        alert("An error occurred while initiating payment.");
      }
    });
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initAutocomplete"
    async defer>
  </script>
</body>
</html>
