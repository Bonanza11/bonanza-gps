<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonanza Transportation — GPS & Estimate</title>

  <!-- Estilos: negro & cobre elegante -->
  <style>
    :root{
      --bg:#000;
      --copper:#c08b5c;
      --copper-2:#b27a49;
      --text:#e9e9e9;
      --muted:#a6a6a6;
      --field:#1a1a1a;
      --ok:#22c55e;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      text-align:center;
      padding:18px 16px 6px;
    }
    header img{
      width:120px; height:120px; border-radius:50%;
      object-fit:cover; border:3px solid var(--copper);
      box-shadow:0 0 30px rgba(192,139,92,.2);
    }
    main{
      max-width: 540px;
      margin: 0 auto;
      padding: 16px;
    }
    label{ display:block; margin-top:14px; font-weight:600; }
    input{
      width:100%; padding:12px 12px;
      margin-top:8px; border-radius:8px;
      border:1px solid #333; outline:none;
      background: var(--field); color: var(--text);
    }
    input::placeholder{ color:#737373; }
    .valid{ border-color: var(--ok) !important; }
    .invalid{ border-color: var(--err) !important; }
    .error-message{
      display:none; color: var(--err); font-size:.85rem; margin:6px 2px 0;
    }

    button{
      width:100%; padding:14px 16px; margin-top:20px;
      border:none; border-radius:10px; cursor:pointer;
      font-weight:700; color:#111; background: linear-gradient(180deg,var(--copper),var(--copper-2));
      box-shadow:0 0 0 0 rgba(192,139,92,.7);
      animation:pulse 2.2s infinite;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; animation:none; }
    @keyframes pulse{
      0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(192,139,92,.35) }
      70%{ transform:scale(1.01); box-shadow:0 0 0 28px rgba(192,139,92,0) }
      100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(192,139,92,0) }
    }

    /* Mapa */
    #map{
      width:100%;
      height:360px;           /* ALTURA OBLIGATORIA */
      border-radius:12px;
      margin-top:16px;
      border:1px solid #2b2b2b;
    }

    /* Tarjeta info */
    .info{
      margin-top:16px;
      background:#111; border:1px solid #2b2b2b;
      border-radius:12px; padding:14px 16px; line-height:1.5;
    }
    .info strong{ color:#fff; }
    footer{
      text-align:center; opacity:.8; font-size:.85rem; margin:22px 0 10px;
    }
  </style>
</head>
<body>
  <header>
    <!-- Usa tu logo si quieres -->
    <img src="bonanza-logo.PNG" alt="Bonanza Logo" />
  </header>

  <main>
    <label for="fullname">Full Name:</label>
    <input id="fullname" type="text" placeholder="e.g. John Doe" />

    <label for="phone">Phone Number:</label>
    <input id="phone" type="tel" inputmode="tel" placeholder="e.g. +1 385 123 4567" />
    <div id="phoneError" class="error-message">Please enter a valid phone number.</div>

    <label for="email">Email Address:</label>
    <input id="email" type="email" inputmode="email" placeholder="e.g. your@email.com" />
    <div id="emailError" class="error-message">Please enter a valid email address.</div>

    <label for="pickup">Pick-up Address:</label>
    <input id="pickup" type="text" placeholder="e.g. 13742 N Jordanelle Pkwy" />
    <div id="pickupError" class="error-message">Please enter a pick-up address.</div>

    <label for="dropoff">Drop-off Address:</label>
    <input id="dropoff" type="text" placeholder="e.g. SLC Airport" />
    <div id="dropoffError" class="error-message">Please enter a drop-off address.</div>

    <label for="date">Date:</label>
    <input id="date" type="date" />
    <div id="dateError" class="error-message">Please select a date.</div>

    <label for="time">Time:</label>
    <input id="time" type="time" />
    <div id="timeError" class="error-message">Please select a time.</div>

    <button id="calcBtn" type="button">Calculate Price</button>

    <div id="map"></div>

    <div class="info" id="infoBox">
      <div><strong>Distance:</strong> <span id="distance">—</span></div>
      <div><strong>Duration:</strong> <span id="duration">—</span></div>
      <div><strong>Estimated Price:</strong> <span id="price">$0.00</span></div>
      <div><strong>Note:</strong> Pet-Friendly Service (No Extra Charge)</div>
      <div><strong>Vehicle:</strong> Black Suburban — 1–5 Passengers</div>
      <div><strong>Luggage:</strong> 5 ski bags, 2 large + 3 small or 3 large + 4 small suitcases</div>
    </div>

    <button id="payBtn" type="button">PAY NOW</button>
  </main>

  <footer>© Bonanza Transportation — Park City, Utah</footer>

  <!-- ========================= SCRIPTS ========================= -->
  <script>
    // Map & Directions
    let map, directionsService, directionsRenderer;
    let calculatedPrice = 0;

    function initMap(){
      const mapEl = document.getElementById('map');
      if (!mapEl) return;

      map = new google.maps.Map(mapEl, {
        center: { lat: 40.646, lng: -111.498 }, // Park City area
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      // Autocomplete
      const acOpts = { componentRestrictions: { country: "us" }, fields: ["formatted_address","geometry","name"] };
      const pickupInput  = document.getElementById('pickup');
      const dropoffInput = document.getElementById('dropoff');
      if (pickupInput)  new google.maps.places.Autocomplete(pickupInput, acOpts);
      if (dropoffInput) new google.maps.places.Autocomplete(dropoffInput, acOpts);
    }
    // Exponer callback para Google
    window.initMap = initMap;

    // Validaciones básicas
    function showError(id, show){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = show ? 'block' : 'none';
    }
    function validateInputs(){
      let ok = true;

      // Phone (simple)
      const phone = document.getElementById('phone').value.trim();
      const phoneOk = /^\+?\d[\d\s\-()]{6,}$/.test(phone);
      showError('phoneError', !phoneOk); ok = ok && phoneOk;

      // Email
      const email = document.getElementById('email').value.trim();
      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      showError('emailError', !emailOk); ok = ok && emailOk;

      // Pickup/Dropoff
      const pick = document.getElementById('pickup').value.trim();
      const drop = document.getElementById('dropoff').value.trim();
      const pickOk = pick.length > 3, dropOk = drop.length > 3;
      showError('pickupError', !pickOk); ok = ok && pickOk;
      showError('dropoffError', !dropOk); ok = ok && dropOk;

      // Date/Time
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const dateOk = !!date, timeOk = !!time;
      showError('dateError', !dateOk); ok = ok && dateOk;
      showError('timeError', !timeOk); ok = ok && timeOk;

      return ok;
    }

    // Tabla oficial de precios (millas -> USD)
    function priceFromMiles(miles){
      if (miles <= 10) return 120;
      if (miles <= 35) return 190;
      if (miles <= 39) return 210;
      if (miles <= 48) return 230;
      if (miles <= 55) return 250;
      return miles * 5.4; // más de 55
    }

    async function calculateRoute(){
      if (!validateInputs()) return;

      const origin      = document.getElementById('pickup').value.trim();
      const destination = document.getElementById('dropoff').value.trim();

      directionsService.route({
        origin, destination,
        travelMode: google.maps.TravelMode.DRIVING
      }, (res, status) => {
        if (status !== "OK" || !res) {
          alert("Could not calculate route. Please check the addresses.");
          return;
        }

        directionsRenderer.setDirections(res);

        const leg = res.routes[0].legs[0];
        const meters = leg.distance.value;
        const miles = meters / 1609.34;

        document.getElementById('distance').textContent = miles.toFixed(1) + " miles";
        document.getElementById('duration').textContent = leg.duration.text;

        calculatedPrice = priceFromMiles(miles);
        document.getElementById('price').textContent = "$ " + calculatedPrice.toFixed(2);
      });
    }

    async function payNow(){
      if (!validateInputs()){
        alert("Please complete all fields correctly before paying.");
        return;
      }
      if (calculatedPrice <= 0){
        alert("Please calculate a price before proceeding to payment.");
        return;
      }

      // Recolectar metadata
      const meta = {
        fullname: document.getElementById('fullname').value.trim(),
        phone:    document.getElementById('phone').value.trim(),
        email:    document.getElementById('email').value.trim(),
        pickup:   document.getElementById('pickup').value.trim(),
        dropoff:  document.getElementById('dropoff').value.trim(),
        date:     document.getElementById('date').value,
        time:     document.getElementById('time').value,
        distance: document.getElementById('distance').textContent,
        duration: document.getElementById('duration').textContent,
        price:    calculatedPrice.toFixed(2)
      };

      try{
        const res = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: Math.round(calculatedPrice * 100), // cents
            metadata: meta
          })
        });
        if (!res.ok) throw new Error('Stripe backend error');
        const data = await res.json();
        if (!data.id) throw new Error('No session id returned');

        // ⚠️ Reemplaza con tu CLAVE PUBLICABLE real de Stripe (pk_live_... o pk_test_...)
        const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');
        await stripe.redirectToCheckout({ sessionId: data.id });
      } catch(err){
        console.error('Payment error:', err);
        alert('There was an error starting the payment.');
      }
    }

    // Listeners
    document.getElementById('calcBtn').addEventListener('click', calculateRoute);
    document.getElementById('payBtn').addEventListener('click', payNow);
  </script>

  <!-- Google Maps JS (con Places y callback)
       ⚠️ Reemplaza la key si usas otra. Aquí puedes dejar la tuya pública. -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN6B8izVVhi9CGiO-_TXdhquQAE_i5Lts&libraries=places&callback=initMap"
    async defer>
  </script>
</body>
</html>
